<?xml version="1.0" encoding="utf-8"?><testsuites name="pytest tests"><testsuite name="pytest" errors="0" failures="1" skipped="0" tests="97" time="21.835" timestamp="2025-11-18T15:54:08.716381+00:00" hostname="runnervmg1sw1"><testcase classname="tests.__init__" name="PYDOCSTYLE" time="0.005" /><testcase classname="tests.__init__" name="ISORT" time="0.007" /><testcase classname="tests.__init__" name="black" time="0.327" /><testcase classname="tests.conftest" name="PYDOCSTYLE" time="0.027" /><testcase classname="tests.conftest" name="ISORT" time="0.174" /><testcase classname="tests.conftest" name="black" time="0.217" /><testcase classname="tests.fixtures" name="PYDOCSTYLE" time="0.031" /><testcase classname="tests.fixtures" name="ISORT" time="0.087" /><testcase classname="tests.fixtures" name="black" time="0.258" /><testcase classname="tests.test_alembic" name="ISORT" time="0.012" /><testcase classname="tests.test_alembic" name="black" time="0.168" /><testcase classname="tests.test_alembic" name="test_alembic" time="5.454" /><testcase classname="tests.test_api" name="ISORT" time="0.043" /><testcase classname="tests.test_api" name="black" time="0.210" /><testcase classname="tests.test_api" name="test_github_api_create_hook" time="0.932" /><testcase classname="tests.test_api" name="test_release_api" time="0.034" /><testcase classname="tests.test_api" name="test_release_branch_tag_conflict" time="0.030" /><testcase classname="tests.test_api" name="test_sync_basic" time="0.032" /><testcase classname="tests.test_api" name="test_sync_updates_repo_names" time="0.036" /><testcase classname="tests.test_api" name="test_sync_updates_account_extra_data" time="0.028" /><testcase classname="tests.test_api" name="test_sync_updates_hooks_asynchronously" time="0.976" /><testcase classname="tests.test_api" name="test_sync_repo_hook_creates_repo_when_hook_exists" time="0.031" /><testcase classname="tests.test_api" name="test_sync_repo_hook_enables_existing_repo_when_hook_exists" time="0.092" /><testcase classname="tests.test_badge" name="ISORT" time="0.010" /><testcase classname="tests.test_badge" name="black" time="0.162" /><testcase classname="tests.test_invenio_github" name="ISORT" time="0.013" /><testcase classname="tests.test_invenio_github" name="black" time="0.169" /><testcase classname="tests.test_invenio_github" name="test_version" time="0.001" /><testcase classname="tests.test_invenio_github" name="test_init" time="0.004" /><testcase classname="tests.test_models" name="ISORT" time="0.009" /><testcase classname="tests.test_models" name="black" time="0.160" /><testcase classname="tests.test_models" name="test_repository_unbound" time="0.914" /><testcase classname="tests.test_tasks" name="ISORT" time="0.025" /><testcase classname="tests.test_tasks" name="black" time="0.181" /><testcase classname="tests.test_tasks" name="test_real_process_release_task" time="1.084" /><testcase classname="tests.test_tasks" name="test_refresh_accounts" time="2.105"><failure message="sqlalchemy.exc.InvalidRequestError: Can't operate on closed transaction inside context manager.  Please complete the context manager before emitting further commands.">app = &lt;Flask 'invenio'&gt;
db = &lt;SQLAlchemy postgresql+psycopg2://invenio:***@localhost:5432/invenio&gt;
tester_id = 2, remote_token = Remote Token &lt;token_type= access_token=****test&gt;
github_api = &lt;MagicMock id='140231932387136'&gt;

    def test_refresh_accounts(app, db, tester_id, remote_token, github_api):
        """Test account refresh task."""
    
        def mocked_sync(hooks=True, async_hooks=True):
            """Mock sync function and update the remote account."""
            account = RemoteAccount.query.all()[0]
            account.extra_data.update(
                dict(
                    last_sync=iso_utcnow(),
                )
            )
            db.session.commit()
    
        with patch("invenio_github.api.GitHubAPI.sync", side_effect=mocked_sync):
            updated = RemoteAccount.query.all()[0].updated
            expiration_threshold = {"seconds": 1}
            sleep(2)
&gt;           refresh_accounts.delay(expiration_threshold)

tests/test_tasks.py:99: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.12/site-packages/celery/app/task.py:444: in delay
    return self.apply_async(args, kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/celery/app/task.py:591: in apply_async
    return self.apply(args, kwargs, task_id=task_id or uuid(),
.venv/lib/python3.12/site-packages/celery/app/task.py:819: in apply
    ret = tracer(task_id, args, kwargs, request)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/celery/app/trace.py:470: in trace_task
    I, R, state, retval = on_error(task_request, exc)
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/celery/app/trace.py:453: in trace_task
    R = retval = fun(*args, **kwargs)
                 ^^^^^^^^^^^^^^^^^^^^
invenio_github/tasks.py:167: in refresh_accounts
    sync_account.delay(remote_account.user_id)
.venv/lib/python3.12/site-packages/celery/app/task.py:444: in delay
    return self.apply_async(args, kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/celery/app/task.py:591: in apply_async
    return self.apply(args, kwargs, task_id=task_id or uuid(),
.venv/lib/python3.12/site-packages/celery/app/task.py:819: in apply
    ret = tracer(task_id, args, kwargs, request)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/celery/app/trace.py:470: in trace_task
    I, R, state, retval = on_error(task_request, exc)
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/celery/app/trace.py:453: in trace_task
    R = retval = fun(*args, **kwargs)
                 ^^^^^^^^^^^^^^^^^^^^
invenio_github/tasks.py:179: in sync_account
    gh.sync(hooks=False, async_hooks=False)
.venv/lib/python3.12/site-packages/mock/mock.py:1190: in __call__
    return _mock_self._mock_call(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/mock/mock.py:1194: in _mock_call
    return _mock_self._execute_mock_call(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/mock/mock.py:1257: in _execute_mock_call
    result = effect(*args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^
tests/test_tasks.py:93: in mocked_sync
    db.session.commit()
.venv/lib/python3.12/site-packages/pytest_invenio/fixtures.py:612: in commit
    self._nested_transaction = self._session.begin_nested()
                               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/sqlalchemy/orm/scoping.py:476: in begin_nested
    return self._proxied.begin_nested()
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:1971: in begin_nested
    return self.begin(nested=True)
           ^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:1937: in begin
    trans = trans._begin(nested=nested)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^
&lt;string&gt;:2: in _begin
    ???
.venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:137: in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:1043: in _begin
    return SessionTransaction(
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:929: in __init__
    TransactionalContext._trans_ctx_check(session)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

cls = &lt;class 'sqlalchemy.engine.util.TransactionalContext'&gt;
subject = &lt;sqlalchemy.orm.session.PytestInvenioSession object at 0x7f8a4a851790&gt;

    @classmethod
    def _trans_ctx_check(cls, subject: _TConsSubject) -&gt; None:
        trans_context = subject._trans_context_manager
        if trans_context:
            if not trans_context._transaction_is_active():
&gt;               raise exc.InvalidRequestError(
                    "Can't operate on closed transaction inside context "
                    "manager.  Please complete the context manager "
                    "before emitting further commands."
                )
E               sqlalchemy.exc.InvalidRequestError: Can't operate on closed transaction inside context manager.  Please complete the context manager before emitting further commands.

.venv/lib/python3.12/site-packages/sqlalchemy/engine/util.py:111: InvalidRequestError</failure></testcase><testcase classname="tests.test_views" name="ISORT" time="0.011" /><testcase classname="tests.test_views" name="black" time="0.169" /><testcase classname="tests.test_views" name="test_api_init_user" time="1.028" /><testcase classname="tests.test_webhook" name="ISORT" time="0.023" /><testcase classname="tests.test_webhook" name="black" time="0.182" /><testcase classname="tests.test_webhook" name="test_webhook_post" time="0.952" /><testcase classname="tests.test_webhook" name="test_webhook_post_fail" time="0.091" /><testcase classname="invenio_github.__init__" name="PYDOCSTYLE" time="0.003" /><testcase classname="invenio_github.__init__" name="ISORT" time="0.008" /><testcase classname="invenio_github.__init__" name="black" time="0.165" /><testcase classname="invenio_github.alembic.5a5428312b2b_create_github_branch" name="PYDOCSTYLE" time="0.004" /><testcase classname="invenio_github.alembic.5a5428312b2b_create_github_branch" name="ISORT" time="0.010" /><testcase classname="invenio_github.alembic.5a5428312b2b_create_github_branch" name="black" time="0.171" /><testcase classname="invenio_github.alembic.b0eaee37b545_create_github_tables" name="PYDOCSTYLE" time="0.010" /><testcase classname="invenio_github.alembic.b0eaee37b545_create_github_tables" name="ISORT" time="0.023" /><testcase classname="invenio_github.alembic.b0eaee37b545_create_github_tables" name="black" time="0.190" /><testcase classname="invenio_github.api" name="PYDOCSTYLE" time="0.063" /><testcase classname="invenio_github.api" name="ISORT" time="0.119" /><testcase classname="invenio_github.api" name="black" time="0.310" /><testcase classname="invenio_github.config" name="PYDOCSTYLE" time="0.004" /><testcase classname="invenio_github.config" name="ISORT" time="0.016" /><testcase classname="invenio_github.config" name="black" time="0.172" /><testcase classname="invenio_github.errors" name="PYDOCSTYLE" time="0.014" /><testcase classname="invenio_github.errors" name="ISORT" time="0.026" /><testcase classname="invenio_github.errors" name="black" time="0.184" /><testcase classname="invenio_github.ext" name="PYDOCSTYLE" time="0.009" /><testcase classname="invenio_github.ext" name="ISORT" time="0.024" /><testcase classname="invenio_github.ext" name="black" time="0.181" /><testcase classname="invenio_github.models" name="PYDOCSTYLE" time="0.020" /><testcase classname="invenio_github.models" name="ISORT" time="0.044" /><testcase classname="invenio_github.models" name="black" time="0.209" /><testcase classname="invenio_github.oauth.handlers" name="PYDOCSTYLE" time="0.008" /><testcase classname="invenio_github.oauth.handlers" name="ISORT" time="0.021" /><testcase classname="invenio_github.oauth.handlers" name="black" time="0.176" /><testcase classname="invenio_github.oauth.remote_app" name="PYDOCSTYLE" time="0.003" /><testcase classname="invenio_github.oauth.remote_app" name="ISORT" time="0.009" /><testcase classname="invenio_github.oauth.remote_app" name="black" time="0.166" /><testcase classname="invenio_github.proxies" name="PYDOCSTYLE" time="0.003" /><testcase classname="invenio_github.proxies" name="ISORT" time="0.010" /><testcase classname="invenio_github.proxies" name="black" time="0.163" /><testcase classname="invenio_github.receivers" name="PYDOCSTYLE" time="0.010" /><testcase classname="invenio_github.receivers" name="ISORT" time="0.022" /><testcase classname="invenio_github.receivers" name="black" time="0.179" /><testcase classname="invenio_github.tasks" name="PYDOCSTYLE" time="0.015" /><testcase classname="invenio_github.tasks" name="ISORT" time="0.041" /><testcase classname="invenio_github.tasks" name="black" time="0.193" /><testcase classname="invenio_github.utils" name="PYDOCSTYLE" time="0.006" /><testcase classname="invenio_github.utils" name="ISORT" time="0.015" /><testcase classname="invenio_github.utils" name="black" time="0.166" /><testcase classname="invenio_github.views.__init__" name="PYDOCSTYLE" time="0.003" /><testcase classname="invenio_github.views.__init__" name="ISORT" time="0.006" /><testcase classname="invenio_github.views.__init__" name="black" time="0.160" /><testcase classname="invenio_github.views.badge" name="PYDOCSTYLE" time="0.010" /><testcase classname="invenio_github.views.badge" name="ISORT" time="0.026" /><testcase classname="invenio_github.views.badge" name="black" time="0.176" /><testcase classname="invenio_github.views.github" name="PYDOCSTYLE" time="0.022" /><testcase classname="invenio_github.views.github" name="ISORT" time="0.045" /><testcase classname="invenio_github.views.github" name="black" time="0.206" /><testcase classname="invenio_github.webpack" name="PYDOCSTYLE" time="0.003" /><testcase classname="invenio_github.webpack" name="ISORT" time="0.009" /><testcase classname="invenio_github.webpack" name="black" time="0.165" /></testsuite></testsuites>
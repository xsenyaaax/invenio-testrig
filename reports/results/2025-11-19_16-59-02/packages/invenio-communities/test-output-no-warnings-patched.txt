 opensearch Pulling 
 redis Pulling 
 postgresql Pulling 
 redis Pulled 
 postgresql Pulled 
 opensearch Pulled 
 Network docker_services_cli_default  Creating
 Network docker_services_cli_default  Created
 Container docker_services_cli-postgresql-1  Creating
 Container docker_services_cli-opensearch-1  Creating
 Container docker_services_cli-redis-1  Creating
 Container docker_services_cli-opensearch-1  Created
 Container docker_services_cli-postgresql-1  Created
 Container docker_services_cli-redis-1  Created
 Container docker_services_cli-postgresql-1  Starting
 Container docker_services_cli-opensearch-1  Starting
 Container docker_services_cli-redis-1  Starting
 Container docker_services_cli-postgresql-1  Started
 Container docker_services_cli-redis-1  Started
 Container docker_services_cli-opensearch-1  Started
============================= test session starts ==============================
platform linux -- Python 3.12.12, pytest-8.4.2, pluggy-1.6.0
rootdir: /home/runner/work/invenio-testrig/invenio-testrig/package-repo
configfile: setup.cfg
plugins: github-actions-annotate-failures-0.3.0, pycodestyle-2.5.0, flask-1.3.0, black-ng-0.4.1, Faker-38.2.0, invenio-3.4.2, isort-4.0.0, cov-7.0.0, pydocstyle-2.4.0
collected 714 items

invenio_communities/__init__.py ...                                      [  0%]
invenio_communities/administration/__init__.py ...                       [  0%]
invenio_communities/administration/communities.py ...                    [  1%]
invenio_communities/alembic/__init__.py ...                              [  1%]
invenio_communities/alembic/02cd82910727_update_role_id_type_upgrade.py . [  1%]
..                                                                       [  2%]
invenio_communities/alembic/37b21951084c_update_role_id_type_downgrade.py . [  2%]
..                                                                       [  2%]
invenio_communities/alembic/5b478fe7ef7f_create_featured_communities_table.py . [  2%]
..                                                                       [  2%]
invenio_communities/alembic/5c68d45c80f0_add_deletion_status_to_communities.py . [  3%]
..                                                                       [  3%]
invenio_communities/alembic/72b37bb4119c_create_indeces_for_bucket_id.py . [  3%]
..                                                                       [  3%]
invenio_communities/alembic/90642d415317_create_communities_branch.py .. [  4%]
.                                                                        [  4%]
invenio_communities/alembic/a3f5a8635cbb_remove_version_table.py ...     [  4%]
invenio_communities/alembic/de9c14cbb0b2_create_communities_tables.py .. [  4%]
.                                                                        [  5%]
invenio_communities/alembic/f701a32e6fbe_create_communities_members_table.py . [  5%]
..                                                                       [  5%]
invenio_communities/alembic/fbe746957cfc_create_member_tables.py ...     [  5%]
invenio_communities/cache/__init__.py ...                                [  6%]
invenio_communities/cache/cache.py ...                                   [  6%]
invenio_communities/cache/redis.py ...                                   [  7%]
invenio_communities/cli.py ...                                           [  7%]
invenio_communities/communities/__init__.py ...                          [  7%]
invenio_communities/communities/dumpers/__init__.py ...                  [  8%]
invenio_communities/communities/dumpers/featured.py ...                  [  8%]
invenio_communities/communities/entity_resolvers.py ...                  [  9%]
invenio_communities/communities/records/__init__.py ...                  [  9%]
invenio_communities/communities/records/api.py ...                       [ 10%]
invenio_communities/communities/records/jsonschemas/__init__.py ...      [ 10%]
invenio_communities/communities/records/mappings/__init__.py ...         [ 10%]
invenio_communities/communities/records/mappings/os-v1/__init__.py ...   [ 11%]
invenio_communities/communities/records/mappings/os-v2/__init__.py ...   [ 11%]
invenio_communities/communities/records/mappings/v7/__init__.py ...      [ 12%]
invenio_communities/communities/records/models.py ...                    [ 12%]
invenio_communities/communities/records/systemfields/__init__.py ...     [ 13%]
invenio_communities/communities/records/systemfields/access.py ...       [ 13%]
invenio_communities/communities/records/systemfields/children.py ...     [ 13%]
invenio_communities/communities/records/systemfields/deletion_status.py . [ 14%]
..                                                                       [ 14%]
invenio_communities/communities/records/systemfields/is_verified.py ...  [ 14%]
invenio_communities/communities/records/systemfields/parent_community.py . [ 14%]
..                                                                       [ 15%]
invenio_communities/communities/records/systemfields/pidslug.py ...      [ 15%]
invenio_communities/communities/records/systemfields/tombstone.py ...    [ 15%]
invenio_communities/communities/resources/__init__.py ...                [ 16%]
invenio_communities/communities/resources/args.py ...                    [ 16%]
invenio_communities/communities/resources/config.py ...                  [ 17%]
invenio_communities/communities/resources/resource.py ...                [ 17%]
invenio_communities/communities/resources/serializer.py ...              [ 18%]
invenio_communities/communities/resources/ui_schema.py ...               [ 18%]
invenio_communities/communities/schema.py ...                            [ 18%]
invenio_communities/communities/services/__init__.py ...                 [ 19%]
invenio_communities/communities/services/components.py ...               [ 19%]
invenio_communities/communities/services/config.py ...                   [ 20%]
invenio_communities/communities/services/facets.py ...                   [ 20%]
invenio_communities/communities/services/links.py ...                    [ 21%]
invenio_communities/communities/services/results.py ...                  [ 21%]
invenio_communities/communities/services/search_params.py ...            [ 21%]
invenio_communities/communities/services/service.py ...                  [ 22%]
invenio_communities/communities/services/sort.py ...                     [ 22%]
invenio_communities/communities/services/uow.py ...                      [ 23%]
invenio_communities/config.py ...                                        [ 23%]
invenio_communities/errors.py ...                                        [ 23%]
invenio_communities/ext.py ...                                           [ 24%]
invenio_communities/fixtures/__init__.py ...                             [ 24%]
invenio_communities/fixtures/demo.py ...                                 [ 25%]
invenio_communities/fixtures/tasks.py ...                                [ 25%]
invenio_communities/generators.py ...                                    [ 26%]
invenio_communities/members/__init__.py ...                              [ 26%]
invenio_communities/members/errors.py ...                                [ 26%]
invenio_communities/members/records/__init__.py ...                      [ 27%]
invenio_communities/members/records/api.py ...                           [ 27%]
invenio_communities/members/records/mappings/__init__.py ...             [ 28%]
invenio_communities/members/records/mappings/os-v1/__init__.py ...       [ 28%]
invenio_communities/members/records/mappings/os-v2/__init__.py ...       [ 28%]
invenio_communities/members/records/mappings/v7/__init__.py ...          [ 29%]
invenio_communities/members/records/models.py ...                        [ 29%]
invenio_communities/members/resources/__init__.py ...                    [ 30%]
invenio_communities/members/resources/config.py ...                      [ 30%]
invenio_communities/members/resources/resource.py ...                    [ 31%]
invenio_communities/members/services/__init__.py ...                     [ 31%]
invenio_communities/members/services/components.py ...                   [ 31%]
invenio_communities/members/services/config.py ...                       [ 32%]
invenio_communities/members/services/facets.py ...                       [ 32%]
invenio_communities/members/services/fields.py ...                       [ 33%]
invenio_communities/members/services/request.py ...                      [ 33%]
invenio_communities/members/services/schemas.py ...                      [ 34%]
invenio_communities/members/services/service.py ...                      [ 34%]
invenio_communities/notifications/__init__.py ...                        [ 34%]
invenio_communities/notifications/builders.py ...                        [ 35%]
invenio_communities/notifications/generators.py ...                      [ 35%]
invenio_communities/permissions.py ...                                   [ 36%]
invenio_communities/proxies.py ...                                       [ 36%]
invenio_communities/records/__init__.py ...                              [ 36%]
invenio_communities/records/records/__init__.py ...                      [ 37%]
invenio_communities/records/records/models.py ...                        [ 37%]
invenio_communities/records/records/systemfields/__init__.py ...         [ 38%]
invenio_communities/records/records/systemfields/communities/__init__.py . [ 38%]
..                                                                       [ 38%]
invenio_communities/records/records/systemfields/communities/context.py . [ 38%]
..                                                                       [ 39%]
invenio_communities/records/records/systemfields/communities/field.py .. [ 39%]
.                                                                        [ 39%]
invenio_communities/records/records/systemfields/communities/manager.py . [ 39%]
..                                                                       [ 39%]
invenio_communities/requests/user_moderation/__init__.py ...             [ 40%]
invenio_communities/requests/user_moderation/actions.py ...              [ 40%]
invenio_communities/requests/user_moderation/tasks.py ...                [ 41%]
invenio_communities/roles.py ...                                         [ 41%]
invenio_communities/searchapp.py ...                                     [ 42%]
invenio_communities/subcommunities/__init__.py ...                       [ 42%]
invenio_communities/subcommunities/resources/__init__.py ...             [ 42%]
invenio_communities/subcommunities/resources/config.py ...               [ 43%]
invenio_communities/subcommunities/resources/resource.py ...             [ 43%]
invenio_communities/subcommunities/services/__init__.py ...              [ 44%]
invenio_communities/subcommunities/services/config.py ...                [ 44%]
invenio_communities/subcommunities/services/errors.py ...                [ 44%]
invenio_communities/subcommunities/services/request.py ...               [ 45%]
invenio_communities/subcommunities/services/schema.py ...                [ 45%]
invenio_communities/subcommunities/services/service.py ...               [ 46%]
invenio_communities/tasks.py ...                                         [ 46%]
invenio_communities/utils.py ...                                         [ 47%]
invenio_communities/views/__init__.py ...                                [ 47%]
invenio_communities/views/api.py ...                                     [ 47%]
invenio_communities/views/communities.py ...                             [ 48%]
invenio_communities/views/decorators.py ...                              [ 48%]
invenio_communities/views/template_loader.py ...                         [ 49%]
invenio_communities/views/ui.py ...                                      [ 49%]
invenio_communities/webpack.py ...                                       [ 50%]
setup.py ...                                                             [ 50%]
tests/__init__.py ...                                                    [ 50%]
tests/cache/__init__.py ...                                              [ 51%]
tests/cache/test_identity_redis_cache.py ......                          [ 52%]
tests/communities/__init__.py ...                                        [ 52%]
tests/communities/conftest.py ...                                        [ 52%]
tests/communities/test_alembic.py ..s                                    [ 53%]
tests/communities/test_cli.py ...
.                                       [ 53%]
tests/communities/test_community_ui_serializer.py ...
                    [ 54%]
tests/communities/test_components.py ...
.
.
.
.
.
                            [ 55%]
tests/communities/test_parent_community.py ...
::error file=package-repo/tests/communities/test_parent_community.py,line=42::test_set_parent_community_with_comm_uuid%0A%0Asqlalchemy.orm.exc.StaleDataError: Version id '3' on merged state <CommunityMetadata at 0x7fae24e1e750> does not match existing version '5'. Leave the version attribute unset when merging to update the most recent version.
F::error file=package-repo/tests/communities/test_parent_community.py,line=58::test_set_parent_community_with_comm_uuid_string%0A%0Asqlalchemy.orm.exc.StaleDataError: Version id '3' on merged state <CommunityMetadata at 0x7fae248897c0> does not match existing version '5'. Leave the version attribute unset when merging to update the most recent version.
F..::error file=package-repo/tests/communities/test_parent_community.py,line=83::test_parent_community_dereferencing%0A%0Asqlalchemy.orm.exc.StaleDataError: Version id '3' on merged state <CommunityMetadata at 0x7fae252f1ee0> does not match existing version '5'. Leave the version attribute unset when merging to update the most recent version.
FE
                     [ 56%]
tests/communities/test_permissions.py ...
                                [ 57%]
tests/communities/test_relations_organizations.py ...
.
.
.
.
.
               [ 58%]
tests/communities/test_relations_types.py ...
.
.
.
.
.                       [ 59%]
tests/communities/test_resources.py ...
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
                [ 62%]
tests/communities/test_services.py ...
.
.
.
.
.
..
.
.
.
.
.
.
.
.
.
.
.
.
.
.
              [ 65%]
tests/communities/test_subcommunities.py ...
.
.
.
.
                         [ 66%]
tests/communities/test_tombstone.py ...
.
.
....
                            [ 67%]
tests/communities/test_ui.py ...
                                         [ 68%]
tests/communities/tests_views.py ...                                     [ 68%]
tests/conftest.py ...                                                    [ 69%]
tests/members/__init__.py ...                                            [ 69%]
tests/members/conftest.py ...                                            [ 69%]
tests/members/test_members_components.py ...
.
.
.
.
                         [ 70%]
tests/members/test_members_no_groups.py ...
.
.
.
.
.
.
.
                       [ 72%]
tests/members/test_members_notifications.py ...
.
.
.
.
                      [ 73%]
tests/members/test_members_resource.py ...
.
.
.
.
.
.
.
.
.
.
.
.
.
...               [ 75%]
tests/members/test_members_services.py ...
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
..
..
.
.
.
.
.
.
.
. [ 80%]
.
.
.
.
.
.
.
.
.
..
.E
.
.
.
.
.
.
.
.
.
::error file=package-repo/tests/members/test_members_services.py,line=732::test_delete_allowed[owner-owner]%0A%0Amarshmallow.exceptions.ValidationError: A community must have at least one owner.
F
::error file=package-repo/tests/members/test_members_services.py,line=732::test_delete_allowed[owner-manager]%0A%0Amarshmallow.exceptions.ValidationError: A community must have at least one owner.
F
::error file=package-repo/tests/members/test_members_services.py,line=732::test_delete_allowed[owner-curator]%0A%0Amarshmallow.exceptions.ValidationError: A community must have at least one owner.
F
::error file=package-repo/tests/members/test_members_services.py,line=732::test_delete_allowed[owner-reader]%0A%0Amarshmallow.exceptions.ValidationError: A community must have at least one owner.
F
::error file=package-repo/tests/members/test_members_services.py,line=732::test_delete_allowed[manager-manager]%0A%0Amarshmallow.exceptions.ValidationError: A community must have at least one owner.
F
::error file=package-repo/tests/members/test_members_services.py,line=732::test_delete_allowed[manager-curator]%0A%0Amarshmallow.exceptions.ValidationError: A community must have at least one owner.
F
::error file=package-repo/tests/members/test_members_services.py,line=732::test_delete_allowed[manager-reader]%0A%0Amarshmallow.exceptions.ValidationError: A community must have at least one owner.
F
::error file=package-repo/tests/members/test_members_services.py,line=747::test_delete_member_type_group%0A%0Amarshmallow.exceptions.ValidationError: A community must have at least one owner.
F
..::error file=package-repo/tests/members/test_members_services.py,line=804::test_selfupdate_role_denied[owner]%0A%0Ainvenio_communities.members.errors.InvalidMemberError
F
.
.
.
::error file=package-repo/tests/members/test_members_services.py,line=829::test_selfupdate_allow_visibility[owner]%0A%0Ainvenio_communities.members.errors.InvalidMemberError
F
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
::error file=package-repo/tests/members/test_members_services.py,line=948::test_update_role_allowed[owner-owner-reader]%0A%0Amarshmallow.exceptions.ValidationError: A community must have at least one owner.
F
::error file=package-repo/tests/members/test_members_services.py,line=948::test_update_role_allowed[owner-manager-reader]%0A%0Amarshmallow.exceptions.ValidationError: A community must have at least one owner.
F
::error file=package-repo/tests/members/test_members_services.py,line=948::test_update_role_allowed[owner-curator-manager]%0A%0Amarshmallow.exceptions.ValidationError: A community must have at least one owner.
F
::error file=package-repo/tests/members/test_members_services.py,line=948::test_update_role_allowed[owner-reader-curator]%0A%0Amarshmallow.exceptions.ValidationError: A community must have at least one owner.
F
::error file=package-repo/tests/members/test_members_services.py,line=948::test_update_role_allowed[manager-manager-curator]%0A%0Amarshmallow.exceptions.ValidationError: A community must have at least one owner.
F
::error file=package-repo/tests/members/test_members_services.py,line=948::test_update_role_allowed[manager-curator-manager]%0A%0Amarshmallow.exceptions.ValidationError: A community must have at least one owner.
F
::error file=package-repo/tests/members/test_members_services.py,line=948::test_update_role_allowed[manager-reader-curator]%0A%0Amarshmallow.exceptions.ValidationError: A community must have at least one owner.
F
.
.
.
.
.
.
.
.
.
::error file=package-repo/tests/members/test_members_services.py,line=1014::test_update_invitation_role_allowed[owner-owner-reader]%0A%0Amarshmallow.exceptions.ValidationError: A community must have at least one owner.
F [ 90%]
::error file=package-repo/tests/members/test_members_services.py,line=1014::test_update_invitation_role_allowed[owner-manager-reader]%0A%0Amarshmallow.exceptions.ValidationError: A community must have at least one owner.
F
::error file=package-repo/tests/members/test_members_services.py,line=1014::test_update_invitation_role_allowed[owner-curator-manager]%0A%0Amarshmallow.exceptions.ValidationError: A community must have at least one owner.
F
::error file=package-repo/tests/members/test_members_services.py,line=1014::test_update_invitation_role_allowed[owner-reader-curator]%0A%0Amarshmallow.exceptions.ValidationError: A community must have at least one owner.
F
::error file=package-repo/tests/members/test_members_services.py,line=1014::test_update_invitation_role_allowed[manager-manager-curator]%0A%0Amarshmallow.exceptions.ValidationError: A community must have at least one owner.
F
::error file=package-repo/tests/members/test_members_services.py,line=1014::test_update_invitation_role_allowed[manager-curator-manager]%0A%0Amarshmallow.exceptions.ValidationError: A community must have at least one owner.
F
::error file=package-repo/tests/members/test_members_services.py,line=1014::test_update_invitation_role_allowed[manager-reader-curator]%0A%0Amarshmallow.exceptions.ValidationError: A community must have at least one owner.
F
.
.
.
.
.
.
.
.
.
.
.
.
::error file=package-repo/tests/members/test_members_services.py,line=1100::test_update_role_must_have_owner%0A%0Ainvenio_communities.members.errors.InvalidMemberError
F
..
.
                                                   [ 93%]
tests/mock_module/__init__.py ...                                        [ 93%]
tests/records/__init__.py ...                                            [ 94%]
tests/records/conftest.py ...                                            [ 94%]
tests/records/mock_module/__init__.py ...                                [ 95%]
tests/records/mock_module/api.py ...                                     [ 95%]
tests/records/mock_module/jsonschemas/__init__.py ...                    [ 96%]
tests/records/mock_module/mappings/__init__.py ...                       [ 96%]
tests/records/mock_module/mappings/v6/__init__.py ...                    [ 96%]
tests/records/mock_module/mappings/v7/__init__.py ...                    [ 97%]
tests/records/mock_module/models.py ...                                  [ 97%]
tests/records/test_mockrecords_api.py ...
.
.
.
.
.
.
.
.
.
.
                      [ 99%]
tests/test_notifications.py ...
                                          [100%]

==================================== ERRORS ====================================
___________ ERROR at teardown of test_parent_community_dereferencing ___________

database = <SQLAlchemy>

    @pytest.yield_fixture(scope="module")
    def location(database):
        """Creates a simple default location for a test.
    
        Scope: function
    
        Use this fixture if your test requires a `files location <https://invenio-
        files-rest.readthedocs.io/en/latest/api.html#invenio_files_rest.models.
        Location>`_. The location will be a default location with the name
        ``pytest-location``.
        """
        from invenio_files_rest.models import Location
    
        uri = tempfile.mkdtemp()
        location_obj = Location(name="pytest-location", uri=uri, default=True)
    
        database.session.add(location_obj)
        database.session.commit()
    
        yield location_obj
    
>       shutil.rmtree(location_obj.uri)
                      ^^^^^^^^^^^^^^^^

.venv/lib/python3.12/site-packages/pytest_invenio/fixtures.py:766: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.12/site-packages/sqlalchemy/orm/attributes.py:569: in __get__
    return self.impl.get(state, dict_)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/sqlalchemy/orm/attributes.py:1096: in get
    value = self._fire_loader_callables(state, key, passive)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/sqlalchemy/orm/attributes.py:1126: in _fire_loader_callables
    return state._load_expired(state, passive)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/sqlalchemy/orm/state.py:803: in _load_expired
    self.manager.expired_attribute_loader(self, toload, passive)
.venv/lib/python3.12/site-packages/sqlalchemy/orm/loading.py:1674: in load_scalar_attributes
    result = load_on_ident(
.venv/lib/python3.12/site-packages/sqlalchemy/orm/loading.py:510: in load_on_ident
    return load_on_pk_identity(
.venv/lib/python3.12/site-packages/sqlalchemy/orm/loading.py:695: in load_on_pk_identity
    session.execute(
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2351: in execute
    return self._execute_internal(
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2228: in _execute_internal
    ) = compile_state_cls.orm_pre_session_exec(
.venv/lib/python3.12/site-packages/sqlalchemy/orm/context.py:577: in orm_pre_session_exec
    session._autoflush()
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:3040: in _autoflush
    self.flush()
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:4331: in flush
    self._flush(objects)
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:4466: in _flush
    with util.safe_reraise():
         ^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/sqlalchemy/util/langhelpers.py:224: in __exit__
    raise exc_value.with_traceback(exc_tb)
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:4427: in _flush
    flush_context.execute()
.venv/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py:466: in execute
    rec.execute(self)
.venv/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py:642: in execute
    util.preloaded.orm_persistence.save_obj(
.venv/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py:85: in save_obj
    _emit_update_statements(
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

base_mapper = <Mapper at 0x7fae2954e2d0; CommunityMetadata>
uowtransaction = <sqlalchemy.orm.unitofwork.UOWTransaction object at 0x7fae24be5130>
mapper = <Mapper at 0x7fae2954e2d0; CommunityMetadata>
table = Table('communities_metadata', MetaData(), Column('slug', String(length=255), table=<communities_metadata>), Column('bu...s_metadata>, nullable=False, default=CallableColumnDefault(<function datetime.utcnow at 0x7fae2d48d580>)), schema=None)
update = <generator object _collect_update_commands at 0x7fae26c9af20>

    def _emit_update_statements(
        base_mapper,
        uowtransaction,
        mapper,
        table,
        update,
        *,
        bookkeeping=True,
        use_orm_update_stmt=None,
        enable_check_rowcount=True,
    ):
        """Emit UPDATE statements corresponding to value lists collected
        by _collect_update_commands()."""
    
        needs_version_id = (
            mapper.version_id_col is not None
            and mapper.version_id_col in mapper._cols_by_table[table]
        )
    
        execution_options = {"compiled_cache": base_mapper._compiled_cache}
    
        def update_stmt(existing_stmt=None):
            clauses = BooleanClauseList._construct_raw(operators.and_)
    
            for col in mapper._pks_by_table[table]:
                clauses._append_inplace(
                    col == sql.bindparam(col._label, type_=col.type)
                )
    
            if needs_version_id:
                clauses._append_inplace(
                    mapper.version_id_col
                    == sql.bindparam(
                        mapper.version_id_col._label,
                        type_=mapper.version_id_col.type,
                    )
                )
    
            if existing_stmt is not None:
                stmt = existing_stmt.where(clauses)
            else:
                stmt = table.update().where(clauses)
            return stmt
    
        if use_orm_update_stmt is not None:
            cached_stmt = update_stmt(use_orm_update_stmt)
    
        else:
            cached_stmt = base_mapper._memo(("update", table), update_stmt)
    
        for (
            (connection, paramkeys, hasvalue, has_all_defaults, has_all_pks),
            records,
        ) in groupby(
            update,
            lambda rec: (
                rec[4],  # connection
                set(rec[2]),  # set of parameter keys
                bool(rec[5]),  # whether or not we have "value" parameters
                rec[6],  # has_all_defaults
                rec[7],  # has all pks
            ),
        ):
            rows = 0
            records = list(records)
    
            statement = cached_stmt
    
            if use_orm_update_stmt is not None:
                statement = statement._annotate(
                    {
                        "_emit_update_table": table,
                        "_emit_update_mapper": mapper,
                    }
                )
    
            return_defaults = False
    
            if not has_all_pks:
                statement = statement.return_defaults(*mapper._pks_by_table[table])
                return_defaults = True
    
            if (
                bookkeeping
                and not has_all_defaults
                and mapper.base_mapper.eager_defaults is True
                # change as of #8889 - if RETURNING is not going to be used anyway,
                # (applies to MySQL, MariaDB which lack UPDATE RETURNING) ensure
                # we can do an executemany UPDATE which is more efficient
                and table.implicit_returning
                and connection.dialect.update_returning
            ):
                statement = statement.return_defaults(
                    *mapper._server_onupdate_default_cols[table]
                )
                return_defaults = True
    
            if mapper._version_id_has_server_side_value:
                statement = statement.return_defaults(mapper.version_id_col)
                return_defaults = True
    
            assert_singlerow = connection.dialect.supports_sane_rowcount
    
            assert_multirow = (
                assert_singlerow
                and connection.dialect.supports_sane_multi_rowcount
            )
    
            # change as of #8889 - if RETURNING is not going to be used anyway,
            # (applies to MySQL, MariaDB which lack UPDATE RETURNING) ensure
            # we can do an executemany UPDATE which is more efficient
            allow_executemany = not return_defaults and not needs_version_id
    
            if hasvalue:
                for (
                    state,
                    state_dict,
                    params,
                    mapper,
                    connection,
                    value_params,
                    has_all_defaults,
                    has_all_pks,
                ) in records:
                    c = connection.execute(
                        statement.values(value_params),
                        params,
                        execution_options=execution_options,
                    )
                    if bookkeeping:
                        _postfetch(
                            mapper,
                            uowtransaction,
                            table,
                            state,
                            state_dict,
                            c,
                            c.context.compiled_parameters[0],
                            value_params,
                            True,
                            c.returned_defaults,
                        )
                    rows += c.rowcount
                    check_rowcount = enable_check_rowcount and assert_singlerow
            else:
                if not allow_executemany:
                    check_rowcount = enable_check_rowcount and assert_singlerow
                    for (
                        state,
                        state_dict,
                        params,
                        mapper,
                        connection,
                        value_params,
                        has_all_defaults,
                        has_all_pks,
                    ) in records:
                        c = connection.execute(
                            statement, params, execution_options=execution_options
                        )
    
                        # TODO: why with bookkeeping=False?
                        if bookkeeping:
                            _postfetch(
                                mapper,
                                uowtransaction,
                                table,
                                state,
                                state_dict,
                                c,
                                c.context.compiled_parameters[0],
                                value_params,
                                True,
                                c.returned_defaults,
                            )
                        rows += c.rowcount
                else:
                    multiparams = [rec[2] for rec in records]
    
                    check_rowcount = enable_check_rowcount and (
                        assert_multirow
                        or (assert_singlerow and len(multiparams) == 1)
                    )
    
                    c = connection.execute(
                        statement, multiparams, execution_options=execution_options
                    )
    
                    rows += c.rowcount
    
                    for (
                        state,
                        state_dict,
                        params,
                        mapper,
                        connection,
                        value_params,
                        has_all_defaults,
                        has_all_pks,
                    ) in records:
                        if bookkeeping:
                            _postfetch(
                                mapper,
                                uowtransaction,
                                table,
                                state,
                                state_dict,
                                c,
                                c.context.compiled_parameters[0],
                                value_params,
                                True,
                                (
                                    c.returned_defaults
                                    if not c.context.executemany
                                    else None
                                ),
                            )
    
            if check_rowcount:
                if rows != len(records):
>                   raise orm_exc.StaleDataError(
                        "UPDATE statement on table '%s' expected to "
                        "update %d row(s); %d were matched."
                        % (table.description, len(records), rows)
                    )
E                   sqlalchemy.orm.exc.StaleDataError: UPDATE statement on table 'communities_metadata' expected to update 1 row(s); 0 were matched.

.venv/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py:948: StaleDataError
---------------------------- Captured stderr setup -----------------------------
MS PATCH Storing database values
Storing database values
Storing database values done
MS PATCH Stored
--------------------------- Captured stderr teardown ---------------------------
MS PATCH Rollback and original connection close
MS PATCH Purging database changes
Purging database values
Purging database values done
MS PATCH Purged and closed
________________ ERROR at teardown of test_leave_owner_allowed _________________

database = <SQLAlchemy postgresql+psycopg2://invenio:***@localhost:5432/invenio>
db_session_options = {}

    @pytest.fixture(scope="function")
    def db(database, db_session_options):
        """Creates a new database session for a test.
    
        Scope: function
    
        You must use this fixture if your test connects to the database. The
        fixture will set a save point and rollback all changes performed during
        the test (this is much faster than recreating the entire database).
        """
        from flask_sqlalchemy.session import Session as FlaskSQLAlchemySession
    
        from pytest_invenio.database_tools import (
            purge_database_values,
            store_database_values,
        )
    
        class PytestInvenioSession(FlaskSQLAlchemySession):
            def get_bind(self, mapper=None, clause=None, bind=None, **kwargs):
                if self.bind:
                    return self.bind
                return super().get_bind(mapper=mapper, clause=clause, bind=bind, **kwargs)
    
            def rollback(self) -> None:
                if self._transaction is None:
                    pass
                else:
                    self._transaction.rollback(_to_root=False)
    
        # the session.rollback() does not always clean everything, if the test
        # used db.session.commit() and has not cleaned up after itself. We can not
        # use nested transactions because a lot of Invenio code would need to be updated
        # so that it is aware of the nested transaction concept. Instead, we store
        # the database values here and purge any new rows after the test.
        #
        # We do it in explicit connection to avoid issues in tests that drop all tables
        # (causes deadlock in alembic tests of invenio-pages on github actions, not
        # reproducible locally).
        print("MS PATCH Storing database values", file=sys.stderr, flush=True)
        with database.engine.connect() as connection:
            with connection.begin():
                stored_values = store_database_values(database.engine, connection)
        print("MS PATCH Stored", file=sys.stderr, flush=True)
    
        with database.engine.connect() as connection:
            with connection.begin():
    
                options = dict(
                    bind=connection,
                    binds={},
                    **db_session_options,
                    class_=PytestInvenioSession,
                )
    
                session = database._make_scoped_session(options=options)
    
                old_session = database.session
                database.session = session
    
                yield database
    
                print(
                    "MS PATCH Rollback and original connection close",
                    file=sys.stderr,
                    flush=True,
                )
                session.rollback()
                database.session = old_session
    
        print("MS PATCH Purging database changes", file=sys.stderr, flush=True)
        # use a brand new connection for the purge operation
        with database.engine.connect() as connection:
>           purge_database_values(database.engine, connection, stored_values)

.venv/lib/python3.12/site-packages/pytest_invenio/fixtures.py:614: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

engine = Engine(postgresql+psycopg2://invenio:***@localhost:5432/invenio)
conn = <sqlalchemy.engine.base.Connection object at 0x7fae13cc4560>
stored_values = {'access_actionsroles': [], 'access_actionssystemroles': [], 'access_actionsusers': [], 'accounts_domain_category': [], ...}

    def purge_database_values(engine, conn, stored_values):
        """Delete rows that are not in the stored values."""
    
        print("Purging database values", file=sys.stderr, flush=True)
        metadata = MetaData()
        metadata.reflect(engine)
    
        # Build a list of (table_name, delete_condition) tuples
        to_be_deleted = []
    
        for table_name, table in metadata.tables.items():
            stored_rows = stored_values.get(table_name, [])
    
            # Get primary key columns and foreign key columns
            pk_columns = [
                column
                for column in table.columns
                if column.primary_key or len(column.foreign_keys) > 0
            ]
    
            if not pk_columns:
                logger.warning(f"Table {table_name} has no primary key. Skipping.")
                continue
    
            # Convert stored rows to a set of primary key tuples for fast lookup
            stored_pk_set = set(stored_rows)
    
            # create a select statement that would include only rows that are not present
            # in the stored values. It will be not (pk1 == val1 and pk2 == val2 and ...) and not (...)
            row_matcher_conditions = []
            for stored_pk in stored_pk_set:
                # Cast columns to string at database level for comparison
                condition = and_(
                    *(
                        func.cast(pk_col, String) == pk_val
                        for pk_col, pk_val in zip(pk_columns, stored_pk)
                    )
                )
                # negate the condition to match rows that are not equal
                row_matcher_conditions.append(~condition)
    
            if row_matcher_conditions:
                non_matching_condition = and_(*row_matcher_conditions)
                to_be_deleted.append(
                    (table_name, table, non_matching_condition, len(stored_pk_set))
                )
            else:
                # delete everything
                to_be_deleted.append((table_name, table, None, len(stored_pk_set)))
    
        # Try to delete rows with retry mechanism for foreign key constraints
        while to_be_deleted:
            failed_deletions = []
    
            for table_name, table, where_condition, expected_count in to_be_deleted:
                # Execute deletion in a transaction so that we can rollback on failure
                with conn.begin():
                    try:
                        delete_stmt = table.delete()
                        if where_condition is not None:
                            delete_stmt = delete_stmt.where(where_condition)
    
                        conn.execute(delete_stmt)
    
                        existing_count = conn.execute(
                            select(func.count()).select_from(table)
                        ).scalar()
                        conn.commit()
                        if existing_count != expected_count:
                            logger.warning(
                                "Not all rows deleted as expected, will try again."
                            )
                            failed_deletions.append(
                                (table_name, table, where_condition, expected_count)
                            )
                    except Exception:
                        # Rollback on failure and retry in next iteration
                        conn.rollback()
                        failed_deletions.append(
                            (table_name, table, where_condition, expected_count)
                        )
    
            if len(failed_deletions) == len(to_be_deleted):
                table_names = [table_name for table_name, _, _, _ in failed_deletions]
>               raise RuntimeError(
                    f"Could not delete any rows in this iteration due to foreign key cycles in tables: {table_names}"
                )
E               RuntimeError: Could not delete any rows in this iteration due to foreign key cycles in tables: ['communities_members']

.venv/lib/python3.12/site-packages/pytest_invenio/database_tools.py:129: RuntimeError
---------------------------- Captured stderr setup -----------------------------
MS PATCH Storing database values
Storing database values
Storing database values done
MS PATCH Stored
--------------------------- Captured stderr teardown ---------------------------
MS PATCH Rollback and original connection close
MS PATCH Purging database changes
Purging database values
---------------------------- Captured log teardown -----------------------------
WARNING  pytest_invenio.database_tools:database_tools.py:114 Not all rows deleted as expected, will try again.
WARNING  pytest_invenio.database_tools:database_tools.py:114 Not all rows deleted as expected, will try again.
=================================== FAILURES ===================================
___________________ test_set_parent_community_with_comm_uuid ___________________

parent_community = {'$schema': 'local://communities/communities-v1.0.0.json', 'files': {'enabled': True}, 'metadata': {'title': 'My Commu...members_visibility': 'public', 'member_policy': 'open', 'record_submission_policy': 'open', 'review_policy': 'closed'}}
child_community = {'$schema': 'local://communities/communities-v1.0.0.json', 'files': {'enabled': True}, 'metadata': {'title': 'My Commu...ecord_submission_policy': 'open', 'review_policy': 'closed'}, 'parent': {'id': '763641c6-e231-4c45-9633-710a30c4322a'}}
db = <SQLAlchemy postgresql+psycopg2://invenio:***@localhost:5432/invenio>

    def test_set_parent_community_with_comm_uuid(parent_community, child_community, db):
        child_community.parent = parent_community.id
    
        assert child_community.parent == parent_community
    
>       child_community.commit()

tests/communities/test_parent_community.py:42: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.12/site-packages/invenio_records/api.py:461: in commit
    db.session.merge(self.model)
.venv/lib/python3.12/site-packages/sqlalchemy/orm/scoping.py:1553: in merge
    return self._proxied.merge(instance, load=load, options=options)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:3945: in merge
    return self._merge(
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <sqlalchemy.orm.session.PytestInvenioSession object at 0x7fae252f35f0>
state = <sqlalchemy.orm.state.InstanceState object at 0x7fae2544b5f0>
state_dict = {'_sa_instance_state': <sqlalchemy.orm.state.InstanceState object at 0x7fae2544b5f0>, 'bucket_id': UUID('f52e9593-bc25...tetime.datetime(2025, 11, 19, 17, 2, 10, 244813), 'deletion_status': <CommunityDeletionStatusEnum.PUBLISHED: 'P'>, ...}

    def _merge(
        self,
        state: InstanceState[_O],
        state_dict: _InstanceDict,
        *,
        options: Optional[Sequence[ORMOption]] = None,
        load: bool,
        _recursive: Dict[Any, object],
        _resolve_conflict_map: Dict[_IdentityKeyType[Any], object],
    ) -> _O:
        mapper: Mapper[_O] = _state_mapper(state)
        if state in _recursive:
            return cast(_O, _recursive[state])
    
        new_instance = False
        key = state.key
    
        merged: Optional[_O]
    
        if key is None:
            if state in self._new:
                util.warn(
                    "Instance %s is already pending in this Session yet is "
                    "being merged again; this is probably not what you want "
                    "to do" % state_str(state)
                )
    
            if not load:
                raise sa_exc.InvalidRequestError(
                    "merge() with load=False option does not support "
                    "objects transient (i.e. unpersisted) objects.  flush() "
                    "all changes on mapped instances before merging with "
                    "load=False."
                )
            key = mapper._identity_key_from_state(state)
            key_is_persistent = LoaderCallableStatus.NEVER_SET not in key[
                1
            ] and (
                not _none_set.intersection(key[1])
                or (
                    mapper.allow_partial_pks
                    and not _none_set.issuperset(key[1])
                )
            )
        else:
            key_is_persistent = True
    
        merged = self.identity_map.get(key)
    
        if merged is None:
            if key_is_persistent and key in _resolve_conflict_map:
                merged = cast(_O, _resolve_conflict_map[key])
    
            elif not load:
                if state.modified:
                    raise sa_exc.InvalidRequestError(
                        "merge() with load=False option does not support "
                        "objects marked as 'dirty'.  flush() all changes on "
                        "mapped instances before merging with load=False."
                    )
                merged = mapper.class_manager.new_instance()
                merged_state = attributes.instance_state(merged)
                merged_state.key = key
                self._update_impl(merged_state)
                new_instance = True
    
            elif key_is_persistent:
                merged = self.get(
                    mapper.class_,
                    key[1],
                    identity_token=key[2],
                    options=options,
                )
    
        if merged is None:
            merged = mapper.class_manager.new_instance()
            merged_state = attributes.instance_state(merged)
            merged_dict = attributes.instance_dict(merged)
            new_instance = True
            self._save_or_update_state(merged_state)
        else:
            merged_state = attributes.instance_state(merged)
            merged_dict = attributes.instance_dict(merged)
    
        _recursive[state] = merged
        _resolve_conflict_map[key] = merged
    
        # check that we didn't just pull the exact same
        # state out.
        if state is not merged_state:
            # version check if applicable
            if mapper.version_id_col is not None:
                existing_version = mapper._get_state_attr_by_column(
                    state,
                    state_dict,
                    mapper.version_id_col,
                    passive=PassiveFlag.PASSIVE_NO_INITIALIZE,
                )
    
                merged_version = mapper._get_state_attr_by_column(
                    merged_state,
                    merged_dict,
                    mapper.version_id_col,
                    passive=PassiveFlag.PASSIVE_NO_INITIALIZE,
                )
    
                if (
                    existing_version
                    is not LoaderCallableStatus.PASSIVE_NO_RESULT
                    and merged_version
                    is not LoaderCallableStatus.PASSIVE_NO_RESULT
                    and existing_version != merged_version
                ):
>                   raise exc.StaleDataError(
                        "Version id '%s' on merged state %s "
                        "does not match existing version '%s'. "
                        "Leave the version attribute unset when "
                        "merging to update the most recent version."
                        % (
                            existing_version,
                            state_str(merged_state),
                            merged_version,
                        )
                    )
E                   sqlalchemy.orm.exc.StaleDataError: Version id '3' on merged state <CommunityMetadata at 0x7fae24e1e750> does not match existing version '5'. Leave the version attribute unset when merging to update the most recent version.

.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:4069: StaleDataError
---------------------------- Captured stderr setup -----------------------------
MS PATCH Storing database values
Storing database values
Storing database values done
MS PATCH Stored
--------------------------- Captured stderr teardown ---------------------------
MS PATCH Rollback and original connection close
MS PATCH Purging database changes
Purging database values
Purging database values done
MS PATCH Purged and closed
_______________ test_set_parent_community_with_comm_uuid_string ________________

parent_community = {'$schema': 'local://communities/communities-v1.0.0.json', 'files': {'enabled': True}, 'metadata': {'title': 'My Commu...members_visibility': 'public', 'member_policy': 'open', 'record_submission_policy': 'open', 'review_policy': 'closed'}}
child_community = {'$schema': 'local://communities/communities-v1.0.0.json', 'files': {'enabled': True}, 'metadata': {'title': 'My Commu...ecord_submission_policy': 'open', 'review_policy': 'closed'}, 'parent': {'id': '763641c6-e231-4c45-9633-710a30c4322a'}}
db = <SQLAlchemy postgresql+psycopg2://invenio:***@localhost:5432/invenio>

    def test_set_parent_community_with_comm_uuid_string(
        parent_community, child_community, db
    ):
        child_community.parent = str(parent_community.id)
    
        assert child_community.parent == parent_community
    
>       child_community.commit()

tests/communities/test_parent_community.py:58: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.12/site-packages/invenio_records/api.py:461: in commit
    db.session.merge(self.model)
.venv/lib/python3.12/site-packages/sqlalchemy/orm/scoping.py:1553: in merge
    return self._proxied.merge(instance, load=load, options=options)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:3945: in merge
    return self._merge(
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <sqlalchemy.orm.session.PytestInvenioSession object at 0x7fae248884a0>
state = <sqlalchemy.orm.state.InstanceState object at 0x7fae2544b5f0>
state_dict = {'_sa_instance_state': <sqlalchemy.orm.state.InstanceState object at 0x7fae2544b5f0>, 'bucket_id': UUID('f52e9593-bc25...tetime.datetime(2025, 11, 19, 17, 2, 10, 244813), 'deletion_status': <CommunityDeletionStatusEnum.PUBLISHED: 'P'>, ...}

    def _merge(
        self,
        state: InstanceState[_O],
        state_dict: _InstanceDict,
        *,
        options: Optional[Sequence[ORMOption]] = None,
        load: bool,
        _recursive: Dict[Any, object],
        _resolve_conflict_map: Dict[_IdentityKeyType[Any], object],
    ) -> _O:
        mapper: Mapper[_O] = _state_mapper(state)
        if state in _recursive:
            return cast(_O, _recursive[state])
    
        new_instance = False
        key = state.key
    
        merged: Optional[_O]
    
        if key is None:
            if state in self._new:
                util.warn(
                    "Instance %s is already pending in this Session yet is "
                    "being merged again; this is probably not what you want "
                    "to do" % state_str(state)
                )
    
            if not load:
                raise sa_exc.InvalidRequestError(
                    "merge() with load=False option does not support "
                    "objects transient (i.e. unpersisted) objects.  flush() "
                    "all changes on mapped instances before merging with "
                    "load=False."
                )
            key = mapper._identity_key_from_state(state)
            key_is_persistent = LoaderCallableStatus.NEVER_SET not in key[
                1
            ] and (
                not _none_set.intersection(key[1])
                or (
                    mapper.allow_partial_pks
                    and not _none_set.issuperset(key[1])
                )
            )
        else:
            key_is_persistent = True
    
        merged = self.identity_map.get(key)
    
        if merged is None:
            if key_is_persistent and key in _resolve_conflict_map:
                merged = cast(_O, _resolve_conflict_map[key])
    
            elif not load:
                if state.modified:
                    raise sa_exc.InvalidRequestError(
                        "merge() with load=False option does not support "
                        "objects marked as 'dirty'.  flush() all changes on "
                        "mapped instances before merging with load=False."
                    )
                merged = mapper.class_manager.new_instance()
                merged_state = attributes.instance_state(merged)
                merged_state.key = key
                self._update_impl(merged_state)
                new_instance = True
    
            elif key_is_persistent:
                merged = self.get(
                    mapper.class_,
                    key[1],
                    identity_token=key[2],
                    options=options,
                )
    
        if merged is None:
            merged = mapper.class_manager.new_instance()
            merged_state = attributes.instance_state(merged)
            merged_dict = attributes.instance_dict(merged)
            new_instance = True
            self._save_or_update_state(merged_state)
        else:
            merged_state = attributes.instance_state(merged)
            merged_dict = attributes.instance_dict(merged)
    
        _recursive[state] = merged
        _resolve_conflict_map[key] = merged
    
        # check that we didn't just pull the exact same
        # state out.
        if state is not merged_state:
            # version check if applicable
            if mapper.version_id_col is not None:
                existing_version = mapper._get_state_attr_by_column(
                    state,
                    state_dict,
                    mapper.version_id_col,
                    passive=PassiveFlag.PASSIVE_NO_INITIALIZE,
                )
    
                merged_version = mapper._get_state_attr_by_column(
                    merged_state,
                    merged_dict,
                    mapper.version_id_col,
                    passive=PassiveFlag.PASSIVE_NO_INITIALIZE,
                )
    
                if (
                    existing_version
                    is not LoaderCallableStatus.PASSIVE_NO_RESULT
                    and merged_version
                    is not LoaderCallableStatus.PASSIVE_NO_RESULT
                    and existing_version != merged_version
                ):
>                   raise exc.StaleDataError(
                        "Version id '%s' on merged state %s "
                        "does not match existing version '%s'. "
                        "Leave the version attribute unset when "
                        "merging to update the most recent version."
                        % (
                            existing_version,
                            state_str(merged_state),
                            merged_version,
                        )
                    )
E                   sqlalchemy.orm.exc.StaleDataError: Version id '3' on merged state <CommunityMetadata at 0x7fae248897c0> does not match existing version '5'. Leave the version attribute unset when merging to update the most recent version.

.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:4069: StaleDataError
---------------------------- Captured stderr setup -----------------------------
MS PATCH Storing database values
Storing database values
Storing database values done
MS PATCH Stored
--------------------------- Captured stderr teardown ---------------------------
MS PATCH Rollback and original connection close
MS PATCH Purging database changes
Purging database values
Purging database values done
MS PATCH Purged and closed
_____________________ test_parent_community_dereferencing ______________________

community_service = <invenio_communities.communities.services.service.CommunityService object at 0x7fae25abf380>
parent_community = {'$schema': 'local://communities/communities-v1.0.0.json', 'files': {'enabled': True}, 'metadata': {'title': 'My Commu...members_visibility': 'public', 'member_policy': 'open', 'record_submission_policy': 'open', 'review_policy': 'closed'}}
child_community = {'$schema': 'local://communities/communities-v1.0.0.json', 'files': {'enabled': True}, 'metadata': {'title': 'My Commu...ecord_submission_policy': 'open', 'review_policy': 'closed'}, 'parent': {'id': '763641c6-e231-4c45-9633-710a30c4322a'}}
db = <SQLAlchemy postgresql+psycopg2://invenio:***@localhost:5432/invenio>

    def test_parent_community_dereferencing(
        community_service, parent_community, child_community, db
    ):
        child_community.parent = parent_community
    
        assert child_community.parent == parent_community
    
>       child_community.commit()

tests/communities/test_parent_community.py:83: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.12/site-packages/invenio_records/api.py:461: in commit
    db.session.merge(self.model)
.venv/lib/python3.12/site-packages/sqlalchemy/orm/scoping.py:1553: in merge
    return self._proxied.merge(instance, load=load, options=options)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:3945: in merge
    return self._merge(
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <sqlalchemy.orm.session.PytestInvenioSession object at 0x7fae248895b0>
state = <sqlalchemy.orm.state.InstanceState object at 0x7fae2544b5f0>
state_dict = {'_sa_instance_state': <sqlalchemy.orm.state.InstanceState object at 0x7fae2544b5f0>, 'bucket_id': UUID('f52e9593-bc25...tetime.datetime(2025, 11, 19, 17, 2, 10, 244813), 'deletion_status': <CommunityDeletionStatusEnum.PUBLISHED: 'P'>, ...}

    def _merge(
        self,
        state: InstanceState[_O],
        state_dict: _InstanceDict,
        *,
        options: Optional[Sequence[ORMOption]] = None,
        load: bool,
        _recursive: Dict[Any, object],
        _resolve_conflict_map: Dict[_IdentityKeyType[Any], object],
    ) -> _O:
        mapper: Mapper[_O] = _state_mapper(state)
        if state in _recursive:
            return cast(_O, _recursive[state])
    
        new_instance = False
        key = state.key
    
        merged: Optional[_O]
    
        if key is None:
            if state in self._new:
                util.warn(
                    "Instance %s is already pending in this Session yet is "
                    "being merged again; this is probably not what you want "
                    "to do" % state_str(state)
                )
    
            if not load:
                raise sa_exc.InvalidRequestError(
                    "merge() with load=False option does not support "
                    "objects transient (i.e. unpersisted) objects.  flush() "
                    "all changes on mapped instances before merging with "
                    "load=False."
                )
            key = mapper._identity_key_from_state(state)
            key_is_persistent = LoaderCallableStatus.NEVER_SET not in key[
                1
            ] and (
                not _none_set.intersection(key[1])
                or (
                    mapper.allow_partial_pks
                    and not _none_set.issuperset(key[1])
                )
            )
        else:
            key_is_persistent = True
    
        merged = self.identity_map.get(key)
    
        if merged is None:
            if key_is_persistent and key in _resolve_conflict_map:
                merged = cast(_O, _resolve_conflict_map[key])
    
            elif not load:
                if state.modified:
                    raise sa_exc.InvalidRequestError(
                        "merge() with load=False option does not support "
                        "objects marked as 'dirty'.  flush() all changes on "
                        "mapped instances before merging with load=False."
                    )
                merged = mapper.class_manager.new_instance()
                merged_state = attributes.instance_state(merged)
                merged_state.key = key
                self._update_impl(merged_state)
                new_instance = True
    
            elif key_is_persistent:
                merged = self.get(
                    mapper.class_,
                    key[1],
                    identity_token=key[2],
                    options=options,
                )
    
        if merged is None:
            merged = mapper.class_manager.new_instance()
            merged_state = attributes.instance_state(merged)
            merged_dict = attributes.instance_dict(merged)
            new_instance = True
            self._save_or_update_state(merged_state)
        else:
            merged_state = attributes.instance_state(merged)
            merged_dict = attributes.instance_dict(merged)
    
        _recursive[state] = merged
        _resolve_conflict_map[key] = merged
    
        # check that we didn't just pull the exact same
        # state out.
        if state is not merged_state:
            # version check if applicable
            if mapper.version_id_col is not None:
                existing_version = mapper._get_state_attr_by_column(
                    state,
                    state_dict,
                    mapper.version_id_col,
                    passive=PassiveFlag.PASSIVE_NO_INITIALIZE,
                )
    
                merged_version = mapper._get_state_attr_by_column(
                    merged_state,
                    merged_dict,
                    mapper.version_id_col,
                    passive=PassiveFlag.PASSIVE_NO_INITIALIZE,
                )
    
                if (
                    existing_version
                    is not LoaderCallableStatus.PASSIVE_NO_RESULT
                    and merged_version
                    is not LoaderCallableStatus.PASSIVE_NO_RESULT
                    and existing_version != merged_version
                ):
>                   raise exc.StaleDataError(
                        "Version id '%s' on merged state %s "
                        "does not match existing version '%s'. "
                        "Leave the version attribute unset when "
                        "merging to update the most recent version."
                        % (
                            existing_version,
                            state_str(merged_state),
                            merged_version,
                        )
                    )
E                   sqlalchemy.orm.exc.StaleDataError: Version id '3' on merged state <CommunityMetadata at 0x7fae252f1ee0> does not match existing version '5'. Leave the version attribute unset when merging to update the most recent version.

.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:4069: StaleDataError
---------------------------- Captured stderr setup -----------------------------
MS PATCH Storing database values
Storing database values
Storing database values done
MS PATCH Stored
_______________________ test_delete_allowed[owner-owner] _______________________

member_service = <invenio_communities.members.services.service.MemberService object at 0x7fae14f79bb0>
community = <invenio_communities.communities.services.results.CommunityItem object at 0x7fae14a39d00>
members = {'curator': <pytest_invenio.user.UserFixtureBase object at 0x7fae18d7aa50>, 'manager': <pytest_invenio.user.UserFixtur...er.UserFixtureBase object at 0x7fae163c3b90>, 'reader': <pytest_invenio.user.UserFixtureBase object at 0x7fae14b6cc80>}
actor = 'owner', role = 'owner'
new_user = <pytest_invenio.user.UserFixtureBase object at 0x7fae162fa750>
db = <SQLAlchemy postgresql+psycopg2://invenio:***@localhost:5432/invenio>

    @pytest.mark.parametrize(
        "actor,role",
        [
            ("owner", "owner"),
            ("owner", "manager"),
            ("owner", "curator"),
            ("owner", "reader"),
            ("manager", "manager"),
            ("manager", "curator"),
            ("manager", "reader"),
        ],
    )
    def test_delete_allowed(member_service, community, members, actor, role, new_user, db):
        """Test that the given roles CAN be removed by the actor."""
        # Add a new user with role
        data = {
            "members": [{"type": "user", "id": str(new_user.id)}],
            "role": role,
        }
        member_service.add(system_identity, community._record.id, data)
        # Delete the member again as the actor
        data = {
            "members": [{"type": "user", "id": str(new_user.id)}],
        }
>       member_service.delete(members[actor].identity, community._record.id, data)

tests/members/test_members_services.py:732: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.12/site-packages/invenio_db/uow.py:251: in inner
    res = f(self, *args, **kwargs)
          ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <invenio_communities.members.services.service.MemberService object at 0x7fae14f79bb0>
identity = <Identity id="1" auth_type="None" provides={Need(method='community', value='8ceb5c91-08e0-4a44-9c61-faf4dbfbfd2b', rol...r'), Need(method='community', value='363c723c-cda8-42be-b7ae-8f23325572ea', role='owner'), Need(method='id', value=1)}>
community_id = UUID('8ceb5c91-08e0-4a44-9c61-faf4dbfbfd2b')
data = {'members': [{'id': '5', 'type': 'user'}]}
uow = <invenio_db.uow.UnitOfWork object at 0x7fae13666ba0>

    @unit_of_work()
    def delete(self, identity, community_id, data, uow=None):
        """Bulk delete."""
        community = self.community_cls.get_record(community_id)
    
        # Permission check - validates that:
        # - identity has permission to delete any member at all (incl self)
        self.require_permission(
            identity,
            "members_bulk_delete",
            record=community,
        )
    
        # Validate data (if there are errors, .load() raises)
        data, errors = self.delete_schema.load(
            data,
            context={"identity": identity},
        )
        members = self.record_cls.get_members(community.id, members=data["members"])
        if len(members) != len(data["members"]):
            raise InvalidMemberError()
    
        # Perform deletes (and check permissions)
        for m in members:
            self.require_permission(
                identity,
                "members_delete",
                record=community,
                member=m,
            )
            # Run components
            self.run_components(
                "members_delete",
                identity,
                record=m,
                community=community,
                errors=None,
                uow=uow,
            )
            uow.register(RecordDeleteOp(m, self.indexer, force=True))
    
        # Make sure we're not left owner-less
        if not self.record_cls.has_members(
            community_id, role=current_roles.owner_role.name
        ):
>           raise ValidationError(
                _("A community must have at least one owner."),
            )
E           marshmallow.exceptions.ValidationError: A community must have at least one owner.

invenio_communities/members/services/service.py:661: ValidationError
---------------------------- Captured stderr setup -----------------------------
MS PATCH Storing database values
Storing database values
Storing database values done
MS PATCH Stored
--------------------------- Captured stderr teardown ---------------------------
MS PATCH Rollback and original connection close
MS PATCH Purging database changes
Purging database values
Purging database values done
MS PATCH Purged and closed
______________________ test_delete_allowed[owner-manager] ______________________

member_service = <invenio_communities.members.services.service.MemberService object at 0x7fae14f79bb0>
community = <invenio_communities.communities.services.results.CommunityItem object at 0x7fae14a39d00>
members = {'curator': <pytest_invenio.user.UserFixtureBase object at 0x7fae18d7aa50>, 'manager': <pytest_invenio.user.UserFixtur...er.UserFixtureBase object at 0x7fae163c3b90>, 'reader': <pytest_invenio.user.UserFixtureBase object at 0x7fae14b6cc80>}
actor = 'owner', role = 'manager'
new_user = <pytest_invenio.user.UserFixtureBase object at 0x7fae162fa750>
db = <SQLAlchemy postgresql+psycopg2://invenio:***@localhost:5432/invenio>

    @pytest.mark.parametrize(
        "actor,role",
        [
            ("owner", "owner"),
            ("owner", "manager"),
            ("owner", "curator"),
            ("owner", "reader"),
            ("manager", "manager"),
            ("manager", "curator"),
            ("manager", "reader"),
        ],
    )
    def test_delete_allowed(member_service, community, members, actor, role, new_user, db):
        """Test that the given roles CAN be removed by the actor."""
        # Add a new user with role
        data = {
            "members": [{"type": "user", "id": str(new_user.id)}],
            "role": role,
        }
        member_service.add(system_identity, community._record.id, data)
        # Delete the member again as the actor
        data = {
            "members": [{"type": "user", "id": str(new_user.id)}],
        }
>       member_service.delete(members[actor].identity, community._record.id, data)

tests/members/test_members_services.py:732: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.12/site-packages/invenio_db/uow.py:251: in inner
    res = f(self, *args, **kwargs)
          ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <invenio_communities.members.services.service.MemberService object at 0x7fae14f79bb0>
identity = <Identity id="1" auth_type="None" provides={Need(method='community', value='8ceb5c91-08e0-4a44-9c61-faf4dbfbfd2b', rol...r'), Need(method='community', value='363c723c-cda8-42be-b7ae-8f23325572ea', role='owner'), Need(method='id', value=1)}>
community_id = UUID('8ceb5c91-08e0-4a44-9c61-faf4dbfbfd2b')
data = {'members': [{'id': '5', 'type': 'user'}]}
uow = <invenio_db.uow.UnitOfWork object at 0x7fae168786e0>

    @unit_of_work()
    def delete(self, identity, community_id, data, uow=None):
        """Bulk delete."""
        community = self.community_cls.get_record(community_id)
    
        # Permission check - validates that:
        # - identity has permission to delete any member at all (incl self)
        self.require_permission(
            identity,
            "members_bulk_delete",
            record=community,
        )
    
        # Validate data (if there are errors, .load() raises)
        data, errors = self.delete_schema.load(
            data,
            context={"identity": identity},
        )
        members = self.record_cls.get_members(community.id, members=data["members"])
        if len(members) != len(data["members"]):
            raise InvalidMemberError()
    
        # Perform deletes (and check permissions)
        for m in members:
            self.require_permission(
                identity,
                "members_delete",
                record=community,
                member=m,
            )
            # Run components
            self.run_components(
                "members_delete",
                identity,
                record=m,
                community=community,
                errors=None,
                uow=uow,
            )
            uow.register(RecordDeleteOp(m, self.indexer, force=True))
    
        # Make sure we're not left owner-less
        if not self.record_cls.has_members(
            community_id, role=current_roles.owner_role.name
        ):
>           raise ValidationError(
                _("A community must have at least one owner."),
            )
E           marshmallow.exceptions.ValidationError: A community must have at least one owner.

invenio_communities/members/services/service.py:661: ValidationError
---------------------------- Captured stderr setup -----------------------------
MS PATCH Storing database values
Storing database values
Storing database values done
MS PATCH Stored
--------------------------- Captured stderr teardown ---------------------------
MS PATCH Rollback and original connection close
MS PATCH Purging database changes
Purging database values
Purging database values done
MS PATCH Purged and closed
______________________ test_delete_allowed[owner-curator] ______________________

member_service = <invenio_communities.members.services.service.MemberService object at 0x7fae14f79bb0>
community = <invenio_communities.communities.services.results.CommunityItem object at 0x7fae14a39d00>
members = {'curator': <pytest_invenio.user.UserFixtureBase object at 0x7fae18d7aa50>, 'manager': <pytest_invenio.user.UserFixtur...er.UserFixtureBase object at 0x7fae163c3b90>, 'reader': <pytest_invenio.user.UserFixtureBase object at 0x7fae14b6cc80>}
actor = 'owner', role = 'curator'
new_user = <pytest_invenio.user.UserFixtureBase object at 0x7fae162fa750>
db = <SQLAlchemy postgresql+psycopg2://invenio:***@localhost:5432/invenio>

    @pytest.mark.parametrize(
        "actor,role",
        [
            ("owner", "owner"),
            ("owner", "manager"),
            ("owner", "curator"),
            ("owner", "reader"),
            ("manager", "manager"),
            ("manager", "curator"),
            ("manager", "reader"),
        ],
    )
    def test_delete_allowed(member_service, community, members, actor, role, new_user, db):
        """Test that the given roles CAN be removed by the actor."""
        # Add a new user with role
        data = {
            "members": [{"type": "user", "id": str(new_user.id)}],
            "role": role,
        }
        member_service.add(system_identity, community._record.id, data)
        # Delete the member again as the actor
        data = {
            "members": [{"type": "user", "id": str(new_user.id)}],
        }
>       member_service.delete(members[actor].identity, community._record.id, data)

tests/members/test_members_services.py:732: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.12/site-packages/invenio_db/uow.py:251: in inner
    res = f(self, *args, **kwargs)
          ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <invenio_communities.members.services.service.MemberService object at 0x7fae14f79bb0>
identity = <Identity id="1" auth_type="None" provides={Need(method='community', value='8ceb5c91-08e0-4a44-9c61-faf4dbfbfd2b', rol...r'), Need(method='community', value='363c723c-cda8-42be-b7ae-8f23325572ea', role='owner'), Need(method='id', value=1)}>
community_id = UUID('8ceb5c91-08e0-4a44-9c61-faf4dbfbfd2b')
data = {'members': [{'id': '5', 'type': 'user'}]}
uow = <invenio_db.uow.UnitOfWork object at 0x7fae1687bef0>

    @unit_of_work()
    def delete(self, identity, community_id, data, uow=None):
        """Bulk delete."""
        community = self.community_cls.get_record(community_id)
    
        # Permission check - validates that:
        # - identity has permission to delete any member at all (incl self)
        self.require_permission(
            identity,
            "members_bulk_delete",
            record=community,
        )
    
        # Validate data (if there are errors, .load() raises)
        data, errors = self.delete_schema.load(
            data,
            context={"identity": identity},
        )
        members = self.record_cls.get_members(community.id, members=data["members"])
        if len(members) != len(data["members"]):
            raise InvalidMemberError()
    
        # Perform deletes (and check permissions)
        for m in members:
            self.require_permission(
                identity,
                "members_delete",
                record=community,
                member=m,
            )
            # Run components
            self.run_components(
                "members_delete",
                identity,
                record=m,
                community=community,
                errors=None,
                uow=uow,
            )
            uow.register(RecordDeleteOp(m, self.indexer, force=True))
    
        # Make sure we're not left owner-less
        if not self.record_cls.has_members(
            community_id, role=current_roles.owner_role.name
        ):
>           raise ValidationError(
                _("A community must have at least one owner."),
            )
E           marshmallow.exceptions.ValidationError: A community must have at least one owner.

invenio_communities/members/services/service.py:661: ValidationError
---------------------------- Captured stderr setup -----------------------------
MS PATCH Storing database values
Storing database values
Storing database values done
MS PATCH Stored
--------------------------- Captured stderr teardown ---------------------------
MS PATCH Rollback and original connection close
MS PATCH Purging database changes
Purging database values
Purging database values done
MS PATCH Purged and closed
______________________ test_delete_allowed[owner-reader] _______________________

member_service = <invenio_communities.members.services.service.MemberService object at 0x7fae14f79bb0>
community = <invenio_communities.communities.services.results.CommunityItem object at 0x7fae14a39d00>
members = {'curator': <pytest_invenio.user.UserFixtureBase object at 0x7fae18d7aa50>, 'manager': <pytest_invenio.user.UserFixtur...er.UserFixtureBase object at 0x7fae163c3b90>, 'reader': <pytest_invenio.user.UserFixtureBase object at 0x7fae14b6cc80>}
actor = 'owner', role = 'reader'
new_user = <pytest_invenio.user.UserFixtureBase object at 0x7fae162fa750>
db = <SQLAlchemy postgresql+psycopg2://invenio:***@localhost:5432/invenio>

    @pytest.mark.parametrize(
        "actor,role",
        [
            ("owner", "owner"),
            ("owner", "manager"),
            ("owner", "curator"),
            ("owner", "reader"),
            ("manager", "manager"),
            ("manager", "curator"),
            ("manager", "reader"),
        ],
    )
    def test_delete_allowed(member_service, community, members, actor, role, new_user, db):
        """Test that the given roles CAN be removed by the actor."""
        # Add a new user with role
        data = {
            "members": [{"type": "user", "id": str(new_user.id)}],
            "role": role,
        }
        member_service.add(system_identity, community._record.id, data)
        # Delete the member again as the actor
        data = {
            "members": [{"type": "user", "id": str(new_user.id)}],
        }
>       member_service.delete(members[actor].identity, community._record.id, data)

tests/members/test_members_services.py:732: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.12/site-packages/invenio_db/uow.py:251: in inner
    res = f(self, *args, **kwargs)
          ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <invenio_communities.members.services.service.MemberService object at 0x7fae14f79bb0>
identity = <Identity id="1" auth_type="None" provides={Need(method='community', value='8ceb5c91-08e0-4a44-9c61-faf4dbfbfd2b', rol...r'), Need(method='community', value='363c723c-cda8-42be-b7ae-8f23325572ea', role='owner'), Need(method='id', value=1)}>
community_id = UUID('8ceb5c91-08e0-4a44-9c61-faf4dbfbfd2b')
data = {'members': [{'id': '5', 'type': 'user'}]}
uow = <invenio_db.uow.UnitOfWork object at 0x7fae168791f0>

    @unit_of_work()
    def delete(self, identity, community_id, data, uow=None):
        """Bulk delete."""
        community = self.community_cls.get_record(community_id)
    
        # Permission check - validates that:
        # - identity has permission to delete any member at all (incl self)
        self.require_permission(
            identity,
            "members_bulk_delete",
            record=community,
        )
    
        # Validate data (if there are errors, .load() raises)
        data, errors = self.delete_schema.load(
            data,
            context={"identity": identity},
        )
        members = self.record_cls.get_members(community.id, members=data["members"])
        if len(members) != len(data["members"]):
            raise InvalidMemberError()
    
        # Perform deletes (and check permissions)
        for m in members:
            self.require_permission(
                identity,
                "members_delete",
                record=community,
                member=m,
            )
            # Run components
            self.run_components(
                "members_delete",
                identity,
                record=m,
                community=community,
                errors=None,
                uow=uow,
            )
            uow.register(RecordDeleteOp(m, self.indexer, force=True))
    
        # Make sure we're not left owner-less
        if not self.record_cls.has_members(
            community_id, role=current_roles.owner_role.name
        ):
>           raise ValidationError(
                _("A community must have at least one owner."),
            )
E           marshmallow.exceptions.ValidationError: A community must have at least one owner.

invenio_communities/members/services/service.py:661: ValidationError
---------------------------- Captured stderr setup -----------------------------
MS PATCH Storing database values
Storing database values
Storing database values done
MS PATCH Stored
--------------------------- Captured stderr teardown ---------------------------
MS PATCH Rollback and original connection close
MS PATCH Purging database changes
Purging database values
Purging database values done
MS PATCH Purged and closed
_____________________ test_delete_allowed[manager-manager] _____________________

member_service = <invenio_communities.members.services.service.MemberService object at 0x7fae14f79bb0>
community = <invenio_communities.communities.services.results.CommunityItem object at 0x7fae14a39d00>
members = {'curator': <pytest_invenio.user.UserFixtureBase object at 0x7fae18d7aa50>, 'manager': <pytest_invenio.user.UserFixtur...er.UserFixtureBase object at 0x7fae163c3b90>, 'reader': <pytest_invenio.user.UserFixtureBase object at 0x7fae14b6cc80>}
actor = 'manager', role = 'manager'
new_user = <pytest_invenio.user.UserFixtureBase object at 0x7fae162fa750>
db = <SQLAlchemy postgresql+psycopg2://invenio:***@localhost:5432/invenio>

    @pytest.mark.parametrize(
        "actor,role",
        [
            ("owner", "owner"),
            ("owner", "manager"),
            ("owner", "curator"),
            ("owner", "reader"),
            ("manager", "manager"),
            ("manager", "curator"),
            ("manager", "reader"),
        ],
    )
    def test_delete_allowed(member_service, community, members, actor, role, new_user, db):
        """Test that the given roles CAN be removed by the actor."""
        # Add a new user with role
        data = {
            "members": [{"type": "user", "id": str(new_user.id)}],
            "role": role,
        }
        member_service.add(system_identity, community._record.id, data)
        # Delete the member again as the actor
        data = {
            "members": [{"type": "user", "id": str(new_user.id)}],
        }
>       member_service.delete(members[actor].identity, community._record.id, data)

tests/members/test_members_services.py:732: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.12/site-packages/invenio_db/uow.py:251: in inner
    res = f(self, *args, **kwargs)
          ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <invenio_communities.members.services.service.MemberService object at 0x7fae14f79bb0>
identity = <Identity id="2" auth_type="None" provides={Need(method='system_role', value='any_user'), Need(method='system_role', v...), Need(method='community', value='8ceb5c91-08e0-4a44-9c61-faf4dbfbfd2b', role='manager'), Need(method='id', value=2)}>
community_id = UUID('8ceb5c91-08e0-4a44-9c61-faf4dbfbfd2b')
data = {'members': [{'id': '5', 'type': 'user'}]}
uow = <invenio_db.uow.UnitOfWork object at 0x7fae12e0f140>

    @unit_of_work()
    def delete(self, identity, community_id, data, uow=None):
        """Bulk delete."""
        community = self.community_cls.get_record(community_id)
    
        # Permission check - validates that:
        # - identity has permission to delete any member at all (incl self)
        self.require_permission(
            identity,
            "members_bulk_delete",
            record=community,
        )
    
        # Validate data (if there are errors, .load() raises)
        data, errors = self.delete_schema.load(
            data,
            context={"identity": identity},
        )
        members = self.record_cls.get_members(community.id, members=data["members"])
        if len(members) != len(data["members"]):
            raise InvalidMemberError()
    
        # Perform deletes (and check permissions)
        for m in members:
            self.require_permission(
                identity,
                "members_delete",
                record=community,
                member=m,
            )
            # Run components
            self.run_components(
                "members_delete",
                identity,
                record=m,
                community=community,
                errors=None,
                uow=uow,
            )
            uow.register(RecordDeleteOp(m, self.indexer, force=True))
    
        # Make sure we're not left owner-less
        if not self.record_cls.has_members(
            community_id, role=current_roles.owner_role.name
        ):
>           raise ValidationError(
                _("A community must have at least one owner."),
            )
E           marshmallow.exceptions.ValidationError: A community must have at least one owner.

invenio_communities/members/services/service.py:661: ValidationError
---------------------------- Captured stderr setup -----------------------------
MS PATCH Storing database values
Storing database values
Storing database values done
MS PATCH Stored
--------------------------- Captured stderr teardown ---------------------------
MS PATCH Rollback and original connection close
MS PATCH Purging database changes
Purging database values
Purging database values done
MS PATCH Purged and closed
_____________________ test_delete_allowed[manager-curator] _____________________

member_service = <invenio_communities.members.services.service.MemberService object at 0x7fae14f79bb0>
community = <invenio_communities.communities.services.results.CommunityItem object at 0x7fae14a39d00>
members = {'curator': <pytest_invenio.user.UserFixtureBase object at 0x7fae18d7aa50>, 'manager': <pytest_invenio.user.UserFixtur...er.UserFixtureBase object at 0x7fae163c3b90>, 'reader': <pytest_invenio.user.UserFixtureBase object at 0x7fae14b6cc80>}
actor = 'manager', role = 'curator'
new_user = <pytest_invenio.user.UserFixtureBase object at 0x7fae162fa750>
db = <SQLAlchemy postgresql+psycopg2://invenio:***@localhost:5432/invenio>

    @pytest.mark.parametrize(
        "actor,role",
        [
            ("owner", "owner"),
            ("owner", "manager"),
            ("owner", "curator"),
            ("owner", "reader"),
            ("manager", "manager"),
            ("manager", "curator"),
            ("manager", "reader"),
        ],
    )
    def test_delete_allowed(member_service, community, members, actor, role, new_user, db):
        """Test that the given roles CAN be removed by the actor."""
        # Add a new user with role
        data = {
            "members": [{"type": "user", "id": str(new_user.id)}],
            "role": role,
        }
        member_service.add(system_identity, community._record.id, data)
        # Delete the member again as the actor
        data = {
            "members": [{"type": "user", "id": str(new_user.id)}],
        }
>       member_service.delete(members[actor].identity, community._record.id, data)

tests/members/test_members_services.py:732: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.12/site-packages/invenio_db/uow.py:251: in inner
    res = f(self, *args, **kwargs)
          ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <invenio_communities.members.services.service.MemberService object at 0x7fae14f79bb0>
identity = <Identity id="2" auth_type="None" provides={Need(method='system_role', value='any_user'), Need(method='system_role', v...), Need(method='community', value='8ceb5c91-08e0-4a44-9c61-faf4dbfbfd2b', role='manager'), Need(method='id', value=2)}>
community_id = UUID('8ceb5c91-08e0-4a44-9c61-faf4dbfbfd2b')
data = {'members': [{'id': '5', 'type': 'user'}]}
uow = <invenio_db.uow.UnitOfWork object at 0x7fae12ea5d30>

    @unit_of_work()
    def delete(self, identity, community_id, data, uow=None):
        """Bulk delete."""
        community = self.community_cls.get_record(community_id)
    
        # Permission check - validates that:
        # - identity has permission to delete any member at all (incl self)
        self.require_permission(
            identity,
            "members_bulk_delete",
            record=community,
        )
    
        # Validate data (if there are errors, .load() raises)
        data, errors = self.delete_schema.load(
            data,
            context={"identity": identity},
        )
        members = self.record_cls.get_members(community.id, members=data["members"])
        if len(members) != len(data["members"]):
            raise InvalidMemberError()
    
        # Perform deletes (and check permissions)
        for m in members:
            self.require_permission(
                identity,
                "members_delete",
                record=community,
                member=m,
            )
            # Run components
            self.run_components(
                "members_delete",
                identity,
                record=m,
                community=community,
                errors=None,
                uow=uow,
            )
            uow.register(RecordDeleteOp(m, self.indexer, force=True))
    
        # Make sure we're not left owner-less
        if not self.record_cls.has_members(
            community_id, role=current_roles.owner_role.name
        ):
>           raise ValidationError(
                _("A community must have at least one owner."),
            )
E           marshmallow.exceptions.ValidationError: A community must have at least one owner.

invenio_communities/members/services/service.py:661: ValidationError
---------------------------- Captured stderr setup -----------------------------
MS PATCH Storing database values
Storing database values
Storing database values done
MS PATCH Stored
--------------------------- Captured stderr teardown ---------------------------
MS PATCH Rollback and original connection close
MS PATCH Purging database changes
Purging database values
Purging database values done
MS PATCH Purged and closed
_____________________ test_delete_allowed[manager-reader] ______________________

member_service = <invenio_communities.members.services.service.MemberService object at 0x7fae14f79bb0>
community = <invenio_communities.communities.services.results.CommunityItem object at 0x7fae14a39d00>
members = {'curator': <pytest_invenio.user.UserFixtureBase object at 0x7fae18d7aa50>, 'manager': <pytest_invenio.user.UserFixtur...er.UserFixtureBase object at 0x7fae163c3b90>, 'reader': <pytest_invenio.user.UserFixtureBase object at 0x7fae14b6cc80>}
actor = 'manager', role = 'reader'
new_user = <pytest_invenio.user.UserFixtureBase object at 0x7fae162fa750>
db = <SQLAlchemy postgresql+psycopg2://invenio:***@localhost:5432/invenio>

    @pytest.mark.parametrize(
        "actor,role",
        [
            ("owner", "owner"),
            ("owner", "manager"),
            ("owner", "curator"),
            ("owner", "reader"),
            ("manager", "manager"),
            ("manager", "curator"),
            ("manager", "reader"),
        ],
    )
    def test_delete_allowed(member_service, community, members, actor, role, new_user, db):
        """Test that the given roles CAN be removed by the actor."""
        # Add a new user with role
        data = {
            "members": [{"type": "user", "id": str(new_user.id)}],
            "role": role,
        }
        member_service.add(system_identity, community._record.id, data)
        # Delete the member again as the actor
        data = {
            "members": [{"type": "user", "id": str(new_user.id)}],
        }
>       member_service.delete(members[actor].identity, community._record.id, data)

tests/members/test_members_services.py:732: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.12/site-packages/invenio_db/uow.py:251: in inner
    res = f(self, *args, **kwargs)
          ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <invenio_communities.members.services.service.MemberService object at 0x7fae14f79bb0>
identity = <Identity id="2" auth_type="None" provides={Need(method='system_role', value='any_user'), Need(method='system_role', v...), Need(method='community', value='8ceb5c91-08e0-4a44-9c61-faf4dbfbfd2b', role='manager'), Need(method='id', value=2)}>
community_id = UUID('8ceb5c91-08e0-4a44-9c61-faf4dbfbfd2b')
data = {'members': [{'id': '5', 'type': 'user'}]}
uow = <invenio_db.uow.UnitOfWork object at 0x7fae128e92e0>

    @unit_of_work()
    def delete(self, identity, community_id, data, uow=None):
        """Bulk delete."""
        community = self.community_cls.get_record(community_id)
    
        # Permission check - validates that:
        # - identity has permission to delete any member at all (incl self)
        self.require_permission(
            identity,
            "members_bulk_delete",
            record=community,
        )
    
        # Validate data (if there are errors, .load() raises)
        data, errors = self.delete_schema.load(
            data,
            context={"identity": identity},
        )
        members = self.record_cls.get_members(community.id, members=data["members"])
        if len(members) != len(data["members"]):
            raise InvalidMemberError()
    
        # Perform deletes (and check permissions)
        for m in members:
            self.require_permission(
                identity,
                "members_delete",
                record=community,
                member=m,
            )
            # Run components
            self.run_components(
                "members_delete",
                identity,
                record=m,
                community=community,
                errors=None,
                uow=uow,
            )
            uow.register(RecordDeleteOp(m, self.indexer, force=True))
    
        # Make sure we're not left owner-less
        if not self.record_cls.has_members(
            community_id, role=current_roles.owner_role.name
        ):
>           raise ValidationError(
                _("A community must have at least one owner."),
            )
E           marshmallow.exceptions.ValidationError: A community must have at least one owner.

invenio_communities/members/services/service.py:661: ValidationError
---------------------------- Captured stderr setup -----------------------------
MS PATCH Storing database values
Storing database values
Storing database values done
MS PATCH Stored
--------------------------- Captured stderr teardown ---------------------------
MS PATCH Rollback and original connection close
MS PATCH Purging database changes
Purging database values
Purging database values done
MS PATCH Purged and closed
________________________ test_delete_member_type_group _________________________

member_service = <invenio_communities.members.services.service.MemberService object at 0x7fae14f79bb0>
community = <invenio_communities.communities.services.results.CommunityItem object at 0x7fae14a39d00>
owner = <pytest_invenio.user.UserFixtureBase object at 0x7fae163c3b90>
group = <Role it-dep>
db = <SQLAlchemy postgresql+psycopg2://invenio:***@localhost:5432/invenio>

    def test_delete_member_type_group(member_service, community, owner, group, db):
        """Groups can be removed."""
        # Add a new user with role
        data = {
            "members": [{"type": "group", "id": group.name}],
            "role": "reader",
        }
        member_service.add(system_identity, community._record.id, data)
        # Delete the member again
        data = {
            "members": [{"type": "group", "id": group.name}],
        }
>       member_service.delete(owner.identity, community._record.id, data)

tests/members/test_members_services.py:747: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.12/site-packages/invenio_db/uow.py:251: in inner
    res = f(self, *args, **kwargs)
          ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <invenio_communities.members.services.service.MemberService object at 0x7fae14f79bb0>
identity = <Identity id="1" auth_type="None" provides={Need(method='community', value='8ceb5c91-08e0-4a44-9c61-faf4dbfbfd2b', rol...r'), Need(method='community', value='363c723c-cda8-42be-b7ae-8f23325572ea', role='owner'), Need(method='id', value=1)}>
community_id = UUID('8ceb5c91-08e0-4a44-9c61-faf4dbfbfd2b')
data = {'members': [{'id': 'it-dep', 'type': 'group'}]}
uow = <invenio_db.uow.UnitOfWork object at 0x7fae12ea5c70>

    @unit_of_work()
    def delete(self, identity, community_id, data, uow=None):
        """Bulk delete."""
        community = self.community_cls.get_record(community_id)
    
        # Permission check - validates that:
        # - identity has permission to delete any member at all (incl self)
        self.require_permission(
            identity,
            "members_bulk_delete",
            record=community,
        )
    
        # Validate data (if there are errors, .load() raises)
        data, errors = self.delete_schema.load(
            data,
            context={"identity": identity},
        )
        members = self.record_cls.get_members(community.id, members=data["members"])
        if len(members) != len(data["members"]):
            raise InvalidMemberError()
    
        # Perform deletes (and check permissions)
        for m in members:
            self.require_permission(
                identity,
                "members_delete",
                record=community,
                member=m,
            )
            # Run components
            self.run_components(
                "members_delete",
                identity,
                record=m,
                community=community,
                errors=None,
                uow=uow,
            )
            uow.register(RecordDeleteOp(m, self.indexer, force=True))
    
        # Make sure we're not left owner-less
        if not self.record_cls.has_members(
            community_id, role=current_roles.owner_role.name
        ):
>           raise ValidationError(
                _("A community must have at least one owner."),
            )
E           marshmallow.exceptions.ValidationError: A community must have at least one owner.

invenio_communities/members/services/service.py:661: ValidationError
---------------------------- Captured stderr setup -----------------------------
MS PATCH Storing database values
Storing database values
Storing database values done
MS PATCH Stored
--------------------------- Captured stderr teardown ---------------------------
MS PATCH Rollback and original connection close
MS PATCH Purging database changes
Purging database values
Purging database values done
MS PATCH Purged and closed
______________________ test_selfupdate_role_denied[owner] ______________________

member_service = <invenio_communities.members.services.service.MemberService object at 0x7fae14f79bb0>
community = <invenio_communities.communities.services.results.CommunityItem object at 0x7fae14a39d00>
members = {'curator': <pytest_invenio.user.UserFixtureBase object at 0x7fae18d7aa50>, 'manager': <pytest_invenio.user.UserFixtur...er.UserFixtureBase object at 0x7fae163c3b90>, 'reader': <pytest_invenio.user.UserFixtureBase object at 0x7fae14b6cc80>}
actor = 'owner'

    @pytest.mark.parametrize(
        "actor",
        [
            "owner",
            "manager",
            "curator",
            "reader",
        ],
    )
    def test_selfupdate_role_denied(member_service, community, members, actor):
        """Nobody can change their own role."""
        user = members[actor]
        data = {
            "members": [{"type": "user", "id": str(user.id)}],
            "role": actor,
        }
>       pytest.raises(
            ValidationError,
            member_service.update,
            user.identity,
            community._record.id,
            data,
        )

tests/members/test_members_services.py:804: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.12/site-packages/invenio_db/uow.py:251: in inner
    res = f(self, *args, **kwargs)
          ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <invenio_communities.members.services.service.MemberService object at 0x7fae14f79bb0>
identity = <Identity id="1" auth_type="None" provides={Need(method='community', value='8ceb5c91-08e0-4a44-9c61-faf4dbfbfd2b', rol...r'), Need(method='community', value='363c723c-cda8-42be-b7ae-8f23325572ea', role='owner'), Need(method='id', value=1)}>
community_id = UUID('8ceb5c91-08e0-4a44-9c61-faf4dbfbfd2b')
data = {'members': [{'id': '1', 'type': 'user'}], 'role': Role(name='owner', title=l'Owner', description=l'Full administrativ...anage_roles=['owner', 'manager', 'curator', 'reader'], is_owner=True, can_manage=True, can_curate=True, can_view=True)}
uow = <invenio_db.uow.UnitOfWork object at 0x7fae12e15400>, refresh = False

    @unit_of_work()
    def update(self, identity, community_id, data, uow=None, refresh=False):
        """Bulk update.
    
        Used to update both active members and active invitations. Archived
        invitations cannot be updated.
        """
        community = self.community_cls.get_record(community_id)
    
        # Permission check - validates that:
        # - identity has permission to change any member at all (incl self)
        self.require_permission(
            identity,
            "members_bulk_update",
            record=community,
        )
    
        # Validate data (if there are errors, .load() raises)
        data, errors = self.update_schema.load(
            data,
            context={"identity": identity},
        )
    
        # Schema validates that role and/or visibility are defined.
        members = self.record_cls.get_members(community.id, members=data["members"])
        if len(members) != len(data["members"]):
>           raise InvalidMemberError()
E           invenio_communities.members.errors.InvalidMemberError

invenio_communities/members/services/service.py:528: InvalidMemberError
---------------------------- Captured stderr setup -----------------------------
MS PATCH Storing database values
Storing database values
Storing database values done
MS PATCH Stored
--------------------------- Captured stderr teardown ---------------------------
MS PATCH Rollback and original connection close
MS PATCH Purging database changes
Purging database values
Purging database values done
MS PATCH Purged and closed
___________________ test_selfupdate_allow_visibility[owner] ____________________

member_service = <invenio_communities.members.services.service.MemberService object at 0x7fae14f79bb0>
community = <invenio_communities.communities.services.results.CommunityItem object at 0x7fae14a39d00>
members = {'curator': <pytest_invenio.user.UserFixtureBase object at 0x7fae18d7aa50>, 'manager': <pytest_invenio.user.UserFixtur...er.UserFixtureBase object at 0x7fae163c3b90>, 'reader': <pytest_invenio.user.UserFixtureBase object at 0x7fae14b6cc80>}
actor = 'owner'
db = <SQLAlchemy postgresql+psycopg2://invenio:***@localhost:5432/invenio>

    @pytest.mark.parametrize(
        "actor",
        [
            "owner",
            "manager",
            "curator",
            "reader",
        ],
    )
    def test_selfupdate_allow_visibility(member_service, community, members, actor, db):
        """All + system identity can change their own visibility to true."""
        user = members[actor]
        data = {
            "members": [{"type": "user", "id": str(user.id)}],
            "visible": True,
        }
>       member_service.update(user.identity, community._record.id, data)

tests/members/test_members_services.py:829: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.12/site-packages/invenio_db/uow.py:251: in inner
    res = f(self, *args, **kwargs)
          ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <invenio_communities.members.services.service.MemberService object at 0x7fae14f79bb0>
identity = <Identity id="1" auth_type="None" provides={Need(method='community', value='8ceb5c91-08e0-4a44-9c61-faf4dbfbfd2b', rol...r'), Need(method='community', value='363c723c-cda8-42be-b7ae-8f23325572ea', role='owner'), Need(method='id', value=1)}>
community_id = UUID('8ceb5c91-08e0-4a44-9c61-faf4dbfbfd2b')
data = {'members': [{'id': '1', 'type': 'user'}], 'visible': True}
uow = <invenio_db.uow.UnitOfWork object at 0x7fae15fdbb60>, refresh = False

    @unit_of_work()
    def update(self, identity, community_id, data, uow=None, refresh=False):
        """Bulk update.
    
        Used to update both active members and active invitations. Archived
        invitations cannot be updated.
        """
        community = self.community_cls.get_record(community_id)
    
        # Permission check - validates that:
        # - identity has permission to change any member at all (incl self)
        self.require_permission(
            identity,
            "members_bulk_update",
            record=community,
        )
    
        # Validate data (if there are errors, .load() raises)
        data, errors = self.update_schema.load(
            data,
            context={"identity": identity},
        )
    
        # Schema validates that role and/or visibility are defined.
        members = self.record_cls.get_members(community.id, members=data["members"])
        if len(members) != len(data["members"]):
>           raise InvalidMemberError()
E           invenio_communities.members.errors.InvalidMemberError

invenio_communities/members/services/service.py:528: InvalidMemberError
---------------------------- Captured stderr setup -----------------------------
MS PATCH Storing database values
Storing database values
Storing database values done
MS PATCH Stored
--------------------------- Captured stderr teardown ---------------------------
MS PATCH Rollback and original connection close
MS PATCH Purging database changes
Purging database values
Purging database values done
MS PATCH Purged and closed
_________________ test_update_role_allowed[owner-owner-reader] _________________

member_service = <invenio_communities.members.services.service.MemberService object at 0x7fae14f79bb0>
community = <invenio_communities.communities.services.results.CommunityItem object at 0x7fae14a39d00>
members = {'curator': <pytest_invenio.user.UserFixtureBase object at 0x7fae18d7aa50>, 'manager': <pytest_invenio.user.UserFixtur...er.UserFixtureBase object at 0x7fae163c3b90>, 'reader': <pytest_invenio.user.UserFixtureBase object at 0x7fae14b6cc80>}
actor = 'owner', initial_role = 'owner', new_role = 'reader'
new_user = <pytest_invenio.user.UserFixtureBase object at 0x7fae162fa750>
db = <SQLAlchemy postgresql+psycopg2://invenio:***@localhost:5432/invenio>

    @pytest.mark.parametrize(
        "actor,initial_role,new_role",
        [
            ("owner", "owner", "reader"),
            ("owner", "manager", "reader"),
            ("owner", "curator", "manager"),
            ("owner", "reader", "curator"),
            ("manager", "manager", "curator"),
            ("manager", "curator", "manager"),
            ("manager", "reader", "curator"),
        ],
    )
    def test_update_role_allowed(
        member_service, community, members, actor, initial_role, new_role, new_user, db
    ):
        """Owners can change role of all, managers all but owners."""
        # Add a new user with role
        data = {
            "members": [{"type": "user", "id": str(new_user.id)}],
            "role": initial_role,
        }
        member_service.add(system_identity, community._record.id, data)
        # Update the member with new role
        data = {
            "members": [{"type": "user", "id": str(new_user.id)}],
            "role": new_role,
        }
>       member_service.update(members[actor].identity, community._record.id, data)

tests/members/test_members_services.py:948: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.12/site-packages/invenio_db/uow.py:251: in inner
    res = f(self, *args, **kwargs)
          ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <invenio_communities.members.services.service.MemberService object at 0x7fae14f79bb0>
identity = <Identity id="1" auth_type="None" provides={Need(method='community', value='8ceb5c91-08e0-4a44-9c61-faf4dbfbfd2b', rol...r'), Need(method='community', value='363c723c-cda8-42be-b7ae-8f23325572ea', role='owner'), Need(method='id', value=1)}>
community_id = UUID('8ceb5c91-08e0-4a44-9c61-faf4dbfbfd2b')
data = {'members': [{'id': '5', 'type': 'user'}], 'role': Role(name='reader', title=l'Reader', description=l'Can view restricted records.', can_manage_roles=[], is_owner=False, can_manage=False, can_curate=False, can_view=True)}
uow = <invenio_db.uow.UnitOfWork object at 0x7fae142fdbb0>, refresh = False

    @unit_of_work()
    def update(self, identity, community_id, data, uow=None, refresh=False):
        """Bulk update.
    
        Used to update both active members and active invitations. Archived
        invitations cannot be updated.
        """
        community = self.community_cls.get_record(community_id)
    
        # Permission check - validates that:
        # - identity has permission to change any member at all (incl self)
        self.require_permission(
            identity,
            "members_bulk_update",
            record=community,
        )
    
        # Validate data (if there are errors, .load() raises)
        data, errors = self.update_schema.load(
            data,
            context={"identity": identity},
        )
    
        # Schema validates that role and/or visibility are defined.
        members = self.record_cls.get_members(community.id, members=data["members"])
        if len(members) != len(data["members"]):
            raise InvalidMemberError()
        role = data.get("role")
        visible = data.get("visible")
    
        # Perform updates (and check permissions)
        for m in members:
            self._update(identity, community, m, role, visible, uow)
    
        # Make sure we're not left owner-less if a role was changed.
        if role is not None:
            if not self.record_cls.has_members(
                community_id, role=current_roles.owner_role.name
            ):
>               raise ValidationError(
                    _("A community must have at least one owner."),
                )
E               marshmallow.exceptions.ValidationError: A community must have at least one owner.

invenio_communities/members/services/service.py:541: ValidationError
---------------------------- Captured stderr setup -----------------------------
MS PATCH Storing database values
Storing database values
Storing database values done
MS PATCH Stored
--------------------------- Captured stderr teardown ---------------------------
MS PATCH Rollback and original connection close
MS PATCH Purging database changes
Purging database values
Purging database values done
MS PATCH Purged and closed
________________ test_update_role_allowed[owner-manager-reader] ________________

member_service = <invenio_communities.members.services.service.MemberService object at 0x7fae14f79bb0>
community = <invenio_communities.communities.services.results.CommunityItem object at 0x7fae14a39d00>
members = {'curator': <pytest_invenio.user.UserFixtureBase object at 0x7fae18d7aa50>, 'manager': <pytest_invenio.user.UserFixtur...er.UserFixtureBase object at 0x7fae163c3b90>, 'reader': <pytest_invenio.user.UserFixtureBase object at 0x7fae14b6cc80>}
actor = 'owner', initial_role = 'manager', new_role = 'reader'
new_user = <pytest_invenio.user.UserFixtureBase object at 0x7fae162fa750>
db = <SQLAlchemy postgresql+psycopg2://invenio:***@localhost:5432/invenio>

    @pytest.mark.parametrize(
        "actor,initial_role,new_role",
        [
            ("owner", "owner", "reader"),
            ("owner", "manager", "reader"),
            ("owner", "curator", "manager"),
            ("owner", "reader", "curator"),
            ("manager", "manager", "curator"),
            ("manager", "curator", "manager"),
            ("manager", "reader", "curator"),
        ],
    )
    def test_update_role_allowed(
        member_service, community, members, actor, initial_role, new_role, new_user, db
    ):
        """Owners can change role of all, managers all but owners."""
        # Add a new user with role
        data = {
            "members": [{"type": "user", "id": str(new_user.id)}],
            "role": initial_role,
        }
        member_service.add(system_identity, community._record.id, data)
        # Update the member with new role
        data = {
            "members": [{"type": "user", "id": str(new_user.id)}],
            "role": new_role,
        }
>       member_service.update(members[actor].identity, community._record.id, data)

tests/members/test_members_services.py:948: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.12/site-packages/invenio_db/uow.py:251: in inner
    res = f(self, *args, **kwargs)
          ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <invenio_communities.members.services.service.MemberService object at 0x7fae14f79bb0>
identity = <Identity id="1" auth_type="None" provides={Need(method='community', value='8ceb5c91-08e0-4a44-9c61-faf4dbfbfd2b', rol...r'), Need(method='community', value='363c723c-cda8-42be-b7ae-8f23325572ea', role='owner'), Need(method='id', value=1)}>
community_id = UUID('8ceb5c91-08e0-4a44-9c61-faf4dbfbfd2b')
data = {'members': [{'id': '5', 'type': 'user'}], 'role': Role(name='reader', title=l'Reader', description=l'Can view restricted records.', can_manage_roles=[], is_owner=False, can_manage=False, can_curate=False, can_view=True)}
uow = <invenio_db.uow.UnitOfWork object at 0x7fae1477c740>, refresh = False

    @unit_of_work()
    def update(self, identity, community_id, data, uow=None, refresh=False):
        """Bulk update.
    
        Used to update both active members and active invitations. Archived
        invitations cannot be updated.
        """
        community = self.community_cls.get_record(community_id)
    
        # Permission check - validates that:
        # - identity has permission to change any member at all (incl self)
        self.require_permission(
            identity,
            "members_bulk_update",
            record=community,
        )
    
        # Validate data (if there are errors, .load() raises)
        data, errors = self.update_schema.load(
            data,
            context={"identity": identity},
        )
    
        # Schema validates that role and/or visibility are defined.
        members = self.record_cls.get_members(community.id, members=data["members"])
        if len(members) != len(data["members"]):
            raise InvalidMemberError()
        role = data.get("role")
        visible = data.get("visible")
    
        # Perform updates (and check permissions)
        for m in members:
            self._update(identity, community, m, role, visible, uow)
    
        # Make sure we're not left owner-less if a role was changed.
        if role is not None:
            if not self.record_cls.has_members(
                community_id, role=current_roles.owner_role.name
            ):
>               raise ValidationError(
                    _("A community must have at least one owner."),
                )
E               marshmallow.exceptions.ValidationError: A community must have at least one owner.

invenio_communities/members/services/service.py:541: ValidationError
---------------------------- Captured stderr setup -----------------------------
MS PATCH Storing database values
Storing database values
Storing database values done
MS PATCH Stored
--------------------------- Captured stderr teardown ---------------------------
MS PATCH Rollback and original connection close
MS PATCH Purging database changes
Purging database values
Purging database values done
MS PATCH Purged and closed
_______________ test_update_role_allowed[owner-curator-manager] ________________

member_service = <invenio_communities.members.services.service.MemberService object at 0x7fae14f79bb0>
community = <invenio_communities.communities.services.results.CommunityItem object at 0x7fae14a39d00>
members = {'curator': <pytest_invenio.user.UserFixtureBase object at 0x7fae18d7aa50>, 'manager': <pytest_invenio.user.UserFixtur...er.UserFixtureBase object at 0x7fae163c3b90>, 'reader': <pytest_invenio.user.UserFixtureBase object at 0x7fae14b6cc80>}
actor = 'owner', initial_role = 'curator', new_role = 'manager'
new_user = <pytest_invenio.user.UserFixtureBase object at 0x7fae162fa750>
db = <SQLAlchemy postgresql+psycopg2://invenio:***@localhost:5432/invenio>

    @pytest.mark.parametrize(
        "actor,initial_role,new_role",
        [
            ("owner", "owner", "reader"),
            ("owner", "manager", "reader"),
            ("owner", "curator", "manager"),
            ("owner", "reader", "curator"),
            ("manager", "manager", "curator"),
            ("manager", "curator", "manager"),
            ("manager", "reader", "curator"),
        ],
    )
    def test_update_role_allowed(
        member_service, community, members, actor, initial_role, new_role, new_user, db
    ):
        """Owners can change role of all, managers all but owners."""
        # Add a new user with role
        data = {
            "members": [{"type": "user", "id": str(new_user.id)}],
            "role": initial_role,
        }
        member_service.add(system_identity, community._record.id, data)
        # Update the member with new role
        data = {
            "members": [{"type": "user", "id": str(new_user.id)}],
            "role": new_role,
        }
>       member_service.update(members[actor].identity, community._record.id, data)

tests/members/test_members_services.py:948: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.12/site-packages/invenio_db/uow.py:251: in inner
    res = f(self, *args, **kwargs)
          ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <invenio_communities.members.services.service.MemberService object at 0x7fae14f79bb0>
identity = <Identity id="1" auth_type="None" provides={Need(method='community', value='8ceb5c91-08e0-4a44-9c61-faf4dbfbfd2b', rol...r'), Need(method='community', value='363c723c-cda8-42be-b7ae-8f23325572ea', role='owner'), Need(method='id', value=1)}>
community_id = UUID('8ceb5c91-08e0-4a44-9c61-faf4dbfbfd2b')
data = {'members': [{'id': '5', 'type': 'user'}], 'role': Role(name='manager', title=l'Manager', description=l'Can manage mem...', can_manage_roles=['manager', 'curator', 'reader'], is_owner=False, can_manage=True, can_curate=True, can_view=True)}
uow = <invenio_db.uow.UnitOfWork object at 0x7fae17ddc260>, refresh = False

    @unit_of_work()
    def update(self, identity, community_id, data, uow=None, refresh=False):
        """Bulk update.
    
        Used to update both active members and active invitations. Archived
        invitations cannot be updated.
        """
        community = self.community_cls.get_record(community_id)
    
        # Permission check - validates that:
        # - identity has permission to change any member at all (incl self)
        self.require_permission(
            identity,
            "members_bulk_update",
            record=community,
        )
    
        # Validate data (if there are errors, .load() raises)
        data, errors = self.update_schema.load(
            data,
            context={"identity": identity},
        )
    
        # Schema validates that role and/or visibility are defined.
        members = self.record_cls.get_members(community.id, members=data["members"])
        if len(members) != len(data["members"]):
            raise InvalidMemberError()
        role = data.get("role")
        visible = data.get("visible")
    
        # Perform updates (and check permissions)
        for m in members:
            self._update(identity, community, m, role, visible, uow)
    
        # Make sure we're not left owner-less if a role was changed.
        if role is not None:
            if not self.record_cls.has_members(
                community_id, role=current_roles.owner_role.name
            ):
>               raise ValidationError(
                    _("A community must have at least one owner."),
                )
E               marshmallow.exceptions.ValidationError: A community must have at least one owner.

invenio_communities/members/services/service.py:541: ValidationError
---------------------------- Captured stderr setup -----------------------------
MS PATCH Storing database values
Storing database values
Storing database values done
MS PATCH Stored
--------------------------- Captured stderr teardown ---------------------------
MS PATCH Rollback and original connection close
MS PATCH Purging database changes
Purging database values
Purging database values done
MS PATCH Purged and closed
________________ test_update_role_allowed[owner-reader-curator] ________________

member_service = <invenio_communities.members.services.service.MemberService object at 0x7fae14f79bb0>
community = <invenio_communities.communities.services.results.CommunityItem object at 0x7fae14a39d00>
members = {'curator': <pytest_invenio.user.UserFixtureBase object at 0x7fae18d7aa50>, 'manager': <pytest_invenio.user.UserFixtur...er.UserFixtureBase object at 0x7fae163c3b90>, 'reader': <pytest_invenio.user.UserFixtureBase object at 0x7fae14b6cc80>}
actor = 'owner', initial_role = 'reader', new_role = 'curator'
new_user = <pytest_invenio.user.UserFixtureBase object at 0x7fae162fa750>
db = <SQLAlchemy postgresql+psycopg2://invenio:***@localhost:5432/invenio>

    @pytest.mark.parametrize(
        "actor,initial_role,new_role",
        [
            ("owner", "owner", "reader"),
            ("owner", "manager", "reader"),
            ("owner", "curator", "manager"),
            ("owner", "reader", "curator"),
            ("manager", "manager", "curator"),
            ("manager", "curator", "manager"),
            ("manager", "reader", "curator"),
        ],
    )
    def test_update_role_allowed(
        member_service, community, members, actor, initial_role, new_role, new_user, db
    ):
        """Owners can change role of all, managers all but owners."""
        # Add a new user with role
        data = {
            "members": [{"type": "user", "id": str(new_user.id)}],
            "role": initial_role,
        }
        member_service.add(system_identity, community._record.id, data)
        # Update the member with new role
        data = {
            "members": [{"type": "user", "id": str(new_user.id)}],
            "role": new_role,
        }
>       member_service.update(members[actor].identity, community._record.id, data)

tests/members/test_members_services.py:948: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.12/site-packages/invenio_db/uow.py:251: in inner
    res = f(self, *args, **kwargs)
          ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <invenio_communities.members.services.service.MemberService object at 0x7fae14f79bb0>
identity = <Identity id="1" auth_type="None" provides={Need(method='community', value='8ceb5c91-08e0-4a44-9c61-faf4dbfbfd2b', rol...r'), Need(method='community', value='363c723c-cda8-42be-b7ae-8f23325572ea', role='owner'), Need(method='id', value=1)}>
community_id = UUID('8ceb5c91-08e0-4a44-9c61-faf4dbfbfd2b')
data = {'members': [{'id': '5', 'type': 'user'}], 'role': Role(name='curator', title=l'Curator', description=l'Can curate rec... and view restricted records.', can_manage_roles=[], is_owner=False, can_manage=False, can_curate=True, can_view=True)}
uow = <invenio_db.uow.UnitOfWork object at 0x7fae13403dd0>, refresh = False

    @unit_of_work()
    def update(self, identity, community_id, data, uow=None, refresh=False):
        """Bulk update.
    
        Used to update both active members and active invitations. Archived
        invitations cannot be updated.
        """
        community = self.community_cls.get_record(community_id)
    
        # Permission check - validates that:
        # - identity has permission to change any member at all (incl self)
        self.require_permission(
            identity,
            "members_bulk_update",
            record=community,
        )
    
        # Validate data (if there are errors, .load() raises)
        data, errors = self.update_schema.load(
            data,
            context={"identity": identity},
        )
    
        # Schema validates that role and/or visibility are defined.
        members = self.record_cls.get_members(community.id, members=data["members"])
        if len(members) != len(data["members"]):
            raise InvalidMemberError()
        role = data.get("role")
        visible = data.get("visible")
    
        # Perform updates (and check permissions)
        for m in members:
            self._update(identity, community, m, role, visible, uow)
    
        # Make sure we're not left owner-less if a role was changed.
        if role is not None:
            if not self.record_cls.has_members(
                community_id, role=current_roles.owner_role.name
            ):
>               raise ValidationError(
                    _("A community must have at least one owner."),
                )
E               marshmallow.exceptions.ValidationError: A community must have at least one owner.

invenio_communities/members/services/service.py:541: ValidationError
---------------------------- Captured stderr setup -----------------------------
MS PATCH Storing database values
Storing database values
Storing database values done
MS PATCH Stored
--------------------------- Captured stderr teardown ---------------------------
MS PATCH Rollback and original connection close
MS PATCH Purging database changes
Purging database values
Purging database values done
MS PATCH Purged and closed
______________ test_update_role_allowed[manager-manager-curator] _______________

member_service = <invenio_communities.members.services.service.MemberService object at 0x7fae14f79bb0>
community = <invenio_communities.communities.services.results.CommunityItem object at 0x7fae14a39d00>
members = {'curator': <pytest_invenio.user.UserFixtureBase object at 0x7fae18d7aa50>, 'manager': <pytest_invenio.user.UserFixtur...er.UserFixtureBase object at 0x7fae163c3b90>, 'reader': <pytest_invenio.user.UserFixtureBase object at 0x7fae14b6cc80>}
actor = 'manager', initial_role = 'manager', new_role = 'curator'
new_user = <pytest_invenio.user.UserFixtureBase object at 0x7fae162fa750>
db = <SQLAlchemy postgresql+psycopg2://invenio:***@localhost:5432/invenio>

    @pytest.mark.parametrize(
        "actor,initial_role,new_role",
        [
            ("owner", "owner", "reader"),
            ("owner", "manager", "reader"),
            ("owner", "curator", "manager"),
            ("owner", "reader", "curator"),
            ("manager", "manager", "curator"),
            ("manager", "curator", "manager"),
            ("manager", "reader", "curator"),
        ],
    )
    def test_update_role_allowed(
        member_service, community, members, actor, initial_role, new_role, new_user, db
    ):
        """Owners can change role of all, managers all but owners."""
        # Add a new user with role
        data = {
            "members": [{"type": "user", "id": str(new_user.id)}],
            "role": initial_role,
        }
        member_service.add(system_identity, community._record.id, data)
        # Update the member with new role
        data = {
            "members": [{"type": "user", "id": str(new_user.id)}],
            "role": new_role,
        }
>       member_service.update(members[actor].identity, community._record.id, data)

tests/members/test_members_services.py:948: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.12/site-packages/invenio_db/uow.py:251: in inner
    res = f(self, *args, **kwargs)
          ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <invenio_communities.members.services.service.MemberService object at 0x7fae14f79bb0>
identity = <Identity id="2" auth_type="None" provides={Need(method='system_role', value='any_user'), Need(method='system_role', v...), Need(method='community', value='8ceb5c91-08e0-4a44-9c61-faf4dbfbfd2b', role='manager'), Need(method='id', value=2)}>
community_id = UUID('8ceb5c91-08e0-4a44-9c61-faf4dbfbfd2b')
data = {'members': [{'id': '5', 'type': 'user'}], 'role': Role(name='curator', title=l'Curator', description=l'Can curate rec... and view restricted records.', can_manage_roles=[], is_owner=False, can_manage=False, can_curate=True, can_view=True)}
uow = <invenio_db.uow.UnitOfWork object at 0x7fae190a6cf0>, refresh = False

    @unit_of_work()
    def update(self, identity, community_id, data, uow=None, refresh=False):
        """Bulk update.
    
        Used to update both active members and active invitations. Archived
        invitations cannot be updated.
        """
        community = self.community_cls.get_record(community_id)
    
        # Permission check - validates that:
        # - identity has permission to change any member at all (incl self)
        self.require_permission(
            identity,
            "members_bulk_update",
            record=community,
        )
    
        # Validate data (if there are errors, .load() raises)
        data, errors = self.update_schema.load(
            data,
            context={"identity": identity},
        )
    
        # Schema validates that role and/or visibility are defined.
        members = self.record_cls.get_members(community.id, members=data["members"])
        if len(members) != len(data["members"]):
            raise InvalidMemberError()
        role = data.get("role")
        visible = data.get("visible")
    
        # Perform updates (and check permissions)
        for m in members:
            self._update(identity, community, m, role, visible, uow)
    
        # Make sure we're not left owner-less if a role was changed.
        if role is not None:
            if not self.record_cls.has_members(
                community_id, role=current_roles.owner_role.name
            ):
>               raise ValidationError(
                    _("A community must have at least one owner."),
                )
E               marshmallow.exceptions.ValidationError: A community must have at least one owner.

invenio_communities/members/services/service.py:541: ValidationError
---------------------------- Captured stderr setup -----------------------------
MS PATCH Storing database values
Storing database values
Storing database values done
MS PATCH Stored
--------------------------- Captured stderr teardown ---------------------------
MS PATCH Rollback and original connection close
MS PATCH Purging database changes
Purging database values
Purging database values done
MS PATCH Purged and closed
______________ test_update_role_allowed[manager-curator-manager] _______________

member_service = <invenio_communities.members.services.service.MemberService object at 0x7fae14f79bb0>
community = <invenio_communities.communities.services.results.CommunityItem object at 0x7fae14a39d00>
members = {'curator': <pytest_invenio.user.UserFixtureBase object at 0x7fae18d7aa50>, 'manager': <pytest_invenio.user.UserFixtur...er.UserFixtureBase object at 0x7fae163c3b90>, 'reader': <pytest_invenio.user.UserFixtureBase object at 0x7fae14b6cc80>}
actor = 'manager', initial_role = 'curator', new_role = 'manager'
new_user = <pytest_invenio.user.UserFixtureBase object at 0x7fae162fa750>
db = <SQLAlchemy postgresql+psycopg2://invenio:***@localhost:5432/invenio>

    @pytest.mark.parametrize(
        "actor,initial_role,new_role",
        [
            ("owner", "owner", "reader"),
            ("owner", "manager", "reader"),
            ("owner", "curator", "manager"),
            ("owner", "reader", "curator"),
            ("manager", "manager", "curator"),
            ("manager", "curator", "manager"),
            ("manager", "reader", "curator"),
        ],
    )
    def test_update_role_allowed(
        member_service, community, members, actor, initial_role, new_role, new_user, db
    ):
        """Owners can change role of all, managers all but owners."""
        # Add a new user with role
        data = {
            "members": [{"type": "user", "id": str(new_user.id)}],
            "role": initial_role,
        }
        member_service.add(system_identity, community._record.id, data)
        # Update the member with new role
        data = {
            "members": [{"type": "user", "id": str(new_user.id)}],
            "role": new_role,
        }
>       member_service.update(members[actor].identity, community._record.id, data)

tests/members/test_members_services.py:948: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.12/site-packages/invenio_db/uow.py:251: in inner
    res = f(self, *args, **kwargs)
          ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <invenio_communities.members.services.service.MemberService object at 0x7fae14f79bb0>
identity = <Identity id="2" auth_type="None" provides={Need(method='system_role', value='any_user'), Need(method='system_role', v...), Need(method='community', value='8ceb5c91-08e0-4a44-9c61-faf4dbfbfd2b', role='manager'), Need(method='id', value=2)}>
community_id = UUID('8ceb5c91-08e0-4a44-9c61-faf4dbfbfd2b')
data = {'members': [{'id': '5', 'type': 'user'}], 'role': Role(name='manager', title=l'Manager', description=l'Can manage mem...', can_manage_roles=['manager', 'curator', 'reader'], is_owner=False, can_manage=True, can_curate=True, can_view=True)}
uow = <invenio_db.uow.UnitOfWork object at 0x7fae160bffe0>, refresh = False

    @unit_of_work()
    def update(self, identity, community_id, data, uow=None, refresh=False):
        """Bulk update.
    
        Used to update both active members and active invitations. Archived
        invitations cannot be updated.
        """
        community = self.community_cls.get_record(community_id)
    
        # Permission check - validates that:
        # - identity has permission to change any member at all (incl self)
        self.require_permission(
            identity,
            "members_bulk_update",
            record=community,
        )
    
        # Validate data (if there are errors, .load() raises)
        data, errors = self.update_schema.load(
            data,
            context={"identity": identity},
        )
    
        # Schema validates that role and/or visibility are defined.
        members = self.record_cls.get_members(community.id, members=data["members"])
        if len(members) != len(data["members"]):
            raise InvalidMemberError()
        role = data.get("role")
        visible = data.get("visible")
    
        # Perform updates (and check permissions)
        for m in members:
            self._update(identity, community, m, role, visible, uow)
    
        # Make sure we're not left owner-less if a role was changed.
        if role is not None:
            if not self.record_cls.has_members(
                community_id, role=current_roles.owner_role.name
            ):
>               raise ValidationError(
                    _("A community must have at least one owner."),
                )
E               marshmallow.exceptions.ValidationError: A community must have at least one owner.

invenio_communities/members/services/service.py:541: ValidationError
---------------------------- Captured stderr setup -----------------------------
MS PATCH Storing database values
Storing database values
Storing database values done
MS PATCH Stored
--------------------------- Captured stderr teardown ---------------------------
MS PATCH Rollback and original connection close
MS PATCH Purging database changes
Purging database values
Purging database values done
MS PATCH Purged and closed
_______________ test_update_role_allowed[manager-reader-curator] _______________

member_service = <invenio_communities.members.services.service.MemberService object at 0x7fae14f79bb0>
community = <invenio_communities.communities.services.results.CommunityItem object at 0x7fae14a39d00>
members = {'curator': <pytest_invenio.user.UserFixtureBase object at 0x7fae18d7aa50>, 'manager': <pytest_invenio.user.UserFixtur...er.UserFixtureBase object at 0x7fae163c3b90>, 'reader': <pytest_invenio.user.UserFixtureBase object at 0x7fae14b6cc80>}
actor = 'manager', initial_role = 'reader', new_role = 'curator'
new_user = <pytest_invenio.user.UserFixtureBase object at 0x7fae162fa750>
db = <SQLAlchemy postgresql+psycopg2://invenio:***@localhost:5432/invenio>

    @pytest.mark.parametrize(
        "actor,initial_role,new_role",
        [
            ("owner", "owner", "reader"),
            ("owner", "manager", "reader"),
            ("owner", "curator", "manager"),
            ("owner", "reader", "curator"),
            ("manager", "manager", "curator"),
            ("manager", "curator", "manager"),
            ("manager", "reader", "curator"),
        ],
    )
    def test_update_role_allowed(
        member_service, community, members, actor, initial_role, new_role, new_user, db
    ):
        """Owners can change role of all, managers all but owners."""
        # Add a new user with role
        data = {
            "members": [{"type": "user", "id": str(new_user.id)}],
            "role": initial_role,
        }
        member_service.add(system_identity, community._record.id, data)
        # Update the member with new role
        data = {
            "members": [{"type": "user", "id": str(new_user.id)}],
            "role": new_role,
        }
>       member_service.update(members[actor].identity, community._record.id, data)

tests/members/test_members_services.py:948: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.12/site-packages/invenio_db/uow.py:251: in inner
    res = f(self, *args, **kwargs)
          ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <invenio_communities.members.services.service.MemberService object at 0x7fae14f79bb0>
identity = <Identity id="2" auth_type="None" provides={Need(method='system_role', value='any_user'), Need(method='system_role', v...), Need(method='community', value='8ceb5c91-08e0-4a44-9c61-faf4dbfbfd2b', role='manager'), Need(method='id', value=2)}>
community_id = UUID('8ceb5c91-08e0-4a44-9c61-faf4dbfbfd2b')
data = {'members': [{'id': '5', 'type': 'user'}], 'role': Role(name='curator', title=l'Curator', description=l'Can curate rec... and view restricted records.', can_manage_roles=[], is_owner=False, can_manage=False, can_curate=True, can_view=True)}
uow = <invenio_db.uow.UnitOfWork object at 0x7fae12aea780>, refresh = False

    @unit_of_work()
    def update(self, identity, community_id, data, uow=None, refresh=False):
        """Bulk update.
    
        Used to update both active members and active invitations. Archived
        invitations cannot be updated.
        """
        community = self.community_cls.get_record(community_id)
    
        # Permission check - validates that:
        # - identity has permission to change any member at all (incl self)
        self.require_permission(
            identity,
            "members_bulk_update",
            record=community,
        )
    
        # Validate data (if there are errors, .load() raises)
        data, errors = self.update_schema.load(
            data,
            context={"identity": identity},
        )
    
        # Schema validates that role and/or visibility are defined.
        members = self.record_cls.get_members(community.id, members=data["members"])
        if len(members) != len(data["members"]):
            raise InvalidMemberError()
        role = data.get("role")
        visible = data.get("visible")
    
        # Perform updates (and check permissions)
        for m in members:
            self._update(identity, community, m, role, visible, uow)
    
        # Make sure we're not left owner-less if a role was changed.
        if role is not None:
            if not self.record_cls.has_members(
                community_id, role=current_roles.owner_role.name
            ):
>               raise ValidationError(
                    _("A community must have at least one owner."),
                )
E               marshmallow.exceptions.ValidationError: A community must have at least one owner.

invenio_communities/members/services/service.py:541: ValidationError
---------------------------- Captured stderr setup -----------------------------
MS PATCH Storing database values
Storing database values
Storing database values done
MS PATCH Stored
--------------------------- Captured stderr teardown ---------------------------
MS PATCH Rollback and original connection close
MS PATCH Purging database changes
Purging database values
Purging database values done
MS PATCH Purged and closed
___________ test_update_invitation_role_allowed[owner-owner-reader] ____________

member_service = <invenio_communities.members.services.service.MemberService object at 0x7fae14f79bb0>
community = <invenio_communities.communities.services.results.CommunityItem object at 0x7fae14a39d00>
members = {'curator': <pytest_invenio.user.UserFixtureBase object at 0x7fae18d7aa50>, 'manager': <pytest_invenio.user.UserFixtur...er.UserFixtureBase object at 0x7fae163c3b90>, 'reader': <pytest_invenio.user.UserFixtureBase object at 0x7fae14b6cc80>}
actor = 'owner', initial_role = 'owner', new_role = 'reader'
new_user = <pytest_invenio.user.UserFixtureBase object at 0x7fae162fa750>
db = <SQLAlchemy postgresql+psycopg2://invenio:***@localhost:5432/invenio>

    @pytest.mark.parametrize(
        "actor,initial_role,new_role",
        [
            ("owner", "owner", "reader"),
            ("owner", "manager", "reader"),
            ("owner", "curator", "manager"),
            ("owner", "reader", "curator"),
            ("manager", "manager", "curator"),
            ("manager", "curator", "manager"),
            ("manager", "reader", "curator"),
        ],
    )
    def test_update_invitation_role_allowed(
        member_service, community, members, actor, initial_role, new_role, new_user, db
    ):
        """Owners can change role of all, managers all but owners."""
        # Invite a new user with role
        data = {
            "members": [{"type": "user", "id": str(new_user.id)}],
            "role": initial_role,
        }
        member_service.invite(members[actor].identity, community._record.id, data)
    
        # Update the invitation with new role
        data = {
            "members": [{"type": "user", "id": str(new_user.id)}],
            "role": new_role,
        }
>       member_service.update(members[actor].identity, community._record.id, data)

tests/members/test_members_services.py:1014: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.12/site-packages/invenio_db/uow.py:251: in inner
    res = f(self, *args, **kwargs)
          ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <invenio_communities.members.services.service.MemberService object at 0x7fae14f79bb0>
identity = <Identity id="1" auth_type="None" provides={Need(method='community', value='8ceb5c91-08e0-4a44-9c61-faf4dbfbfd2b', rol...r'), Need(method='community', value='363c723c-cda8-42be-b7ae-8f23325572ea', role='owner'), Need(method='id', value=1)}>
community_id = UUID('8ceb5c91-08e0-4a44-9c61-faf4dbfbfd2b')
data = {'members': [{'id': '5', 'type': 'user'}], 'role': Role(name='reader', title=l'Reader', description=l'Can view restricted records.', can_manage_roles=[], is_owner=False, can_manage=False, can_curate=False, can_view=True)}
uow = <invenio_db.uow.UnitOfWork object at 0x7fae12caa420>, refresh = False

    @unit_of_work()
    def update(self, identity, community_id, data, uow=None, refresh=False):
        """Bulk update.
    
        Used to update both active members and active invitations. Archived
        invitations cannot be updated.
        """
        community = self.community_cls.get_record(community_id)
    
        # Permission check - validates that:
        # - identity has permission to change any member at all (incl self)
        self.require_permission(
            identity,
            "members_bulk_update",
            record=community,
        )
    
        # Validate data (if there are errors, .load() raises)
        data, errors = self.update_schema.load(
            data,
            context={"identity": identity},
        )
    
        # Schema validates that role and/or visibility are defined.
        members = self.record_cls.get_members(community.id, members=data["members"])
        if len(members) != len(data["members"]):
            raise InvalidMemberError()
        role = data.get("role")
        visible = data.get("visible")
    
        # Perform updates (and check permissions)
        for m in members:
            self._update(identity, community, m, role, visible, uow)
    
        # Make sure we're not left owner-less if a role was changed.
        if role is not None:
            if not self.record_cls.has_members(
                community_id, role=current_roles.owner_role.name
            ):
>               raise ValidationError(
                    _("A community must have at least one owner."),
                )
E               marshmallow.exceptions.ValidationError: A community must have at least one owner.

invenio_communities/members/services/service.py:541: ValidationError
---------------------------- Captured stderr setup -----------------------------
MS PATCH Storing database values
Storing database values
Storing database values done
MS PATCH Stored
----------------------------- Captured stdout call -----------------------------
Content-Type: multipart/mixed; boundary="===============8820393958482232952=="
MIME-Version: 1.0
Subject: =?utf-8?q?=F0=9F=93=AC_New_invitation_to_join_the_community_=27My_Community?=
 =?utf-8?q?=27_as_=27Owner=27?=
From: test@invenio-rdm-records.org
To: newuser@newuser.org
Date: Wed, 19 Nov 2025 17:05:43 +0000
Message-ID: <176357194319.3440.1096707918698588984@runnervmg1sw1.fitldde52jauziqwlxzvrlyhde.cx.internal.cloudapp.net>

--===============8820393958482232952==
Content-Type: multipart/alternative; boundary="===============0328041987491036463=="
MIME-Version: 1.0

--===============0328041987491036463==
Content-Type: text/plain; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit

You have been invited to join community 'My Community' as 'Owner'



Check out the invitation: https://127.0.0.1:5000/me/requests/256de476-b432-4a65-b1f2-7c3d1871de2d
--===============0328041987491036463==
Content-Type: text/html; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit

<table style="font-family:'Lato',Helvetica,Arial,sans-serif;border-spacing:15px">
    <tr>
        <td>You have been invited to join community 'My Community' as 'Owner'
        
        </td>
    </tr>
    <tr>
        
    </tr>
    <tr>
        <td><a href="https://127.0.0.1:5000/me/requests/256de476-b432-4a65-b1f2-7c3d1871de2d" class="button">Check out the invitation</a></td>
    </tr>
    <tr>
        <td><strong>_</strong></td>
    </tr>
    <tr>
        <td style="font-size:smaller">This is an auto-generated message. To manage notifications, visit your <a href="https://127.0.0.1:5000/account/settings/notifications/">account settings</a>.</td>
    </tr>
</table>
--===============0328041987491036463==--

--===============8820393958482232952==--

--------------------------- Captured stderr teardown ---------------------------
MS PATCH Rollback and original connection close
MS PATCH Purging database changes
Purging database values
Purging database values done
MS PATCH Purged and closed
__________ test_update_invitation_role_allowed[owner-manager-reader] ___________

member_service = <invenio_communities.members.services.service.MemberService object at 0x7fae14f79bb0>
community = <invenio_communities.communities.services.results.CommunityItem object at 0x7fae14a39d00>
members = {'curator': <pytest_invenio.user.UserFixtureBase object at 0x7fae18d7aa50>, 'manager': <pytest_invenio.user.UserFixtur...er.UserFixtureBase object at 0x7fae163c3b90>, 'reader': <pytest_invenio.user.UserFixtureBase object at 0x7fae14b6cc80>}
actor = 'owner', initial_role = 'manager', new_role = 'reader'
new_user = <pytest_invenio.user.UserFixtureBase object at 0x7fae162fa750>
db = <SQLAlchemy postgresql+psycopg2://invenio:***@localhost:5432/invenio>

    @pytest.mark.parametrize(
        "actor,initial_role,new_role",
        [
            ("owner", "owner", "reader"),
            ("owner", "manager", "reader"),
            ("owner", "curator", "manager"),
            ("owner", "reader", "curator"),
            ("manager", "manager", "curator"),
            ("manager", "curator", "manager"),
            ("manager", "reader", "curator"),
        ],
    )
    def test_update_invitation_role_allowed(
        member_service, community, members, actor, initial_role, new_role, new_user, db
    ):
        """Owners can change role of all, managers all but owners."""
        # Invite a new user with role
        data = {
            "members": [{"type": "user", "id": str(new_user.id)}],
            "role": initial_role,
        }
        member_service.invite(members[actor].identity, community._record.id, data)
    
        # Update the invitation with new role
        data = {
            "members": [{"type": "user", "id": str(new_user.id)}],
            "role": new_role,
        }
>       member_service.update(members[actor].identity, community._record.id, data)

tests/members/test_members_services.py:1014: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.12/site-packages/invenio_db/uow.py:251: in inner
    res = f(self, *args, **kwargs)
          ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <invenio_communities.members.services.service.MemberService object at 0x7fae14f79bb0>
identity = <Identity id="1" auth_type="None" provides={Need(method='community', value='8ceb5c91-08e0-4a44-9c61-faf4dbfbfd2b', rol...r'), Need(method='community', value='363c723c-cda8-42be-b7ae-8f23325572ea', role='owner'), Need(method='id', value=1)}>
community_id = UUID('8ceb5c91-08e0-4a44-9c61-faf4dbfbfd2b')
data = {'members': [{'id': '5', 'type': 'user'}], 'role': Role(name='reader', title=l'Reader', description=l'Can view restricted records.', can_manage_roles=[], is_owner=False, can_manage=False, can_curate=False, can_view=True)}
uow = <invenio_db.uow.UnitOfWork object at 0x7fae1574d820>, refresh = False

    @unit_of_work()
    def update(self, identity, community_id, data, uow=None, refresh=False):
        """Bulk update.
    
        Used to update both active members and active invitations. Archived
        invitations cannot be updated.
        """
        community = self.community_cls.get_record(community_id)
    
        # Permission check - validates that:
        # - identity has permission to change any member at all (incl self)
        self.require_permission(
            identity,
            "members_bulk_update",
            record=community,
        )
    
        # Validate data (if there are errors, .load() raises)
        data, errors = self.update_schema.load(
            data,
            context={"identity": identity},
        )
    
        # Schema validates that role and/or visibility are defined.
        members = self.record_cls.get_members(community.id, members=data["members"])
        if len(members) != len(data["members"]):
            raise InvalidMemberError()
        role = data.get("role")
        visible = data.get("visible")
    
        # Perform updates (and check permissions)
        for m in members:
            self._update(identity, community, m, role, visible, uow)
    
        # Make sure we're not left owner-less if a role was changed.
        if role is not None:
            if not self.record_cls.has_members(
                community_id, role=current_roles.owner_role.name
            ):
>               raise ValidationError(
                    _("A community must have at least one owner."),
                )
E               marshmallow.exceptions.ValidationError: A community must have at least one owner.

invenio_communities/members/services/service.py:541: ValidationError
---------------------------- Captured stderr setup -----------------------------
MS PATCH Storing database values
Storing database values
Storing database values done
MS PATCH Stored
----------------------------- Captured stdout call -----------------------------
Content-Type: multipart/mixed; boundary="===============1701739969925923295=="
MIME-Version: 1.0
Subject: =?utf-8?q?=F0=9F=93=AC_New_invitation_to_join_the_community_=27My_Community?=
 =?utf-8?q?=27_as_=27Manager=27?=
From: test@invenio-rdm-records.org
To: newuser@newuser.org
Date: Wed, 19 Nov 2025 17:05:43 +0000
Message-ID: <176357194392.3440.9592739456888098076@runnervmg1sw1.fitldde52jauziqwlxzvrlyhde.cx.internal.cloudapp.net>

--===============1701739969925923295==
Content-Type: multipart/alternative; boundary="===============3806251365840398624=="
MIME-Version: 1.0

--===============3806251365840398624==
Content-Type: text/plain; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit

You have been invited to join community 'My Community' as 'Manager'



Check out the invitation: https://127.0.0.1:5000/me/requests/2df95464-751f-48bf-b2b4-213d3b5d7894
--===============3806251365840398624==
Content-Type: text/html; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit

<table style="font-family:'Lato',Helvetica,Arial,sans-serif;border-spacing:15px">
    <tr>
        <td>You have been invited to join community 'My Community' as 'Manager'
        
        </td>
    </tr>
    <tr>
        
    </tr>
    <tr>
        <td><a href="https://127.0.0.1:5000/me/requests/2df95464-751f-48bf-b2b4-213d3b5d7894" class="button">Check out the invitation</a></td>
    </tr>
    <tr>
        <td><strong>_</strong></td>
    </tr>
    <tr>
        <td style="font-size:smaller">This is an auto-generated message. To manage notifications, visit your <a href="https://127.0.0.1:5000/account/settings/notifications/">account settings</a>.</td>
    </tr>
</table>
--===============3806251365840398624==--

--===============1701739969925923295==--

--------------------------- Captured stderr teardown ---------------------------
MS PATCH Rollback and original connection close
MS PATCH Purging database changes
Purging database values
Purging database values done
MS PATCH Purged and closed
__________ test_update_invitation_role_allowed[owner-curator-manager] __________

member_service = <invenio_communities.members.services.service.MemberService object at 0x7fae14f79bb0>
community = <invenio_communities.communities.services.results.CommunityItem object at 0x7fae14a39d00>
members = {'curator': <pytest_invenio.user.UserFixtureBase object at 0x7fae18d7aa50>, 'manager': <pytest_invenio.user.UserFixtur...er.UserFixtureBase object at 0x7fae163c3b90>, 'reader': <pytest_invenio.user.UserFixtureBase object at 0x7fae14b6cc80>}
actor = 'owner', initial_role = 'curator', new_role = 'manager'
new_user = <pytest_invenio.user.UserFixtureBase object at 0x7fae162fa750>
db = <SQLAlchemy postgresql+psycopg2://invenio:***@localhost:5432/invenio>

    @pytest.mark.parametrize(
        "actor,initial_role,new_role",
        [
            ("owner", "owner", "reader"),
            ("owner", "manager", "reader"),
            ("owner", "curator", "manager"),
            ("owner", "reader", "curator"),
            ("manager", "manager", "curator"),
            ("manager", "curator", "manager"),
            ("manager", "reader", "curator"),
        ],
    )
    def test_update_invitation_role_allowed(
        member_service, community, members, actor, initial_role, new_role, new_user, db
    ):
        """Owners can change role of all, managers all but owners."""
        # Invite a new user with role
        data = {
            "members": [{"type": "user", "id": str(new_user.id)}],
            "role": initial_role,
        }
        member_service.invite(members[actor].identity, community._record.id, data)
    
        # Update the invitation with new role
        data = {
            "members": [{"type": "user", "id": str(new_user.id)}],
            "role": new_role,
        }
>       member_service.update(members[actor].identity, community._record.id, data)

tests/members/test_members_services.py:1014: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.12/site-packages/invenio_db/uow.py:251: in inner
    res = f(self, *args, **kwargs)
          ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <invenio_communities.members.services.service.MemberService object at 0x7fae14f79bb0>
identity = <Identity id="1" auth_type="None" provides={Need(method='community', value='8ceb5c91-08e0-4a44-9c61-faf4dbfbfd2b', rol...r'), Need(method='community', value='363c723c-cda8-42be-b7ae-8f23325572ea', role='owner'), Need(method='id', value=1)}>
community_id = UUID('8ceb5c91-08e0-4a44-9c61-faf4dbfbfd2b')
data = {'members': [{'id': '5', 'type': 'user'}], 'role': Role(name='manager', title=l'Manager', description=l'Can manage mem...', can_manage_roles=['manager', 'curator', 'reader'], is_owner=False, can_manage=True, can_curate=True, can_view=True)}
uow = <invenio_db.uow.UnitOfWork object at 0x7fae18d57da0>, refresh = False

    @unit_of_work()
    def update(self, identity, community_id, data, uow=None, refresh=False):
        """Bulk update.
    
        Used to update both active members and active invitations. Archived
        invitations cannot be updated.
        """
        community = self.community_cls.get_record(community_id)
    
        # Permission check - validates that:
        # - identity has permission to change any member at all (incl self)
        self.require_permission(
            identity,
            "members_bulk_update",
            record=community,
        )
    
        # Validate data (if there are errors, .load() raises)
        data, errors = self.update_schema.load(
            data,
            context={"identity": identity},
        )
    
        # Schema validates that role and/or visibility are defined.
        members = self.record_cls.get_members(community.id, members=data["members"])
        if len(members) != len(data["members"]):
            raise InvalidMemberError()
        role = data.get("role")
        visible = data.get("visible")
    
        # Perform updates (and check permissions)
        for m in members:
            self._update(identity, community, m, role, visible, uow)
    
        # Make sure we're not left owner-less if a role was changed.
        if role is not None:
            if not self.record_cls.has_members(
                community_id, role=current_roles.owner_role.name
            ):
>               raise ValidationError(
                    _("A community must have at least one owner."),
                )
E               marshmallow.exceptions.ValidationError: A community must have at least one owner.

invenio_communities/members/services/service.py:541: ValidationError
---------------------------- Captured stderr setup -----------------------------
MS PATCH Storing database values
Storing database values
Storing database values done
MS PATCH Stored
----------------------------- Captured stdout call -----------------------------
Content-Type: multipart/mixed; boundary="===============4100820373106916628=="
MIME-Version: 1.0
Subject: =?utf-8?q?=F0=9F=93=AC_New_invitation_to_join_the_community_=27My_Community?=
 =?utf-8?q?=27_as_=27Curator=27?=
From: test@invenio-rdm-records.org
To: newuser@newuser.org
Date: Wed, 19 Nov 2025 17:05:44 +0000
Message-ID: <176357194465.3440.7387164732363365293@runnervmg1sw1.fitldde52jauziqwlxzvrlyhde.cx.internal.cloudapp.net>

--===============4100820373106916628==
Content-Type: multipart/alternative; boundary="===============2095614313411386887=="
MIME-Version: 1.0

--===============2095614313411386887==
Content-Type: text/plain; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit

You have been invited to join community 'My Community' as 'Curator'



Check out the invitation: https://127.0.0.1:5000/me/requests/14b8ed60-41a7-478b-9c9e-dc31cbcf0ba8
--===============2095614313411386887==
Content-Type: text/html; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit

<table style="font-family:'Lato',Helvetica,Arial,sans-serif;border-spacing:15px">
    <tr>
        <td>You have been invited to join community 'My Community' as 'Curator'
        
        </td>
    </tr>
    <tr>
        
    </tr>
    <tr>
        <td><a href="https://127.0.0.1:5000/me/requests/14b8ed60-41a7-478b-9c9e-dc31cbcf0ba8" class="button">Check out the invitation</a></td>
    </tr>
    <tr>
        <td><strong>_</strong></td>
    </tr>
    <tr>
        <td style="font-size:smaller">This is an auto-generated message. To manage notifications, visit your <a href="https://127.0.0.1:5000/account/settings/notifications/">account settings</a>.</td>
    </tr>
</table>
--===============2095614313411386887==--

--===============4100820373106916628==--

--------------------------- Captured stderr teardown ---------------------------
MS PATCH Rollback and original connection close
MS PATCH Purging database changes
Purging database values
Purging database values done
MS PATCH Purged and closed
__________ test_update_invitation_role_allowed[owner-reader-curator] ___________

member_service = <invenio_communities.members.services.service.MemberService object at 0x7fae14f79bb0>
community = <invenio_communities.communities.services.results.CommunityItem object at 0x7fae14a39d00>
members = {'curator': <pytest_invenio.user.UserFixtureBase object at 0x7fae18d7aa50>, 'manager': <pytest_invenio.user.UserFixtur...er.UserFixtureBase object at 0x7fae163c3b90>, 'reader': <pytest_invenio.user.UserFixtureBase object at 0x7fae14b6cc80>}
actor = 'owner', initial_role = 'reader', new_role = 'curator'
new_user = <pytest_invenio.user.UserFixtureBase object at 0x7fae162fa750>
db = <SQLAlchemy postgresql+psycopg2://invenio:***@localhost:5432/invenio>

    @pytest.mark.parametrize(
        "actor,initial_role,new_role",
        [
            ("owner", "owner", "reader"),
            ("owner", "manager", "reader"),
            ("owner", "curator", "manager"),
            ("owner", "reader", "curator"),
            ("manager", "manager", "curator"),
            ("manager", "curator", "manager"),
            ("manager", "reader", "curator"),
        ],
    )
    def test_update_invitation_role_allowed(
        member_service, community, members, actor, initial_role, new_role, new_user, db
    ):
        """Owners can change role of all, managers all but owners."""
        # Invite a new user with role
        data = {
            "members": [{"type": "user", "id": str(new_user.id)}],
            "role": initial_role,
        }
        member_service.invite(members[actor].identity, community._record.id, data)
    
        # Update the invitation with new role
        data = {
            "members": [{"type": "user", "id": str(new_user.id)}],
            "role": new_role,
        }
>       member_service.update(members[actor].identity, community._record.id, data)

tests/members/test_members_services.py:1014: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.12/site-packages/invenio_db/uow.py:251: in inner
    res = f(self, *args, **kwargs)
          ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <invenio_communities.members.services.service.MemberService object at 0x7fae14f79bb0>
identity = <Identity id="1" auth_type="None" provides={Need(method='community', value='8ceb5c91-08e0-4a44-9c61-faf4dbfbfd2b', rol...r'), Need(method='community', value='363c723c-cda8-42be-b7ae-8f23325572ea', role='owner'), Need(method='id', value=1)}>
community_id = UUID('8ceb5c91-08e0-4a44-9c61-faf4dbfbfd2b')
data = {'members': [{'id': '5', 'type': 'user'}], 'role': Role(name='curator', title=l'Curator', description=l'Can curate rec... and view restricted records.', can_manage_roles=[], is_owner=False, can_manage=False, can_curate=True, can_view=True)}
uow = <invenio_db.uow.UnitOfWork object at 0x7fae160cf6e0>, refresh = False

    @unit_of_work()
    def update(self, identity, community_id, data, uow=None, refresh=False):
        """Bulk update.
    
        Used to update both active members and active invitations. Archived
        invitations cannot be updated.
        """
        community = self.community_cls.get_record(community_id)
    
        # Permission check - validates that:
        # - identity has permission to change any member at all (incl self)
        self.require_permission(
            identity,
            "members_bulk_update",
            record=community,
        )
    
        # Validate data (if there are errors, .load() raises)
        data, errors = self.update_schema.load(
            data,
            context={"identity": identity},
        )
    
        # Schema validates that role and/or visibility are defined.
        members = self.record_cls.get_members(community.id, members=data["members"])
        if len(members) != len(data["members"]):
            raise InvalidMemberError()
        role = data.get("role")
        visible = data.get("visible")
    
        # Perform updates (and check permissions)
        for m in members:
            self._update(identity, community, m, role, visible, uow)
    
        # Make sure we're not left owner-less if a role was changed.
        if role is not None:
            if not self.record_cls.has_members(
                community_id, role=current_roles.owner_role.name
            ):
>               raise ValidationError(
                    _("A community must have at least one owner."),
                )
E               marshmallow.exceptions.ValidationError: A community must have at least one owner.

invenio_communities/members/services/service.py:541: ValidationError
---------------------------- Captured stderr setup -----------------------------
MS PATCH Storing database values
Storing database values
Storing database values done
MS PATCH Stored
----------------------------- Captured stdout call -----------------------------
Content-Type: multipart/mixed; boundary="===============1041938852765488217=="
MIME-Version: 1.0
Subject: =?utf-8?q?=F0=9F=93=AC_New_invitation_to_join_the_community_=27My_Community?=
 =?utf-8?q?=27_as_=27Reader=27?=
From: test@invenio-rdm-records.org
To: newuser@newuser.org
Date: Wed, 19 Nov 2025 17:05:45 +0000
Message-ID: <176357194537.3440.9443309879592328636@runnervmg1sw1.fitldde52jauziqwlxzvrlyhde.cx.internal.cloudapp.net>

--===============1041938852765488217==
Content-Type: multipart/alternative; boundary="===============9090098671631231098=="
MIME-Version: 1.0

--===============9090098671631231098==
Content-Type: text/plain; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit

You have been invited to join community 'My Community' as 'Reader'



Check out the invitation: https://127.0.0.1:5000/me/requests/475f4a40-b549-4036-aadf-b07c5b56751b
--===============9090098671631231098==
Content-Type: text/html; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit

<table style="font-family:'Lato',Helvetica,Arial,sans-serif;border-spacing:15px">
    <tr>
        <td>You have been invited to join community 'My Community' as 'Reader'
        
        </td>
    </tr>
    <tr>
        
    </tr>
    <tr>
        <td><a href="https://127.0.0.1:5000/me/requests/475f4a40-b549-4036-aadf-b07c5b56751b" class="button">Check out the invitation</a></td>
    </tr>
    <tr>
        <td><strong>_</strong></td>
    </tr>
    <tr>
        <td style="font-size:smaller">This is an auto-generated message. To manage notifications, visit your <a href="https://127.0.0.1:5000/account/settings/notifications/">account settings</a>.</td>
    </tr>
</table>
--===============9090098671631231098==--

--===============1041938852765488217==--

--------------------------- Captured stderr teardown ---------------------------
MS PATCH Rollback and original connection close
MS PATCH Purging database changes
Purging database values
Purging database values done
MS PATCH Purged and closed
_________ test_update_invitation_role_allowed[manager-manager-curator] _________

member_service = <invenio_communities.members.services.service.MemberService object at 0x7fae14f79bb0>
community = <invenio_communities.communities.services.results.CommunityItem object at 0x7fae14a39d00>
members = {'curator': <pytest_invenio.user.UserFixtureBase object at 0x7fae18d7aa50>, 'manager': <pytest_invenio.user.UserFixtur...er.UserFixtureBase object at 0x7fae163c3b90>, 'reader': <pytest_invenio.user.UserFixtureBase object at 0x7fae14b6cc80>}
actor = 'manager', initial_role = 'manager', new_role = 'curator'
new_user = <pytest_invenio.user.UserFixtureBase object at 0x7fae162fa750>
db = <SQLAlchemy postgresql+psycopg2://invenio:***@localhost:5432/invenio>

    @pytest.mark.parametrize(
        "actor,initial_role,new_role",
        [
            ("owner", "owner", "reader"),
            ("owner", "manager", "reader"),
            ("owner", "curator", "manager"),
            ("owner", "reader", "curator"),
            ("manager", "manager", "curator"),
            ("manager", "curator", "manager"),
            ("manager", "reader", "curator"),
        ],
    )
    def test_update_invitation_role_allowed(
        member_service, community, members, actor, initial_role, new_role, new_user, db
    ):
        """Owners can change role of all, managers all but owners."""
        # Invite a new user with role
        data = {
            "members": [{"type": "user", "id": str(new_user.id)}],
            "role": initial_role,
        }
        member_service.invite(members[actor].identity, community._record.id, data)
    
        # Update the invitation with new role
        data = {
            "members": [{"type": "user", "id": str(new_user.id)}],
            "role": new_role,
        }
>       member_service.update(members[actor].identity, community._record.id, data)

tests/members/test_members_services.py:1014: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.12/site-packages/invenio_db/uow.py:251: in inner
    res = f(self, *args, **kwargs)
          ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <invenio_communities.members.services.service.MemberService object at 0x7fae14f79bb0>
identity = <Identity id="2" auth_type="None" provides={Need(method='system_role', value='any_user'), Need(method='system_role', v...), Need(method='community', value='8ceb5c91-08e0-4a44-9c61-faf4dbfbfd2b', role='manager'), Need(method='id', value=2)}>
community_id = UUID('8ceb5c91-08e0-4a44-9c61-faf4dbfbfd2b')
data = {'members': [{'id': '5', 'type': 'user'}], 'role': Role(name='curator', title=l'Curator', description=l'Can curate rec... and view restricted records.', can_manage_roles=[], is_owner=False, can_manage=False, can_curate=True, can_view=True)}
uow = <invenio_db.uow.UnitOfWork object at 0x7fae18bf08f0>, refresh = False

    @unit_of_work()
    def update(self, identity, community_id, data, uow=None, refresh=False):
        """Bulk update.
    
        Used to update both active members and active invitations. Archived
        invitations cannot be updated.
        """
        community = self.community_cls.get_record(community_id)
    
        # Permission check - validates that:
        # - identity has permission to change any member at all (incl self)
        self.require_permission(
            identity,
            "members_bulk_update",
            record=community,
        )
    
        # Validate data (if there are errors, .load() raises)
        data, errors = self.update_schema.load(
            data,
            context={"identity": identity},
        )
    
        # Schema validates that role and/or visibility are defined.
        members = self.record_cls.get_members(community.id, members=data["members"])
        if len(members) != len(data["members"]):
            raise InvalidMemberError()
        role = data.get("role")
        visible = data.get("visible")
    
        # Perform updates (and check permissions)
        for m in members:
            self._update(identity, community, m, role, visible, uow)
    
        # Make sure we're not left owner-less if a role was changed.
        if role is not None:
            if not self.record_cls.has_members(
                community_id, role=current_roles.owner_role.name
            ):
>               raise ValidationError(
                    _("A community must have at least one owner."),
                )
E               marshmallow.exceptions.ValidationError: A community must have at least one owner.

invenio_communities/members/services/service.py:541: ValidationError
---------------------------- Captured stderr setup -----------------------------
MS PATCH Storing database values
Storing database values
Storing database values done
MS PATCH Stored
----------------------------- Captured stdout call -----------------------------
Content-Type: multipart/mixed; boundary="===============4772914916593087515=="
MIME-Version: 1.0
Subject: =?utf-8?q?=F0=9F=93=AC_New_invitation_to_join_the_community_=27My_Community?=
 =?utf-8?q?=27_as_=27Manager=27?=
From: test@invenio-rdm-records.org
To: newuser@newuser.org
Date: Wed, 19 Nov 2025 17:05:46 +0000
Message-ID: <176357194612.3440.7607542001776563210@runnervmg1sw1.fitldde52jauziqwlxzvrlyhde.cx.internal.cloudapp.net>

--===============4772914916593087515==
Content-Type: multipart/alternative; boundary="===============6545531439892412424=="
MIME-Version: 1.0

--===============6545531439892412424==
Content-Type: text/plain; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit

You have been invited to join community 'My Community' as 'Manager'



Check out the invitation: https://127.0.0.1:5000/me/requests/13d79b63-40f9-4454-ac41-b79eeb7da4cd
--===============6545531439892412424==
Content-Type: text/html; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit

<table style="font-family:'Lato',Helvetica,Arial,sans-serif;border-spacing:15px">
    <tr>
        <td>You have been invited to join community 'My Community' as 'Manager'
        
        </td>
    </tr>
    <tr>
        
    </tr>
    <tr>
        <td><a href="https://127.0.0.1:5000/me/requests/13d79b63-40f9-4454-ac41-b79eeb7da4cd" class="button">Check out the invitation</a></td>
    </tr>
    <tr>
        <td><strong>_</strong></td>
    </tr>
    <tr>
        <td style="font-size:smaller">This is an auto-generated message. To manage notifications, visit your <a href="https://127.0.0.1:5000/account/settings/notifications/">account settings</a>.</td>
    </tr>
</table>
--===============6545531439892412424==--

--===============4772914916593087515==--

--------------------------- Captured stderr teardown ---------------------------
MS PATCH Rollback and original connection close
MS PATCH Purging database changes
Purging database values
Purging database values done
MS PATCH Purged and closed
_________ test_update_invitation_role_allowed[manager-curator-manager] _________

member_service = <invenio_communities.members.services.service.MemberService object at 0x7fae14f79bb0>
community = <invenio_communities.communities.services.results.CommunityItem object at 0x7fae14a39d00>
members = {'curator': <pytest_invenio.user.UserFixtureBase object at 0x7fae18d7aa50>, 'manager': <pytest_invenio.user.UserFixtur...er.UserFixtureBase object at 0x7fae163c3b90>, 'reader': <pytest_invenio.user.UserFixtureBase object at 0x7fae14b6cc80>}
actor = 'manager', initial_role = 'curator', new_role = 'manager'
new_user = <pytest_invenio.user.UserFixtureBase object at 0x7fae162fa750>
db = <SQLAlchemy postgresql+psycopg2://invenio:***@localhost:5432/invenio>

    @pytest.mark.parametrize(
        "actor,initial_role,new_role",
        [
            ("owner", "owner", "reader"),
            ("owner", "manager", "reader"),
            ("owner", "curator", "manager"),
            ("owner", "reader", "curator"),
            ("manager", "manager", "curator"),
            ("manager", "curator", "manager"),
            ("manager", "reader", "curator"),
        ],
    )
    def test_update_invitation_role_allowed(
        member_service, community, members, actor, initial_role, new_role, new_user, db
    ):
        """Owners can change role of all, managers all but owners."""
        # Invite a new user with role
        data = {
            "members": [{"type": "user", "id": str(new_user.id)}],
            "role": initial_role,
        }
        member_service.invite(members[actor].identity, community._record.id, data)
    
        # Update the invitation with new role
        data = {
            "members": [{"type": "user", "id": str(new_user.id)}],
            "role": new_role,
        }
>       member_service.update(members[actor].identity, community._record.id, data)

tests/members/test_members_services.py:1014: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.12/site-packages/invenio_db/uow.py:251: in inner
    res = f(self, *args, **kwargs)
          ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <invenio_communities.members.services.service.MemberService object at 0x7fae14f79bb0>
identity = <Identity id="2" auth_type="None" provides={Need(method='system_role', value='any_user'), Need(method='system_role', v...), Need(method='community', value='8ceb5c91-08e0-4a44-9c61-faf4dbfbfd2b', role='manager'), Need(method='id', value=2)}>
community_id = UUID('8ceb5c91-08e0-4a44-9c61-faf4dbfbfd2b')
data = {'members': [{'id': '5', 'type': 'user'}], 'role': Role(name='manager', title=l'Manager', description=l'Can manage mem...', can_manage_roles=['manager', 'curator', 'reader'], is_owner=False, can_manage=True, can_curate=True, can_view=True)}
uow = <invenio_db.uow.UnitOfWork object at 0x7fae145359d0>, refresh = False

    @unit_of_work()
    def update(self, identity, community_id, data, uow=None, refresh=False):
        """Bulk update.
    
        Used to update both active members and active invitations. Archived
        invitations cannot be updated.
        """
        community = self.community_cls.get_record(community_id)
    
        # Permission check - validates that:
        # - identity has permission to change any member at all (incl self)
        self.require_permission(
            identity,
            "members_bulk_update",
            record=community,
        )
    
        # Validate data (if there are errors, .load() raises)
        data, errors = self.update_schema.load(
            data,
            context={"identity": identity},
        )
    
        # Schema validates that role and/or visibility are defined.
        members = self.record_cls.get_members(community.id, members=data["members"])
        if len(members) != len(data["members"]):
            raise InvalidMemberError()
        role = data.get("role")
        visible = data.get("visible")
    
        # Perform updates (and check permissions)
        for m in members:
            self._update(identity, community, m, role, visible, uow)
    
        # Make sure we're not left owner-less if a role was changed.
        if role is not None:
            if not self.record_cls.has_members(
                community_id, role=current_roles.owner_role.name
            ):
>               raise ValidationError(
                    _("A community must have at least one owner."),
                )
E               marshmallow.exceptions.ValidationError: A community must have at least one owner.

invenio_communities/members/services/service.py:541: ValidationError
---------------------------- Captured stderr setup -----------------------------
MS PATCH Storing database values
Storing database values
Storing database values done
MS PATCH Stored
----------------------------- Captured stdout call -----------------------------
Content-Type: multipart/mixed; boundary="===============5103875693964683552=="
MIME-Version: 1.0
Subject: =?utf-8?q?=F0=9F=93=AC_New_invitation_to_join_the_community_=27My_Community?=
 =?utf-8?q?=27_as_=27Curator=27?=
From: test@invenio-rdm-records.org
To: newuser@newuser.org
Date: Wed, 19 Nov 2025 17:05:46 +0000
Message-ID: <176357194684.3440.163235782404081681@runnervmg1sw1.fitldde52jauziqwlxzvrlyhde.cx.internal.cloudapp.net>

--===============5103875693964683552==
Content-Type: multipart/alternative; boundary="===============2202764117537718480=="
MIME-Version: 1.0

--===============2202764117537718480==
Content-Type: text/plain; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit

You have been invited to join community 'My Community' as 'Curator'



Check out the invitation: https://127.0.0.1:5000/me/requests/aae7a359-511e-486a-98d1-d037e757ecb3
--===============2202764117537718480==
Content-Type: text/html; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit

<table style="font-family:'Lato',Helvetica,Arial,sans-serif;border-spacing:15px">
    <tr>
        <td>You have been invited to join community 'My Community' as 'Curator'
        
        </td>
    </tr>
    <tr>
        
    </tr>
    <tr>
        <td><a href="https://127.0.0.1:5000/me/requests/aae7a359-511e-486a-98d1-d037e757ecb3" class="button">Check out the invitation</a></td>
    </tr>
    <tr>
        <td><strong>_</strong></td>
    </tr>
    <tr>
        <td style="font-size:smaller">This is an auto-generated message. To manage notifications, visit your <a href="https://127.0.0.1:5000/account/settings/notifications/">account settings</a>.</td>
    </tr>
</table>
--===============2202764117537718480==--

--===============5103875693964683552==--

--------------------------- Captured stderr teardown ---------------------------
MS PATCH Rollback and original connection close
MS PATCH Purging database changes
Purging database values
Purging database values done
MS PATCH Purged and closed
_________ test_update_invitation_role_allowed[manager-reader-curator] __________

member_service = <invenio_communities.members.services.service.MemberService object at 0x7fae14f79bb0>
community = <invenio_communities.communities.services.results.CommunityItem object at 0x7fae14a39d00>
members = {'curator': <pytest_invenio.user.UserFixtureBase object at 0x7fae18d7aa50>, 'manager': <pytest_invenio.user.UserFixtur...er.UserFixtureBase object at 0x7fae163c3b90>, 'reader': <pytest_invenio.user.UserFixtureBase object at 0x7fae14b6cc80>}
actor = 'manager', initial_role = 'reader', new_role = 'curator'
new_user = <pytest_invenio.user.UserFixtureBase object at 0x7fae162fa750>
db = <SQLAlchemy postgresql+psycopg2://invenio:***@localhost:5432/invenio>

    @pytest.mark.parametrize(
        "actor,initial_role,new_role",
        [
            ("owner", "owner", "reader"),
            ("owner", "manager", "reader"),
            ("owner", "curator", "manager"),
            ("owner", "reader", "curator"),
            ("manager", "manager", "curator"),
            ("manager", "curator", "manager"),
            ("manager", "reader", "curator"),
        ],
    )
    def test_update_invitation_role_allowed(
        member_service, community, members, actor, initial_role, new_role, new_user, db
    ):
        """Owners can change role of all, managers all but owners."""
        # Invite a new user with role
        data = {
            "members": [{"type": "user", "id": str(new_user.id)}],
            "role": initial_role,
        }
        member_service.invite(members[actor].identity, community._record.id, data)
    
        # Update the invitation with new role
        data = {
            "members": [{"type": "user", "id": str(new_user.id)}],
            "role": new_role,
        }
>       member_service.update(members[actor].identity, community._record.id, data)

tests/members/test_members_services.py:1014: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.12/site-packages/invenio_db/uow.py:251: in inner
    res = f(self, *args, **kwargs)
          ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <invenio_communities.members.services.service.MemberService object at 0x7fae14f79bb0>
identity = <Identity id="2" auth_type="None" provides={Need(method='system_role', value='any_user'), Need(method='system_role', v...), Need(method='community', value='8ceb5c91-08e0-4a44-9c61-faf4dbfbfd2b', role='manager'), Need(method='id', value=2)}>
community_id = UUID('8ceb5c91-08e0-4a44-9c61-faf4dbfbfd2b')
data = {'members': [{'id': '5', 'type': 'user'}], 'role': Role(name='curator', title=l'Curator', description=l'Can curate rec... and view restricted records.', can_manage_roles=[], is_owner=False, can_manage=False, can_curate=True, can_view=True)}
uow = <invenio_db.uow.UnitOfWork object at 0x7fae123a21e0>, refresh = False

    @unit_of_work()
    def update(self, identity, community_id, data, uow=None, refresh=False):
        """Bulk update.
    
        Used to update both active members and active invitations. Archived
        invitations cannot be updated.
        """
        community = self.community_cls.get_record(community_id)
    
        # Permission check - validates that:
        # - identity has permission to change any member at all (incl self)
        self.require_permission(
            identity,
            "members_bulk_update",
            record=community,
        )
    
        # Validate data (if there are errors, .load() raises)
        data, errors = self.update_schema.load(
            data,
            context={"identity": identity},
        )
    
        # Schema validates that role and/or visibility are defined.
        members = self.record_cls.get_members(community.id, members=data["members"])
        if len(members) != len(data["members"]):
            raise InvalidMemberError()
        role = data.get("role")
        visible = data.get("visible")
    
        # Perform updates (and check permissions)
        for m in members:
            self._update(identity, community, m, role, visible, uow)
    
        # Make sure we're not left owner-less if a role was changed.
        if role is not None:
            if not self.record_cls.has_members(
                community_id, role=current_roles.owner_role.name
            ):
>               raise ValidationError(
                    _("A community must have at least one owner."),
                )
E               marshmallow.exceptions.ValidationError: A community must have at least one owner.

invenio_communities/members/services/service.py:541: ValidationError
---------------------------- Captured stderr setup -----------------------------
MS PATCH Storing database values
Storing database values
Storing database values done
MS PATCH Stored
----------------------------- Captured stdout call -----------------------------
Content-Type: multipart/mixed; boundary="===============4387513757325783000=="
MIME-Version: 1.0
Subject: =?utf-8?q?=F0=9F=93=AC_New_invitation_to_join_the_community_=27My_Community?=
 =?utf-8?q?=27_as_=27Reader=27?=
From: test@invenio-rdm-records.org
To: newuser@newuser.org
Date: Wed, 19 Nov 2025 17:05:47 +0000
Message-ID: <176357194757.3440.8939566086508808171@runnervmg1sw1.fitldde52jauziqwlxzvrlyhde.cx.internal.cloudapp.net>

--===============4387513757325783000==
Content-Type: multipart/alternative; boundary="===============3265432449909097679=="
MIME-Version: 1.0

--===============3265432449909097679==
Content-Type: text/plain; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit

You have been invited to join community 'My Community' as 'Reader'



Check out the invitation: https://127.0.0.1:5000/me/requests/960c7344-b7e1-4913-ad56-6d1637edfd29
--===============3265432449909097679==
Content-Type: text/html; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit

<table style="font-family:'Lato',Helvetica,Arial,sans-serif;border-spacing:15px">
    <tr>
        <td>You have been invited to join community 'My Community' as 'Reader'
        
        </td>
    </tr>
    <tr>
        
    </tr>
    <tr>
        <td><a href="https://127.0.0.1:5000/me/requests/960c7344-b7e1-4913-ad56-6d1637edfd29" class="button">Check out the invitation</a></td>
    </tr>
    <tr>
        <td><strong>_</strong></td>
    </tr>
    <tr>
        <td style="font-size:smaller">This is an auto-generated message. To manage notifications, visit your <a href="https://127.0.0.1:5000/account/settings/notifications/">account settings</a>.</td>
    </tr>
</table>
--===============3265432449909097679==--

--===============4387513757325783000==--

--------------------------- Captured stderr teardown ---------------------------
MS PATCH Rollback and original connection close
MS PATCH Purging database changes
Purging database values
Purging database values done
MS PATCH Purged and closed
_______________________ test_update_role_must_have_owner _______________________

member_service = <invenio_communities.members.services.service.MemberService object at 0x7fae14f79bb0>
community = <invenio_communities.communities.services.results.CommunityItem object at 0x7fae14a39d00>
owner = <pytest_invenio.user.UserFixtureBase object at 0x7fae163c3b90>
group = <Role it-dep>
db = <SQLAlchemy postgresql+psycopg2://invenio:***@localhost:5432/invenio>

    def test_update_role_must_have_owner(member_service, community, owner, group, db):
        """There must always be at least one owner."""
        # Add an owner group
        data = {
            "members": [{"type": "group", "id": group.name}],
            "role": "owner",
        }
        member_service.add(system_identity, community._record.id, data)
    
        # Update the both owners with manager role using system_identity
        data = {
            "members": [
                {"type": "group", "id": group.name},
                {"type": "user", "id": str(owner.id)},
            ],
            "role": "manager",
        }
>       pytest.raises(
            ValidationError,
            member_service.update,
            system_identity,
            community._record.id,
            data,
        )

tests/members/test_members_services.py:1100: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.12/site-packages/invenio_db/uow.py:251: in inner
    res = f(self, *args, **kwargs)
          ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <invenio_communities.members.services.service.MemberService object at 0x7fae14f79bb0>
identity = <Identity id="system" auth_type="None" provides={Need(method='system_role', value='system_process')}>
community_id = UUID('8ceb5c91-08e0-4a44-9c61-faf4dbfbfd2b')
data = {'members': [{'id': 'it-dep', 'type': 'group'}, {'id': '1', 'type': 'user'}], 'role': Role(name='manager', title=l'Man...', can_manage_roles=['manager', 'curator', 'reader'], is_owner=False, can_manage=True, can_curate=True, can_view=True)}
uow = <invenio_db.uow.UnitOfWork object at 0x7fae13bef620>, refresh = False

    @unit_of_work()
    def update(self, identity, community_id, data, uow=None, refresh=False):
        """Bulk update.
    
        Used to update both active members and active invitations. Archived
        invitations cannot be updated.
        """
        community = self.community_cls.get_record(community_id)
    
        # Permission check - validates that:
        # - identity has permission to change any member at all (incl self)
        self.require_permission(
            identity,
            "members_bulk_update",
            record=community,
        )
    
        # Validate data (if there are errors, .load() raises)
        data, errors = self.update_schema.load(
            data,
            context={"identity": identity},
        )
    
        # Schema validates that role and/or visibility are defined.
        members = self.record_cls.get_members(community.id, members=data["members"])
        if len(members) != len(data["members"]):
>           raise InvalidMemberError()
E           invenio_communities.members.errors.InvalidMemberError

invenio_communities/members/services/service.py:528: InvalidMemberError
---------------------------- Captured stderr setup -----------------------------
MS PATCH Storing database values
Storing database values
Storing database values done
MS PATCH Stored
--------------------------- Captured stderr teardown ---------------------------
MS PATCH Rollback and original connection close
MS PATCH Purging database changes
Purging database values
Purging database values done
MS PATCH Purged and closed
=============================== warnings summary ===============================
.venv/lib/python3.12/site-packages/passlib/utils/__init__.py:854
    from crypt import crypt as _crypt

.venv/lib/python3.12/site-packages/marshmallow_utils/fields/generated.py:12
.venv/lib/python3.12/site-packages/marshmallow_utils/fields/generated.py:12
    from marshmallow import __version_info__ as marshmallow_version

.venv/lib/python3.12/site-packages/jsonresolver/contrib/jsonschema.py:31
.venv/lib/python3.12/site-packages/jsonresolver/contrib/jsonschema.py:31
    from jsonschema import RefResolver as _RefResolver

.venv/lib/python3.12/site-packages/invenio_records/resolver.py:14
.venv/lib/python3.12/site-packages/invenio_records/resolver.py:14
    from jsonschema import RefResolutionError, RefResolver

.venv/lib/python3.12/site-packages/invenio_records/resolver.py:14
.venv/lib/python3.12/site-packages/invenio_records/resolver.py:14
    from jsonschema import RefResolutionError, RefResolver

.venv/lib/python3.12/site-packages/fs/__init__.py:4
    __import__("pkg_resources").declare_namespace(__name__)  # type: ignore

.venv/lib/python3.12/site-packages/pkg_resources/__init__.py:3146
  Implementing implicit namespace packages (as specified in PEP 420) is preferred to `pkg_resources.declare_namespace`. See https://setuptools.pypa.io/en/latest/references/keywords.html#keyword-namespace-packages
    declare_namespace(pkg)

.venv/lib/python3.12/site-packages/fs/__init__.py:4
  Implementing implicit namespace packages (as specified in PEP 420) is preferred to `pkg_resources.declare_namespace`. See https://setuptools.pypa.io/en/latest/references/keywords.html#keyword-namespace-packages
    __import__("pkg_resources").declare_namespace(__name__)  # type: ignore

.venv/lib/python3.12/site-packages/fs/opener/__init__.py:6
  Implementing implicit namespace packages (as specified in PEP 420) is preferred to `pkg_resources.declare_namespace`. See https://setuptools.pypa.io/en/latest/references/keywords.html#keyword-namespace-packages
    __import__("pkg_resources").declare_namespace(__name__)  # type: ignore

.venv/lib/python3.12/site-packages/pkg_resources/__init__.py:2558
  Implementing implicit namespace packages (as specified in PEP 420) is preferred to `pkg_resources.declare_namespace`. See https://setuptools.pypa.io/en/latest/references/keywords.html#keyword-namespace-packages
    declare_namespace(parent)

    warnings.warn(

.venv/lib/python3.12/site-packages/invenio_vocabularies/config.py:15
    from idutils import is_doi, is_gnd, is_isni, is_orcid, is_ror, is_url

.venv/lib/python3.12/site-packages/marshmallow/utils.py:361
.venv/lib/python3.12/site-packages/marshmallow/utils.py:361
  /home/runner/work/invenio-testrig/invenio-testrig/package-repo/.venv/lib/python3.12/site-packages/marshmallow/utils.py:361: ChangedInMarshmallow4Warning: `Field` should not be instantiated. Use `fields.Raw` or  another field subclass instead.
    return cls_or_instance()

    self.init_app(app)

    warnings.warn(

    self._set_cache(app, config)

    return util.wrap_callable(lambda ctx: fn(), fn)  # type: ignore

    self._confirmed = datetime.utcnow() if confirmed else None

    datetime.utcnow()

  /home/runner/work/invenio-testrig/invenio-testrig/package-repo/.venv/lib/python3.12/site-packages/flask_security/datastore.py:235: LegacyAPIWarning: The Query.get() method is considered legacy as of the 1.x series of SQLAlchemy and becomes a legacy construct in 2.0. The method is now available as Session.get() (deprecated since: 2.0) (Background on SQLAlchemy 2.0 at: https://sqlalche.me/e/b8d9)
    return self.user_model.query.get(identifier)

    target.updated = datetime.utcnow()

  /home/runner/work/invenio-testrig/invenio-testrig/package-repo/.venv/lib/python3.12/site-packages/invenio_records_resources/services/records/schema.py:90: RemovedInMarshmallow4Warning: The `context` parameter is deprecated and will be removed in marshmallow 4.0. Use `contextvars.ContextVar` to pass context instead.
    valid_data = self.schema(context=context, **schema_args).load(data)

    target.updated = datetime.utcnow()

  /home/runner/work/invenio-testrig/invenio-testrig/package-repo/.venv/lib/python3.12/site-packages/marshmallow/fields.py:631: RemovedInMarshmallow4Warning: The `context` parameter is deprecated and will be removed in marshmallow 4.0. Use `contextvars.ContextVar` to pass context instead.
    self._schema = schema_class(

    now_ = datetime.utcnow()

tests/communities/test_community_ui_serializer.py::test_ui_serializer
tests/communities/test_components.py::test_oai_set_create_community
tests/communities/test_resources.py::test_simple_flow
tests/communities/test_services.py::test_search_featured
tests/communities/test_subcommunities.py::test_service_join_already_existing
tests/members/test_members_components.py::test_accept_invite_cache_clear
tests/members/test_members_no_groups.py::test_invite_member_with_groups_disabled
tests/members/test_members_notifications.py::test_community_invitation_submit_notification
tests/test_notifications.py::test_user_recipient_generator
  /home/runner/work/invenio-testrig/invenio-testrig/package-repo/.venv/lib/python3.12/site-packages/invenio_records_resources/services/records/schema.py:105: RemovedInMarshmallow4Warning: The `context` parameter is deprecated and will be removed in marshmallow 4.0. Use `contextvars.ContextVar` to pass context instead.
    return self.schema(context=context, **schema_args).dump(data)

tests/communities/test_community_ui_serializer.py::test_ui_serializer
  /home/runner/work/invenio-testrig/invenio-testrig/package-repo/.venv/lib/python3.12/site-packages/flask_resources/serializers/base.py:53: RemovedInMarshmallow4Warning: The `context` parameter is deprecated and will be removed in marshmallow 4.0. Use `contextvars.ContextVar` to pass context instead.
    self.object_schema = object_schema_cls(context=schema_context, **schema_kwargs)

tests/communities/test_community_ui_serializer.py::test_ui_serializer
  /home/runner/work/invenio-testrig/invenio-testrig/package-repo/.venv/lib/python3.12/site-packages/flask_resources/serializers/base.py:55: RemovedInMarshmallow4Warning: The `context` parameter is deprecated and will be removed in marshmallow 4.0. Use `contextvars.ContextVar` to pass context instead.
    self.list_schema = list_schema_cls(

tests/communities/test_components.py::test_oai_set_create_community
tests/communities/test_components.py::test_oai_set_delete_community
tests/communities/test_components.py::test_oai_set_renamed
tests/communities/test_components.py::test_oai_set_update
tests/communities/test_components.py::test_children_component_without_children
    slug=str(datetime.utcnow().timestamp()).replace(".", "-")

tests/communities/test_components.py::test_oai_set_create_community
tests/communities/test_components.py::test_oai_set_delete_community
tests/communities/test_components.py::test_oai_set_renamed
tests/communities/test_components.py::test_oai_set_update
    slug=str(datetime.utcnow().timestamp()).replace(".", "-")

    value = datetime.utcnow()

    warnings.warn(

    _security.datetime_factory(),

    created = datetime.utcnow()

    return cls(int(id_s, 16), datetime.utcfromtimestamp(int(created_s, 16)))

    now = now or datetime.utcnow()

tests/communities/test_resources.py::test_simple_flow
tests/communities/test_subcommunities.py::test_subcommunity_simple_flow
    current_app.logger.warn(

    target.updated = datetime.utcnow()

    slug=str(datetime.utcnow().timestamp()).replace(".", "-")

tests/communities/test_services.py::test_search_featured
    "start_date": datetime.utcnow().isoformat(),

tests/communities/test_services.py::test_search_featured
    "start_date": (datetime.utcnow() + timedelta(days=1)).isoformat(),

tests/communities/test_services.py::test_search_featured
    data["start_date"] = (datetime.utcnow() - timedelta(days=1)).isoformat()

tests/communities/test_services.py::test_search_featured
    data["start_date"] = datetime.utcnow().isoformat()

tests/communities/test_services.py::test_reindex_featured_entries_task
    "start_date": (datetime.utcnow() + timedelta(days=1)).isoformat(),

tests/communities/test_services.py::test_reindex_featured_entries_task
    datetime.utcnow() + timedelta(seconds=near_future_difference)

tests/communities/test_services.py::test_reindex_featured_entries_task
    now = datetime.utcnow().isoformat()

tests/communities/test_services.py::test_create_featured
    slug=str(datetime.utcnow().timestamp()).replace(".", "-")

tests/communities/test_services.py::test_create_featured
    "start_date": datetime.utcnow().isoformat(),

tests/communities/test_services.py::test_get_featured
    "start_date": datetime.utcnow().isoformat(),

tests/communities/test_services.py::test_get_featured
    "start_date": (datetime.utcnow() + timedelta(days=1)).isoformat(),

tests/communities/test_services.py::test_delete_featured
    "start_date": datetime.utcnow().isoformat(),

tests/communities/test_services.py::test_delete_featured
    "start_date": (datetime.utcnow() + timedelta(days=1)).isoformat(),

tests/communities/test_services.py::test_update_featured
    "start_date": datetime.utcnow().isoformat(),

tests/communities/test_services.py::test_update_featured
    "start_date": (datetime.utcnow() + timedelta(days=1)).isoformat(),

tests/communities/test_services.py::test_community_deletion
    assert arrow.get(tombstone.removal_date).date() == datetime.utcnow().date()

tests/communities/test_tombstone.py::test_tombstone_creation
    "removal_date": datetime.datetime.utcnow(),

tests/communities/test_tombstone.py::test_tombstone_invalid_removed_by
    for invalid_value in [[], datetime.datetime.utcnow()]:

    datetime.utcnow().replace(tzinfo=timezone.utc)

    now = datetime.utcnow()

tests/records/test_mockrecords_api.py::test_record_create_empty
    warnings.warn(

- generated xml file: /home/runner/work/invenio-testrig/invenio-testrig/artifacts/test-report-patched.xml -
================================ tests coverage ================================
_______________ coverage: platform linux, python 3.12.12-final-0 _______________

Name                                                                             Stmts   Miss  Cover   Missing
invenio_communities/__init__.py                                                      4      0   100%
invenio_communities/administration/__init__.py                                       0      0   100%
invenio_communities/administration/communities.py                                   42      1    98%   78
invenio_communities/alembic/02cd82910727_update_role_id_type_upgrade.py             13      5    62%   33-55, 67
invenio_communities/alembic/5b478fe7ef7f_create_featured_communities_table.py       12      2    83%   24, 54
invenio_communities/alembic/5c68d45c80f0_add_deletion_status_to_communities.py      27     18    33%   22-43, 49-62, 67
invenio_communities/alembic/37b21951084c_update_role_id_type_downgrade.py           13      5    62%   22, 27-51
invenio_communities/alembic/72b37bb4119c_create_indeces_for_bucket_id.py            11      4    64%   21-27, 37-40
invenio_communities/alembic/90642d415317_create_communities_branch.py                8      2    75%   20, 25
invenio_communities/alembic/__init__.py                                              0      0   100%
invenio_communities/alembic/a3f5a8635cbb_remove_version_table.py                    22     12    45%   24-40, 48-111
invenio_communities/alembic/de9c14cbb0b2_create_communities_tables.py               24     14    42%   25-171, 178-193
invenio_communities/alembic/f701a32e6fbe_create_communities_members_table.py        14      4    71%   24-65, 75-76
invenio_communities/alembic/fbe746957cfc_create_member_tables.py                    36     26    28%   27-147, 157-196
invenio_communities/cache/__init__.py                                                0      0   100%
invenio_communities/cache/cache.py                                                  18      0   100%
invenio_communities/cache/redis.py                                                  29      1    97%   64
invenio_communities/cli.py                                                          76     21    72%   47-49, 56-62, 69-74, 99-100, 108-112, 124-126
invenio_communities/communities/__init__.py                                          3      0   100%
invenio_communities/communities/dumpers/__init__.py                                  0      0   100%
invenio_communities/communities/dumpers/featured.py                                 16      0   100%
invenio_communities/communities/entity_resolvers.py                                 32      9    72%   35-48, 69, 80
invenio_communities/communities/records/__init__.py                                  0      0   100%
invenio_communities/communities/records/api.py                                      45      0   100%
invenio_communities/communities/records/jsonschemas/__init__.py                      0      0   100%
invenio_communities/communities/records/mappings/__init__.py                         0      0   100%
invenio_communities/communities/records/mappings/os-v1/__init__.py                   0      0   100%
invenio_communities/communities/records/mappings/os-v2/__init__.py                   0      0   100%
invenio_communities/communities/records/mappings/v7/__init__.py                      0      0   100%
invenio_communities/communities/records/models.py                                   23      0   100%
invenio_communities/communities/records/systemfields/__init__.py                     0      0   100%
invenio_communities/communities/records/systemfields/access.py                     148     14    91%   136, 148, 154, 159, 170, 182, 194, 240, 264, 284-291, 304
invenio_communities/communities/records/systemfields/children.py                    50      3    94%   31, 74, 77
invenio_communities/communities/records/systemfields/deletion_status.py             59      6    90%   57, 61, 70, 75-78
invenio_communities/communities/records/systemfields/is_verified.py                 11      0   100%
invenio_communities/communities/records/systemfields/parent_community.py            53      2    96%   63-64
invenio_communities/communities/records/systemfields/pidslug.py                     44      3    93%   41, 51, 67
invenio_communities/communities/records/systemfields/tombstone.py                   96      4    96%   43, 139, 145, 177
invenio_communities/communities/resources/__init__.py                                3      0   100%
invenio_communities/communities/resources/args.py                                    5      0   100%
invenio_communities/communities/resources/config.py                                 21      0   100%
invenio_communities/communities/resources/resource.py                               91      6    93%   73-78, 89-96, 162-168
invenio_communities/communities/resources/serializer.py                              5      0   100%
invenio_communities/communities/resources/ui_schema.py                              75     17    77%   34-35, 50-61, 121-125, 132
invenio_communities/communities/schema.py                                          124      0   100%
invenio_communities/communities/services/__init__.py                                 4      0   100%
invenio_communities/communities/services/components.py                             188     10    95%   46, 57, 65, 80, 257, 283-284, 327, 331, 348
invenio_communities/communities/services/config.py                                  52      2    96%   81-85
invenio_communities/communities/services/facets.py                                   6      0   100%
invenio_communities/communities/services/links.py                                   34      1    97%   75
invenio_communities/communities/services/results.py                                 45      4    91%   76, 80, 100, 119
invenio_communities/communities/services/search_params.py                           14      1    93%   27
invenio_communities/communities/services/service.py                                258     21    92%   127, 305-306, 473, 480, 520-547, 634-638, 674-680, 716
invenio_communities/communities/services/sort.py                                    10      2    80%   32-33
invenio_communities/communities/services/uow.py                                     14      0   100%
invenio_communities/config.py                                                       50      0   100%
invenio_communities/errors.py                                                       29      1    97%   67
invenio_communities/ext.py                                                          73     10    86%   138-139, 144-189
invenio_communities/fixtures/__init__.py                                             0      0   100%
invenio_communities/fixtures/demo.py                                                 5      0   100%
invenio_communities/fixtures/tasks.py                                               42     13    69%   38-39, 42-43, 45-50, 76-79
invenio_communities/generators.py                                                  182     25    86%   74, 105-110, 150-151, 219-224, 228-229, 233-234, 254, 258, 281, 291, 295, 309, 365, 379, 397
invenio_communities/members/__init__.py                                              4      0   100%
invenio_communities/members/errors.py                                                3      0   100%
invenio_communities/members/records/__init__.py                                      3      0   100%
invenio_communities/members/records/api.py                                          94      2    98%   98-101
invenio_communities/members/records/mappings/__init__.py                             0      0   100%
invenio_communities/members/records/mappings/os-v1/__init__.py                       0      0   100%
invenio_communities/members/records/mappings/os-v2/__init__.py                       0      0   100%
invenio_communities/members/records/mappings/v7/__init__.py                          0      0   100%
invenio_communities/members/records/models.py                                       55      2    96%   100-101
invenio_communities/members/resources/__init__.py                                    3      0   100%
invenio_communities/members/resources/config.py                                     13      0   100%
invenio_communities/members/resources/resource.py                                   57      0   100%
invenio_communities/members/services/__init__.py                                     3      0   100%
invenio_communities/members/services/components.py                                  45      9    80%   34, 37, 41-48, 69
invenio_communities/members/services/config.py                                      46      0   100%
invenio_communities/members/services/facets.py                                       7      0   100%
invenio_communities/members/services/fields.py                                      22      8    64%   38-45
invenio_communities/members/services/request.py                                     53      0   100%
invenio_communities/members/services/schemas.py                                     81      0   100%
invenio_communities/members/services/service.py                                    239      9    96%   352, 546, 711, 715, 719, 723, 828, 833, 839
invenio_communities/notifications/__init__.py                                        0      0   100%
invenio_communities/notifications/builders.py                                       85      1    99%   309
invenio_communities/notifications/generators.py                                     28      1    96%   51
invenio_communities/permissions.py                                                  49      0   100%
invenio_communities/proxies.py                                                       8      0   100%
invenio_communities/records/__init__.py                                              0      0   100%
invenio_communities/records/records/__init__.py                                      0      0   100%
invenio_communities/records/records/models.py                                       17      0   100%
invenio_communities/records/records/systemfields/__init__.py                         2      0   100%
invenio_communities/records/records/systemfields/communities/__init__.py             0      0   100%
invenio_communities/records/records/systemfields/communities/context.py              4      1    75%   28
invenio_communities/records/records/systemfields/communities/field.py               40     14    65%   59, 64-111, 115-118
invenio_communities/records/records/systemfields/communities/manager.py             99      2    98%   167, 208
invenio_communities/requests/user_moderation/__init__.py                             2      0   100%
invenio_communities/requests/user_moderation/actions.py                             40     28    30%   32-60, 70-85, 95-99, 108-117
invenio_communities/requests/user_moderation/tasks.py                               16      8    50%   19-25, 31-35
invenio_communities/roles.py                                                        61      1    98%   80
invenio_communities/searchapp.py                                                     5      1    80%   18
invenio_communities/subcommunities/__init__.py                                       3      0   100%
invenio_communities/subcommunities/resources/__init__.py                             3      0   100%
invenio_communities/subcommunities/resources/config.py                              20      0   100%
invenio_communities/subcommunities/resources/resource.py                            18      0   100%
invenio_communities/subcommunities/services/__init__.py                              4      0   100%
invenio_communities/subcommunities/services/config.py                               22      0   100%
invenio_communities/subcommunities/services/errors.py                                2      0   100%
invenio_communities/subcommunities/services/request.py                              67     16    76%   50-57, 96-108, 116-128, 137-144, 187, 200
invenio_communities/subcommunities/services/schema.py                               16      1    94%   49
invenio_communities/subcommunities/services/service.py                              62     11    82%   45, 55, 84, 119, 136, 166-175
invenio_communities/tasks.py                                                         5      1    80%   22
invenio_communities/utils.py                                                        55      5    91%   107, 110-113
invenio_communities/views/__init__.py                                                3      0   100%
invenio_communities/views/api.py                                                    11      0   100%
invenio_communities/views/communities.py                                           172    107    38%   169, 179-191, 196, 201, 209-210, 218-219, 231-260, 269-277, 296-309, 329-334, 346-371, 388-392, 404-414, 433-437, 455-459, 471-475, 489-492, 505-509, 522-525, 537-546
invenio_communities/views/decorators.py                                             27     10    63%   28-38, 51-57
invenio_communities/views/template_loader.py                                        24      2    92%   46-47
invenio_communities/views/ui.py                                                     84     34    60%   54, 59-70, 81-84, 89, 100-103, 108-111, 116-123, 243-245, 250-260
invenio_communities/webpack.py                                                       2      0   100%
TOTAL                                                                             4043    543    87%
=========================== short test summary info ============================
FAILED tests/communities/test_parent_community.py::test_set_parent_community_with_comm_uuid - sqlalchemy.orm.exc.StaleDataError: Version id '3' on merged state <CommunityMetadata at 0x7fae24e1e750> does not match existing version '5'. Leave the version attribute unset when merging to update the most recent version.
FAILED tests/communities/test_parent_community.py::test_set_parent_community_with_comm_uuid_string - sqlalchemy.orm.exc.StaleDataError: Version id '3' on merged state <CommunityMetadata at 0x7fae248897c0> does not match existing version '5'. Leave the version attribute unset when merging to update the most recent version.
FAILED tests/communities/test_parent_community.py::test_parent_community_dereferencing - sqlalchemy.orm.exc.StaleDataError: Version id '3' on merged state <CommunityMetadata at 0x7fae252f1ee0> does not match existing version '5'. Leave the version attribute unset when merging to update the most recent version.
FAILED tests/members/test_members_services.py::test_delete_allowed[owner-owner] - marshmallow.exceptions.ValidationError: A community must have at least one owner.
FAILED tests/members/test_members_services.py::test_delete_allowed[owner-manager] - marshmallow.exceptions.ValidationError: A community must have at least one owner.
FAILED tests/members/test_members_services.py::test_delete_allowed[owner-curator] - marshmallow.exceptions.ValidationError: A community must have at least one owner.
FAILED tests/members/test_members_services.py::test_delete_allowed[owner-reader] - marshmallow.exceptions.ValidationError: A community must have at least one owner.
FAILED tests/members/test_members_services.py::test_delete_allowed[manager-manager] - marshmallow.exceptions.ValidationError: A community must have at least one owner.
FAILED tests/members/test_members_services.py::test_delete_allowed[manager-curator] - marshmallow.exceptions.ValidationError: A community must have at least one owner.
FAILED tests/members/test_members_services.py::test_delete_allowed[manager-reader] - marshmallow.exceptions.ValidationError: A community must have at least one owner.
FAILED tests/members/test_members_services.py::test_delete_member_type_group - marshmallow.exceptions.ValidationError: A community must have at least one owner.
FAILED tests/members/test_members_services.py::test_selfupdate_role_denied[owner] - invenio_communities.members.errors.InvalidMemberError
FAILED tests/members/test_members_services.py::test_selfupdate_allow_visibility[owner] - invenio_communities.members.errors.InvalidMemberError
FAILED tests/members/test_members_services.py::test_update_role_allowed[owner-owner-reader] - marshmallow.exceptions.ValidationError: A community must have at least one owner.
FAILED tests/members/test_members_services.py::test_update_role_allowed[owner-manager-reader] - marshmallow.exceptions.ValidationError: A community must have at least one owner.
FAILED tests/members/test_members_services.py::test_update_role_allowed[owner-curator-manager] - marshmallow.exceptions.ValidationError: A community must have at least one owner.
FAILED tests/members/test_members_services.py::test_update_role_allowed[owner-reader-curator] - marshmallow.exceptions.ValidationError: A community must have at least one owner.
FAILED tests/members/test_members_services.py::test_update_role_allowed[manager-manager-curator] - marshmallow.exceptions.ValidationError: A community must have at least one owner.
FAILED tests/members/test_members_services.py::test_update_role_allowed[manager-curator-manager] - marshmallow.exceptions.ValidationError: A community must have at least one owner.
FAILED tests/members/test_members_services.py::test_update_role_allowed[manager-reader-curator] - marshmallow.exceptions.ValidationError: A community must have at least one owner.
FAILED tests/members/test_members_services.py::test_update_invitation_role_allowed[owner-owner-reader] - marshmallow.exceptions.ValidationError: A community must have at least one owner.
FAILED tests/members/test_members_services.py::test_update_invitation_role_allowed[owner-manager-reader] - marshmallow.exceptions.ValidationError: A community must have at least one owner.
FAILED tests/members/test_members_services.py::test_update_invitation_role_allowed[owner-curator-manager] - marshmallow.exceptions.ValidationError: A community must have at least one owner.
FAILED tests/members/test_members_services.py::test_update_invitation_role_allowed[owner-reader-curator] - marshmallow.exceptions.ValidationError: A community must have at least one owner.
FAILED tests/members/test_members_services.py::test_update_invitation_role_allowed[manager-manager-curator] - marshmallow.exceptions.ValidationError: A community must have at least one owner.
FAILED tests/members/test_members_services.py::test_update_invitation_role_allowed[manager-curator-manager] - marshmallow.exceptions.ValidationError: A community must have at least one owner.
FAILED tests/members/test_members_services.py::test_update_invitation_role_allowed[manager-reader-curator] - marshmallow.exceptions.ValidationError: A community must have at least one owner.
FAILED tests/members/test_members_services.py::test_update_role_must_have_owner - invenio_communities.members.errors.InvalidMemberError
ERROR tests/communities/test_parent_community.py::test_parent_community_dereferencing - sqlalchemy.orm.exc.StaleDataError: UPDATE statement on table 'communities_metadata' expected to update 1 row(s); 0 were matched.
ERROR tests/members/test_members_services.py::test_leave_owner_allowed - RuntimeError: Could not delete any rows in this iteration due to foreign key cycles in tables: ['communities_members']
= 28 failed, 685 passed, 1 skipped, 4955 warnings, 2 errors in 320.81s (0:05:20) =
 Container docker_services_cli-postgresql-1  Stopping
 Container docker_services_cli-redis-1  Stopping
 Container docker_services_cli-opensearch-1  Stopping
 Container docker_services_cli-redis-1  Stopped
 Container docker_services_cli-redis-1  Removing
 Container docker_services_cli-redis-1  Removed
 Container docker_services_cli-postgresql-1  Stopped
 Container docker_services_cli-postgresql-1  Removing
 Container docker_services_cli-postgresql-1  Removed
 Container docker_services_cli-opensearch-1  Stopped
 Container docker_services_cli-opensearch-1  Removing
 Container docker_services_cli-opensearch-1  Removed
 Network docker_services_cli_default  Removing
 Network docker_services_cli_default  Removed

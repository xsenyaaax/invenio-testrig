running extract_messages
extracting messages from invenio_users_resources/__init__.py (encoding="utf-8")
extracting messages from invenio_users_resources/config.py (encoding="utf-8")
extracting messages from invenio_users_resources/entity_resolvers.py (encoding="utf-8")
extracting messages from invenio_users_resources/ext.py (encoding="utf-8")
extracting messages from invenio_users_resources/forms.py (encoding="utf-8")
extracting messages from invenio_users_resources/models.py (encoding="utf-8")
extracting messages from invenio_users_resources/permissions.py (encoding="utf-8")
extracting messages from invenio_users_resources/proxies.py (encoding="utf-8")
extracting messages from invenio_users_resources/views.py (encoding="utf-8")
extracting messages from invenio_users_resources/notifications/__init__.py (encoding="utf-8")
extracting messages from invenio_users_resources/notifications/filters.py (encoding="utf-8")
extracting messages from invenio_users_resources/notifications/generators.py (encoding="utf-8")
extracting messages from invenio_users_resources/records/__init__.py (encoding="utf-8")
extracting messages from invenio_users_resources/records/api.py (encoding="utf-8")
extracting messages from invenio_users_resources/records/hooks.py (encoding="utf-8")
extracting messages from invenio_users_resources/records/models.py (encoding="utf-8")
extracting messages from invenio_users_resources/records/dumpers/__init__.py (encoding="utf-8")
extracting messages from invenio_users_resources/records/dumpers/email.py (encoding="utf-8")
extracting messages from invenio_users_resources/records/mappings/__init__.py (encoding="utf-8")
extracting messages from invenio_users_resources/records/mappings/os-v1/__init__.py (encoding="utf-8")
extracting messages from invenio_users_resources/records/mappings/os-v2/__init__.py (encoding="utf-8")
extracting messages from invenio_users_resources/records/mappings/v7/__init__.py (encoding="utf-8")
extracting messages from invenio_users_resources/records/systemfields/__init__.py (encoding="utf-8")
extracting messages from invenio_users_resources/resources/__init__.py (encoding="utf-8")
extracting messages from invenio_users_resources/resources/domains/__init__.py (encoding="utf-8")
extracting messages from invenio_users_resources/resources/domains/config.py (encoding="utf-8")
extracting messages from invenio_users_resources/resources/domains/resource.py (encoding="utf-8")
extracting messages from invenio_users_resources/resources/groups/__init__.py (encoding="utf-8")
extracting messages from invenio_users_resources/resources/groups/config.py (encoding="utf-8")
extracting messages from invenio_users_resources/resources/groups/resource.py (encoding="utf-8")
extracting messages from invenio_users_resources/resources/users/__init__.py (encoding="utf-8")
extracting messages from invenio_users_resources/resources/users/config.py (encoding="utf-8")
extracting messages from invenio_users_resources/resources/users/errors.py (encoding="utf-8")
extracting messages from invenio_users_resources/resources/users/resource.py (encoding="utf-8")
extracting messages from invenio_users_resources/services/__init__.py (encoding="utf-8")
extracting messages from invenio_users_resources/services/common.py (encoding="utf-8")
extracting messages from invenio_users_resources/services/generators.py (encoding="utf-8")
extracting messages from invenio_users_resources/services/params.py (encoding="utf-8")
extracting messages from invenio_users_resources/services/permissions.py (encoding="utf-8")
extracting messages from invenio_users_resources/services/results.py (encoding="utf-8")
extracting messages from invenio_users_resources/services/schemas.py (encoding="utf-8")
extracting messages from invenio_users_resources/services/domains/__init__.py (encoding="utf-8")
extracting messages from invenio_users_resources/services/domains/components.py (encoding="utf-8")
extracting messages from invenio_users_resources/services/domains/config.py (encoding="utf-8")
extracting messages from invenio_users_resources/services/domains/facets.py (encoding="utf-8")
extracting messages from invenio_users_resources/services/domains/service.py (encoding="utf-8")
extracting messages from invenio_users_resources/services/domains/tasks.py (encoding="utf-8")
extracting messages from invenio_users_resources/services/groups/__init__.py (encoding="utf-8")
extracting messages from invenio_users_resources/services/groups/config.py (encoding="utf-8")
extracting messages from invenio_users_resources/services/groups/results.py (encoding="utf-8")
extracting messages from invenio_users_resources/services/groups/service.py (encoding="utf-8")
extracting messages from invenio_users_resources/services/groups/tasks.py (encoding="utf-8")
extracting messages from invenio_users_resources/services/users/__init__.py (encoding="utf-8")
extracting messages from invenio_users_resources/services/users/config.py (encoding="utf-8")
extracting messages from invenio_users_resources/services/users/facets.py (encoding="utf-8")
extracting messages from invenio_users_resources/services/users/lock.py (encoding="utf-8")
extracting messages from invenio_users_resources/services/users/results.py (encoding="utf-8")
extracting messages from invenio_users_resources/services/users/search_params.py (encoding="utf-8")
extracting messages from invenio_users_resources/services/users/service.py (encoding="utf-8")
extracting messages from invenio_users_resources/services/users/tasks.py (encoding="utf-8")
extracting messages from invenio_users_resources/templates/security/email/new_user_via_admin.html (encoding="utf-8")
extracting messages from invenio_users_resources/templates/semantic-ui/invenio_users_resources/settings/notifications.html (encoding="utf-8")
writing PO template file to /dev/null
 redis Pulling 
 rabbitmq Pulling 
 opensearch Pulling 
 postgresql Pulling 
 redis Pulled 
 rabbitmq Pulled 
 postgresql Pulled 
 opensearch Pulled 
 Network docker_services_cli_default  Creating
 Network docker_services_cli_default  Created
 Container docker_services_cli-rabbitmq-1  Creating
 Container docker_services_cli-opensearch-1  Creating
 Container docker_services_cli-redis-1  Creating
 Container docker_services_cli-postgresql-1  Creating
 Container docker_services_cli-redis-1  Created
 Container docker_services_cli-opensearch-1  Created
 Container docker_services_cli-rabbitmq-1  Created
 Container docker_services_cli-postgresql-1  Created
 Container docker_services_cli-redis-1  Starting
 Container docker_services_cli-postgresql-1  Starting
 Container docker_services_cli-opensearch-1  Starting
 Container docker_services_cli-rabbitmq-1  Starting
 Container docker_services_cli-redis-1  Started
 Container docker_services_cli-opensearch-1  Started
 Container docker_services_cli-postgresql-1  Started
 Container docker_services_cli-rabbitmq-1  Started
============================= test session starts ==============================
platform linux -- Python 3.12.12, pytest-8.4.2, pluggy-1.6.0 -- /home/runner/work/invenio-testrig/invenio-testrig/package-repo/.venv/bin/python
cachedir: .pytest_cache
rootdir: /home/runner/work/invenio-testrig/invenio-testrig/package-repo
configfile: setup.cfg
testpaths: docs, tests, invenio_users_resources
plugins: github-actions-annotate-failures-0.3.0, pycodestyle-2.5.0, flask-1.3.0, black-ng-0.4.1, invenio-3.4.2, isort-4.0.0, cov-7.0.0, pydocstyle-2.4.0
collecting ... collected 302 items

docs/conf.py::PYDOCSTYLE PASSED
docs/conf.py::ISORT PASSED
docs/conf.py::black PASSED
tests/conftest.py::PYDOCSTYLE PASSED
tests/conftest.py::ISORT PASSED
tests/conftest.py::black PASSED
tests/resources/test_resources_domains.py::ISORT PASSED
tests/resources/test_resources_domains.py::black PASSED
tests/resources/test_resources_domains.py::test_domains_access PASSED
tests/resources/test_resources_domains.py::test_domains_search PASSED

tests/resources/test_resources_domains.py::test_domains_read Tried to build event emitter for unregistered event 'record-view'
[2025-12-10 09:54:24,427] WARNING in receivers: Tried to build event emitter for unregistered event 'record-view'
PASSED

tests/resources/test_resources_domains.py::test_domains_delete PASSED

tests/resources/test_resources_domains.py::test_domains_create PASSED

tests/resources/test_resources_domains.py::test_domains_create_failure[400-json0] PASSED

tests/resources/test_resources_domains.py::test_domains_create_failure[400-json1] PASSED

tests/resources/test_resources_domains.py::test_domains_create_failure[400-json2] PASSED

tests/resources/test_resources_domains.py::test_domains_create_failure[400-json3] PASSED

tests/resources/test_resources_domains.py::test_domains_update PASSED

tests/resources/test_resources_groups.py::ISORT PASSED
tests/resources/test_resources_groups.py::black PASSED
tests/resources/test_resources_groups.py::test_group_avatar PASSED

tests/resources/test_resources_users.py::ISORT PASSED
tests/resources/test_resources_users.py::black PASSED
tests/resources/test_resources_users.py::test_read_self_serialization PASSED

tests/resources/test_resources_users.py::test_read_anon_serialization PASSED

tests/resources/test_resources_users.py::test_read_logged_in_serialization[pub] PASSED

tests/resources/test_resources_users.py::test_read_logged_in_serialization[pubres] PASSED

tests/resources/test_resources_users.py::test_read_logged_in_serialization[res] PASSED

tests/resources/test_resources_users.py::test_user_avatar PASSED

tests/resources/test_resources_users.py::test_user_avatar_non_ascii PASSED

tests/resources/test_resources_users.py::test_create_user MS PATCH Storing database values
Storing database values
Storing database values done
MS PATCH Stored
Content-Type: multipart/mixed; boundary="===============8573622357988813087=="
MIME-Version: 1.0
Subject: Password reset instructions
From: no-reply@localhost
To: newuser@inveniosoftware.org
Date: Wed, 10 Dec 2025 09:54:32 +0000
Message-ID: <176536047201.3767.6855088454028931475@runnervmoqczp.f2vfsl0ystsenpp5sr4gipprta.ex.internal.cloudapp.net>

--===============8573622357988813087==
Content-Type: multipart/alternative; boundary="===============1722168994781276179=="
MIME-Version: 1.0

--===============1722168994781276179==
Content-Type: text/plain; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit

Your new account has been created

Click the link below to create a new password:

http://localhost/lost-password/WyIxMCIsIiQ1JHJvdW5kcz01MzUwMDAkRGtJSkEwUmo5dklPRG4ycyRQNzRXb0pBc2xVeTBDWktSc29qWnRQR212Z3ZVdDY1YUhwd1IyMVVVLy5CIl0.aTlDVw.l7bJwGsTn_MiwA9_5YbicrNth-U
--===============1722168994781276179==
Content-Type: text/html; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit

<p>Your new account has been created</p>

<p>
  <a href="http://localhost/lost-password/WyIxMCIsIiQ1JHJvdW5kcz01MzUwMDAkRGtJSkEwUmo5dklPRG4ycyRQNzRXb0pBc2xVeTBDWktSc29qWnRQR212Z3ZVdDY1YUhwd1IyMVVVLy5CIl0.aTlDVw.l7bJwGsTn_MiwA9_5YbicrNth-U">Click here to create a new password</a>
</p>
--===============1722168994781276179==--

--===============8573622357988813087==--

PASSEDMS PATCH Rollback and original connection close
MS PATCH Purging database changes
Purging database values
Purging database values done
MS PATCH Purged and closed

tests/resources/test_resources_users.py::test_approve_user MS PATCH Storing database values
Storing database values
Storing database values done
MS PATCH Stored
PASSEDMS PATCH Rollback and original connection close
MS PATCH Purging database changes
Purging database values
Purging database values done
MS PATCH Purged and closed

tests/resources/test_resources_users.py::test_block_user MS PATCH Storing database values
Storing database values
Storing database values done
MS PATCH Stored
PASSEDMS PATCH Rollback and original connection close
MS PATCH Purging database changes
Purging database values
Purging database values done
MS PATCH Purged and closed

tests/resources/test_resources_users.py::test_deactivate_user MS PATCH Storing database values
Storing database values
Storing database values done
MS PATCH Stored
PASSEDMS PATCH Rollback and original connection close
MS PATCH Purging database changes
Purging database values
Purging database values done
MS PATCH Purged and closed

tests/resources/test_resources_users.py::test_management_permissions MS PATCH Storing database values
Storing database values
Storing database values done
MS PATCH Stored
PASSEDMS PATCH Rollback and original connection close
MS PATCH Purging database changes
Purging database values
Purging database values done
MS PATCH Purged and closed

tests/resources/test_resources_users.py::test_impersonate_user MS PATCH Storing database values
Storing database values
Storing database values done
MS PATCH Stored
PASSEDMS PATCH Rollback and original connection close
MS PATCH Purging database changes
Purging database values
Purging database values done
MS PATCH Purged and closed

tests/resources/test_resources_users.py::test_admin_links[admin_records_html-/administration/records?q=parent.access.owned_by.user:{id}&f=allversions] ::error file=package-repo/tests/resources/test_resources_users.py,line=281::test_admin_links[admin_records_html-/administration/records?q=parent.access.owned_by.user:{id}&f=allversions]%0A%0Asqlalchemy.orm.exc.StaleDataError: UPDATE statement on table 'accounts_user' expected to update 1 row(s); 0 were matched.
FAILED

tests/resources/test_resources_users.py::test_admin_links[admin_drafts_html-/administration/drafts?q=parent.access.owned_by.user:{id}&f=allversions] ::error file=package-repo/tests/resources/test_resources_users.py,line=281::test_admin_links[admin_drafts_html-/administration/drafts?q=parent.access.owned_by.user:{id}&f=allversions]%0A%0Asqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: UPDATE statement on table 'accounts_user' expected to update 1 row(s); 0 were matched. (Background on this error at: https://sqlalche.me/e/20/7s2a)
FAILED

tests/resources/test_resources_users.py::test_admin_links[admin_moderation_html-/administration/moderation?q=topic.user:{id}] ::error file=package-repo/tests/resources/test_resources_users.py,line=281::test_admin_links[admin_moderation_html-/administration/moderation?q=topic.user:{id}]%0A%0Asqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: UPDATE statement on table 'accounts_user' expected to update 1 row(s); 0 were matched. (Background on this error at: https://sqlalche.me/e/20/7s2a)
FAILED

tests/resources/test_resources_users.py::test_admin_links_visibility[user_moderator-True] ::error file=package-repo/tests/resources/test_resources_users.py,line=303::test_admin_links_visibility[user_moderator-True]%0A%0Asqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: UPDATE statement on table 'accounts_user' expected to update 1 row(s); 0 were matched. (Background on this error at: https://sqlalche.me/e/20/7s2a)
FAILED

tests/resources/test_resources_users.py::test_admin_links_visibility[pub-False] ::error file=package-repo/tests/resources/test_resources_users.py,line=303::test_admin_links_visibility[pub-False]%0A%0Asqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: UPDATE statement on table 'accounts_user' expected to update 1 row(s); 0 were matched. (Background on this error at: https://sqlalche.me/e/20/7s2a)
FAILED

tests/resources/test_resources_users.py::test_admin_links_visibility[res-False] ::error file=package-repo/tests/resources/test_resources_users.py,line=303::test_admin_links_visibility[res-False]%0A%0Asqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: UPDATE statement on table 'accounts_user' expected to update 1 row(s); 0 were matched. (Background on this error at: https://sqlalche.me/e/20/7s2a)
FAILED

tests/services/test_generators.py::ISORT PASSED
tests/services/test_generators.py::black PASSED
tests/services/test_generators.py::test_group_not_managed_generator PASSED

tests/services/test_service_groups.py::ISORT PASSED
tests/services/test_service_groups.py::black PASSED
tests/services/test_service_groups.py::test_groups_sort Failed to index record administration-moderation
Traceback (most recent call last):
  File "/home/runner/work/invenio-testrig/invenio-testrig/package-repo/.venv/lib/python3.12/site-packages/invenio_indexer/api.py", line 370, in _actionsiter
    yield self._index_action(payload)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/work/invenio-testrig/invenio-testrig/package-repo/.venv/lib/python3.12/site-packages/invenio_indexer/api.py", line 416, in _index_action
    index = self.record_to_index(record)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/work/invenio-testrig/invenio-testrig/package-repo/.venv/lib/python3.12/site-packages/invenio_indexer/api.py", line 114, in record_to_index
    result = self._record_to_index(record)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/work/invenio-testrig/invenio-testrig/package-repo/.venv/lib/python3.12/site-packages/invenio_records_resources/services/records/service.py", line 67, in record_to_index
    return record.index._name
           ^^^^^^^^^^^^
AttributeError: 'NoneType' object has no attribute 'index'
[2025-12-10 09:54:44,294] ERROR in api: Failed to index record administration-moderation
Traceback (most recent call last):
  File "/home/runner/work/invenio-testrig/invenio-testrig/package-repo/.venv/lib/python3.12/site-packages/invenio_indexer/api.py", line 370, in _actionsiter
    yield self._index_action(payload)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/work/invenio-testrig/invenio-testrig/package-repo/.venv/lib/python3.12/site-packages/invenio_indexer/api.py", line 416, in _index_action
    index = self.record_to_index(record)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/work/invenio-testrig/invenio-testrig/package-repo/.venv/lib/python3.12/site-packages/invenio_indexer/api.py", line 114, in record_to_index
    result = self._record_to_index(record)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/work/invenio-testrig/invenio-testrig/package-repo/.venv/lib/python3.12/site-packages/invenio_records_resources/services/records/service.py", line 67, in record_to_index
    return record.index._name
           ^^^^^^^^^^^^
AttributeError: 'NoneType' object has no attribute 'index'
Failed to index record administration-moderation
Traceback (most recent call last):
  File "/home/runner/work/invenio-testrig/invenio-testrig/package-repo/.venv/lib/python3.12/site-packages/invenio_indexer/api.py", line 370, in _actionsiter
    yield self._index_action(payload)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/work/invenio-testrig/invenio-testrig/package-repo/.venv/lib/python3.12/site-packages/invenio_indexer/api.py", line 416, in _index_action
    index = self.record_to_index(record)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/work/invenio-testrig/invenio-testrig/package-repo/.venv/lib/python3.12/site-packages/invenio_indexer/api.py", line 114, in record_to_index
    result = self._record_to_index(record)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/work/invenio-testrig/invenio-testrig/package-repo/.venv/lib/python3.12/site-packages/invenio_records_resources/services/records/service.py", line 67, in record_to_index
    return record.index._name
           ^^^^^^^^^^^^
AttributeError: 'NoneType' object has no attribute 'index'
Failed to index record administration-moderation
Traceback (most recent call last):
  File "/home/runner/work/invenio-testrig/invenio-testrig/package-repo/.venv/lib/python3.12/site-packages/invenio_indexer/api.py", line 370, in _actionsiter
    yield self._index_action(payload)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/work/invenio-testrig/invenio-testrig/package-repo/.venv/lib/python3.12/site-packages/invenio_indexer/api.py", line 416, in _index_action
    index = self.record_to_index(record)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/work/invenio-testrig/invenio-testrig/package-repo/.venv/lib/python3.12/site-packages/invenio_indexer/api.py", line 114, in record_to_index
    result = self._record_to_index(record)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/work/invenio-testrig/invenio-testrig/package-repo/.venv/lib/python3.12/site-packages/invenio_records_resources/services/records/service.py", line 67, in record_to_index
    return record.index._name
           ^^^^^^^^^^^^
AttributeError: 'NoneType' object has no attribute 'index'
Failed to index record administration-moderation
Traceback (most recent call last):
  File "/home/runner/work/invenio-testrig/invenio-testrig/package-repo/.venv/lib/python3.12/site-packages/invenio_indexer/api.py", line 370, in _actionsiter
    yield self._index_action(payload)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/work/invenio-testrig/invenio-testrig/package-repo/.venv/lib/python3.12/site-packages/invenio_indexer/api.py", line 416, in _index_action
    index = self.record_to_index(record)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/work/invenio-testrig/invenio-testrig/package-repo/.venv/lib/python3.12/site-packages/invenio_indexer/api.py", line 114, in record_to_index
    result = self._record_to_index(record)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/work/invenio-testrig/invenio-testrig/package-repo/.venv/lib/python3.12/site-packages/invenio_records_resources/services/records/service.py", line 67, in record_to_index
    return record.index._name
           ^^^^^^^^^^^^
AttributeError: 'NoneType' object has no attribute 'index'
Failed to index record administration-moderation
Traceback (most recent call last):
  File "/home/runner/work/invenio-testrig/invenio-testrig/package-repo/.venv/lib/python3.12/site-packages/invenio_indexer/api.py", line 370, in _actionsiter
    yield self._index_action(payload)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/work/invenio-testrig/invenio-testrig/package-repo/.venv/lib/python3.12/site-packages/invenio_indexer/api.py", line 416, in _index_action
    index = self.record_to_index(record)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/work/invenio-testrig/invenio-testrig/package-repo/.venv/lib/python3.12/site-packages/invenio_indexer/api.py", line 114, in record_to_index
    result = self._record_to_index(record)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/work/invenio-testrig/invenio-testrig/package-repo/.venv/lib/python3.12/site-packages/invenio_records_resources/services/records/service.py", line 67, in record_to_index
    return record.index._name
           ^^^^^^^^^^^^
AttributeError: 'NoneType' object has no attribute 'index'
PASSED

tests/services/test_service_groups.py::test_groups_no_facets PASSED
tests/services/test_service_groups.py::test_groups_fixed_pagination PASSED
tests/services/test_service_groups.py::test_groups_search_field[id:it-dep] PASSED
tests/services/test_service_groups.py::test_groups_search_field[name:IT Department] PASSED
tests/services/test_service_groups.py::test_groups_search_field[+name:it] PASSED
tests/services/test_service_groups.py::test_groups_search_field[IT] PASSED
tests/services/test_service_groups.py::test_groups_search PASSED

tests/services/test_service_groups.py::test_groups_read PASSED

tests/services/test_service_tasks_domains.py::ISORT PASSED
tests/services/test_service_tasks_domains.py::black PASSED
tests/services/test_service_tasks_domains.py::test_import_domain_blocklist MS PATCH Storing database values
Storing database values
Storing database values done
MS PATCH Stored
PASSEDMS PATCH Rollback and original connection close
MS PATCH Purging database changes
Purging database values
Purging database values done
MS PATCH Purged and closed

tests/services/test_service_tasks_domains.py::test_import_domain_blocklist_download_error MS PATCH Storing database values
Storing database values
Storing database values done
MS PATCH Stored
Failed to download http://fake-url
[2025-12-10 09:54:47,573] ERROR in tasks: Failed to download http://fake-url
Failed to download http://fake-url
Failed to download http://fake-url
Failed to download http://fake-url
Failed to download http://fake-url
Failed to download http://fake-url
PASSEDMS PATCH Rollback and original connection close
MS PATCH Purging database changes
Purging database values
Purging database values done
MS PATCH Purged and closed

tests/services/users/test_service_users.py::ISORT PASSED
tests/services/users/test_service_users.py::black PASSED
tests/services/users/test_service_users.py::test_search_restricted PASSED

tests/services/users/test_service_users.py::test_search_public_users PASSED

tests/services/users/test_service_users.py::test_admin_search_field[affiliations:CERN] PASSED

tests/services/users/test_service_users.py::test_admin_search_field[affiliation:CERN] PASSED

tests/services/users/test_service_users.py::test_admin_search_field[name:Jose affiliation:CERN] PASSED

tests/services/users/test_service_users.py::test_admin_search_field[+name:Jose +affiliation:CERN] PASSED

tests/services/users/test_service_users.py::test_admin_search_field[CERN] PASSED

tests/services/users/test_service_users.py::test_admin_search_field[Tim] PASSED

tests/services/users/test_service_users.py::test_admin_search_field[Tim CERN] PASSED

tests/services/users/test_service_users.py::test_admin_search_field[Jose] PASSED

tests/services/users/test_service_users.py::test_admin_search_field[Jos] PASSED

tests/services/users/test_service_users.py::test_admin_search_field[Jose CERN] PASSED

tests/services/users/test_service_users.py::test_admin_search_field[email:pub@inveniosoftware.org] PASSED

tests/services/users/test_service_users.py::test_admin_search_field[username:pub] PASSED

tests/services/users/test_service_users.py::test_user_search_field_not_searchable[res@inveniosoftware.org] PASSED
tests/services/users/test_service_users.py::test_user_search_field_not_searchable[pubres@inveniosoftware.org] PASSED
tests/services/users/test_service_users.py::test_user_search_field_not_searchable[Plazi0] PASSED
tests/services/users/test_service_users.py::test_user_search_field_not_searchable[inactive] PASSED
tests/services/users/test_service_users.py::test_user_search_field_not_searchable[unconfirmed] PASSED
tests/services/users/test_service_users.py::test_user_search_field_not_searchable[restricted] PASSED
tests/services/users/test_service_users.py::test_user_search_field_not_searchable[Plazi1] PASSED
tests/services/users/test_service_users.py::test_user_search_field_not_searchable[test] PASSED
tests/services/users/test_service_users.py::test_user_search_field[CERN] PASSED

tests/services/users/test_service_users.py::test_user_search_field[Jose CERN] PASSED

tests/services/users/test_service_users.py::test_user_search_field[Jose AND CERN] PASSED

tests/services/users/test_service_users.py::test_user_search_field[Tim] PASSED

tests/services/users/test_service_users.py::test_user_search_field[Tim CERN] PASSED

tests/services/users/test_service_users.py::test_user_search_field[Jose] PASSED

tests/services/users/test_service_users.py::test_user_search_field[Jos] PASSED

tests/services/users/test_service_users.py::test_user_search_field[pub@inveniosoftware.org] PASSED

tests/services/users/test_service_users.py::test_user_search_field[pub] PASSED

tests/services/users/test_service_users.py::test_read_with_anon PASSED

tests/services/users/test_service_users.py::test_read_with_logged_in PASSED

tests/services/users/test_service_users.py::test_read_self[pub] PASSED

tests/services/users/test_service_users.py::test_read_self[pubres] PASSED

tests/services/users/test_service_users.py::test_read_self[res] PASSED

tests/services/users/test_service_users.py::test_search_permissions MS PATCH Storing database values
Storing database values
Storing database values done
MS PATCH Stored
PASSEDMS PATCH Rollback and original connection close
MS PATCH Purging database changes
Purging database values
Purging database values done
MS PATCH Purged and closed

tests/services/users/test_service_users.py::test_create_permission_denied MS PATCH Storing database values
Storing database values
Storing database values done
MS PATCH Stored
PASSEDMS PATCH Rollback and original connection close
MS PATCH Purging database changes
Purging database values
Purging database values done
MS PATCH Purged and closed

tests/services/users/test_service_users.py::test_create_user MS PATCH Storing database values
Storing database values
Storing database values done
MS PATCH Stored
Content-Type: multipart/mixed; boundary="===============3706557015609096615=="
MIME-Version: 1.0
Subject: Password reset instructions
From: no-reply@localhost
To: newuser@inveniosoftware.org
Date: Wed, 10 Dec 2025 09:55:01 +0000
Message-ID: <176536050108.3767.1252004095411601882@runnervmoqczp.f2vfsl0ystsenpp5sr4gipprta.ex.internal.cloudapp.net>

--===============3706557015609096615==
Content-Type: multipart/alternative; boundary="===============8528753474065729399=="
MIME-Version: 1.0

--===============8528753474065729399==
Content-Type: text/plain; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit

Your new account has been created

Click the link below to create a new password:

http://localhost/lost-password/WyIxMCIsIiQ1JHJvdW5kcz01MzUwMDAkUUo0UmJqcEVEMXdJdWJWbyR0V1NlQlRFMmdZQll0WjFlUi5hZ2xlSkF3MG1SeUNFZ1VXZGcueEZGMGw0Il0.aTlDdQ.jrLc1lr6RT8Qd_7xmf_CYs9tstI
--===============8528753474065729399==
Content-Type: text/html; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit

<p>Your new account has been created</p>

<p>
  <a href="http://localhost/lost-password/WyIxMCIsIiQ1JHJvdW5kcz01MzUwMDAkUUo0UmJqcEVEMXdJdWJWbyR0V1NlQlRFMmdZQll0WjFlUi5hZ2xlSkF3MG1SeUNFZ1VXZGcueEZGMGw0Il0.aTlDdQ.jrLc1lr6RT8Qd_7xmf_CYs9tstI">Click here to create a new password</a>
</p>
--===============8528753474065729399==--

--===============3706557015609096615==--

PASSEDMS PATCH Rollback and original connection close
MS PATCH Purging database changes
Purging database values
Purging database values done
MS PATCH Purged and closed

tests/services/users/test_service_users.py::test_create_user_errors MS PATCH Storing database values
Storing database values
Storing database values done
MS PATCH Stored
Content-Type: multipart/mixed; boundary="===============0318490860371434682=="
MIME-Version: 1.0
Subject: Password reset instructions
From: no-reply@localhost
To: newuser@inveniosoftware.org
Date: Wed, 10 Dec 2025 09:55:02 +0000
Message-ID: <176536050293.3767.3844955887056475421@runnervmoqczp.f2vfsl0ystsenpp5sr4gipprta.ex.internal.cloudapp.net>

--===============0318490860371434682==
Content-Type: multipart/alternative; boundary="===============4905677870463626309=="
MIME-Version: 1.0

--===============4905677870463626309==
Content-Type: text/plain; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit

Your new account has been created

Click the link below to create a new password:

http://localhost/lost-password/WyIxMSIsIiQ1JHJvdW5kcz01MzUwMDAkUDl1bWw3cWtuanYxa0NuciRQSkpKRW5MM29JWC54akVaRTlkTm5TMjNWbGx4Lkptc1dCY29aYnJGWk5BIl0.aTlDdg.LwWm8L_e1saFBG_R7DkvNnEaMaU
--===============4905677870463626309==
Content-Type: text/html; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit

<p>Your new account has been created</p>

<p>
  <a href="http://localhost/lost-password/WyIxMSIsIiQ1JHJvdW5kcz01MzUwMDAkUDl1bWw3cWtuanYxa0NuciRQSkpKRW5MM29JWC54akVaRTlkTm5TMjNWbGx4Lkptc1dCY29aYnJGWk5BIl0.aTlDdg.LwWm8L_e1saFBG_R7DkvNnEaMaU">Click here to create a new password</a>
</p>
--===============4905677870463626309==--

--===============0318490860371434682==--

PASSEDMS PATCH Rollback and original connection close
MS PATCH Purging database changes
Purging database values
Purging database values done
MS PATCH Purged and closed

tests/services/users/test_service_users.py::test_block MS PATCH Storing database values
Storing database values
Storing database values done
MS PATCH Stored
PASSEDMS PATCH Rollback and original connection close
MS PATCH Purging database changes
Purging database values
Purging database values done
MS PATCH Purged and closed

tests/services/users/test_service_users.py::test_approve MS PATCH Storing database values
Storing database values
Storing database values done
MS PATCH Stored
PASSEDMS PATCH Rollback and original connection close
MS PATCH Purging database changes
Purging database values
Purging database values done
MS PATCH Purged and closed

tests/services/users/test_service_users.py::test_deactivate MS PATCH Storing database values
Storing database values
Storing database values done
MS PATCH Stored
PASSEDMS PATCH Rollback and original connection close
MS PATCH Purging database changes
Purging database values
Purging database values done
MS PATCH Purged and closed

tests/services/users/test_service_users.py::test_non_existent_user_management MS PATCH Storing database values
Storing database values
Storing database values done
MS PATCH Stored
PASSEDMS PATCH Rollback and original connection close
MS PATCH Purging database changes
Purging database values
Purging database values done
MS PATCH Purged and closed

tests/services/users/test_service_users.py::test_restore MS PATCH Storing database values
Storing database values
Storing database values done
MS PATCH Stored
PASSEDMS PATCH Rollback and original connection close
MS PATCH Purging database changes
Purging database values
Purging database values done
MS PATCH Purged and closed

tests/services/users/test_user_moderation.py::ISORT PASSED
tests/services/users/test_user_moderation.py::black PASSED
tests/services/users/test_user_moderation.py::test_moderation_callbacks_success PASSED

tests/services/users/test_user_moderation.py::test_moderation_callbacks_failure Could not execute action 'block' for user: Error on lock: <Lock user_moderation_lock.3>: Lock failed to be acquired.
[2025-12-10 09:55:09,782] WARNING in tasks: Could not execute action 'block' for user: Error on lock: <Lock user_moderation_lock.3>: Lock failed to be acquired.
Could not execute action 'block' for user: Error on lock: <Lock user_moderation_lock.3>: Lock failed to be acquired.
Could not execute action 'block' for user: Error on lock: <Lock user_moderation_lock.3>: Lock failed to be acquired.
Could not execute action 'block' for user: Error on lock: <Lock user_moderation_lock.3>: Lock failed to be acquired.
Could not execute action 'block' for user: Error on lock: <Lock user_moderation_lock.3>: Lock failed to be acquired.
Could not execute action 'block' for user: Error on lock: <Lock user_moderation_lock.3>: Lock failed to be acquired.
Could not execute action 'block' for user: Error on lock: <Lock user_moderation_lock.3>: Lock failed to be acquired.
Could not execute action 'block' for user: Error on lock: <Lock user_moderation_lock.3>: Lock failed to be acquired.
PASSED

tests/services/users/test_user_moderation.py::test_moderation_callbacks_lock PASSED

tests/services/users/test_user_moderation.py::test_moderation_callbacks_lock_renewal[1-10-True] PASSED

tests/services/users/test_user_moderation.py::test_moderation_callbacks_lock_renewal[2-2-False] Could not execute action 'block' for user: assert True == False
 +  where True = exists()
 +    where exists = <Lock user_moderation_lock.3>.exists
[2025-12-10 09:55:13,249] WARNING in tasks: Could not execute action 'block' for user: assert True == False
 +  where True = exists()
 +    where exists = <Lock user_moderation_lock.3>.exists
Could not execute action 'block' for user: assert True == False
 +  where True = exists()
 +    where exists = <Lock user_moderation_lock.3>.exists
Could not execute action 'block' for user: assert True == False
 +  where True = exists()
 +    where exists = <Lock user_moderation_lock.3>.exists
Could not execute action 'block' for user: assert True == False
 +  where True = exists()
 +    where exists = <Lock user_moderation_lock.3>.exists
Could not execute action 'block' for user: assert True == False
 +  where True = exists()
 +    where exists = <Lock user_moderation_lock.3>.exists
Could not execute action 'block' for user: assert True == False
 +  where True = exists()
 +    where exists = <Lock user_moderation_lock.3>.exists
Could not execute action 'block' for user: assert True == False
 +  where True = exists()
 +    where exists = <Lock user_moderation_lock.3>.exists
Could not execute action 'block' for user: assert True == False
 +  where True = exists()
 +    where exists = <Lock user_moderation_lock.3>.exists
PASSED

tests/test_invenio_users_resources.py::ISORT PASSED
tests/test_invenio_users_resources.py::black PASSED
tests/test_invenio_users_resources.py::test_version PASSED
tests/test_invenio_users_resources.py::test_init PASSED
tests/test_notifications.py::ISORT PASSED
tests/test_notifications.py::black PASSED
tests/test_notifications.py::test_user_recipient_generator PASSED

tests/test_notifications.py::test_user_recipient_filter PASSED
invenio_users_resources/__init__.py::PYDOCSTYLE PASSED
invenio_users_resources/__init__.py::ISORT PASSED
invenio_users_resources/__init__.py::black PASSED
invenio_users_resources/config.py::PYDOCSTYLE PASSED
invenio_users_resources/config.py::ISORT PASSED
invenio_users_resources/config.py::black PASSED
invenio_users_resources/entity_resolvers.py::PYDOCSTYLE PASSED
invenio_users_resources/entity_resolvers.py::ISORT PASSED
invenio_users_resources/entity_resolvers.py::black PASSED
invenio_users_resources/ext.py::PYDOCSTYLE PASSED
invenio_users_resources/ext.py::ISORT PASSED
invenio_users_resources/ext.py::black PASSED
invenio_users_resources/forms.py::PYDOCSTYLE PASSED
invenio_users_resources/forms.py::ISORT PASSED
invenio_users_resources/forms.py::black PASSED
invenio_users_resources/models.py::PYDOCSTYLE PASSED
invenio_users_resources/models.py::ISORT PASSED
invenio_users_resources/models.py::black PASSED
invenio_users_resources/notifications/__init__.py::PYDOCSTYLE PASSED
invenio_users_resources/notifications/__init__.py::ISORT PASSED
invenio_users_resources/notifications/__init__.py::black PASSED
invenio_users_resources/notifications/filters.py::PYDOCSTYLE PASSED
invenio_users_resources/notifications/filters.py::ISORT PASSED
invenio_users_resources/notifications/filters.py::black PASSED
invenio_users_resources/notifications/generators.py::PYDOCSTYLE PASSED
invenio_users_resources/notifications/generators.py::ISORT PASSED
invenio_users_resources/notifications/generators.py::black PASSED
invenio_users_resources/permissions.py::PYDOCSTYLE PASSED
invenio_users_resources/permissions.py::ISORT PASSED
invenio_users_resources/permissions.py::black PASSED
invenio_users_resources/proxies.py::PYDOCSTYLE PASSED
invenio_users_resources/proxies.py::ISORT PASSED
invenio_users_resources/proxies.py::black PASSED
invenio_users_resources/records/__init__.py::PYDOCSTYLE PASSED
invenio_users_resources/records/__init__.py::ISORT PASSED
invenio_users_resources/records/__init__.py::black PASSED
invenio_users_resources/records/api.py::PYDOCSTYLE PASSED
invenio_users_resources/records/api.py::ISORT PASSED
invenio_users_resources/records/api.py::black PASSED
invenio_users_resources/records/dumpers/__init__.py::PYDOCSTYLE PASSED
invenio_users_resources/records/dumpers/__init__.py::ISORT PASSED
invenio_users_resources/records/dumpers/__init__.py::black PASSED
invenio_users_resources/records/dumpers/email.py::PYDOCSTYLE PASSED
invenio_users_resources/records/dumpers/email.py::ISORT PASSED
invenio_users_resources/records/dumpers/email.py::black PASSED
invenio_users_resources/records/hooks.py::PYDOCSTYLE PASSED
invenio_users_resources/records/hooks.py::ISORT PASSED
invenio_users_resources/records/hooks.py::black PASSED
invenio_users_resources/records/mappings/__init__.py::PYDOCSTYLE PASSED
invenio_users_resources/records/mappings/__init__.py::ISORT PASSED
invenio_users_resources/records/mappings/__init__.py::black PASSED
invenio_users_resources/records/mappings/os-v1/__init__.py::PYDOCSTYLE PASSED
invenio_users_resources/records/mappings/os-v1/__init__.py::ISORT PASSED
invenio_users_resources/records/mappings/os-v1/__init__.py::black PASSED
invenio_users_resources/records/mappings/os-v2/__init__.py::PYDOCSTYLE PASSED
invenio_users_resources/records/mappings/os-v2/__init__.py::ISORT PASSED
invenio_users_resources/records/mappings/os-v2/__init__.py::black PASSED
invenio_users_resources/records/mappings/v7/__init__.py::PYDOCSTYLE PASSED
invenio_users_resources/records/mappings/v7/__init__.py::ISORT PASSED
invenio_users_resources/records/mappings/v7/__init__.py::black PASSED
invenio_users_resources/records/models.py::PYDOCSTYLE PASSED
invenio_users_resources/records/models.py::ISORT PASSED
invenio_users_resources/records/models.py::black PASSED
invenio_users_resources/records/systemfields/__init__.py::PYDOCSTYLE PASSED
invenio_users_resources/records/systemfields/__init__.py::ISORT PASSED
invenio_users_resources/records/systemfields/__init__.py::black PASSED
invenio_users_resources/resources/__init__.py::PYDOCSTYLE PASSED
invenio_users_resources/resources/__init__.py::ISORT PASSED
invenio_users_resources/resources/__init__.py::black PASSED
invenio_users_resources/resources/domains/__init__.py::PYDOCSTYLE PASSED
invenio_users_resources/resources/domains/__init__.py::ISORT PASSED
invenio_users_resources/resources/domains/__init__.py::black PASSED
invenio_users_resources/resources/domains/config.py::PYDOCSTYLE PASSED
invenio_users_resources/resources/domains/config.py::ISORT PASSED
invenio_users_resources/resources/domains/config.py::black PASSED
invenio_users_resources/resources/domains/resource.py::PYDOCSTYLE PASSED
invenio_users_resources/resources/domains/resource.py::ISORT PASSED
invenio_users_resources/resources/domains/resource.py::black PASSED
invenio_users_resources/resources/groups/__init__.py::PYDOCSTYLE PASSED
invenio_users_resources/resources/groups/__init__.py::ISORT PASSED
invenio_users_resources/resources/groups/__init__.py::black PASSED
invenio_users_resources/resources/groups/config.py::PYDOCSTYLE PASSED
invenio_users_resources/resources/groups/config.py::ISORT PASSED
invenio_users_resources/resources/groups/config.py::black PASSED
invenio_users_resources/resources/groups/resource.py::PYDOCSTYLE PASSED
invenio_users_resources/resources/groups/resource.py::ISORT PASSED
invenio_users_resources/resources/groups/resource.py::black PASSED
invenio_users_resources/resources/users/__init__.py::PYDOCSTYLE PASSED
invenio_users_resources/resources/users/__init__.py::ISORT PASSED
invenio_users_resources/resources/users/__init__.py::black PASSED
invenio_users_resources/resources/users/config.py::PYDOCSTYLE PASSED
invenio_users_resources/resources/users/config.py::ISORT PASSED
invenio_users_resources/resources/users/config.py::black PASSED
invenio_users_resources/resources/users/errors.py::PYDOCSTYLE PASSED
invenio_users_resources/resources/users/errors.py::ISORT PASSED
invenio_users_resources/resources/users/errors.py::black PASSED
invenio_users_resources/resources/users/resource.py::PYDOCSTYLE PASSED
invenio_users_resources/resources/users/resource.py::ISORT PASSED
invenio_users_resources/resources/users/resource.py::black PASSED
invenio_users_resources/services/__init__.py::PYDOCSTYLE PASSED
invenio_users_resources/services/__init__.py::ISORT PASSED
invenio_users_resources/services/__init__.py::black PASSED
invenio_users_resources/services/common.py::PYDOCSTYLE PASSED
invenio_users_resources/services/common.py::ISORT PASSED
invenio_users_resources/services/common.py::black PASSED
invenio_users_resources/services/domains/__init__.py::PYDOCSTYLE PASSED
invenio_users_resources/services/domains/__init__.py::ISORT PASSED
invenio_users_resources/services/domains/__init__.py::black PASSED
invenio_users_resources/services/domains/components.py::PYDOCSTYLE PASSED
invenio_users_resources/services/domains/components.py::ISORT PASSED
invenio_users_resources/services/domains/components.py::black PASSED
invenio_users_resources/services/domains/config.py::PYDOCSTYLE PASSED
invenio_users_resources/services/domains/config.py::ISORT PASSED
invenio_users_resources/services/domains/config.py::black PASSED
invenio_users_resources/services/domains/facets.py::PYDOCSTYLE PASSED
invenio_users_resources/services/domains/facets.py::ISORT PASSED
invenio_users_resources/services/domains/facets.py::black PASSED
invenio_users_resources/services/domains/service.py::PYDOCSTYLE PASSED
invenio_users_resources/services/domains/service.py::ISORT PASSED
invenio_users_resources/services/domains/service.py::black PASSED
invenio_users_resources/services/domains/tasks.py::PYDOCSTYLE PASSED
invenio_users_resources/services/domains/tasks.py::ISORT PASSED
invenio_users_resources/services/domains/tasks.py::black PASSED
invenio_users_resources/services/generators.py::PYDOCSTYLE PASSED
invenio_users_resources/services/generators.py::ISORT PASSED
invenio_users_resources/services/generators.py::black PASSED
invenio_users_resources/services/groups/__init__.py::PYDOCSTYLE PASSED
invenio_users_resources/services/groups/__init__.py::ISORT PASSED
invenio_users_resources/services/groups/__init__.py::black PASSED
invenio_users_resources/services/groups/config.py::PYDOCSTYLE PASSED
invenio_users_resources/services/groups/config.py::ISORT PASSED
invenio_users_resources/services/groups/config.py::black PASSED
invenio_users_resources/services/groups/results.py::PYDOCSTYLE PASSED
invenio_users_resources/services/groups/results.py::ISORT PASSED
invenio_users_resources/services/groups/results.py::black PASSED
invenio_users_resources/services/groups/service.py::PYDOCSTYLE PASSED
invenio_users_resources/services/groups/service.py::ISORT PASSED
invenio_users_resources/services/groups/service.py::black PASSED
invenio_users_resources/services/groups/tasks.py::PYDOCSTYLE PASSED
invenio_users_resources/services/groups/tasks.py::ISORT PASSED
invenio_users_resources/services/groups/tasks.py::black PASSED
invenio_users_resources/services/params.py::PYDOCSTYLE PASSED
invenio_users_resources/services/params.py::ISORT PASSED
invenio_users_resources/services/params.py::black PASSED
invenio_users_resources/services/permissions.py::PYDOCSTYLE PASSED
invenio_users_resources/services/permissions.py::ISORT PASSED
invenio_users_resources/services/permissions.py::black PASSED
invenio_users_resources/services/results.py::PYDOCSTYLE PASSED
invenio_users_resources/services/results.py::ISORT PASSED
invenio_users_resources/services/results.py::black PASSED
invenio_users_resources/services/schemas.py::PYDOCSTYLE PASSED
invenio_users_resources/services/schemas.py::ISORT PASSED
invenio_users_resources/services/schemas.py::black PASSED
invenio_users_resources/services/users/__init__.py::PYDOCSTYLE PASSED
invenio_users_resources/services/users/__init__.py::ISORT PASSED
invenio_users_resources/services/users/__init__.py::black PASSED
invenio_users_resources/services/users/config.py::PYDOCSTYLE PASSED
invenio_users_resources/services/users/config.py::ISORT PASSED
invenio_users_resources/services/users/config.py::black PASSED
invenio_users_resources/services/users/facets.py::PYDOCSTYLE PASSED
invenio_users_resources/services/users/facets.py::ISORT PASSED
invenio_users_resources/services/users/facets.py::black PASSED
invenio_users_resources/services/users/lock.py::PYDOCSTYLE PASSED
invenio_users_resources/services/users/lock.py::ISORT PASSED
invenio_users_resources/services/users/lock.py::black PASSED
invenio_users_resources/services/users/results.py::PYDOCSTYLE PASSED
invenio_users_resources/services/users/results.py::ISORT PASSED
invenio_users_resources/services/users/results.py::black PASSED
invenio_users_resources/services/users/search_params.py::PYDOCSTYLE PASSED
invenio_users_resources/services/users/search_params.py::ISORT PASSED
invenio_users_resources/services/users/search_params.py::black PASSED
invenio_users_resources/services/users/service.py::PYDOCSTYLE PASSED
invenio_users_resources/services/users/service.py::ISORT PASSED
invenio_users_resources/services/users/service.py::black PASSED
invenio_users_resources/services/users/tasks.py::PYDOCSTYLE PASSED
invenio_users_resources/services/users/tasks.py::ISORT PASSED
invenio_users_resources/services/users/tasks.py::black PASSED
invenio_users_resources/views.py::PYDOCSTYLE PASSED
invenio_users_resources/views.py::ISORT PASSED
invenio_users_resources/views.py::black PASSED

=================================== FAILURES ===================================
_ test_admin_links[admin_records_html-/administration/records?q=parent.access.owned_by.user:{id}&f=allversions] _

client = <FlaskClient <Flask 'invenio'>>
headers = {'accept': 'application/json', 'content-type': 'application/json'}
user_moderator = <pytest_invenio.user.UserFixtureBase object at 0x7fc58928c050>
user_pub = <pytest_invenio.user.UserFixtureBase object at 0x7fc589257620>
link_name = 'admin_records_html'
expected_url = '/administration/records?q=parent.access.owned_by.user:{id}&f=allversions'

    @pytest.mark.parametrize(
        "link_name,expected_url",
        [
            (
                "admin_records_html",
                "/administration/records?q=parent.access.owned_by.user:{id}&f=allversions",
            ),
            (
                "admin_drafts_html",
                "/administration/drafts?q=parent.access.owned_by.user:{id}&f=allversions",
            ),
            ("admin_moderation_html", "/administration/moderation?q=topic.user:{id}"),
        ],
    )
    def test_admin_links(
        client, headers, user_moderator, user_pub, link_name, expected_url
    ):
        """Test admin links."""
>       client = user_moderator.login(client)
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^

client     = <FlaskClient <Flask 'invenio'>>
expected_url = '/administration/records?q=parent.access.owned_by.user:{id}&f=allversions'
headers    = {'accept': 'application/json', 'content-type': 'application/json'}
link_name  = 'admin_records_html'
user_moderator = <pytest_invenio.user.UserFixtureBase object at 0x7fc58928c050>
user_pub   = <pytest_invenio.user.UserFixtureBase object at 0x7fc589257620>

tests/resources/test_resources_users.py:281: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.12/site-packages/pytest_invenio/user.py:152: in login
    return self._login(client, "/", logout_first)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        client     = <FlaskClient <Flask 'invenio'>>
        logout_first = False
        self       = <pytest_invenio.user.UserFixtureBase object at 0x7fc58928c050>
.venv/lib/python3.12/site-packages/pytest_invenio/user.py:170: in _login
    res = client.post(
        base_path  = '/'
        client     = <FlaskClient <Flask 'invenio'>>
        logout     = False
        self       = <pytest_invenio.user.UserFixtureBase object at 0x7fc58928c050>
.venv/lib/python3.12/site-packages/werkzeug/test.py:1167: in post
    return self.open(*args, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^
        args       = ('/login',)
        kw         = {'data': {'email': 'user_moderator@inveniosoftware.org',
          'password': 'user_moderator'},
 'follow_redirects': True,
 'method': 'POST'}
        self       = <FlaskClient <Flask 'invenio'>>
.venv/lib/python3.12/site-packages/flask/testing.py:235: in open
    response = super().open(
        __class__  = <class 'flask.testing.FlaskClient'>
        args       = ('/login',)
        buffered   = False
        follow_redirects = True
        kwargs     = {'data': {'email': 'user_moderator@inveniosoftware.org',
          'password': 'user_moderator'},
 'environ_base': {'HTTP_USER_AGENT': 'Werkzeug/3.1.4',
                  'REMOTE_ADDR': '127.0.0.1',
                  'werkzeug.debug.preserve_context': <built-in method append of list object at 0x7fc58864c600>},
 'method': 'POST'}
        request    = <Request 'http://localhost/login' [POST]>
        self       = <FlaskClient <Flask 'invenio'>>
.venv/lib/python3.12/site-packages/werkzeug/test.py:1116: in open
    response_parts = self.run_wsgi_app(request.environ, buffered=buffered)
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        arg        = <Request 'http://localhost/login' [POST]>
        args       = (<Request 'http://localhost/login' [POST]>,)
        buffered   = False
        follow_redirects = True
        kwargs     = {}
        request    = <Request 'http://localhost/login' [POST]>
        self       = <FlaskClient <Flask 'invenio'>>
.venv/lib/python3.12/site-packages/werkzeug/test.py:988: in run_wsgi_app
    rv = run_wsgi_app(self.application, environ, buffered=buffered)
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        buffered   = False
        environ    = {'CONTENT_LENGTH': '64',
 'CONTENT_TYPE': 'application/x-www-form-urlencoded',
 'HTTP_HOST': 'localhost',
 'HTTP_USER_AGENT': 'Werkzeug/3.1.4',
 'PATH_INFO': '/login',
 'QUERY_STRING': '',
 'RAW_URI': '/login',
 'REMOTE_ADDR': '127.0.0.1',
 'REQUEST_METHOD': 'POST',
 'REQUEST_URI': '/login',
 'SCRIPT_NAME': '',
 'SERVER_NAME': 'localhost',
 'SERVER_PORT': '80',
 'SERVER_PROTOCOL': 'HTTP/1.1',
 'werkzeug.debug.preserve_context': <built-in method append of list object at 0x7fc58864c600>,
 'werkzeug.request': <Request 'http://localhost/login' [POST]>,
 'wsgi.errors': <_io.TextIOWrapper name='<stderr>' mode='w' encoding='utf-8'>,
 'wsgi.input': <_io.BytesIO object at 0x7fc588558180>,
 'wsgi.multiprocess': False,
 'wsgi.multithread': False,
 'wsgi.run_once': False,
 'wsgi.url_scheme': 'http',
 'wsgi.version': (1, 0)}
        self       = <FlaskClient <Flask 'invenio'>>
.venv/lib/python3.12/site-packages/werkzeug/test.py:1264: in run_wsgi_app
    app_rv = app(environ, start_response)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        app        = <Flask 'invenio'>
        buffer     = []
        buffered   = False
        environ    = {'CONTENT_LENGTH': '64',
 'CONTENT_TYPE': 'application/x-www-form-urlencoded',
 'HTTP_HOST': 'localhost',
 'HTTP_USER_AGENT': 'Werkzeug/3.1.4',
 'PATH_INFO': '/login',
 'QUERY_STRING': '',
 'RAW_URI': '/login',
 'REMOTE_ADDR': '127.0.0.1',
 'REQUEST_METHOD': 'POST',
 'REQUEST_URI': '/login',
 'SCRIPT_NAME': '',
 'SERVER_NAME': 'localhost',
 'SERVER_PORT': '80',
 'SERVER_PROTOCOL': 'HTTP/1.1',
 'werkzeug.debug.preserve_context': <built-in method append of list object at 0x7fc58864c600>,
 'werkzeug.request': None,
 'wsgi.errors': <_io.TextIOWrapper name='<stderr>' mode='w' encoding='utf-8'>,
 'wsgi.input': <_io.BytesIO object at 0x7fc588558180>,
 'wsgi.multiprocess': False,
 'wsgi.multithread': False,
 'wsgi.run_once': False,
 'wsgi.url_scheme': 'http',
 'wsgi.version': (1, 0)}
        response   = None
        start_response = <function run_wsgi_app.<locals>.start_response at 0x7fc588470b80>
.venv/lib/python3.12/site-packages/flask/app.py:1536: in __call__
    return self.wsgi_app(environ, start_response)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        environ    = {'CONTENT_LENGTH': '64',
 'CONTENT_TYPE': 'application/x-www-form-urlencoded',
 'HTTP_HOST': 'localhost',
 'HTTP_USER_AGENT': 'Werkzeug/3.1.4',
 'PATH_INFO': '/login',
 'QUERY_STRING': '',
 'RAW_URI': '/login',
 'REMOTE_ADDR': '127.0.0.1',
 'REQUEST_METHOD': 'POST',
 'REQUEST_URI': '/login',
 'SCRIPT_NAME': '',
 'SERVER_NAME': 'localhost',
 'SERVER_PORT': '80',
 'SERVER_PROTOCOL': 'HTTP/1.1',
 'werkzeug.debug.preserve_context': <built-in method append of list object at 0x7fc58864c600>,
 'werkzeug.request': None,
 'wsgi.errors': <_io.TextIOWrapper name='<stderr>' mode='w' encoding='utf-8'>,
 'wsgi.input': <_io.BytesIO object at 0x7fc588558180>,
 'wsgi.multiprocess': False,
 'wsgi.multithread': False,
 'wsgi.run_once': False,
 'wsgi.url_scheme': 'http',
 'wsgi.version': (1, 0)}
        self       = <Flask 'invenio'>
        start_response = <function run_wsgi_app.<locals>.start_response at 0x7fc588470b80>
.venv/lib/python3.12/site-packages/flask/app.py:1514: in wsgi_app
    response = self.handle_exception(e)
               ^^^^^^^^^^^^^^^^^^^^^^^^
        ctx        = <RequestContext 'http://localhost/login' [POST] of invenio>
        environ    = {'CONTENT_LENGTH': '64',
 'CONTENT_TYPE': 'application/x-www-form-urlencoded',
 'HTTP_HOST': 'localhost',
 'HTTP_USER_AGENT': 'Werkzeug/3.1.4',
 'PATH_INFO': '/login',
 'QUERY_STRING': '',
 'RAW_URI': '/login',
 'REMOTE_ADDR': '127.0.0.1',
 'REQUEST_METHOD': 'POST',
 'REQUEST_URI': '/login',
 'SCRIPT_NAME': '',
 'SERVER_NAME': 'localhost',
 'SERVER_PORT': '80',
 'SERVER_PROTOCOL': 'HTTP/1.1',
 'werkzeug.debug.preserve_context': <built-in method append of list object at 0x7fc58864c600>,
 'werkzeug.request': None,
 'wsgi.errors': <_io.TextIOWrapper name='<stderr>' mode='w' encoding='utf-8'>,
 'wsgi.input': <_io.BytesIO object at 0x7fc588558180>,
 'wsgi.multiprocess': False,
 'wsgi.multithread': False,
 'wsgi.run_once': False,
 'wsgi.url_scheme': 'http',
 'wsgi.version': (1, 0)}
        error      = StaleDataError("UPDATE statement on table 'accounts_user' expected to update 1 row(s); 0 were matched.")
        self       = <Flask 'invenio'>
        start_response = <function run_wsgi_app.<locals>.start_response at 0x7fc588470b80>
.venv/lib/python3.12/site-packages/flask/app.py:1511: in wsgi_app
    response = self.full_dispatch_request()
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        ctx        = <RequestContext 'http://localhost/login' [POST] of invenio>
        environ    = {'CONTENT_LENGTH': '64',
 'CONTENT_TYPE': 'application/x-www-form-urlencoded',
 'HTTP_HOST': 'localhost',
 'HTTP_USER_AGENT': 'Werkzeug/3.1.4',
 'PATH_INFO': '/login',
 'QUERY_STRING': '',
 'RAW_URI': '/login',
 'REMOTE_ADDR': '127.0.0.1',
 'REQUEST_METHOD': 'POST',
 'REQUEST_URI': '/login',
 'SCRIPT_NAME': '',
 'SERVER_NAME': 'localhost',
 'SERVER_PORT': '80',
 'SERVER_PROTOCOL': 'HTTP/1.1',
 'werkzeug.debug.preserve_context': <built-in method append of list object at 0x7fc58864c600>,
 'werkzeug.request': None,
 'wsgi.errors': <_io.TextIOWrapper name='<stderr>' mode='w' encoding='utf-8'>,
 'wsgi.input': <_io.BytesIO object at 0x7fc588558180>,
 'wsgi.multiprocess': False,
 'wsgi.multithread': False,
 'wsgi.run_once': False,
 'wsgi.url_scheme': 'http',
 'wsgi.version': (1, 0)}
        error      = StaleDataError("UPDATE statement on table 'accounts_user' expected to update 1 row(s); 0 were matched.")
        self       = <Flask 'invenio'>
        start_response = <function run_wsgi_app.<locals>.start_response at 0x7fc588470b80>
.venv/lib/python3.12/site-packages/flask/app.py:919: in full_dispatch_request
    rv = self.handle_user_exception(e)
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        rv         = None
        self       = <Flask 'invenio'>
.venv/lib/python3.12/site-packages/flask/app.py:917: in full_dispatch_request
    rv = self.dispatch_request()
         ^^^^^^^^^^^^^^^^^^^^^^^
        rv         = None
        self       = <Flask 'invenio'>
.venv/lib/python3.12/site-packages/flask/app.py:902: in dispatch_request
    return self.ensure_sync(self.view_functions[rule.endpoint])(**view_args)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        req        = <Request 'http://localhost/login' [POST]>
        rule       = <Rule '/login' (POST, OPTIONS) -> invenio_accounts_rest_auth.login>
        self       = <Flask 'invenio'>
        view_args  = {}
.venv/lib/python3.12/site-packages/invenio_accounts/views/rest.py:61: in wrapper
    return f(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^
        args       = ()
        f          = <function View.as_view.<locals>.view at 0x7fc5892600e0>
        kwargs     = {}
.venv/lib/python3.12/site-packages/flask/views.py:110: in view
    return current_app.ensure_sync(self.dispatch_request)(**kwargs)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        class_args = ()
        class_kwargs = {}
        kwargs     = {}
        self       = <invenio_accounts.views.rest.LoginView object at 0x7fc5891a7260>
        view       = <function View.as_view.<locals>.view at 0x7fc589280a40>
.venv/lib/python3.12/site-packages/flask/views.py:191: in dispatch_request
    return current_app.ensure_sync(meth)(**kwargs)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        kwargs     = {}
        meth       = <bound method LoginView.post of <invenio_accounts.views.rest.LoginView object at 0x7fc5891a7260>>
        self       = <invenio_accounts.views.rest.LoginView object at 0x7fc5891a7260>
.venv/lib/python3.12/site-packages/webargs/core.py:455: in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
        argmap     = <GeneratedSchema(many=False)>
        args       = (<invenio_accounts.views.rest.LoginView object at 0x7fc5891a7260>,)
        as_kwargs  = True
        error_headers = None
        error_status_code = None
        func       = <function LoginView.post at 0x7fc58d494fe0>
        kwargs     = {'email': 'user_moderator@inveniosoftware.org', 'password': 'user_moderator'}
        locations  = ('querystring', 'form', 'json')
        parsed_args = {'email': 'user_moderator@inveniosoftware.org', 'password': 'user_moderator'}
        req_       = None
        req_obj    = None
        self       = <invenio_accounts.views.rest.FlaskParser object at 0x7fc58d659df0>
        validate   = None
.venv/lib/python3.12/site-packages/invenio_accounts/views/rest.py:278: in post
    self.login_user(user)
        kwargs     = {'email': 'user_moderator@inveniosoftware.org', 'password': 'user_moderator'}
        self       = <invenio_accounts.views.rest.LoginView object at 0x7fc5891a7260>
        user       = <User 8>
.venv/lib/python3.12/site-packages/invenio_accounts/views/rest.py:268: in login_user
    return login_user(user)
           ^^^^^^^^^^^^^^^^
        self       = <invenio_accounts.views.rest.LoginView object at 0x7fc5891a7260>
        user       = <User 8>
.venv/lib/python3.12/site-packages/flask_security/utils.py:99: in login_user
    identity_changed.send(current_app._get_current_object(), identity=Identity(user.id))
        kwargs     = {}
        new_current_ip = '127.0.0.1'
        new_current_login = datetime.datetime(2025, 12, 10, 9, 54, 35, 408102)
        old_current_ip = None
        old_current_login = None
        remote_addr = '127.0.0.1'
        user       = <User 8>
.venv/lib/python3.12/site-packages/blinker/base.py:249: in send
    result = receiver(sender, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^
        _async_wrapper = None
        kwargs     = {'identity': <Identity id="8" auth_type="None" provides={Need(method='id', value=8)}>}
        receiver   = <bound method Principal._on_identity_changed of <flask_principal.Principal object at 0x7fc5893e1d00>>
        results    = []
        self       = <blinker.base.NamedSignal object at 0x7fc599cc31d0; 'identity-changed'>
        sender     = <Flask 'invenio'>
.venv/lib/python3.12/site-packages/flask_principal.py:469: in _on_identity_changed
    self.set_identity(identity)
        app        = <Flask 'invenio'>
        identity   = <Identity id="8" auth_type="None" provides={Need(method='id', value=8)}>
        self       = <flask_principal.Principal object at 0x7fc5893e1d00>
.venv/lib/python3.12/site-packages/flask_principal.py:418: in set_identity
    self._set_thread_identity(identity)
        identity   = <Identity id="8" auth_type="None" provides={Need(method='id', value=8)}>
        self       = <flask_principal.Principal object at 0x7fc5893e1d00>
.venv/lib/python3.12/site-packages/flask_principal.py:462: in _set_thread_identity
    identity_loaded.send(current_app._get_current_object(),
        identity   = <Identity id="8" auth_type="None" provides={Need(method='id', value=8)}>
        self       = <flask_principal.Principal object at 0x7fc5893e1d00>
.venv/lib/python3.12/site-packages/blinker/base.py:249: in send
    result = receiver(sender, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^
        _async_wrapper = None
        kwargs     = {'identity': <Identity id="8" auth_type="None" provides={Need(method='id', value=8)}>}
        receiver   = <function _on_identity_loaded at 0x7fc597c4e480>
        results    = []
        self       = <blinker.base.NamedSignal object at 0x7fc598575190; 'identity-loaded'>
        sender     = <Flask 'invenio'>
.venv/lib/python3.12/site-packages/flask_security/core.py:256: in _on_identity_loaded
    for role in getattr(current_user, "roles", []):
                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        identity   = <Identity id="8" auth_type="None" provides={Need(method='id', value=8)}>
        sender     = <Flask 'invenio'>
.venv/lib/python3.12/site-packages/sqlalchemy/orm/attributes.py:569: in __get__
    return self.impl.get(state, dict_)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
        dict_      = {'_sa_instance_state': <sqlalchemy.orm.state.InstanceState object at 0x7fc58922d310>}
        instance   = <User 8>
        owner      = <class 'invenio_accounts.models.User'>
        self       = <sqlalchemy.orm.attributes.InstrumentedAttribute object at 0x7fc59495f880>
        state      = <sqlalchemy.orm.state.InstanceState object at 0x7fc58922d310>
.venv/lib/python3.12/site-packages/sqlalchemy/orm/attributes.py:1096: in get
    value = self._fire_loader_callables(state, key, passive)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        dict_      = {'_sa_instance_state': <sqlalchemy.orm.state.InstanceState object at 0x7fc58922d310>}
        key        = 'roles'
        passive    = symbol('PASSIVE_OFF')
        self       = <sqlalchemy.orm.attributes.CollectionAttributeImpl object at 0x7fc597435b10>
        state      = <sqlalchemy.orm.state.InstanceState object at 0x7fc58922d310>
.venv/lib/python3.12/site-packages/sqlalchemy/orm/attributes.py:1131: in _fire_loader_callables
    return self.callable_(state, passive)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        key        = 'roles'
        passive    = symbol('PASSIVE_OFF')
        self       = <sqlalchemy.orm.attributes.CollectionAttributeImpl object at 0x7fc597435b10>
        state      = <sqlalchemy.orm.state.InstanceState object at 0x7fc58922d310>
.venv/lib/python3.12/site-packages/sqlalchemy/orm/strategies.py:978: in _load_for_state
    return self._emit_lazyload(
        alternate_effective_path = None
        execution_options = immutabledict({})
        extra_criteria = ()
        extra_options = ()
        loadopt    = None
        passive    = symbol('PASSIVE_OFF')
        pending    = False
        primary_key_identity = None
        self       = <sqlalchemy.orm.strategies.LazyLoader object at 0x7fc597484820>
        session    = <sqlalchemy.orm.session.Session object at 0x7fc5892ebef0>
        state      = <sqlalchemy.orm.state.InstanceState object at 0x7fc58922d310>
        use_get    = False
.venv/lib/python3.12/site-packages/sqlalchemy/orm/strategies.py:1141: in _emit_lazyload
    result = session.execute(
        _lazyload_reverse = <function LazyLoader._emit_lazyload.<locals>._lazyload_reverse at 0x7fc5884711c0>
        alternate_effective_path = None
        clauseelement = Table('accounts_role', MetaData(), Column('id', String(length=80), table=<accounts_role>, primary_key=True, nullable=False, default=CallableColumnDefault(<function Role.<lambda> at 0x7fc59499f9c0>)), Column('name', String(length=80), table=<accounts_role>), Column('description', String(length=255), table=<accounts_role>), Column('is_managed', Boolean(), table=<accounts_role>, nullable=False, default=ScalarElementColumnDefault(True)), Column('version_id', Integer(), table=<accounts_role>, nullable=False), Column('created', DateTime(), table=<accounts_role>, nullable=False, default=CallableColumnDefault(<function datetime.utcnow at 0x7fc596558ea0>)), Column('updated', DateTime(), table=<accounts_role>, nullable=False, default=CallableColumnDefault(<function datetime.utcnow at 0x7fc596558fe0>)), schema=None)
        effective_path = PropRegistry((<Mapper at 0x7fc596363b30; User>, <_RelationshipDeclared at 0x7fc59495d9f0; roles>))
        execution_options = {'_sa_orm_load_options': default_load_options(_invoke_all_eagers=False, _lazy_loaded_from=<sqlalchemy.orm.state.InstanceState object at 0x7fc58922d310>)}
        extra_criteria = ()
        extra_options = ()
        lazy_clause = <sqlalchemy.sql.annotation.AnnotatedBooleanClauseList object at 0x7fc58d3abad0>
        load_options = default_load_options(_invoke_all_eagers=False, _lazy_loaded_from=<sqlalchemy.orm.state.InstanceState object at 0x7fc58922d310>)
        loadopt    = None
        params     = {'%(140486465528816 param)s': 8}
        passive    = symbol('PASSIVE_OFF')
        pending    = False
        primary_key_identity = None
        self       = <sqlalchemy.orm.strategies.LazyLoader object at 0x7fc597484820>
        session    = <sqlalchemy.orm.session.Session object at 0x7fc5892ebef0>
        state      = <sqlalchemy.orm.state.InstanceState object at 0x7fc58922d310>
        stmt       = <sqlalchemy.sql.selectable.Select object at 0x7fc588550410>
        strategy_options = <module 'sqlalchemy.orm.strategy_options' from '/home/runner/work/invenio-testrig/invenio-testrig/package-repo/.venv/lib/python3.12/site-packages/sqlalchemy/orm/strategy_options.py'>
        use_get    = False
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2351: in execute
    return self._execute_internal(
        _add_event = None
        _parent_execute_state = None
        bind_arguments = None
        execution_options = {'_sa_orm_load_options': default_load_options(_invoke_all_eagers=False, _lazy_loaded_from=<sqlalchemy.orm.state.InstanceState object at 0x7fc58922d310>)}
        params     = {'%(140486465528816 param)s': 8}
        self       = <sqlalchemy.orm.session.Session object at 0x7fc5892ebef0>
        statement  = <sqlalchemy.sql.selectable.Select object at 0x7fc588550410>
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2228: in _execute_internal
    ) = compile_state_cls.orm_pre_session_exec(
        _add_event = None
        _parent_execute_state = None
        _scalar_result = False
        bind_arguments = {'clause': <sqlalchemy.sql.selectable.Select object at 0x7fc588550410>,
 'mapper': <Mapper at 0x7fc5963623c0; Role>}
        compile_state_cls = <class 'sqlalchemy.orm.context.ORMSelectCompileState'>
        events_todo = <sqlalchemy.event.attr._EmptyListener object at 0x7fc58e552b40>
        execution_options = immutabledict({'_sa_orm_load_options': default_load_options(_invoke_all_eagers=False, _lazy_loaded_from=<sqlalchemy.orm.state.InstanceState object at 0x7fc58922d310>)})
        params     = {'%(140486465528816 param)s': 8}
        self       = <sqlalchemy.orm.session.Session object at 0x7fc5892ebef0>
        statement  = <sqlalchemy.sql.selectable.Select object at 0x7fc588550410>
.venv/lib/python3.12/site-packages/sqlalchemy/orm/context.py:577: in orm_pre_session_exec
    session._autoflush()
        bind_arguments = {'clause': <sqlalchemy.sql.selectable.Select object at 0x7fc588550410>,
 'mapper': <Mapper at 0x7fc5963623c0; Role>}
        cls        = <class 'sqlalchemy.orm.context.ORMSelectCompileState'>
        execution_options = immutabledict({'_sa_orm_load_options': default_load_options(_invoke_all_eagers=False, _lazy_loaded_from=<sqlalchemy.orm.state.InstanceState object at 0x7fc58922d310>), '_result_disable_adapt_to_context': True})
        is_pre_event = False
        load_options = default_load_options(_invoke_all_eagers=False, _lazy_loaded_from=<sqlalchemy.orm.state.InstanceState object at 0x7fc58922d310>)
        params     = {'%(140486465528816 param)s': 8}
        plugin_subject = <Mapper at 0x7fc5963623c0; Role>
        session    = <sqlalchemy.orm.session.Session object at 0x7fc5892ebef0>
        statement  = <sqlalchemy.sql.selectable.Select object at 0x7fc588550410>
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:3040: in _autoflush
    self.flush()
        self       = <sqlalchemy.orm.session.Session object at 0x7fc5892ebef0>
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:4331: in flush
    self._flush(objects)
        objects    = None
        self       = <sqlalchemy.orm.session.Session object at 0x7fc5892ebef0>
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:4466: in _flush
    with util.safe_reraise():
         ^^^^^^^^^^^^^^^^^^^
        _reg       = True
        deleted    = set()
        dirty      = {<sqlalchemy.orm.state.InstanceState object at 0x7fc58922d310>}
        flush_context = <sqlalchemy.orm.unitofwork.UOWTransaction object at 0x7fc58880f7a0>
        is_orphan  = False
        is_persistent_orphan = False
        new        = {<sqlalchemy.orm.state.InstanceState object at 0x7fc588455df0>}
        objects    = None
        objset     = None
        proc       = set()
        processed  = {<sqlalchemy.orm.state.InstanceState object at 0x7fc588455df0>,
 <sqlalchemy.orm.state.InstanceState object at 0x7fc58922d310>}
        self       = <sqlalchemy.orm.session.Session object at 0x7fc5892ebef0>
        state      = <sqlalchemy.orm.state.InstanceState object at 0x7fc588455df0>
        transaction = <sqlalchemy.orm.session.SessionTransaction object at 0x7fc588567ad0>
.venv/lib/python3.12/site-packages/sqlalchemy/util/langhelpers.py:224: in __exit__
    raise exc_value.with_traceback(exc_tb)
        exc_tb     = <traceback object at 0x7fc588542300>
        exc_type   = <class 'sqlalchemy.orm.exc.StaleDataError'>
        exc_value  = StaleDataError("UPDATE statement on table 'accounts_user' expected to update 1 row(s); 0 were matched.")
        self       = <sqlalchemy.util.langhelpers.safe_reraise object at 0x7fc588746470>
        traceback  = None
        type_      = None
        value      = None
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:4427: in _flush
    flush_context.execute()
        _reg       = True
        deleted    = set()
        dirty      = {<sqlalchemy.orm.state.InstanceState object at 0x7fc58922d310>}
        flush_context = <sqlalchemy.orm.unitofwork.UOWTransaction object at 0x7fc58880f7a0>
        is_orphan  = False
        is_persistent_orphan = False
        new        = {<sqlalchemy.orm.state.InstanceState object at 0x7fc588455df0>}
        objects    = None
        objset     = None
        proc       = set()
        processed  = {<sqlalchemy.orm.state.InstanceState object at 0x7fc588455df0>,
 <sqlalchemy.orm.state.InstanceState object at 0x7fc58922d310>}
        self       = <sqlalchemy.orm.session.Session object at 0x7fc5892ebef0>
        state      = <sqlalchemy.orm.state.InstanceState object at 0x7fc588455df0>
        transaction = <sqlalchemy.orm.session.SessionTransaction object at 0x7fc588567ad0>
.venv/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py:466: in execute
    rec.execute(self)
        postsort_actions = [DeleteAll(Mapper[LoginInformation(accounts_user_login_information)]),
 DeleteAll(Mapper[User(accounts_user)]),
 ProcessAll(ManyToOneDP(LoginInformation.user), isdelete=False),
 ProcessAll(ManyToOneDP(LoginInformation.user), isdelete=True),
 ProcessAll(OneToManyDP(User.login_info), isdelete=False),
 ProcessAll(OneToManyDP(User.login_info), isdelete=True),
 SaveUpdateAll(Mapper[LoginInformation(accounts_user_login_information)]),
 SaveUpdateAll(Mapper[User(accounts_user)])]
        rec        = SaveUpdateAll(Mapper[User(accounts_user)])
        self       = <sqlalchemy.orm.unitofwork.UOWTransaction object at 0x7fc58880f7a0>
.venv/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py:642: in execute
    util.preloaded.orm_persistence.save_obj(
        self       = SaveUpdateAll(Mapper[User(accounts_user)])
        uow        = <sqlalchemy.orm.unitofwork.UOWTransaction object at 0x7fc58880f7a0>
.venv/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py:85: in save_obj
    _emit_update_statements(
        base_mapper = <Mapper at 0x7fc596363b30; User>
        connection = <sqlalchemy.engine.base.Connection object at 0x7fc588fc4d10>
        dict_      = {'_sa_instance_state': <sqlalchemy.orm.state.InstanceState object at 0x7fc58922d310>}
        has_identity = True
        insert     = <generator object _collect_insert_commands at 0x7fc58907ad90>
        mapper     = <Mapper at 0x7fc596363b30; User>
        row_switch = None
        single     = False
        state      = <sqlalchemy.orm.state.InstanceState object at 0x7fc58922d310>
        states     = <generator object UOWTransaction.states_for_mapper_hierarchy at 0x7fc5884889a0>
        states_to_insert = []
        states_to_update = [(<sqlalchemy.orm.state.InstanceState object at 0x7fc58922d310>,
  {'_sa_instance_state': <sqlalchemy.orm.state.InstanceState object at 0x7fc58922d310>},
  <Mapper at 0x7fc596363b30; User>,
  <sqlalchemy.engine.base.Connection object at 0x7fc588fc4d10>,
  2)]
        table      = Table('accounts_user', MetaData(), Column('id', Integer(), table=<accounts_user>, primary_key=True, nullable=False), Column('username', String(length=255), table=<accounts_user>), Column('displayname', String(length=255), table=<accounts_user>), Column('email', String(length=255), table=<accounts_user>), Column('domain', String(length=255), table=<accounts_user>), Column('password', String(length=255), table=<accounts_user>), Column('active', Boolean(name='active'), table=<accounts_user>), Column('confirmed_at', DateTime(), table=<accounts_user>), Column('version_id', Integer(), table=<accounts_user>, nullable=False), Column('profile', JSON(), table=<accounts_user>, default=CallableColumnDefault(<function User.<lambda> at 0x7fc59495dbc0>)), Column('preferences', JSON(), table=<accounts_user>, default=CallableColumnDefault(<function User.<lambda> at 0x7fc59495dd00>)), Column('blocked_at', DateTime(), table=<accounts_user>), Column('verified_at', DateTime(), table=<accounts_user>), Column('created', DateTime(), table=<accounts_user>, nullable=False, default=CallableColumnDefault(<function datetime.utcnow at 0x7fc596558ea0>)), Column('updated', DateTime(), table=<accounts_user>, nullable=False, default=CallableColumnDefault(<function datetime.utcnow at 0x7fc596558fe0>)), schema=None)
        uowtransaction = <sqlalchemy.orm.unitofwork.UOWTransaction object at 0x7fc58880f7a0>
        update     = <generator object _collect_update_commands at 0x7fc588829300>
        update_version_id = 2
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

base_mapper = <Mapper at 0x7fc596363b30; User>
uowtransaction = <sqlalchemy.orm.unitofwork.UOWTransaction object at 0x7fc58880f7a0>
mapper = <Mapper at 0x7fc596363b30; User>
table = Table('accounts_user', MetaData(), Column('id', Integer(), table=<accounts_user>, primary_key=True, nullable=False), C...ounts_user>, nullable=False, default=CallableColumnDefault(<function datetime.utcnow at 0x7fc596558fe0>)), schema=None)
update = <generator object _collect_update_commands at 0x7fc588829300>

    def _emit_update_statements(
        base_mapper,
        uowtransaction,
        mapper,
        table,
        update,
        *,
        bookkeeping=True,
        use_orm_update_stmt=None,
        enable_check_rowcount=True,
    ):
        """Emit UPDATE statements corresponding to value lists collected
        by _collect_update_commands()."""
    
        needs_version_id = (
            mapper.version_id_col is not None
            and mapper.version_id_col in mapper._cols_by_table[table]
        )
    
        execution_options = {"compiled_cache": base_mapper._compiled_cache}
    
        def update_stmt(existing_stmt=None):
            clauses = BooleanClauseList._construct_raw(operators.and_)
    
            for col in mapper._pks_by_table[table]:
                clauses._append_inplace(
                    col == sql.bindparam(col._label, type_=col.type)
                )
    
            if needs_version_id:
                clauses._append_inplace(
                    mapper.version_id_col
                    == sql.bindparam(
                        mapper.version_id_col._label,
                        type_=mapper.version_id_col.type,
                    )
                )
    
            if existing_stmt is not None:
                stmt = existing_stmt.where(clauses)
            else:
                stmt = table.update().where(clauses)
            return stmt
    
        if use_orm_update_stmt is not None:
            cached_stmt = update_stmt(use_orm_update_stmt)
    
        else:
            cached_stmt = base_mapper._memo(("update", table), update_stmt)
    
        for (
            (connection, paramkeys, hasvalue, has_all_defaults, has_all_pks),
            records,
        ) in groupby(
            update,
            lambda rec: (
                rec[4],  # connection
                set(rec[2]),  # set of parameter keys
                bool(rec[5]),  # whether or not we have "value" parameters
                rec[6],  # has_all_defaults
                rec[7],  # has all pks
            ),
        ):
            rows = 0
            records = list(records)
    
            statement = cached_stmt
    
            if use_orm_update_stmt is not None:
                statement = statement._annotate(
                    {
                        "_emit_update_table": table,
                        "_emit_update_mapper": mapper,
                    }
                )
    
            return_defaults = False
    
            if not has_all_pks:
                statement = statement.return_defaults(*mapper._pks_by_table[table])
                return_defaults = True
    
            if (
                bookkeeping
                and not has_all_defaults
                and mapper.base_mapper.eager_defaults is True
                # change as of #8889 - if RETURNING is not going to be used anyway,
                # (applies to MySQL, MariaDB which lack UPDATE RETURNING) ensure
                # we can do an executemany UPDATE which is more efficient
                and table.implicit_returning
                and connection.dialect.update_returning
            ):
                statement = statement.return_defaults(
                    *mapper._server_onupdate_default_cols[table]
                )
                return_defaults = True
    
            if mapper._version_id_has_server_side_value:
                statement = statement.return_defaults(mapper.version_id_col)
                return_defaults = True
    
            assert_singlerow = connection.dialect.supports_sane_rowcount
    
            assert_multirow = (
                assert_singlerow
                and connection.dialect.supports_sane_multi_rowcount
            )
    
            # change as of #8889 - if RETURNING is not going to be used anyway,
            # (applies to MySQL, MariaDB which lack UPDATE RETURNING) ensure
            # we can do an executemany UPDATE which is more efficient
            allow_executemany = not return_defaults and not needs_version_id
    
            if hasvalue:
                for (
                    state,
                    state_dict,
                    params,
                    mapper,
                    connection,
                    value_params,
                    has_all_defaults,
                    has_all_pks,
                ) in records:
                    c = connection.execute(
                        statement.values(value_params),
                        params,
                        execution_options=execution_options,
                    )
                    if bookkeeping:
                        _postfetch(
                            mapper,
                            uowtransaction,
                            table,
                            state,
                            state_dict,
                            c,
                            c.context.compiled_parameters[0],
                            value_params,
                            True,
                            c.returned_defaults,
                        )
                    rows += c.rowcount
                    check_rowcount = enable_check_rowcount and assert_singlerow
            else:
                if not allow_executemany:
                    check_rowcount = enable_check_rowcount and assert_singlerow
                    for (
                        state,
                        state_dict,
                        params,
                        mapper,
                        connection,
                        value_params,
                        has_all_defaults,
                        has_all_pks,
                    ) in records:
                        c = connection.execute(
                            statement, params, execution_options=execution_options
                        )
    
                        # TODO: why with bookkeeping=False?
                        if bookkeeping:
                            _postfetch(
                                mapper,
                                uowtransaction,
                                table,
                                state,
                                state_dict,
                                c,
                                c.context.compiled_parameters[0],
                                value_params,
                                True,
                                c.returned_defaults,
                            )
                        rows += c.rowcount
                else:
                    multiparams = [rec[2] for rec in records]
    
                    check_rowcount = enable_check_rowcount and (
                        assert_multirow
                        or (assert_singlerow and len(multiparams) == 1)
                    )
    
                    c = connection.execute(
                        statement, multiparams, execution_options=execution_options
                    )
    
                    rows += c.rowcount
    
                    for (
                        state,
                        state_dict,
                        params,
                        mapper,
                        connection,
                        value_params,
                        has_all_defaults,
                        has_all_pks,
                    ) in records:
                        if bookkeeping:
                            _postfetch(
                                mapper,
                                uowtransaction,
                                table,
                                state,
                                state_dict,
                                c,
                                c.context.compiled_parameters[0],
                                value_params,
                                True,
                                (
                                    c.returned_defaults
                                    if not c.context.executemany
                                    else None
                                ),
                            )
    
            if check_rowcount:
                if rows != len(records):
>                   raise orm_exc.StaleDataError(
                        "UPDATE statement on table '%s' expected to "
                        "update %d row(s); %d were matched."
                        % (table.description, len(records), rows)
                    )
E                   sqlalchemy.orm.exc.StaleDataError: UPDATE statement on table 'accounts_user' expected to update 1 row(s); 0 were matched.

allow_executemany = False
assert_multirow = True
assert_singlerow = True
base_mapper = <Mapper at 0x7fc596363b30; User>
bookkeeping = True
c          = <sqlalchemy.engine.cursor.CursorResult object at 0x7fc5887f0d00>
cached_stmt = <sqlalchemy.sql.dml.Update object at 0x7fc58d39d580>
check_rowcount = True
connection = <sqlalchemy.engine.base.Connection object at 0x7fc588fc4d10>
enable_check_rowcount = True
execution_options = {'compiled_cache': <sqlalchemy.util._collections.LRUCache object at 0x7fc58ca9b790>}
has_all_defaults = True
has_all_pks = True
hasvalue   = False
mapper     = <Mapper at 0x7fc596363b30; User>
needs_version_id = True
paramkeys  = {'accounts_user_id', 'version_id', 'accounts_user_version_id', 'updated'}
params     = {'accounts_user_id': 8,
 'accounts_user_version_id': 2,
 'updated': datetime.datetime(2025, 12, 10, 9, 54, 35, 409943),
 'version_id': 3}
records    = [(<sqlalchemy.orm.state.InstanceState object at 0x7fc58922d310>,
  {'_sa_instance_state': <sqlalchemy.orm.state.InstanceState object at 0x7fc58922d310>},
  {'accounts_user_id': 8,
   'accounts_user_version_id': 2,
   'updated': datetime.datetime(2025, 12, 10, 9, 54, 35, 409943),
   'version_id': 3},
  <Mapper at 0x7fc596363b30; User>,
  <sqlalchemy.engine.base.Connection object at 0x7fc588fc4d10>,
  {},
  True,
  True)]
return_defaults = False
rows       = 0
state      = <sqlalchemy.orm.state.InstanceState object at 0x7fc58922d310>
state_dict = {'_sa_instance_state': <sqlalchemy.orm.state.InstanceState object at 0x7fc58922d310>}
statement  = <sqlalchemy.sql.dml.Update object at 0x7fc58d39d580>
table      = Table('accounts_user', MetaData(), Column('id', Integer(), table=<accounts_user>, primary_key=True, nullable=False), Column('username', String(length=255), table=<accounts_user>), Column('displayname', String(length=255), table=<accounts_user>), Column('email', String(length=255), table=<accounts_user>), Column('domain', String(length=255), table=<accounts_user>), Column('password', String(length=255), table=<accounts_user>), Column('active', Boolean(name='active'), table=<accounts_user>), Column('confirmed_at', DateTime(), table=<accounts_user>), Column('version_id', Integer(), table=<accounts_user>, nullable=False), Column('profile', JSON(), table=<accounts_user>, default=CallableColumnDefault(<function User.<lambda> at 0x7fc59495dbc0>)), Column('preferences', JSON(), table=<accounts_user>, default=CallableColumnDefault(<function User.<lambda> at 0x7fc59495dd00>)), Column('blocked_at', DateTime(), table=<accounts_user>), Column('verified_at', DateTime(), table=<accounts_user>), Column('created', DateTime(), table=<accounts_user>, nullable=False, default=CallableColumnDefault(<function datetime.utcnow at 0x7fc596558ea0>)), Column('updated', DateTime(), table=<accounts_user>, nullable=False, default=CallableColumnDefault(<function datetime.utcnow at 0x7fc596558fe0>)), schema=None)
uowtransaction = <sqlalchemy.orm.unitofwork.UOWTransaction object at 0x7fc58880f7a0>
update     = <generator object _collect_update_commands at 0x7fc588829300>
update_stmt = <function _emit_update_statements.<locals>.update_stmt at 0x7fc588471300>
use_orm_update_stmt = None
value_params = {}

.venv/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py:948: StaleDataError
_ test_admin_links[admin_drafts_html-/administration/drafts?q=parent.access.owned_by.user:{id}&f=allversions] _

client = <FlaskClient <Flask 'invenio'>>
headers = {'accept': 'application/json', 'content-type': 'application/json'}
user_moderator = <pytest_invenio.user.UserFixtureBase object at 0x7fc58928c050>
user_pub = <pytest_invenio.user.UserFixtureBase object at 0x7fc589257620>
link_name = 'admin_drafts_html'
expected_url = '/administration/drafts?q=parent.access.owned_by.user:{id}&f=allversions'

    @pytest.mark.parametrize(
        "link_name,expected_url",
        [
            (
                "admin_records_html",
                "/administration/records?q=parent.access.owned_by.user:{id}&f=allversions",
            ),
            (
                "admin_drafts_html",
                "/administration/drafts?q=parent.access.owned_by.user:{id}&f=allversions",
            ),
            ("admin_moderation_html", "/administration/moderation?q=topic.user:{id}"),
        ],
    )
    def test_admin_links(
        client, headers, user_moderator, user_pub, link_name, expected_url
    ):
        """Test admin links."""
>       client = user_moderator.login(client)
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^

client     = <FlaskClient <Flask 'invenio'>>
expected_url = '/administration/drafts?q=parent.access.owned_by.user:{id}&f=allversions'
headers    = {'accept': 'application/json', 'content-type': 'application/json'}
link_name  = 'admin_drafts_html'
user_moderator = <pytest_invenio.user.UserFixtureBase object at 0x7fc58928c050>
user_pub   = <pytest_invenio.user.UserFixtureBase object at 0x7fc589257620>

tests/resources/test_resources_users.py:281: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.12/site-packages/pytest_invenio/user.py:152: in login
    return self._login(client, "/", logout_first)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        client     = <FlaskClient <Flask 'invenio'>>
        logout_first = False
        self       = <pytest_invenio.user.UserFixtureBase object at 0x7fc58928c050>
.venv/lib/python3.12/site-packages/pytest_invenio/user.py:170: in _login
    res = client.post(
        base_path  = '/'
        client     = <FlaskClient <Flask 'invenio'>>
        logout     = False
        self       = <pytest_invenio.user.UserFixtureBase object at 0x7fc58928c050>
.venv/lib/python3.12/site-packages/werkzeug/test.py:1167: in post
    return self.open(*args, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^
        args       = ('/login',)
        kw         = {'data': {'email': 'user_moderator@inveniosoftware.org',
          'password': 'user_moderator'},
 'follow_redirects': True,
 'method': 'POST'}
        self       = <FlaskClient <Flask 'invenio'>>
.venv/lib/python3.12/site-packages/flask/testing.py:235: in open
    response = super().open(
        __class__  = <class 'flask.testing.FlaskClient'>
        args       = ('/login',)
        buffered   = False
        follow_redirects = True
        kwargs     = {'data': {'email': 'user_moderator@inveniosoftware.org',
          'password': 'user_moderator'},
 'environ_base': {'HTTP_USER_AGENT': 'Werkzeug/3.1.4',
                  'REMOTE_ADDR': '127.0.0.1',
                  'werkzeug.debug.preserve_context': <built-in method append of list object at 0x7fc586bfce80>},
 'method': 'POST'}
        request    = <Request 'http://localhost/login' [POST]>
        self       = <FlaskClient <Flask 'invenio'>>
.venv/lib/python3.12/site-packages/werkzeug/test.py:1116: in open
    response_parts = self.run_wsgi_app(request.environ, buffered=buffered)
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        arg        = <Request 'http://localhost/login' [POST]>
        args       = (<Request 'http://localhost/login' [POST]>,)
        buffered   = False
        follow_redirects = True
        kwargs     = {}
        request    = <Request 'http://localhost/login' [POST]>
        self       = <FlaskClient <Flask 'invenio'>>
.venv/lib/python3.12/site-packages/werkzeug/test.py:988: in run_wsgi_app
    rv = run_wsgi_app(self.application, environ, buffered=buffered)
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        buffered   = False
        environ    = {'CONTENT_LENGTH': '64',
 'CONTENT_TYPE': 'application/x-www-form-urlencoded',
 'HTTP_HOST': 'localhost',
 'HTTP_USER_AGENT': 'Werkzeug/3.1.4',
 'PATH_INFO': '/login',
 'QUERY_STRING': '',
 'RAW_URI': '/login',
 'REMOTE_ADDR': '127.0.0.1',
 'REQUEST_METHOD': 'POST',
 'REQUEST_URI': '/login',
 'SCRIPT_NAME': '',
 'SERVER_NAME': 'localhost',
 'SERVER_PORT': '80',
 'SERVER_PROTOCOL': 'HTTP/1.1',
 'werkzeug.debug.preserve_context': <built-in method append of list object at 0x7fc586bfce80>,
 'werkzeug.request': <Request 'http://localhost/login' [POST]>,
 'wsgi.errors': <_io.TextIOWrapper name='<stderr>' mode='w' encoding='utf-8'>,
 'wsgi.input': <_io.BytesIO object at 0x7fc587582700>,
 'wsgi.multiprocess': False,
 'wsgi.multithread': False,
 'wsgi.run_once': False,
 'wsgi.url_scheme': 'http',
 'wsgi.version': (1, 0)}
        self       = <FlaskClient <Flask 'invenio'>>
.venv/lib/python3.12/site-packages/werkzeug/test.py:1264: in run_wsgi_app
    app_rv = app(environ, start_response)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        app        = <Flask 'invenio'>
        buffer     = []
        buffered   = False
        environ    = {'CONTENT_LENGTH': '64',
 'CONTENT_TYPE': 'application/x-www-form-urlencoded',
 'HTTP_HOST': 'localhost',
 'HTTP_USER_AGENT': 'Werkzeug/3.1.4',
 'PATH_INFO': '/login',
 'QUERY_STRING': '',
 'RAW_URI': '/login',
 'REMOTE_ADDR': '127.0.0.1',
 'REQUEST_METHOD': 'POST',
 'REQUEST_URI': '/login',
 'SCRIPT_NAME': '',
 'SERVER_NAME': 'localhost',
 'SERVER_PORT': '80',
 'SERVER_PROTOCOL': 'HTTP/1.1',
 'werkzeug.debug.preserve_context': <built-in method append of list object at 0x7fc586bfce80>,
 'werkzeug.request': None,
 'wsgi.errors': <_io.TextIOWrapper name='<stderr>' mode='w' encoding='utf-8'>,
 'wsgi.input': <_io.BytesIO object at 0x7fc587582700>,
 'wsgi.multiprocess': False,
 'wsgi.multithread': False,
 'wsgi.run_once': False,
 'wsgi.url_scheme': 'http',
 'wsgi.version': (1, 0)}
        response   = None
        start_response = <function run_wsgi_app.<locals>.start_response at 0x7fc5884e25c0>
.venv/lib/python3.12/site-packages/flask/app.py:1536: in __call__
    return self.wsgi_app(environ, start_response)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        environ    = {'CONTENT_LENGTH': '64',
 'CONTENT_TYPE': 'application/x-www-form-urlencoded',
 'HTTP_HOST': 'localhost',
 'HTTP_USER_AGENT': 'Werkzeug/3.1.4',
 'PATH_INFO': '/login',
 'QUERY_STRING': '',
 'RAW_URI': '/login',
 'REMOTE_ADDR': '127.0.0.1',
 'REQUEST_METHOD': 'POST',
 'REQUEST_URI': '/login',
 'SCRIPT_NAME': '',
 'SERVER_NAME': 'localhost',
 'SERVER_PORT': '80',
 'SERVER_PROTOCOL': 'HTTP/1.1',
 'werkzeug.debug.preserve_context': <built-in method append of list object at 0x7fc586bfce80>,
 'werkzeug.request': None,
 'wsgi.errors': <_io.TextIOWrapper name='<stderr>' mode='w' encoding='utf-8'>,
 'wsgi.input': <_io.BytesIO object at 0x7fc587582700>,
 'wsgi.multiprocess': False,
 'wsgi.multithread': False,
 'wsgi.run_once': False,
 'wsgi.url_scheme': 'http',
 'wsgi.version': (1, 0)}
        self       = <Flask 'invenio'>
        start_response = <function run_wsgi_app.<locals>.start_response at 0x7fc5884e25c0>
.venv/lib/python3.12/site-packages/flask/app.py:1514: in wsgi_app
    response = self.handle_exception(e)
               ^^^^^^^^^^^^^^^^^^^^^^^^
        ctx        = <RequestContext 'http://localhost/login' [POST] of invenio>
        environ    = {'CONTENT_LENGTH': '64',
 'CONTENT_TYPE': 'application/x-www-form-urlencoded',
 'HTTP_HOST': 'localhost',
 'HTTP_USER_AGENT': 'Werkzeug/3.1.4',
 'PATH_INFO': '/login',
 'QUERY_STRING': '',
 'RAW_URI': '/login',
 'REMOTE_ADDR': '127.0.0.1',
 'REQUEST_METHOD': 'POST',
 'REQUEST_URI': '/login',
 'SCRIPT_NAME': '',
 'SERVER_NAME': 'localhost',
 'SERVER_PORT': '80',
 'SERVER_PROTOCOL': 'HTTP/1.1',
 'werkzeug.debug.preserve_context': <built-in method append of list object at 0x7fc586bfce80>,
 'werkzeug.request': None,
 'wsgi.errors': <_io.TextIOWrapper name='<stderr>' mode='w' encoding='utf-8'>,
 'wsgi.input': <_io.BytesIO object at 0x7fc587582700>,
 'wsgi.multiprocess': False,
 'wsgi.multithread': False,
 'wsgi.run_once': False,
 'wsgi.url_scheme': 'http',
 'wsgi.version': (1, 0)}
        error      = PendingRollbackError("This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: UPDATE statement on table 'accounts_user' expected to update 1 row(s); 0 were matched.")
        self       = <Flask 'invenio'>
        start_response = <function run_wsgi_app.<locals>.start_response at 0x7fc5884e25c0>
.venv/lib/python3.12/site-packages/flask/app.py:1511: in wsgi_app
    response = self.full_dispatch_request()
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        ctx        = <RequestContext 'http://localhost/login' [POST] of invenio>
        environ    = {'CONTENT_LENGTH': '64',
 'CONTENT_TYPE': 'application/x-www-form-urlencoded',
 'HTTP_HOST': 'localhost',
 'HTTP_USER_AGENT': 'Werkzeug/3.1.4',
 'PATH_INFO': '/login',
 'QUERY_STRING': '',
 'RAW_URI': '/login',
 'REMOTE_ADDR': '127.0.0.1',
 'REQUEST_METHOD': 'POST',
 'REQUEST_URI': '/login',
 'SCRIPT_NAME': '',
 'SERVER_NAME': 'localhost',
 'SERVER_PORT': '80',
 'SERVER_PROTOCOL': 'HTTP/1.1',
 'werkzeug.debug.preserve_context': <built-in method append of list object at 0x7fc586bfce80>,
 'werkzeug.request': None,
 'wsgi.errors': <_io.TextIOWrapper name='<stderr>' mode='w' encoding='utf-8'>,
 'wsgi.input': <_io.BytesIO object at 0x7fc587582700>,
 'wsgi.multiprocess': False,
 'wsgi.multithread': False,
 'wsgi.run_once': False,
 'wsgi.url_scheme': 'http',
 'wsgi.version': (1, 0)}
        error      = PendingRollbackError("This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: UPDATE statement on table 'accounts_user' expected to update 1 row(s); 0 were matched.")
        self       = <Flask 'invenio'>
        start_response = <function run_wsgi_app.<locals>.start_response at 0x7fc5884e25c0>
.venv/lib/python3.12/site-packages/flask/app.py:919: in full_dispatch_request
    rv = self.handle_user_exception(e)
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        rv         = None
        self       = <Flask 'invenio'>
.venv/lib/python3.12/site-packages/flask/app.py:917: in full_dispatch_request
    rv = self.dispatch_request()
         ^^^^^^^^^^^^^^^^^^^^^^^
        rv         = None
        self       = <Flask 'invenio'>
.venv/lib/python3.12/site-packages/flask/app.py:902: in dispatch_request
    return self.ensure_sync(self.view_functions[rule.endpoint])(**view_args)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        req        = <Request 'http://localhost/login' [POST]>
        rule       = <Rule '/login' (POST, OPTIONS) -> invenio_accounts_rest_auth.login>
        self       = <Flask 'invenio'>
        view_args  = {}
.venv/lib/python3.12/site-packages/invenio_accounts/views/rest.py:61: in wrapper
    return f(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^
        args       = ()
        f          = <function View.as_view.<locals>.view at 0x7fc5892600e0>
        kwargs     = {}
.venv/lib/python3.12/site-packages/flask/views.py:110: in view
    return current_app.ensure_sync(self.dispatch_request)(**kwargs)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        class_args = ()
        class_kwargs = {}
        kwargs     = {}
        self       = <invenio_accounts.views.rest.LoginView object at 0x7fc5884e59d0>
        view       = <function View.as_view.<locals>.view at 0x7fc589280a40>
.venv/lib/python3.12/site-packages/flask/views.py:191: in dispatch_request
    return current_app.ensure_sync(meth)(**kwargs)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        kwargs     = {}
        meth       = <bound method LoginView.post of <invenio_accounts.views.rest.LoginView object at 0x7fc5884e59d0>>
        self       = <invenio_accounts.views.rest.LoginView object at 0x7fc5884e59d0>
.venv/lib/python3.12/site-packages/webargs/core.py:445: in wrapper
    parsed_args = self.parse(
        argmap     = <GeneratedSchema(many=False)>
        args       = (<invenio_accounts.views.rest.LoginView object at 0x7fc5884e59d0>,)
        as_kwargs  = True
        error_headers = None
        error_status_code = None
        func       = <function LoginView.post at 0x7fc58d494fe0>
        kwargs     = {}
        locations  = ('querystring', 'form', 'json')
        req_       = None
        req_obj    = None
        self       = <invenio_accounts.views.rest.FlaskParser object at 0x7fc58d659df0>
        validate   = None
.venv/lib/python3.12/site-packages/webargs/core.py:356: in parse
    result = schema.load(parsed)
             ^^^^^^^^^^^^^^^^^^^
        argmap     = <GeneratedSchema(many=False)>
        data       = None
        error_headers = None
        error_status_code = None
        locations  = ('querystring', 'form', 'json')
        parsed     = {'email': 'user_moderator@inveniosoftware.org', 'password': 'user_moderator'}
        parser     = <invenio_accounts.views.rest.FlaskParser object at 0x7fc5884e6fc0>
        req        = <Request 'http://localhost/' [GET]>
        schema     = <GeneratedSchema(many=False)>
        self       = <invenio_accounts.views.rest.FlaskParser object at 0x7fc58d659df0>
        validate   = None
        validators = []
.venv/lib/python3.12/site-packages/marshmallow/schema.py:792: in load
    return self._do_load(
        data       = {'email': 'user_moderator@inveniosoftware.org', 'password': 'user_moderator'}
        many       = None
        partial    = None
        self       = <GeneratedSchema(many=False)>
        unknown    = None
.venv/lib/python3.12/site-packages/marshmallow/schema.py:951: in _do_load
    result = self._deserialize(
        data       = {'email': 'user_moderator@inveniosoftware.org', 'password': 'user_moderator'}
        error_store = <marshmallow.error_store.ErrorStore object at 0x7fc5884e70e0>
        errors     = {}
        many       = False
        partial    = None
        postprocess = True
        processed_data = {'email': 'user_moderator@inveniosoftware.org', 'password': 'user_moderator'}
        self       = <GeneratedSchema(many=False)>
        unknown    = 'raise'
.venv/lib/python3.12/site-packages/marshmallow/schema.py:734: in _deserialize
    value = self._call_and_store(
        attr_name  = 'email'
        d_kwargs   = {}
        data       = {'email': 'user_moderator@inveniosoftware.org', 'password': 'user_moderator'}
        error_store = <marshmallow.error_store.ErrorStore object at 0x7fc5884e70e0>
        field_name = 'email'
        field_obj  = <fields.Email(dump_default=<marshmallow.missing>, attribute=None, validate=[<function user_exists at 0x7fc58d494400>], required=True, load_only=False, dump_only=False, load_default=<marshmallow.missing>, allow_none=False, error_messages={'required': 'Missing data for required field.', 'null': 'Field may not be null.', 'validator_failed': 'Invalid value.', 'invalid': 'Not a valid email address.', 'invalid_utf8': 'Not a valid utf-8 string.'})>
        getter     = <function Schema._deserialize.<locals>.getter at 0x7fc5884e3100>
        index      = None
        index_errors = True
        many       = False
        partial    = None
        partial_is_collection = False
        raw_value  = 'user_moderator@inveniosoftware.org'
        ret_d      = {}
        self       = <GeneratedSchema(many=False)>
        unknown    = 'raise'
.venv/lib/python3.12/site-packages/marshmallow/schema.py:570: in _call_and_store
    value = getter_func(data)
            ^^^^^^^^^^^^^^^^^
        data       = 'user_moderator@inveniosoftware.org'
        error_store = <marshmallow.error_store.ErrorStore object at 0x7fc5884e70e0>
        field_name = 'email'
        getter_func = <function Schema._deserialize.<locals>.getter at 0x7fc5884e3100>
        index      = None
.venv/lib/python3.12/site-packages/marshmallow/schema.py:727: in getter
    return field_obj.deserialize(
        d_kwargs   = {}
        data       = {'email': 'user_moderator@inveniosoftware.org', 'password': 'user_moderator'}
        field_name = 'email'
        field_obj  = <fields.Email(dump_default=<marshmallow.missing>, attribute=None, validate=[<function user_exists at 0x7fc58d494400>], required=True, load_only=False, dump_only=False, load_default=<marshmallow.missing>, allow_none=False, error_messages={'required': 'Missing data for required field.', 'null': 'Field may not be null.', 'validator_failed': 'Invalid value.', 'invalid': 'Not a valid email address.', 'invalid_utf8': 'Not a valid utf-8 string.'})>
        val        = 'user_moderator@inveniosoftware.org'
.venv/lib/python3.12/site-packages/marshmallow/fields.py:375: in deserialize
    self._validate(output)
        attr       = 'email'
        data       = {'email': 'user_moderator@inveniosoftware.org', 'password': 'user_moderator'}
        kwargs     = {}
        output     = 'user_moderator@inveniosoftware.org'
        self       = <fields.Email(dump_default=<marshmallow.missing>, attribute=None, validate=[<function user_exists at 0x7fc58d494400>], required=True, load_only=False, dump_only=False, load_default=<marshmallow.missing>, allow_none=False, error_messages={'required': 'Missing data for required field.', 'null': 'Field may not be null.', 'validator_failed': 'Invalid value.', 'invalid': 'Not a valid email address.', 'invalid_utf8': 'Not a valid utf-8 string.'})>
        value      = 'user_moderator@inveniosoftware.org'
.venv/lib/python3.12/site-packages/marshmallow/fields.py:276: in _validate
    self._validate_all(value)
        self       = <fields.Email(dump_default=<marshmallow.missing>, attribute=None, validate=[<function user_exists at 0x7fc58d494400>], required=True, load_only=False, dump_only=False, load_default=<marshmallow.missing>, allow_none=False, error_messages={'required': 'Missing data for required field.', 'null': 'Field may not be null.', 'validator_failed': 'Invalid value.', 'invalid': 'Not a valid email address.', 'invalid_utf8': 'Not a valid utf-8 string.'})>
        value      = 'user_moderator@inveniosoftware.org'
.venv/lib/python3.12/site-packages/marshmallow/validate.py:82: in __call__
    r = validator(value)
        ^^^^^^^^^^^^^^^^
        errors     = []
        kwargs     = {}
        r          = 'user_moderator@inveniosoftware.org'
        self       = <And(validators=(<Email(error='Not a valid email address.')>, <function user_exists at 0x7fc58d494400>), error='Invalid value.')>
        validator  = <function user_exists at 0x7fc58d494400>
        value      = 'user_moderator@inveniosoftware.org'
.venv/lib/python3.12/site-packages/invenio_accounts/views/rest.py:187: in user_exists
    if not current_datastore.get_user(email):
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        email      = 'user_moderator@inveniosoftware.org'
.venv/lib/python3.12/site-packages/flask_security/datastore.py:219: in get_user
    rv = self.user_model.query.filter(query).first()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        alchemyFn  = <sqlalchemy.sql.functions._FunctionGenerator object at 0x7fc5977df050>
        attr       = 'email'
        identifier = 'user_moderator@inveniosoftware.org'
        query      = <sqlalchemy.sql.elements.BinaryExpression object at 0x7fc588745f10>
        self       = <invenio_accounts.datastore.SessionAwareSQLAlchemyUserDatastore object at 0x7fc589304e00>
.venv/lib/python3.12/site-packages/sqlalchemy/orm/query.py:2759: in first
    return self.limit(1)._iter().first()  # type: ignore
           ^^^^^^^^^^^^^^^^^^^^^
        self       = <flask_sqlalchemy.query.Query object at 0x7fc58846f2f0>
.venv/lib/python3.12/site-packages/sqlalchemy/orm/query.py:2857: in _iter
    result: Union[ScalarResult[_T], Result[_T]] = self.session.execute(
        params     = immutabledict({})
        self       = <flask_sqlalchemy.query.Query object at 0x7fc588609bb0>
        statement  = <sqlalchemy.sql.selectable.Select object at 0x7fc58846fef0>
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2351: in execute
    return self._execute_internal(
        _add_event = None
        _parent_execute_state = None
        bind_arguments = None
        execution_options = {'_sa_orm_load_options': default_load_options(_legacy_uniquing=True)}
        params     = immutabledict({})
        self       = <sqlalchemy.orm.session.Session object at 0x7fc5892ebef0>
        statement  = <sqlalchemy.sql.selectable.Select object at 0x7fc58846fef0>
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2239: in _execute_internal
    conn = self._connection_for_bind(bind)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        _add_event = None
        _parent_execute_state = None
        _scalar_result = False
        bind       = Engine(postgresql+psycopg2://invenio:***@localhost:5432/invenio)
        bind_arguments = {'clause': <sqlalchemy.sql.selectable.Select object at 0x7fc58846fef0>,
 'mapper': <Mapper at 0x7fc596363b30; User>}
        compile_state_cls = <class 'sqlalchemy.orm.context.ORMSelectCompileState'>
        events_todo = <sqlalchemy.event.attr._EmptyListener object at 0x7fc58e552b40>
        execution_options = immutabledict({'_sa_orm_load_options': default_load_options(_legacy_uniquing=True), '_result_disable_adapt_to_context': True})
        params     = immutabledict({})
        self       = <sqlalchemy.orm.session.Session object at 0x7fc5892ebef0>
        statement  = <sqlalchemy.sql.selectable.Select object at 0x7fc58846fef0>
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2108: in _connection_for_bind
    return trans._connection_for_bind(engine, execution_options)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        engine     = Engine(postgresql+psycopg2://invenio:***@localhost:5432/invenio)
        execution_options = None
        kw         = {}
        self       = <sqlalchemy.orm.session.Session object at 0x7fc5892ebef0>
        trans      = <sqlalchemy.orm.session.SessionTransaction object at 0x7fc5891b0490>
<string>:2: in _connection_for_bind
    ???
        bind       = Engine(postgresql+psycopg2://invenio:***@localhost:5432/invenio)
        execution_options = None
        self       = <sqlalchemy.orm.session.SessionTransaction object at 0x7fc5891b0490>
.venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:101: in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
        arg        = (Engine(postgresql+psycopg2://invenio:***@localhost:5432/invenio), None)
        current_state = <SessionTransactionState.DEACTIVE: 4>
        expect_state_change = False
        fn         = <function SessionTransaction._connection_for_bind at 0x7fc596668860>
        has_prerequisite_states = True
        kw         = {}
        moves_to   = <_StateChangeStates.NO_CHANGE: 2>
        prerequisite_state_collection = (<SessionTransactionState.ACTIVE: 1>,)
        self       = <sqlalchemy.orm.session.SessionTransaction object at 0x7fc5891b0490>
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <sqlalchemy.orm.session.SessionTransaction object at 0x7fc5891b0490>
operation_name = '_connection_for_bind'
state = <SessionTransactionState.DEACTIVE: 4>

    def _raise_for_prerequisite_state(
        self, operation_name: str, state: _StateChangeState
    ) -> NoReturn:
        if state is SessionTransactionState.DEACTIVE:
            if self._rollback_exception:
>               raise sa_exc.PendingRollbackError(
                    "This Session's transaction has been rolled back "
                    "due to a previous exception during flush."
                    " To begin a new transaction with this Session, "
                    "first issue Session.rollback()."
                    f" Original exception was: {self._rollback_exception}",
                    code="7s2a",
                )
E               sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: UPDATE statement on table 'accounts_user' expected to update 1 row(s); 0 were matched. (Background on this error at: https://sqlalche.me/e/20/7s2a)

operation_name = '_connection_for_bind'
self       = <sqlalchemy.orm.session.SessionTransaction object at 0x7fc5891b0490>
state      = <SessionTransactionState.DEACTIVE: 4>

.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:971: PendingRollbackError
_ test_admin_links[admin_moderation_html-/administration/moderation?q=topic.user:{id}] _

client = <FlaskClient <Flask 'invenio'>>
headers = {'accept': 'application/json', 'content-type': 'application/json'}
user_moderator = <pytest_invenio.user.UserFixtureBase object at 0x7fc58928c050>
user_pub = <pytest_invenio.user.UserFixtureBase object at 0x7fc589257620>
link_name = 'admin_moderation_html'
expected_url = '/administration/moderation?q=topic.user:{id}'

    @pytest.mark.parametrize(
        "link_name,expected_url",
        [
            (
                "admin_records_html",
                "/administration/records?q=parent.access.owned_by.user:{id}&f=allversions",
            ),
            (
                "admin_drafts_html",
                "/administration/drafts?q=parent.access.owned_by.user:{id}&f=allversions",
            ),
            ("admin_moderation_html", "/administration/moderation?q=topic.user:{id}"),
        ],
    )
    def test_admin_links(
        client, headers, user_moderator, user_pub, link_name, expected_url
    ):
        """Test admin links."""
>       client = user_moderator.login(client)
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^

client     = <FlaskClient <Flask 'invenio'>>
expected_url = '/administration/moderation?q=topic.user:{id}'
headers    = {'accept': 'application/json', 'content-type': 'application/json'}
link_name  = 'admin_moderation_html'
user_moderator = <pytest_invenio.user.UserFixtureBase object at 0x7fc58928c050>
user_pub   = <pytest_invenio.user.UserFixtureBase object at 0x7fc589257620>

tests/resources/test_resources_users.py:281: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.12/site-packages/pytest_invenio/user.py:152: in login
    return self._login(client, "/", logout_first)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        client     = <FlaskClient <Flask 'invenio'>>
        logout_first = False
        self       = <pytest_invenio.user.UserFixtureBase object at 0x7fc58928c050>
.venv/lib/python3.12/site-packages/pytest_invenio/user.py:170: in _login
    res = client.post(
        base_path  = '/'
        client     = <FlaskClient <Flask 'invenio'>>
        logout     = False
        self       = <pytest_invenio.user.UserFixtureBase object at 0x7fc58928c050>
.venv/lib/python3.12/site-packages/werkzeug/test.py:1167: in post
    return self.open(*args, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^
        args       = ('/login',)
        kw         = {'data': {'email': 'user_moderator@inveniosoftware.org',
          'password': 'user_moderator'},
 'follow_redirects': True,
 'method': 'POST'}
        self       = <FlaskClient <Flask 'invenio'>>
.venv/lib/python3.12/site-packages/flask/testing.py:235: in open
    response = super().open(
        __class__  = <class 'flask.testing.FlaskClient'>
        args       = ('/login',)
        buffered   = False
        follow_redirects = True
        kwargs     = {'data': {'email': 'user_moderator@inveniosoftware.org',
          'password': 'user_moderator'},
 'environ_base': {'HTTP_USER_AGENT': 'Werkzeug/3.1.4',
                  'REMOTE_ADDR': '127.0.0.1',
                  'werkzeug.debug.preserve_context': <built-in method append of list object at 0x7fc5871df640>},
 'method': 'POST'}
        request    = <Request 'http://localhost/login' [POST]>
        self       = <FlaskClient <Flask 'invenio'>>
.venv/lib/python3.12/site-packages/werkzeug/test.py:1116: in open
    response_parts = self.run_wsgi_app(request.environ, buffered=buffered)
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        arg        = <Request 'http://localhost/login' [POST]>
        args       = (<Request 'http://localhost/login' [POST]>,)
        buffered   = False
        follow_redirects = True
        kwargs     = {}
        request    = <Request 'http://localhost/login' [POST]>
        self       = <FlaskClient <Flask 'invenio'>>
.venv/lib/python3.12/site-packages/werkzeug/test.py:988: in run_wsgi_app
    rv = run_wsgi_app(self.application, environ, buffered=buffered)
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        buffered   = False
        environ    = {'CONTENT_LENGTH': '64',
 'CONTENT_TYPE': 'application/x-www-form-urlencoded',
 'HTTP_HOST': 'localhost',
 'HTTP_USER_AGENT': 'Werkzeug/3.1.4',
 'PATH_INFO': '/login',
 'QUERY_STRING': '',
 'RAW_URI': '/login',
 'REMOTE_ADDR': '127.0.0.1',
 'REQUEST_METHOD': 'POST',
 'REQUEST_URI': '/login',
 'SCRIPT_NAME': '',
 'SERVER_NAME': 'localhost',
 'SERVER_PORT': '80',
 'SERVER_PROTOCOL': 'HTTP/1.1',
 'werkzeug.debug.preserve_context': <built-in method append of list object at 0x7fc5871df640>,
 'werkzeug.request': <Request 'http://localhost/login' [POST]>,
 'wsgi.errors': <_io.TextIOWrapper name='<stderr>' mode='w' encoding='utf-8'>,
 'wsgi.input': <_io.BytesIO object at 0x7fc58cac3010>,
 'wsgi.multiprocess': False,
 'wsgi.multithread': False,
 'wsgi.run_once': False,
 'wsgi.url_scheme': 'http',
 'wsgi.version': (1, 0)}
        self       = <FlaskClient <Flask 'invenio'>>
.venv/lib/python3.12/site-packages/werkzeug/test.py:1264: in run_wsgi_app
    app_rv = app(environ, start_response)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        app        = <Flask 'invenio'>
        buffer     = []
        buffered   = False
        environ    = {'CONTENT_LENGTH': '64',
 'CONTENT_TYPE': 'application/x-www-form-urlencoded',
 'HTTP_HOST': 'localhost',
 'HTTP_USER_AGENT': 'Werkzeug/3.1.4',
 'PATH_INFO': '/login',
 'QUERY_STRING': '',
 'RAW_URI': '/login',
 'REMOTE_ADDR': '127.0.0.1',
 'REQUEST_METHOD': 'POST',
 'REQUEST_URI': '/login',
 'SCRIPT_NAME': '',
 'SERVER_NAME': 'localhost',
 'SERVER_PORT': '80',
 'SERVER_PROTOCOL': 'HTTP/1.1',
 'werkzeug.debug.preserve_context': <built-in method append of list object at 0x7fc5871df640>,
 'werkzeug.request': None,
 'wsgi.errors': <_io.TextIOWrapper name='<stderr>' mode='w' encoding='utf-8'>,
 'wsgi.input': <_io.BytesIO object at 0x7fc58cac3010>,
 'wsgi.multiprocess': False,
 'wsgi.multithread': False,
 'wsgi.run_once': False,
 'wsgi.url_scheme': 'http',
 'wsgi.version': (1, 0)}
        response   = None
        start_response = <function run_wsgi_app.<locals>.start_response at 0x7fc5885172e0>
.venv/lib/python3.12/site-packages/flask/app.py:1536: in __call__
    return self.wsgi_app(environ, start_response)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        environ    = {'CONTENT_LENGTH': '64',
 'CONTENT_TYPE': 'application/x-www-form-urlencoded',
 'HTTP_HOST': 'localhost',
 'HTTP_USER_AGENT': 'Werkzeug/3.1.4',
 'PATH_INFO': '/login',
 'QUERY_STRING': '',
 'RAW_URI': '/login',
 'REMOTE_ADDR': '127.0.0.1',
 'REQUEST_METHOD': 'POST',
 'REQUEST_URI': '/login',
 'SCRIPT_NAME': '',
 'SERVER_NAME': 'localhost',
 'SERVER_PORT': '80',
 'SERVER_PROTOCOL': 'HTTP/1.1',
 'werkzeug.debug.preserve_context': <built-in method append of list object at 0x7fc5871df640>,
 'werkzeug.request': None,
 'wsgi.errors': <_io.TextIOWrapper name='<stderr>' mode='w' encoding='utf-8'>,
 'wsgi.input': <_io.BytesIO object at 0x7fc58cac3010>,
 'wsgi.multiprocess': False,
 'wsgi.multithread': False,
 'wsgi.run_once': False,
 'wsgi.url_scheme': 'http',
 'wsgi.version': (1, 0)}
        self       = <Flask 'invenio'>
        start_response = <function run_wsgi_app.<locals>.start_response at 0x7fc5885172e0>
.venv/lib/python3.12/site-packages/flask/app.py:1514: in wsgi_app
    response = self.handle_exception(e)
               ^^^^^^^^^^^^^^^^^^^^^^^^
        ctx        = <RequestContext 'http://localhost/login' [POST] of invenio>
        environ    = {'CONTENT_LENGTH': '64',
 'CONTENT_TYPE': 'application/x-www-form-urlencoded',
 'HTTP_HOST': 'localhost',
 'HTTP_USER_AGENT': 'Werkzeug/3.1.4',
 'PATH_INFO': '/login',
 'QUERY_STRING': '',
 'RAW_URI': '/login',
 'REMOTE_ADDR': '127.0.0.1',
 'REQUEST_METHOD': 'POST',
 'REQUEST_URI': '/login',
 'SCRIPT_NAME': '',
 'SERVER_NAME': 'localhost',
 'SERVER_PORT': '80',
 'SERVER_PROTOCOL': 'HTTP/1.1',
 'werkzeug.debug.preserve_context': <built-in method append of list object at 0x7fc5871df640>,
 'werkzeug.request': None,
 'wsgi.errors': <_io.TextIOWrapper name='<stderr>' mode='w' encoding='utf-8'>,
 'wsgi.input': <_io.BytesIO object at 0x7fc58cac3010>,
 'wsgi.multiprocess': False,
 'wsgi.multithread': False,
 'wsgi.run_once': False,
 'wsgi.url_scheme': 'http',
 'wsgi.version': (1, 0)}
        error      = PendingRollbackError("This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: UPDATE statement on table 'accounts_user' expected to update 1 row(s); 0 were matched.")
        self       = <Flask 'invenio'>
        start_response = <function run_wsgi_app.<locals>.start_response at 0x7fc5885172e0>
.venv/lib/python3.12/site-packages/flask/app.py:1511: in wsgi_app
    response = self.full_dispatch_request()
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        ctx        = <RequestContext 'http://localhost/login' [POST] of invenio>
        environ    = {'CONTENT_LENGTH': '64',
 'CONTENT_TYPE': 'application/x-www-form-urlencoded',
 'HTTP_HOST': 'localhost',
 'HTTP_USER_AGENT': 'Werkzeug/3.1.4',
 'PATH_INFO': '/login',
 'QUERY_STRING': '',
 'RAW_URI': '/login',
 'REMOTE_ADDR': '127.0.0.1',
 'REQUEST_METHOD': 'POST',
 'REQUEST_URI': '/login',
 'SCRIPT_NAME': '',
 'SERVER_NAME': 'localhost',
 'SERVER_PORT': '80',
 'SERVER_PROTOCOL': 'HTTP/1.1',
 'werkzeug.debug.preserve_context': <built-in method append of list object at 0x7fc5871df640>,
 'werkzeug.request': None,
 'wsgi.errors': <_io.TextIOWrapper name='<stderr>' mode='w' encoding='utf-8'>,
 'wsgi.input': <_io.BytesIO object at 0x7fc58cac3010>,
 'wsgi.multiprocess': False,
 'wsgi.multithread': False,
 'wsgi.run_once': False,
 'wsgi.url_scheme': 'http',
 'wsgi.version': (1, 0)}
        error      = PendingRollbackError("This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: UPDATE statement on table 'accounts_user' expected to update 1 row(s); 0 were matched.")
        self       = <Flask 'invenio'>
        start_response = <function run_wsgi_app.<locals>.start_response at 0x7fc5885172e0>
.venv/lib/python3.12/site-packages/flask/app.py:919: in full_dispatch_request
    rv = self.handle_user_exception(e)
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        rv         = None
        self       = <Flask 'invenio'>
.venv/lib/python3.12/site-packages/flask/app.py:917: in full_dispatch_request
    rv = self.dispatch_request()
         ^^^^^^^^^^^^^^^^^^^^^^^
        rv         = None
        self       = <Flask 'invenio'>
.venv/lib/python3.12/site-packages/flask/app.py:902: in dispatch_request
    return self.ensure_sync(self.view_functions[rule.endpoint])(**view_args)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        req        = <Request 'http://localhost/login' [POST]>
        rule       = <Rule '/login' (POST, OPTIONS) -> invenio_accounts_rest_auth.login>
        self       = <Flask 'invenio'>
        view_args  = {}
.venv/lib/python3.12/site-packages/invenio_accounts/views/rest.py:61: in wrapper
    return f(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^
        args       = ()
        f          = <function View.as_view.<locals>.view at 0x7fc5892600e0>
        kwargs     = {}
.venv/lib/python3.12/site-packages/flask/views.py:110: in view
    return current_app.ensure_sync(self.dispatch_request)(**kwargs)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        class_args = ()
        class_kwargs = {}
        kwargs     = {}
        self       = <invenio_accounts.views.rest.LoginView object at 0x7fc588532360>
        view       = <function View.as_view.<locals>.view at 0x7fc589280a40>
.venv/lib/python3.12/site-packages/flask/views.py:191: in dispatch_request
    return current_app.ensure_sync(meth)(**kwargs)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        kwargs     = {}
        meth       = <bound method LoginView.post of <invenio_accounts.views.rest.LoginView object at 0x7fc588532360>>
        self       = <invenio_accounts.views.rest.LoginView object at 0x7fc588532360>
.venv/lib/python3.12/site-packages/webargs/core.py:445: in wrapper
    parsed_args = self.parse(
        argmap     = <GeneratedSchema(many=False)>
        args       = (<invenio_accounts.views.rest.LoginView object at 0x7fc588532360>,)
        as_kwargs  = True
        error_headers = None
        error_status_code = None
        func       = <function LoginView.post at 0x7fc58d494fe0>
        kwargs     = {}
        locations  = ('querystring', 'form', 'json')
        req_       = None
        req_obj    = None
        self       = <invenio_accounts.views.rest.FlaskParser object at 0x7fc58d659df0>
        validate   = None
.venv/lib/python3.12/site-packages/webargs/core.py:356: in parse
    result = schema.load(parsed)
             ^^^^^^^^^^^^^^^^^^^
        argmap     = <GeneratedSchema(many=False)>
        data       = None
        error_headers = None
        error_status_code = None
        locations  = ('querystring', 'form', 'json')
        parsed     = {'email': 'user_moderator@inveniosoftware.org', 'password': 'user_moderator'}
        parser     = <invenio_accounts.views.rest.FlaskParser object at 0x7fc588533770>
        req        = <Request 'http://localhost/' [GET]>
        schema     = <GeneratedSchema(many=False)>
        self       = <invenio_accounts.views.rest.FlaskParser object at 0x7fc58d659df0>
        validate   = None
        validators = []
.venv/lib/python3.12/site-packages/marshmallow/schema.py:792: in load
    return self._do_load(
        data       = {'email': 'user_moderator@inveniosoftware.org', 'password': 'user_moderator'}
        many       = None
        partial    = None
        self       = <GeneratedSchema(many=False)>
        unknown    = None
.venv/lib/python3.12/site-packages/marshmallow/schema.py:951: in _do_load
    result = self._deserialize(
        data       = {'email': 'user_moderator@inveniosoftware.org', 'password': 'user_moderator'}
        error_store = <marshmallow.error_store.ErrorStore object at 0x7fc588533c80>
        errors     = {}
        many       = False
        partial    = None
        postprocess = True
        processed_data = {'email': 'user_moderator@inveniosoftware.org', 'password': 'user_moderator'}
        self       = <GeneratedSchema(many=False)>
        unknown    = 'raise'
.venv/lib/python3.12/site-packages/marshmallow/schema.py:734: in _deserialize
    value = self._call_and_store(
        attr_name  = 'email'
        d_kwargs   = {}
        data       = {'email': 'user_moderator@inveniosoftware.org', 'password': 'user_moderator'}
        error_store = <marshmallow.error_store.ErrorStore object at 0x7fc588533c80>
        field_name = 'email'
        field_obj  = <fields.Email(dump_default=<marshmallow.missing>, attribute=None, validate=[<function user_exists at 0x7fc58d494400>], required=True, load_only=False, dump_only=False, load_default=<marshmallow.missing>, allow_none=False, error_messages={'required': 'Missing data for required field.', 'null': 'Field may not be null.', 'validator_failed': 'Invalid value.', 'invalid': 'Not a valid email address.', 'invalid_utf8': 'Not a valid utf-8 string.'})>
        getter     = <function Schema._deserialize.<locals>.getter at 0x7fc5884709a0>
        index      = None
        index_errors = True
        many       = False
        partial    = None
        partial_is_collection = False
        raw_value  = 'user_moderator@inveniosoftware.org'
        ret_d      = {}
        self       = <GeneratedSchema(many=False)>
        unknown    = 'raise'
.venv/lib/python3.12/site-packages/marshmallow/schema.py:570: in _call_and_store
    value = getter_func(data)
            ^^^^^^^^^^^^^^^^^
        data       = 'user_moderator@inveniosoftware.org'
        error_store = <marshmallow.error_store.ErrorStore object at 0x7fc588533c80>
        field_name = 'email'
        getter_func = <function Schema._deserialize.<locals>.getter at 0x7fc5884709a0>
        index      = None
.venv/lib/python3.12/site-packages/marshmallow/schema.py:727: in getter
    return field_obj.deserialize(
        d_kwargs   = {}
        data       = {'email': 'user_moderator@inveniosoftware.org', 'password': 'user_moderator'}
        field_name = 'email'
        field_obj  = <fields.Email(dump_default=<marshmallow.missing>, attribute=None, validate=[<function user_exists at 0x7fc58d494400>], required=True, load_only=False, dump_only=False, load_default=<marshmallow.missing>, allow_none=False, error_messages={'required': 'Missing data for required field.', 'null': 'Field may not be null.', 'validator_failed': 'Invalid value.', 'invalid': 'Not a valid email address.', 'invalid_utf8': 'Not a valid utf-8 string.'})>
        val        = 'user_moderator@inveniosoftware.org'
.venv/lib/python3.12/site-packages/marshmallow/fields.py:375: in deserialize
    self._validate(output)
        attr       = 'email'
        data       = {'email': 'user_moderator@inveniosoftware.org', 'password': 'user_moderator'}
        kwargs     = {}
        output     = 'user_moderator@inveniosoftware.org'
        self       = <fields.Email(dump_default=<marshmallow.missing>, attribute=None, validate=[<function user_exists at 0x7fc58d494400>], required=True, load_only=False, dump_only=False, load_default=<marshmallow.missing>, allow_none=False, error_messages={'required': 'Missing data for required field.', 'null': 'Field may not be null.', 'validator_failed': 'Invalid value.', 'invalid': 'Not a valid email address.', 'invalid_utf8': 'Not a valid utf-8 string.'})>
        value      = 'user_moderator@inveniosoftware.org'
.venv/lib/python3.12/site-packages/marshmallow/fields.py:276: in _validate
    self._validate_all(value)
        self       = <fields.Email(dump_default=<marshmallow.missing>, attribute=None, validate=[<function user_exists at 0x7fc58d494400>], required=True, load_only=False, dump_only=False, load_default=<marshmallow.missing>, allow_none=False, error_messages={'required': 'Missing data for required field.', 'null': 'Field may not be null.', 'validator_failed': 'Invalid value.', 'invalid': 'Not a valid email address.', 'invalid_utf8': 'Not a valid utf-8 string.'})>
        value      = 'user_moderator@inveniosoftware.org'
.venv/lib/python3.12/site-packages/marshmallow/validate.py:82: in __call__
    r = validator(value)
        ^^^^^^^^^^^^^^^^
        errors     = []
        kwargs     = {}
        r          = 'user_moderator@inveniosoftware.org'
        self       = <And(validators=(<Email(error='Not a valid email address.')>, <function user_exists at 0x7fc58d494400>), error='Invalid value.')>
        validator  = <function user_exists at 0x7fc58d494400>
        value      = 'user_moderator@inveniosoftware.org'
.venv/lib/python3.12/site-packages/invenio_accounts/views/rest.py:187: in user_exists
    if not current_datastore.get_user(email):
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        email      = 'user_moderator@inveniosoftware.org'
.venv/lib/python3.12/site-packages/flask_security/datastore.py:219: in get_user
    rv = self.user_model.query.filter(query).first()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        alchemyFn  = <sqlalchemy.sql.functions._FunctionGenerator object at 0x7fc5977df050>
        attr       = 'email'
        identifier = 'user_moderator@inveniosoftware.org'
        query      = <sqlalchemy.sql.elements.BinaryExpression object at 0x7fc5885327b0>
        self       = <invenio_accounts.datastore.SessionAwareSQLAlchemyUserDatastore object at 0x7fc589304e00>
.venv/lib/python3.12/site-packages/sqlalchemy/orm/query.py:2759: in first
    return self.limit(1)._iter().first()  # type: ignore
           ^^^^^^^^^^^^^^^^^^^^^
        self       = <flask_sqlalchemy.query.Query object at 0x7fc588532f00>
.venv/lib/python3.12/site-packages/sqlalchemy/orm/query.py:2857: in _iter
    result: Union[ScalarResult[_T], Result[_T]] = self.session.execute(
        params     = immutabledict({})
        self       = <flask_sqlalchemy.query.Query object at 0x7fc588532a80>
        statement  = <sqlalchemy.sql.selectable.Select object at 0x7fc588533110>
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2351: in execute
    return self._execute_internal(
        _add_event = None
        _parent_execute_state = None
        bind_arguments = None
        execution_options = {'_sa_orm_load_options': default_load_options(_legacy_uniquing=True)}
        params     = immutabledict({})
        self       = <sqlalchemy.orm.session.Session object at 0x7fc5892ebef0>
        statement  = <sqlalchemy.sql.selectable.Select object at 0x7fc588533110>
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2239: in _execute_internal
    conn = self._connection_for_bind(bind)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        _add_event = None
        _parent_execute_state = None
        _scalar_result = False
        bind       = Engine(postgresql+psycopg2://invenio:***@localhost:5432/invenio)
        bind_arguments = {'clause': <sqlalchemy.sql.selectable.Select object at 0x7fc588533110>,
 'mapper': <Mapper at 0x7fc596363b30; User>}
        compile_state_cls = <class 'sqlalchemy.orm.context.ORMSelectCompileState'>
        events_todo = <sqlalchemy.event.attr._EmptyListener object at 0x7fc58e552b40>
        execution_options = immutabledict({'_sa_orm_load_options': default_load_options(_legacy_uniquing=True), '_result_disable_adapt_to_context': True})
        params     = immutabledict({})
        self       = <sqlalchemy.orm.session.Session object at 0x7fc5892ebef0>
        statement  = <sqlalchemy.sql.selectable.Select object at 0x7fc588533110>
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2108: in _connection_for_bind
    return trans._connection_for_bind(engine, execution_options)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        engine     = Engine(postgresql+psycopg2://invenio:***@localhost:5432/invenio)
        execution_options = None
        kw         = {}
        self       = <sqlalchemy.orm.session.Session object at 0x7fc5892ebef0>
        trans      = <sqlalchemy.orm.session.SessionTransaction object at 0x7fc5891b0490>
<string>:2: in _connection_for_bind
    ???
        bind       = Engine(postgresql+psycopg2://invenio:***@localhost:5432/invenio)
        execution_options = None
        self       = <sqlalchemy.orm.session.SessionTransaction object at 0x7fc5891b0490>
.venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:101: in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
        arg        = (Engine(postgresql+psycopg2://invenio:***@localhost:5432/invenio), None)
        current_state = <SessionTransactionState.DEACTIVE: 4>
        expect_state_change = False
        fn         = <function SessionTransaction._connection_for_bind at 0x7fc596668860>
        has_prerequisite_states = True
        kw         = {}
        moves_to   = <_StateChangeStates.NO_CHANGE: 2>
        prerequisite_state_collection = (<SessionTransactionState.ACTIVE: 1>,)
        self       = <sqlalchemy.orm.session.SessionTransaction object at 0x7fc5891b0490>
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <sqlalchemy.orm.session.SessionTransaction object at 0x7fc5891b0490>
operation_name = '_connection_for_bind'
state = <SessionTransactionState.DEACTIVE: 4>

    def _raise_for_prerequisite_state(
        self, operation_name: str, state: _StateChangeState
    ) -> NoReturn:
        if state is SessionTransactionState.DEACTIVE:
            if self._rollback_exception:
>               raise sa_exc.PendingRollbackError(
                    "This Session's transaction has been rolled back "
                    "due to a previous exception during flush."
                    " To begin a new transaction with this Session, "
                    "first issue Session.rollback()."
                    f" Original exception was: {self._rollback_exception}",
                    code="7s2a",
                )
E               sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: UPDATE statement on table 'accounts_user' expected to update 1 row(s); 0 were matched. (Background on this error at: https://sqlalche.me/e/20/7s2a)

operation_name = '_connection_for_bind'
self       = <sqlalchemy.orm.session.SessionTransaction object at 0x7fc5891b0490>
state      = <SessionTransactionState.DEACTIVE: 4>

.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:971: PendingRollbackError
_______________ test_admin_links_visibility[user_moderator-True] _______________

client = <FlaskClient <Flask 'invenio'>>
headers = {'accept': 'application/json', 'content-type': 'application/json'}
users = {'accented': <pytest_invenio.user.UserFixtureBase object at 0x7fc589357260>, 'inactive': <pytest_invenio.user.UserFixt...object at 0x7fc589356240>, 'notification_enabled': <pytest_invenio.user.UserFixtureBase object at 0x7fc5892eb170>, ...}
username = 'user_moderator', expected_admin_links = True

    @pytest.mark.parametrize(
        "username,expected_admin_links",
        [
            ("user_moderator", True),  # user_moderator should have admin links
            ("pub", False),  # regular user should not have admin links
            ("res", False),  # regular user should not have admin links
        ],
    )
    def test_admin_links_visibility(client, headers, users, username, expected_admin_links):
        """Test admin links visibility based on user permissions."""
        user = users[username]
>       client = user.login(client)
                 ^^^^^^^^^^^^^^^^^^

client     = <FlaskClient <Flask 'invenio'>>
expected_admin_links = True
headers    = {'accept': 'application/json', 'content-type': 'application/json'}
user       = <pytest_invenio.user.UserFixtureBase object at 0x7fc58928c050>
username   = 'user_moderator'
users      = {'accented': <pytest_invenio.user.UserFixtureBase object at 0x7fc589357260>,
 'inactive': <pytest_invenio.user.UserFixtureBase object at 0x7fc5893e0650>,
 'notification_disabled': <pytest_invenio.user.UserFixtureBase object at 0x7fc589356240>,
 'notification_enabled': <pytest_invenio.user.UserFixtureBase object at 0x7fc5892eb170>,
 'pub': <pytest_invenio.user.UserFixtureBase object at 0x7fc589257620>,
 'pubres': <pytest_invenio.user.UserFixtureBase object at 0x7fc5892868d0>,
 'res': <pytest_invenio.user.UserFixtureBase object at 0x7fc5893a4140>,
 'unconfirmed': <pytest_invenio.user.UserFixtureBase object at 0x7fc58928edb0>,
 'user_moderator': <pytest_invenio.user.UserFixtureBase object at 0x7fc58928c050>}

tests/resources/test_resources_users.py:303: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.12/site-packages/pytest_invenio/user.py:152: in login
    return self._login(client, "/", logout_first)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        client     = <FlaskClient <Flask 'invenio'>>
        logout_first = False
        self       = <pytest_invenio.user.UserFixtureBase object at 0x7fc58928c050>
.venv/lib/python3.12/site-packages/pytest_invenio/user.py:170: in _login
    res = client.post(
        base_path  = '/'
        client     = <FlaskClient <Flask 'invenio'>>
        logout     = False
        self       = <pytest_invenio.user.UserFixtureBase object at 0x7fc58928c050>
.venv/lib/python3.12/site-packages/werkzeug/test.py:1167: in post
    return self.open(*args, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^
        args       = ('/login',)
        kw         = {'data': {'email': 'user_moderator@inveniosoftware.org',
          'password': 'user_moderator'},
 'follow_redirects': True,
 'method': 'POST'}
        self       = <FlaskClient <Flask 'invenio'>>
.venv/lib/python3.12/site-packages/flask/testing.py:235: in open
    response = super().open(
        __class__  = <class 'flask.testing.FlaskClient'>
        args       = ('/login',)
        buffered   = False
        follow_redirects = True
        kwargs     = {'data': {'email': 'user_moderator@inveniosoftware.org',
          'password': 'user_moderator'},
 'environ_base': {'HTTP_USER_AGENT': 'Werkzeug/3.1.4',
                  'REMOTE_ADDR': '127.0.0.1',
                  'werkzeug.debug.preserve_context': <built-in method append of list object at 0x7fc587da70c0>},
 'method': 'POST'}
        request    = <Request 'http://localhost/login' [POST]>
        self       = <FlaskClient <Flask 'invenio'>>
.venv/lib/python3.12/site-packages/werkzeug/test.py:1116: in open
    response_parts = self.run_wsgi_app(request.environ, buffered=buffered)
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        arg        = <Request 'http://localhost/login' [POST]>
        args       = (<Request 'http://localhost/login' [POST]>,)
        buffered   = False
        follow_redirects = True
        kwargs     = {}
        request    = <Request 'http://localhost/login' [POST]>
        self       = <FlaskClient <Flask 'invenio'>>
.venv/lib/python3.12/site-packages/werkzeug/test.py:988: in run_wsgi_app
    rv = run_wsgi_app(self.application, environ, buffered=buffered)
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        buffered   = False
        environ    = {'CONTENT_LENGTH': '64',
 'CONTENT_TYPE': 'application/x-www-form-urlencoded',
 'HTTP_HOST': 'localhost',
 'HTTP_USER_AGENT': 'Werkzeug/3.1.4',
 'PATH_INFO': '/login',
 'QUERY_STRING': '',
 'RAW_URI': '/login',
 'REMOTE_ADDR': '127.0.0.1',
 'REQUEST_METHOD': 'POST',
 'REQUEST_URI': '/login',
 'SCRIPT_NAME': '',
 'SERVER_NAME': 'localhost',
 'SERVER_PORT': '80',
 'SERVER_PROTOCOL': 'HTTP/1.1',
 'werkzeug.debug.preserve_context': <built-in method append of list object at 0x7fc587da70c0>,
 'werkzeug.request': <Request 'http://localhost/login' [POST]>,
 'wsgi.errors': <_io.TextIOWrapper name='<stderr>' mode='w' encoding='utf-8'>,
 'wsgi.input': <_io.BytesIO object at 0x7fc58856ef20>,
 'wsgi.multiprocess': False,
 'wsgi.multithread': False,
 'wsgi.run_once': False,
 'wsgi.url_scheme': 'http',
 'wsgi.version': (1, 0)}
        self       = <FlaskClient <Flask 'invenio'>>
.venv/lib/python3.12/site-packages/werkzeug/test.py:1264: in run_wsgi_app
    app_rv = app(environ, start_response)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        app        = <Flask 'invenio'>
        buffer     = []
        buffered   = False
        environ    = {'CONTENT_LENGTH': '64',
 'CONTENT_TYPE': 'application/x-www-form-urlencoded',
 'HTTP_HOST': 'localhost',
 'HTTP_USER_AGENT': 'Werkzeug/3.1.4',
 'PATH_INFO': '/login',
 'QUERY_STRING': '',
 'RAW_URI': '/login',
 'REMOTE_ADDR': '127.0.0.1',
 'REQUEST_METHOD': 'POST',
 'REQUEST_URI': '/login',
 'SCRIPT_NAME': '',
 'SERVER_NAME': 'localhost',
 'SERVER_PORT': '80',
 'SERVER_PROTOCOL': 'HTTP/1.1',
 'werkzeug.debug.preserve_context': <built-in method append of list object at 0x7fc587da70c0>,
 'werkzeug.request': None,
 'wsgi.errors': <_io.TextIOWrapper name='<stderr>' mode='w' encoding='utf-8'>,
 'wsgi.input': <_io.BytesIO object at 0x7fc58856ef20>,
 'wsgi.multiprocess': False,
 'wsgi.multithread': False,
 'wsgi.run_once': False,
 'wsgi.url_scheme': 'http',
 'wsgi.version': (1, 0)}
        response   = None
        start_response = <function run_wsgi_app.<locals>.start_response at 0x7fc588ccb880>
.venv/lib/python3.12/site-packages/flask/app.py:1536: in __call__
    return self.wsgi_app(environ, start_response)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        environ    = {'CONTENT_LENGTH': '64',
 'CONTENT_TYPE': 'application/x-www-form-urlencoded',
 'HTTP_HOST': 'localhost',
 'HTTP_USER_AGENT': 'Werkzeug/3.1.4',
 'PATH_INFO': '/login',
 'QUERY_STRING': '',
 'RAW_URI': '/login',
 'REMOTE_ADDR': '127.0.0.1',
 'REQUEST_METHOD': 'POST',
 'REQUEST_URI': '/login',
 'SCRIPT_NAME': '',
 'SERVER_NAME': 'localhost',
 'SERVER_PORT': '80',
 'SERVER_PROTOCOL': 'HTTP/1.1',
 'werkzeug.debug.preserve_context': <built-in method append of list object at 0x7fc587da70c0>,
 'werkzeug.request': None,
 'wsgi.errors': <_io.TextIOWrapper name='<stderr>' mode='w' encoding='utf-8'>,
 'wsgi.input': <_io.BytesIO object at 0x7fc58856ef20>,
 'wsgi.multiprocess': False,
 'wsgi.multithread': False,
 'wsgi.run_once': False,
 'wsgi.url_scheme': 'http',
 'wsgi.version': (1, 0)}
        self       = <Flask 'invenio'>
        start_response = <function run_wsgi_app.<locals>.start_response at 0x7fc588ccb880>
.venv/lib/python3.12/site-packages/flask/app.py:1514: in wsgi_app
    response = self.handle_exception(e)
               ^^^^^^^^^^^^^^^^^^^^^^^^
        ctx        = <RequestContext 'http://localhost/login' [POST] of invenio>
        environ    = {'CONTENT_LENGTH': '64',
 'CONTENT_TYPE': 'application/x-www-form-urlencoded',
 'HTTP_HOST': 'localhost',
 'HTTP_USER_AGENT': 'Werkzeug/3.1.4',
 'PATH_INFO': '/login',
 'QUERY_STRING': '',
 'RAW_URI': '/login',
 'REMOTE_ADDR': '127.0.0.1',
 'REQUEST_METHOD': 'POST',
 'REQUEST_URI': '/login',
 'SCRIPT_NAME': '',
 'SERVER_NAME': 'localhost',
 'SERVER_PORT': '80',
 'SERVER_PROTOCOL': 'HTTP/1.1',
 'werkzeug.debug.preserve_context': <built-in method append of list object at 0x7fc587da70c0>,
 'werkzeug.request': None,
 'wsgi.errors': <_io.TextIOWrapper name='<stderr>' mode='w' encoding='utf-8'>,
 'wsgi.input': <_io.BytesIO object at 0x7fc58856ef20>,
 'wsgi.multiprocess': False,
 'wsgi.multithread': False,
 'wsgi.run_once': False,
 'wsgi.url_scheme': 'http',
 'wsgi.version': (1, 0)}
        error      = PendingRollbackError("This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: UPDATE statement on table 'accounts_user' expected to update 1 row(s); 0 were matched.")
        self       = <Flask 'invenio'>
        start_response = <function run_wsgi_app.<locals>.start_response at 0x7fc588ccb880>
.venv/lib/python3.12/site-packages/flask/app.py:1511: in wsgi_app
    response = self.full_dispatch_request()
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        ctx        = <RequestContext 'http://localhost/login' [POST] of invenio>
        environ    = {'CONTENT_LENGTH': '64',
 'CONTENT_TYPE': 'application/x-www-form-urlencoded',
 'HTTP_HOST': 'localhost',
 'HTTP_USER_AGENT': 'Werkzeug/3.1.4',
 'PATH_INFO': '/login',
 'QUERY_STRING': '',
 'RAW_URI': '/login',
 'REMOTE_ADDR': '127.0.0.1',
 'REQUEST_METHOD': 'POST',
 'REQUEST_URI': '/login',
 'SCRIPT_NAME': '',
 'SERVER_NAME': 'localhost',
 'SERVER_PORT': '80',
 'SERVER_PROTOCOL': 'HTTP/1.1',
 'werkzeug.debug.preserve_context': <built-in method append of list object at 0x7fc587da70c0>,
 'werkzeug.request': None,
 'wsgi.errors': <_io.TextIOWrapper name='<stderr>' mode='w' encoding='utf-8'>,
 'wsgi.input': <_io.BytesIO object at 0x7fc58856ef20>,
 'wsgi.multiprocess': False,
 'wsgi.multithread': False,
 'wsgi.run_once': False,
 'wsgi.url_scheme': 'http',
 'wsgi.version': (1, 0)}
        error      = PendingRollbackError("This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: UPDATE statement on table 'accounts_user' expected to update 1 row(s); 0 were matched.")
        self       = <Flask 'invenio'>
        start_response = <function run_wsgi_app.<locals>.start_response at 0x7fc588ccb880>
.venv/lib/python3.12/site-packages/flask/app.py:919: in full_dispatch_request
    rv = self.handle_user_exception(e)
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        rv         = None
        self       = <Flask 'invenio'>
.venv/lib/python3.12/site-packages/flask/app.py:917: in full_dispatch_request
    rv = self.dispatch_request()
         ^^^^^^^^^^^^^^^^^^^^^^^
        rv         = None
        self       = <Flask 'invenio'>
.venv/lib/python3.12/site-packages/flask/app.py:902: in dispatch_request
    return self.ensure_sync(self.view_functions[rule.endpoint])(**view_args)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        req        = <Request 'http://localhost/login' [POST]>
        rule       = <Rule '/login' (POST, OPTIONS) -> invenio_accounts_rest_auth.login>
        self       = <Flask 'invenio'>
        view_args  = {}
.venv/lib/python3.12/site-packages/invenio_accounts/views/rest.py:61: in wrapper
    return f(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^
        args       = ()
        f          = <function View.as_view.<locals>.view at 0x7fc5892600e0>
        kwargs     = {}
.venv/lib/python3.12/site-packages/flask/views.py:110: in view
    return current_app.ensure_sync(self.dispatch_request)(**kwargs)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        class_args = ()
        class_kwargs = {}
        kwargs     = {}
        self       = <invenio_accounts.views.rest.LoginView object at 0x7fc58862b530>
        view       = <function View.as_view.<locals>.view at 0x7fc589280a40>
.venv/lib/python3.12/site-packages/flask/views.py:191: in dispatch_request
    return current_app.ensure_sync(meth)(**kwargs)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        kwargs     = {}
        meth       = <bound method LoginView.post of <invenio_accounts.views.rest.LoginView object at 0x7fc58862b530>>
        self       = <invenio_accounts.views.rest.LoginView object at 0x7fc58862b530>
.venv/lib/python3.12/site-packages/webargs/core.py:445: in wrapper
    parsed_args = self.parse(
        argmap     = <GeneratedSchema(many=False)>
        args       = (<invenio_accounts.views.rest.LoginView object at 0x7fc58862b530>,)
        as_kwargs  = True
        error_headers = None
        error_status_code = None
        func       = <function LoginView.post at 0x7fc58d494fe0>
        kwargs     = {}
        locations  = ('querystring', 'form', 'json')
        req_       = None
        req_obj    = None
        self       = <invenio_accounts.views.rest.FlaskParser object at 0x7fc58d659df0>
        validate   = None
.venv/lib/python3.12/site-packages/webargs/core.py:356: in parse
    result = schema.load(parsed)
             ^^^^^^^^^^^^^^^^^^^
        argmap     = <GeneratedSchema(many=False)>
        data       = None
        error_headers = None
        error_status_code = None
        locations  = ('querystring', 'form', 'json')
        parsed     = {'email': 'user_moderator@inveniosoftware.org', 'password': 'user_moderator'}
        parser     = <invenio_accounts.views.rest.FlaskParser object at 0x7fc589306480>
        req        = <Request 'http://localhost/' [GET]>
        schema     = <GeneratedSchema(many=False)>
        self       = <invenio_accounts.views.rest.FlaskParser object at 0x7fc58d659df0>
        validate   = None
        validators = []
.venv/lib/python3.12/site-packages/marshmallow/schema.py:792: in load
    return self._do_load(
        data       = {'email': 'user_moderator@inveniosoftware.org', 'password': 'user_moderator'}
        many       = None
        partial    = None
        self       = <GeneratedSchema(many=False)>
        unknown    = None
.venv/lib/python3.12/site-packages/marshmallow/schema.py:951: in _do_load
    result = self._deserialize(
        data       = {'email': 'user_moderator@inveniosoftware.org', 'password': 'user_moderator'}
        error_store = <marshmallow.error_store.ErrorStore object at 0x7fc58862b2f0>
        errors     = {}
        many       = False
        partial    = None
        postprocess = True
        processed_data = {'email': 'user_moderator@inveniosoftware.org', 'password': 'user_moderator'}
        self       = <GeneratedSchema(many=False)>
        unknown    = 'raise'
.venv/lib/python3.12/site-packages/marshmallow/schema.py:734: in _deserialize
    value = self._call_and_store(
        attr_name  = 'email'
        d_kwargs   = {}
        data       = {'email': 'user_moderator@inveniosoftware.org', 'password': 'user_moderator'}
        error_store = <marshmallow.error_store.ErrorStore object at 0x7fc58862b2f0>
        field_name = 'email'
        field_obj  = <fields.Email(dump_default=<marshmallow.missing>, attribute=None, validate=[<function user_exists at 0x7fc58d494400>], required=True, load_only=False, dump_only=False, load_default=<marshmallow.missing>, allow_none=False, error_messages={'required': 'Missing data for required field.', 'null': 'Field may not be null.', 'validator_failed': 'Invalid value.', 'invalid': 'Not a valid email address.', 'invalid_utf8': 'Not a valid utf-8 string.'})>
        getter     = <function Schema._deserialize.<locals>.getter at 0x7fc589298720>
        index      = None
        index_errors = True
        many       = False
        partial    = None
        partial_is_collection = False
        raw_value  = 'user_moderator@inveniosoftware.org'
        ret_d      = {}
        self       = <GeneratedSchema(many=False)>
        unknown    = 'raise'
.venv/lib/python3.12/site-packages/marshmallow/schema.py:570: in _call_and_store
    value = getter_func(data)
            ^^^^^^^^^^^^^^^^^
        data       = 'user_moderator@inveniosoftware.org'
        error_store = <marshmallow.error_store.ErrorStore object at 0x7fc58862b2f0>
        field_name = 'email'
        getter_func = <function Schema._deserialize.<locals>.getter at 0x7fc589298720>
        index      = None
.venv/lib/python3.12/site-packages/marshmallow/schema.py:727: in getter
    return field_obj.deserialize(
        d_kwargs   = {}
        data       = {'email': 'user_moderator@inveniosoftware.org', 'password': 'user_moderator'}
        field_name = 'email'
        field_obj  = <fields.Email(dump_default=<marshmallow.missing>, attribute=None, validate=[<function user_exists at 0x7fc58d494400>], required=True, load_only=False, dump_only=False, load_default=<marshmallow.missing>, allow_none=False, error_messages={'required': 'Missing data for required field.', 'null': 'Field may not be null.', 'validator_failed': 'Invalid value.', 'invalid': 'Not a valid email address.', 'invalid_utf8': 'Not a valid utf-8 string.'})>
        val        = 'user_moderator@inveniosoftware.org'
.venv/lib/python3.12/site-packages/marshmallow/fields.py:375: in deserialize
    self._validate(output)
        attr       = 'email'
        data       = {'email': 'user_moderator@inveniosoftware.org', 'password': 'user_moderator'}
        kwargs     = {}
        output     = 'user_moderator@inveniosoftware.org'
        self       = <fields.Email(dump_default=<marshmallow.missing>, attribute=None, validate=[<function user_exists at 0x7fc58d494400>], required=True, load_only=False, dump_only=False, load_default=<marshmallow.missing>, allow_none=False, error_messages={'required': 'Missing data for required field.', 'null': 'Field may not be null.', 'validator_failed': 'Invalid value.', 'invalid': 'Not a valid email address.', 'invalid_utf8': 'Not a valid utf-8 string.'})>
        value      = 'user_moderator@inveniosoftware.org'
.venv/lib/python3.12/site-packages/marshmallow/fields.py:276: in _validate
    self._validate_all(value)
        self       = <fields.Email(dump_default=<marshmallow.missing>, attribute=None, validate=[<function user_exists at 0x7fc58d494400>], required=True, load_only=False, dump_only=False, load_default=<marshmallow.missing>, allow_none=False, error_messages={'required': 'Missing data for required field.', 'null': 'Field may not be null.', 'validator_failed': 'Invalid value.', 'invalid': 'Not a valid email address.', 'invalid_utf8': 'Not a valid utf-8 string.'})>
        value      = 'user_moderator@inveniosoftware.org'
.venv/lib/python3.12/site-packages/marshmallow/validate.py:82: in __call__
    r = validator(value)
        ^^^^^^^^^^^^^^^^
        errors     = []
        kwargs     = {}
        r          = 'user_moderator@inveniosoftware.org'
        self       = <And(validators=(<Email(error='Not a valid email address.')>, <function user_exists at 0x7fc58d494400>), error='Invalid value.')>
        validator  = <function user_exists at 0x7fc58d494400>
        value      = 'user_moderator@inveniosoftware.org'
.venv/lib/python3.12/site-packages/invenio_accounts/views/rest.py:187: in user_exists
    if not current_datastore.get_user(email):
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        email      = 'user_moderator@inveniosoftware.org'
.venv/lib/python3.12/site-packages/flask_security/datastore.py:219: in get_user
    rv = self.user_model.query.filter(query).first()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        alchemyFn  = <sqlalchemy.sql.functions._FunctionGenerator object at 0x7fc5977df050>
        attr       = 'email'
        identifier = 'user_moderator@inveniosoftware.org'
        query      = <sqlalchemy.sql.elements.BinaryExpression object at 0x7fc588ce0f20>
        self       = <invenio_accounts.datastore.SessionAwareSQLAlchemyUserDatastore object at 0x7fc589304e00>
.venv/lib/python3.12/site-packages/sqlalchemy/orm/query.py:2759: in first
    return self.limit(1)._iter().first()  # type: ignore
           ^^^^^^^^^^^^^^^^^^^^^
        self       = <flask_sqlalchemy.query.Query object at 0x7fc588ce0c50>
.venv/lib/python3.12/site-packages/sqlalchemy/orm/query.py:2857: in _iter
    result: Union[ScalarResult[_T], Result[_T]] = self.session.execute(
        params     = immutabledict({})
        self       = <flask_sqlalchemy.query.Query object at 0x7fc588ce0aa0>
        statement  = <sqlalchemy.sql.selectable.Select object at 0x7fc588ce0e30>
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2351: in execute
    return self._execute_internal(
        _add_event = None
        _parent_execute_state = None
        bind_arguments = None
        execution_options = {'_sa_orm_load_options': default_load_options(_legacy_uniquing=True)}
        params     = immutabledict({})
        self       = <sqlalchemy.orm.session.Session object at 0x7fc5892ebef0>
        statement  = <sqlalchemy.sql.selectable.Select object at 0x7fc588ce0e30>
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2239: in _execute_internal
    conn = self._connection_for_bind(bind)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        _add_event = None
        _parent_execute_state = None
        _scalar_result = False
        bind       = Engine(postgresql+psycopg2://invenio:***@localhost:5432/invenio)
        bind_arguments = {'clause': <sqlalchemy.sql.selectable.Select object at 0x7fc588ce0e30>,
 'mapper': <Mapper at 0x7fc596363b30; User>}
        compile_state_cls = <class 'sqlalchemy.orm.context.ORMSelectCompileState'>
        events_todo = <sqlalchemy.event.attr._EmptyListener object at 0x7fc58e552b40>
        execution_options = immutabledict({'_sa_orm_load_options': default_load_options(_legacy_uniquing=True), '_result_disable_adapt_to_context': True})
        params     = immutabledict({})
        self       = <sqlalchemy.orm.session.Session object at 0x7fc5892ebef0>
        statement  = <sqlalchemy.sql.selectable.Select object at 0x7fc588ce0e30>
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2108: in _connection_for_bind
    return trans._connection_for_bind(engine, execution_options)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        engine     = Engine(postgresql+psycopg2://invenio:***@localhost:5432/invenio)
        execution_options = None
        kw         = {}
        self       = <sqlalchemy.orm.session.Session object at 0x7fc5892ebef0>
        trans      = <sqlalchemy.orm.session.SessionTransaction object at 0x7fc5891b0490>
<string>:2: in _connection_for_bind
    ???
        bind       = Engine(postgresql+psycopg2://invenio:***@localhost:5432/invenio)
        execution_options = None
        self       = <sqlalchemy.orm.session.SessionTransaction object at 0x7fc5891b0490>
.venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:101: in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
        arg        = (Engine(postgresql+psycopg2://invenio:***@localhost:5432/invenio), None)
        current_state = <SessionTransactionState.DEACTIVE: 4>
        expect_state_change = False
        fn         = <function SessionTransaction._connection_for_bind at 0x7fc596668860>
        has_prerequisite_states = True
        kw         = {}
        moves_to   = <_StateChangeStates.NO_CHANGE: 2>
        prerequisite_state_collection = (<SessionTransactionState.ACTIVE: 1>,)
        self       = <sqlalchemy.orm.session.SessionTransaction object at 0x7fc5891b0490>
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <sqlalchemy.orm.session.SessionTransaction object at 0x7fc5891b0490>
operation_name = '_connection_for_bind'
state = <SessionTransactionState.DEACTIVE: 4>

    def _raise_for_prerequisite_state(
        self, operation_name: str, state: _StateChangeState
    ) -> NoReturn:
        if state is SessionTransactionState.DEACTIVE:
            if self._rollback_exception:
>               raise sa_exc.PendingRollbackError(
                    "This Session's transaction has been rolled back "
                    "due to a previous exception during flush."
                    " To begin a new transaction with this Session, "
                    "first issue Session.rollback()."
                    f" Original exception was: {self._rollback_exception}",
                    code="7s2a",
                )
E               sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: UPDATE statement on table 'accounts_user' expected to update 1 row(s); 0 were matched. (Background on this error at: https://sqlalche.me/e/20/7s2a)

operation_name = '_connection_for_bind'
self       = <sqlalchemy.orm.session.SessionTransaction object at 0x7fc5891b0490>
state      = <SessionTransactionState.DEACTIVE: 4>

.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:971: PendingRollbackError
____________________ test_admin_links_visibility[pub-False] ____________________

client = <FlaskClient <Flask 'invenio'>>
headers = {'accept': 'application/json', 'content-type': 'application/json'}
users = {'accented': <pytest_invenio.user.UserFixtureBase object at 0x7fc589357260>, 'inactive': <pytest_invenio.user.UserFixt...object at 0x7fc589356240>, 'notification_enabled': <pytest_invenio.user.UserFixtureBase object at 0x7fc5892eb170>, ...}
username = 'pub', expected_admin_links = False

    @pytest.mark.parametrize(
        "username,expected_admin_links",
        [
            ("user_moderator", True),  # user_moderator should have admin links
            ("pub", False),  # regular user should not have admin links
            ("res", False),  # regular user should not have admin links
        ],
    )
    def test_admin_links_visibility(client, headers, users, username, expected_admin_links):
        """Test admin links visibility based on user permissions."""
        user = users[username]
>       client = user.login(client)
                 ^^^^^^^^^^^^^^^^^^

client     = <FlaskClient <Flask 'invenio'>>
expected_admin_links = False
headers    = {'accept': 'application/json', 'content-type': 'application/json'}
user       = <pytest_invenio.user.UserFixtureBase object at 0x7fc589257620>
username   = 'pub'
users      = {'accented': <pytest_invenio.user.UserFixtureBase object at 0x7fc589357260>,
 'inactive': <pytest_invenio.user.UserFixtureBase object at 0x7fc5893e0650>,
 'notification_disabled': <pytest_invenio.user.UserFixtureBase object at 0x7fc589356240>,
 'notification_enabled': <pytest_invenio.user.UserFixtureBase object at 0x7fc5892eb170>,
 'pub': <pytest_invenio.user.UserFixtureBase object at 0x7fc589257620>,
 'pubres': <pytest_invenio.user.UserFixtureBase object at 0x7fc5892868d0>,
 'res': <pytest_invenio.user.UserFixtureBase object at 0x7fc5893a4140>,
 'unconfirmed': <pytest_invenio.user.UserFixtureBase object at 0x7fc58928edb0>,
 'user_moderator': <pytest_invenio.user.UserFixtureBase object at 0x7fc58928c050>}

tests/resources/test_resources_users.py:303: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.12/site-packages/pytest_invenio/user.py:152: in login
    return self._login(client, "/", logout_first)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        client     = <FlaskClient <Flask 'invenio'>>
        logout_first = False
        self       = <pytest_invenio.user.UserFixtureBase object at 0x7fc589257620>
.venv/lib/python3.12/site-packages/pytest_invenio/user.py:170: in _login
    res = client.post(
        base_path  = '/'
        client     = <FlaskClient <Flask 'invenio'>>
        logout     = False
        self       = <pytest_invenio.user.UserFixtureBase object at 0x7fc589257620>
.venv/lib/python3.12/site-packages/werkzeug/test.py:1167: in post
    return self.open(*args, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^
        args       = ('/login',)
        kw         = {'data': {'email': 'pub@inveniosoftware.org', 'password': 'pub'},
 'follow_redirects': True,
 'method': 'POST'}
        self       = <FlaskClient <Flask 'invenio'>>
.venv/lib/python3.12/site-packages/flask/testing.py:235: in open
    response = super().open(
        __class__  = <class 'flask.testing.FlaskClient'>
        args       = ('/login',)
        buffered   = False
        follow_redirects = True
        kwargs     = {'data': {'email': 'pub@inveniosoftware.org', 'password': 'pub'},
 'environ_base': {'HTTP_USER_AGENT': 'Werkzeug/3.1.4',
                  'REMOTE_ADDR': '127.0.0.1',
                  'werkzeug.debug.preserve_context': <built-in method append of list object at 0x7fc587b0a580>},
 'method': 'POST'}
        request    = <Request 'http://localhost/login' [POST]>
        self       = <FlaskClient <Flask 'invenio'>>
.venv/lib/python3.12/site-packages/werkzeug/test.py:1116: in open
    response_parts = self.run_wsgi_app(request.environ, buffered=buffered)
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        arg        = <Request 'http://localhost/login' [POST]>
        args       = (<Request 'http://localhost/login' [POST]>,)
        buffered   = False
        follow_redirects = True
        kwargs     = {}
        request    = <Request 'http://localhost/login' [POST]>
        self       = <FlaskClient <Flask 'invenio'>>
.venv/lib/python3.12/site-packages/werkzeug/test.py:988: in run_wsgi_app
    rv = run_wsgi_app(self.application, environ, buffered=buffered)
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        buffered   = False
        environ    = {'CONTENT_LENGTH': '42',
 'CONTENT_TYPE': 'application/x-www-form-urlencoded',
 'HTTP_HOST': 'localhost',
 'HTTP_USER_AGENT': 'Werkzeug/3.1.4',
 'PATH_INFO': '/login',
 'QUERY_STRING': '',
 'RAW_URI': '/login',
 'REMOTE_ADDR': '127.0.0.1',
 'REQUEST_METHOD': 'POST',
 'REQUEST_URI': '/login',
 'SCRIPT_NAME': '',
 'SERVER_NAME': 'localhost',
 'SERVER_PORT': '80',
 'SERVER_PROTOCOL': 'HTTP/1.1',
 'werkzeug.debug.preserve_context': <built-in method append of list object at 0x7fc587b0a580>,
 'werkzeug.request': <Request 'http://localhost/login' [POST]>,
 'wsgi.errors': <_io.TextIOWrapper name='<stderr>' mode='w' encoding='utf-8'>,
 'wsgi.input': <_io.BytesIO object at 0x7fc589183010>,
 'wsgi.multiprocess': False,
 'wsgi.multithread': False,
 'wsgi.run_once': False,
 'wsgi.url_scheme': 'http',
 'wsgi.version': (1, 0)}
        self       = <FlaskClient <Flask 'invenio'>>
.venv/lib/python3.12/site-packages/werkzeug/test.py:1264: in run_wsgi_app
    app_rv = app(environ, start_response)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        app        = <Flask 'invenio'>
        buffer     = []
        buffered   = False
        environ    = {'CONTENT_LENGTH': '42',
 'CONTENT_TYPE': 'application/x-www-form-urlencoded',
 'HTTP_HOST': 'localhost',
 'HTTP_USER_AGENT': 'Werkzeug/3.1.4',
 'PATH_INFO': '/login',
 'QUERY_STRING': '',
 'RAW_URI': '/login',
 'REMOTE_ADDR': '127.0.0.1',
 'REQUEST_METHOD': 'POST',
 'REQUEST_URI': '/login',
 'SCRIPT_NAME': '',
 'SERVER_NAME': 'localhost',
 'SERVER_PORT': '80',
 'SERVER_PROTOCOL': 'HTTP/1.1',
 'werkzeug.debug.preserve_context': <built-in method append of list object at 0x7fc587b0a580>,
 'werkzeug.request': None,
 'wsgi.errors': <_io.TextIOWrapper name='<stderr>' mode='w' encoding='utf-8'>,
 'wsgi.input': <_io.BytesIO object at 0x7fc589183010>,
 'wsgi.multiprocess': False,
 'wsgi.multithread': False,
 'wsgi.run_once': False,
 'wsgi.url_scheme': 'http',
 'wsgi.version': (1, 0)}
        response   = None
        start_response = <function run_wsgi_app.<locals>.start_response at 0x7fc5886402c0>
.venv/lib/python3.12/site-packages/flask/app.py:1536: in __call__
    return self.wsgi_app(environ, start_response)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        environ    = {'CONTENT_LENGTH': '42',
 'CONTENT_TYPE': 'application/x-www-form-urlencoded',
 'HTTP_HOST': 'localhost',
 'HTTP_USER_AGENT': 'Werkzeug/3.1.4',
 'PATH_INFO': '/login',
 'QUERY_STRING': '',
 'RAW_URI': '/login',
 'REMOTE_ADDR': '127.0.0.1',
 'REQUEST_METHOD': 'POST',
 'REQUEST_URI': '/login',
 'SCRIPT_NAME': '',
 'SERVER_NAME': 'localhost',
 'SERVER_PORT': '80',
 'SERVER_PROTOCOL': 'HTTP/1.1',
 'werkzeug.debug.preserve_context': <built-in method append of list object at 0x7fc587b0a580>,
 'werkzeug.request': None,
 'wsgi.errors': <_io.TextIOWrapper name='<stderr>' mode='w' encoding='utf-8'>,
 'wsgi.input': <_io.BytesIO object at 0x7fc589183010>,
 'wsgi.multiprocess': False,
 'wsgi.multithread': False,
 'wsgi.run_once': False,
 'wsgi.url_scheme': 'http',
 'wsgi.version': (1, 0)}
        self       = <Flask 'invenio'>
        start_response = <function run_wsgi_app.<locals>.start_response at 0x7fc5886402c0>
.venv/lib/python3.12/site-packages/flask/app.py:1514: in wsgi_app
    response = self.handle_exception(e)
               ^^^^^^^^^^^^^^^^^^^^^^^^
        ctx        = <RequestContext 'http://localhost/login' [POST] of invenio>
        environ    = {'CONTENT_LENGTH': '42',
 'CONTENT_TYPE': 'application/x-www-form-urlencoded',
 'HTTP_HOST': 'localhost',
 'HTTP_USER_AGENT': 'Werkzeug/3.1.4',
 'PATH_INFO': '/login',
 'QUERY_STRING': '',
 'RAW_URI': '/login',
 'REMOTE_ADDR': '127.0.0.1',
 'REQUEST_METHOD': 'POST',
 'REQUEST_URI': '/login',
 'SCRIPT_NAME': '',
 'SERVER_NAME': 'localhost',
 'SERVER_PORT': '80',
 'SERVER_PROTOCOL': 'HTTP/1.1',
 'werkzeug.debug.preserve_context': <built-in method append of list object at 0x7fc587b0a580>,
 'werkzeug.request': None,
 'wsgi.errors': <_io.TextIOWrapper name='<stderr>' mode='w' encoding='utf-8'>,
 'wsgi.input': <_io.BytesIO object at 0x7fc589183010>,
 'wsgi.multiprocess': False,
 'wsgi.multithread': False,
 'wsgi.run_once': False,
 'wsgi.url_scheme': 'http',
 'wsgi.version': (1, 0)}
        error      = PendingRollbackError("This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: UPDATE statement on table 'accounts_user' expected to update 1 row(s); 0 were matched.")
        self       = <Flask 'invenio'>
        start_response = <function run_wsgi_app.<locals>.start_response at 0x7fc5886402c0>
.venv/lib/python3.12/site-packages/flask/app.py:1511: in wsgi_app
    response = self.full_dispatch_request()
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        ctx        = <RequestContext 'http://localhost/login' [POST] of invenio>
        environ    = {'CONTENT_LENGTH': '42',
 'CONTENT_TYPE': 'application/x-www-form-urlencoded',
 'HTTP_HOST': 'localhost',
 'HTTP_USER_AGENT': 'Werkzeug/3.1.4',
 'PATH_INFO': '/login',
 'QUERY_STRING': '',
 'RAW_URI': '/login',
 'REMOTE_ADDR': '127.0.0.1',
 'REQUEST_METHOD': 'POST',
 'REQUEST_URI': '/login',
 'SCRIPT_NAME': '',
 'SERVER_NAME': 'localhost',
 'SERVER_PORT': '80',
 'SERVER_PROTOCOL': 'HTTP/1.1',
 'werkzeug.debug.preserve_context': <built-in method append of list object at 0x7fc587b0a580>,
 'werkzeug.request': None,
 'wsgi.errors': <_io.TextIOWrapper name='<stderr>' mode='w' encoding='utf-8'>,
 'wsgi.input': <_io.BytesIO object at 0x7fc589183010>,
 'wsgi.multiprocess': False,
 'wsgi.multithread': False,
 'wsgi.run_once': False,
 'wsgi.url_scheme': 'http',
 'wsgi.version': (1, 0)}
        error      = PendingRollbackError("This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: UPDATE statement on table 'accounts_user' expected to update 1 row(s); 0 were matched.")
        self       = <Flask 'invenio'>
        start_response = <function run_wsgi_app.<locals>.start_response at 0x7fc5886402c0>
.venv/lib/python3.12/site-packages/flask/app.py:919: in full_dispatch_request
    rv = self.handle_user_exception(e)
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        rv         = None
        self       = <Flask 'invenio'>
.venv/lib/python3.12/site-packages/flask/app.py:917: in full_dispatch_request
    rv = self.dispatch_request()
         ^^^^^^^^^^^^^^^^^^^^^^^
        rv         = None
        self       = <Flask 'invenio'>
.venv/lib/python3.12/site-packages/flask/app.py:902: in dispatch_request
    return self.ensure_sync(self.view_functions[rule.endpoint])(**view_args)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        req        = <Request 'http://localhost/login' [POST]>
        rule       = <Rule '/login' (POST, OPTIONS) -> invenio_accounts_rest_auth.login>
        self       = <Flask 'invenio'>
        view_args  = {}
.venv/lib/python3.12/site-packages/invenio_accounts/views/rest.py:61: in wrapper
    return f(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^
        args       = ()
        f          = <function View.as_view.<locals>.view at 0x7fc5892600e0>
        kwargs     = {}
.venv/lib/python3.12/site-packages/flask/views.py:110: in view
    return current_app.ensure_sync(self.dispatch_request)(**kwargs)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        class_args = ()
        class_kwargs = {}
        kwargs     = {}
        self       = <invenio_accounts.views.rest.LoginView object at 0x7fc5893a5040>
        view       = <function View.as_view.<locals>.view at 0x7fc589280a40>
.venv/lib/python3.12/site-packages/flask/views.py:191: in dispatch_request
    return current_app.ensure_sync(meth)(**kwargs)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        kwargs     = {}
        meth       = <bound method LoginView.post of <invenio_accounts.views.rest.LoginView object at 0x7fc5893a5040>>
        self       = <invenio_accounts.views.rest.LoginView object at 0x7fc5893a5040>
.venv/lib/python3.12/site-packages/webargs/core.py:445: in wrapper
    parsed_args = self.parse(
        argmap     = <GeneratedSchema(many=False)>
        args       = (<invenio_accounts.views.rest.LoginView object at 0x7fc5893a5040>,)
        as_kwargs  = True
        error_headers = None
        error_status_code = None
        func       = <function LoginView.post at 0x7fc58d494fe0>
        kwargs     = {}
        locations  = ('querystring', 'form', 'json')
        req_       = None
        req_obj    = None
        self       = <invenio_accounts.views.rest.FlaskParser object at 0x7fc58d659df0>
        validate   = None
.venv/lib/python3.12/site-packages/webargs/core.py:356: in parse
    result = schema.load(parsed)
             ^^^^^^^^^^^^^^^^^^^
        argmap     = <GeneratedSchema(many=False)>
        data       = None
        error_headers = None
        error_status_code = None
        locations  = ('querystring', 'form', 'json')
        parsed     = {'email': 'pub@inveniosoftware.org', 'password': 'pub'}
        parser     = <invenio_accounts.views.rest.FlaskParser object at 0x7fc5893a7b90>
        req        = <Request 'http://localhost/' [GET]>
        schema     = <GeneratedSchema(many=False)>
        self       = <invenio_accounts.views.rest.FlaskParser object at 0x7fc58d659df0>
        validate   = None
        validators = []
.venv/lib/python3.12/site-packages/marshmallow/schema.py:792: in load
    return self._do_load(
        data       = {'email': 'pub@inveniosoftware.org', 'password': 'pub'}
        many       = None
        partial    = None
        self       = <GeneratedSchema(many=False)>
        unknown    = None
.venv/lib/python3.12/site-packages/marshmallow/schema.py:951: in _do_load
    result = self._deserialize(
        data       = {'email': 'pub@inveniosoftware.org', 'password': 'pub'}
        error_store = <marshmallow.error_store.ErrorStore object at 0x7fc5893a7800>
        errors     = {}
        many       = False
        partial    = None
        postprocess = True
        processed_data = {'email': 'pub@inveniosoftware.org', 'password': 'pub'}
        self       = <GeneratedSchema(many=False)>
        unknown    = 'raise'
.venv/lib/python3.12/site-packages/marshmallow/schema.py:734: in _deserialize
    value = self._call_and_store(
        attr_name  = 'email'
        d_kwargs   = {}
        data       = {'email': 'pub@inveniosoftware.org', 'password': 'pub'}
        error_store = <marshmallow.error_store.ErrorStore object at 0x7fc5893a7800>
        field_name = 'email'
        field_obj  = <fields.Email(dump_default=<marshmallow.missing>, attribute=None, validate=[<function user_exists at 0x7fc58d494400>], required=True, load_only=False, dump_only=False, load_default=<marshmallow.missing>, allow_none=False, error_messages={'required': 'Missing data for required field.', 'null': 'Field may not be null.', 'validator_failed': 'Invalid value.', 'invalid': 'Not a valid email address.', 'invalid_utf8': 'Not a valid utf-8 string.'})>
        getter     = <function Schema._deserialize.<locals>.getter at 0x7fc588640400>
        index      = None
        index_errors = True
        many       = False
        partial    = None
        partial_is_collection = False
        raw_value  = 'pub@inveniosoftware.org'
        ret_d      = {}
        self       = <GeneratedSchema(many=False)>
        unknown    = 'raise'
.venv/lib/python3.12/site-packages/marshmallow/schema.py:570: in _call_and_store
    value = getter_func(data)
            ^^^^^^^^^^^^^^^^^
        data       = 'pub@inveniosoftware.org'
        error_store = <marshmallow.error_store.ErrorStore object at 0x7fc5893a7800>
        field_name = 'email'
        getter_func = <function Schema._deserialize.<locals>.getter at 0x7fc588640400>
        index      = None
.venv/lib/python3.12/site-packages/marshmallow/schema.py:727: in getter
    return field_obj.deserialize(
        d_kwargs   = {}
        data       = {'email': 'pub@inveniosoftware.org', 'password': 'pub'}
        field_name = 'email'
        field_obj  = <fields.Email(dump_default=<marshmallow.missing>, attribute=None, validate=[<function user_exists at 0x7fc58d494400>], required=True, load_only=False, dump_only=False, load_default=<marshmallow.missing>, allow_none=False, error_messages={'required': 'Missing data for required field.', 'null': 'Field may not be null.', 'validator_failed': 'Invalid value.', 'invalid': 'Not a valid email address.', 'invalid_utf8': 'Not a valid utf-8 string.'})>
        val        = 'pub@inveniosoftware.org'
.venv/lib/python3.12/site-packages/marshmallow/fields.py:375: in deserialize
    self._validate(output)
        attr       = 'email'
        data       = {'email': 'pub@inveniosoftware.org', 'password': 'pub'}
        kwargs     = {}
        output     = 'pub@inveniosoftware.org'
        self       = <fields.Email(dump_default=<marshmallow.missing>, attribute=None, validate=[<function user_exists at 0x7fc58d494400>], required=True, load_only=False, dump_only=False, load_default=<marshmallow.missing>, allow_none=False, error_messages={'required': 'Missing data for required field.', 'null': 'Field may not be null.', 'validator_failed': 'Invalid value.', 'invalid': 'Not a valid email address.', 'invalid_utf8': 'Not a valid utf-8 string.'})>
        value      = 'pub@inveniosoftware.org'
.venv/lib/python3.12/site-packages/marshmallow/fields.py:276: in _validate
    self._validate_all(value)
        self       = <fields.Email(dump_default=<marshmallow.missing>, attribute=None, validate=[<function user_exists at 0x7fc58d494400>], required=True, load_only=False, dump_only=False, load_default=<marshmallow.missing>, allow_none=False, error_messages={'required': 'Missing data for required field.', 'null': 'Field may not be null.', 'validator_failed': 'Invalid value.', 'invalid': 'Not a valid email address.', 'invalid_utf8': 'Not a valid utf-8 string.'})>
        value      = 'pub@inveniosoftware.org'
.venv/lib/python3.12/site-packages/marshmallow/validate.py:82: in __call__
    r = validator(value)
        ^^^^^^^^^^^^^^^^
        errors     = []
        kwargs     = {}
        r          = 'pub@inveniosoftware.org'
        self       = <And(validators=(<Email(error='Not a valid email address.')>, <function user_exists at 0x7fc58d494400>), error='Invalid value.')>
        validator  = <function user_exists at 0x7fc58d494400>
        value      = 'pub@inveniosoftware.org'
.venv/lib/python3.12/site-packages/invenio_accounts/views/rest.py:187: in user_exists
    if not current_datastore.get_user(email):
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        email      = 'pub@inveniosoftware.org'
.venv/lib/python3.12/site-packages/flask_security/datastore.py:219: in get_user
    rv = self.user_model.query.filter(query).first()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        alchemyFn  = <sqlalchemy.sql.functions._FunctionGenerator object at 0x7fc5977df050>
        attr       = 'email'
        identifier = 'pub@inveniosoftware.org'
        query      = <sqlalchemy.sql.elements.BinaryExpression object at 0x7fc5893a56a0>
        self       = <invenio_accounts.datastore.SessionAwareSQLAlchemyUserDatastore object at 0x7fc589304e00>
.venv/lib/python3.12/site-packages/sqlalchemy/orm/query.py:2759: in first
    return self.limit(1)._iter().first()  # type: ignore
           ^^^^^^^^^^^^^^^^^^^^^
        self       = <flask_sqlalchemy.query.Query object at 0x7fc589367860>
.venv/lib/python3.12/site-packages/sqlalchemy/orm/query.py:2857: in _iter
    result: Union[ScalarResult[_T], Result[_T]] = self.session.execute(
        params     = immutabledict({})
        self       = <flask_sqlalchemy.query.Query object at 0x7fc589366990>
        statement  = <sqlalchemy.sql.selectable.Select object at 0x7fc589367c20>
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2351: in execute
    return self._execute_internal(
        _add_event = None
        _parent_execute_state = None
        bind_arguments = None
        execution_options = {'_sa_orm_load_options': default_load_options(_legacy_uniquing=True)}
        params     = immutabledict({})
        self       = <sqlalchemy.orm.session.Session object at 0x7fc5892ebef0>
        statement  = <sqlalchemy.sql.selectable.Select object at 0x7fc589367c20>
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2239: in _execute_internal
    conn = self._connection_for_bind(bind)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        _add_event = None
        _parent_execute_state = None
        _scalar_result = False
        bind       = Engine(postgresql+psycopg2://invenio:***@localhost:5432/invenio)
        bind_arguments = {'clause': <sqlalchemy.sql.selectable.Select object at 0x7fc589367c20>,
 'mapper': <Mapper at 0x7fc596363b30; User>}
        compile_state_cls = <class 'sqlalchemy.orm.context.ORMSelectCompileState'>
        events_todo = <sqlalchemy.event.attr._EmptyListener object at 0x7fc58e552b40>
        execution_options = immutabledict({'_sa_orm_load_options': default_load_options(_legacy_uniquing=True), '_result_disable_adapt_to_context': True})
        params     = immutabledict({})
        self       = <sqlalchemy.orm.session.Session object at 0x7fc5892ebef0>
        statement  = <sqlalchemy.sql.selectable.Select object at 0x7fc589367c20>
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2108: in _connection_for_bind
    return trans._connection_for_bind(engine, execution_options)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        engine     = Engine(postgresql+psycopg2://invenio:***@localhost:5432/invenio)
        execution_options = None
        kw         = {}
        self       = <sqlalchemy.orm.session.Session object at 0x7fc5892ebef0>
        trans      = <sqlalchemy.orm.session.SessionTransaction object at 0x7fc5891b0490>
<string>:2: in _connection_for_bind
    ???
        bind       = Engine(postgresql+psycopg2://invenio:***@localhost:5432/invenio)
        execution_options = None
        self       = <sqlalchemy.orm.session.SessionTransaction object at 0x7fc5891b0490>
.venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:101: in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
        arg        = (Engine(postgresql+psycopg2://invenio:***@localhost:5432/invenio), None)
        current_state = <SessionTransactionState.DEACTIVE: 4>
        expect_state_change = False
        fn         = <function SessionTransaction._connection_for_bind at 0x7fc596668860>
        has_prerequisite_states = True
        kw         = {}
        moves_to   = <_StateChangeStates.NO_CHANGE: 2>
        prerequisite_state_collection = (<SessionTransactionState.ACTIVE: 1>,)
        self       = <sqlalchemy.orm.session.SessionTransaction object at 0x7fc5891b0490>
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <sqlalchemy.orm.session.SessionTransaction object at 0x7fc5891b0490>
operation_name = '_connection_for_bind'
state = <SessionTransactionState.DEACTIVE: 4>

    def _raise_for_prerequisite_state(
        self, operation_name: str, state: _StateChangeState
    ) -> NoReturn:
        if state is SessionTransactionState.DEACTIVE:
            if self._rollback_exception:
>               raise sa_exc.PendingRollbackError(
                    "This Session's transaction has been rolled back "
                    "due to a previous exception during flush."
                    " To begin a new transaction with this Session, "
                    "first issue Session.rollback()."
                    f" Original exception was: {self._rollback_exception}",
                    code="7s2a",
                )
E               sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: UPDATE statement on table 'accounts_user' expected to update 1 row(s); 0 were matched. (Background on this error at: https://sqlalche.me/e/20/7s2a)

operation_name = '_connection_for_bind'
self       = <sqlalchemy.orm.session.SessionTransaction object at 0x7fc5891b0490>
state      = <SessionTransactionState.DEACTIVE: 4>

.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:971: PendingRollbackError
____________________ test_admin_links_visibility[res-False] ____________________

client = <FlaskClient <Flask 'invenio'>>
headers = {'accept': 'application/json', 'content-type': 'application/json'}
users = {'accented': <pytest_invenio.user.UserFixtureBase object at 0x7fc589357260>, 'inactive': <pytest_invenio.user.UserFixt...object at 0x7fc589356240>, 'notification_enabled': <pytest_invenio.user.UserFixtureBase object at 0x7fc5892eb170>, ...}
username = 'res', expected_admin_links = False

    @pytest.mark.parametrize(
        "username,expected_admin_links",
        [
            ("user_moderator", True),  # user_moderator should have admin links
            ("pub", False),  # regular user should not have admin links
            ("res", False),  # regular user should not have admin links
        ],
    )
    def test_admin_links_visibility(client, headers, users, username, expected_admin_links):
        """Test admin links visibility based on user permissions."""
        user = users[username]
>       client = user.login(client)
                 ^^^^^^^^^^^^^^^^^^

client     = <FlaskClient <Flask 'invenio'>>
expected_admin_links = False
headers    = {'accept': 'application/json', 'content-type': 'application/json'}
user       = <pytest_invenio.user.UserFixtureBase object at 0x7fc5893a4140>
username   = 'res'
users      = {'accented': <pytest_invenio.user.UserFixtureBase object at 0x7fc589357260>,
 'inactive': <pytest_invenio.user.UserFixtureBase object at 0x7fc5893e0650>,
 'notification_disabled': <pytest_invenio.user.UserFixtureBase object at 0x7fc589356240>,
 'notification_enabled': <pytest_invenio.user.UserFixtureBase object at 0x7fc5892eb170>,
 'pub': <pytest_invenio.user.UserFixtureBase object at 0x7fc589257620>,
 'pubres': <pytest_invenio.user.UserFixtureBase object at 0x7fc5892868d0>,
 'res': <pytest_invenio.user.UserFixtureBase object at 0x7fc5893a4140>,
 'unconfirmed': <pytest_invenio.user.UserFixtureBase object at 0x7fc58928edb0>,
 'user_moderator': <pytest_invenio.user.UserFixtureBase object at 0x7fc58928c050>}

tests/resources/test_resources_users.py:303: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.12/site-packages/pytest_invenio/user.py:152: in login
    return self._login(client, "/", logout_first)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        client     = <FlaskClient <Flask 'invenio'>>
        logout_first = False
        self       = <pytest_invenio.user.UserFixtureBase object at 0x7fc5893a4140>
.venv/lib/python3.12/site-packages/pytest_invenio/user.py:170: in _login
    res = client.post(
        base_path  = '/'
        client     = <FlaskClient <Flask 'invenio'>>
        logout     = False
        self       = <pytest_invenio.user.UserFixtureBase object at 0x7fc5893a4140>
.venv/lib/python3.12/site-packages/werkzeug/test.py:1167: in post
    return self.open(*args, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^
        args       = ('/login',)
        kw         = {'data': {'email': 'res@inveniosoftware.org', 'password': 'res'},
 'follow_redirects': True,
 'method': 'POST'}
        self       = <FlaskClient <Flask 'invenio'>>
.venv/lib/python3.12/site-packages/flask/testing.py:235: in open
    response = super().open(
        __class__  = <class 'flask.testing.FlaskClient'>
        args       = ('/login',)
        buffered   = False
        follow_redirects = True
        kwargs     = {'data': {'email': 'res@inveniosoftware.org', 'password': 'res'},
 'environ_base': {'HTTP_USER_AGENT': 'Werkzeug/3.1.4',
                  'REMOTE_ADDR': '127.0.0.1',
                  'werkzeug.debug.preserve_context': <built-in method append of list object at 0x7fc587f6ca40>},
 'method': 'POST'}
        request    = <Request 'http://localhost/login' [POST]>
        self       = <FlaskClient <Flask 'invenio'>>
.venv/lib/python3.12/site-packages/werkzeug/test.py:1116: in open
    response_parts = self.run_wsgi_app(request.environ, buffered=buffered)
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        arg        = <Request 'http://localhost/login' [POST]>
        args       = (<Request 'http://localhost/login' [POST]>,)
        buffered   = False
        follow_redirects = True
        kwargs     = {}
        request    = <Request 'http://localhost/login' [POST]>
        self       = <FlaskClient <Flask 'invenio'>>
.venv/lib/python3.12/site-packages/werkzeug/test.py:988: in run_wsgi_app
    rv = run_wsgi_app(self.application, environ, buffered=buffered)
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        buffered   = False
        environ    = {'CONTENT_LENGTH': '42',
 'CONTENT_TYPE': 'application/x-www-form-urlencoded',
 'HTTP_HOST': 'localhost',
 'HTTP_USER_AGENT': 'Werkzeug/3.1.4',
 'PATH_INFO': '/login',
 'QUERY_STRING': '',
 'RAW_URI': '/login',
 'REMOTE_ADDR': '127.0.0.1',
 'REQUEST_METHOD': 'POST',
 'REQUEST_URI': '/login',
 'SCRIPT_NAME': '',
 'SERVER_NAME': 'localhost',
 'SERVER_PORT': '80',
 'SERVER_PROTOCOL': 'HTTP/1.1',
 'werkzeug.debug.preserve_context': <built-in method append of list object at 0x7fc587f6ca40>,
 'werkzeug.request': <Request 'http://localhost/login' [POST]>,
 'wsgi.errors': <_io.TextIOWrapper name='<stderr>' mode='w' encoding='utf-8'>,
 'wsgi.input': <_io.BytesIO object at 0x7fc589180fe0>,
 'wsgi.multiprocess': False,
 'wsgi.multithread': False,
 'wsgi.run_once': False,
 'wsgi.url_scheme': 'http',
 'wsgi.version': (1, 0)}
        self       = <FlaskClient <Flask 'invenio'>>
.venv/lib/python3.12/site-packages/werkzeug/test.py:1264: in run_wsgi_app
    app_rv = app(environ, start_response)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        app        = <Flask 'invenio'>
        buffer     = []
        buffered   = False
        environ    = {'CONTENT_LENGTH': '42',
 'CONTENT_TYPE': 'application/x-www-form-urlencoded',
 'HTTP_HOST': 'localhost',
 'HTTP_USER_AGENT': 'Werkzeug/3.1.4',
 'PATH_INFO': '/login',
 'QUERY_STRING': '',
 'RAW_URI': '/login',
 'REMOTE_ADDR': '127.0.0.1',
 'REQUEST_METHOD': 'POST',
 'REQUEST_URI': '/login',
 'SCRIPT_NAME': '',
 'SERVER_NAME': 'localhost',
 'SERVER_PORT': '80',
 'SERVER_PROTOCOL': 'HTTP/1.1',
 'werkzeug.debug.preserve_context': <built-in method append of list object at 0x7fc587f6ca40>,
 'werkzeug.request': None,
 'wsgi.errors': <_io.TextIOWrapper name='<stderr>' mode='w' encoding='utf-8'>,
 'wsgi.input': <_io.BytesIO object at 0x7fc589180fe0>,
 'wsgi.multiprocess': False,
 'wsgi.multithread': False,
 'wsgi.run_once': False,
 'wsgi.url_scheme': 'http',
 'wsgi.version': (1, 0)}
        response   = None
        start_response = <function run_wsgi_app.<locals>.start_response at 0x7fc58cbe1760>
.venv/lib/python3.12/site-packages/flask/app.py:1536: in __call__
    return self.wsgi_app(environ, start_response)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        environ    = {'CONTENT_LENGTH': '42',
 'CONTENT_TYPE': 'application/x-www-form-urlencoded',
 'HTTP_HOST': 'localhost',
 'HTTP_USER_AGENT': 'Werkzeug/3.1.4',
 'PATH_INFO': '/login',
 'QUERY_STRING': '',
 'RAW_URI': '/login',
 'REMOTE_ADDR': '127.0.0.1',
 'REQUEST_METHOD': 'POST',
 'REQUEST_URI': '/login',
 'SCRIPT_NAME': '',
 'SERVER_NAME': 'localhost',
 'SERVER_PORT': '80',
 'SERVER_PROTOCOL': 'HTTP/1.1',
 'werkzeug.debug.preserve_context': <built-in method append of list object at 0x7fc587f6ca40>,
 'werkzeug.request': None,
 'wsgi.errors': <_io.TextIOWrapper name='<stderr>' mode='w' encoding='utf-8'>,
 'wsgi.input': <_io.BytesIO object at 0x7fc589180fe0>,
 'wsgi.multiprocess': False,
 'wsgi.multithread': False,
 'wsgi.run_once': False,
 'wsgi.url_scheme': 'http',
 'wsgi.version': (1, 0)}
        self       = <Flask 'invenio'>
        start_response = <function run_wsgi_app.<locals>.start_response at 0x7fc58cbe1760>
.venv/lib/python3.12/site-packages/flask/app.py:1514: in wsgi_app
    response = self.handle_exception(e)
               ^^^^^^^^^^^^^^^^^^^^^^^^
        ctx        = <RequestContext 'http://localhost/login' [POST] of invenio>
        environ    = {'CONTENT_LENGTH': '42',
 'CONTENT_TYPE': 'application/x-www-form-urlencoded',
 'HTTP_HOST': 'localhost',
 'HTTP_USER_AGENT': 'Werkzeug/3.1.4',
 'PATH_INFO': '/login',
 'QUERY_STRING': '',
 'RAW_URI': '/login',
 'REMOTE_ADDR': '127.0.0.1',
 'REQUEST_METHOD': 'POST',
 'REQUEST_URI': '/login',
 'SCRIPT_NAME': '',
 'SERVER_NAME': 'localhost',
 'SERVER_PORT': '80',
 'SERVER_PROTOCOL': 'HTTP/1.1',
 'werkzeug.debug.preserve_context': <built-in method append of list object at 0x7fc587f6ca40>,
 'werkzeug.request': None,
 'wsgi.errors': <_io.TextIOWrapper name='<stderr>' mode='w' encoding='utf-8'>,
 'wsgi.input': <_io.BytesIO object at 0x7fc589180fe0>,
 'wsgi.multiprocess': False,
 'wsgi.multithread': False,
 'wsgi.run_once': False,
 'wsgi.url_scheme': 'http',
 'wsgi.version': (1, 0)}
        error      = PendingRollbackError("This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: UPDATE statement on table 'accounts_user' expected to update 1 row(s); 0 were matched.")
        self       = <Flask 'invenio'>
        start_response = <function run_wsgi_app.<locals>.start_response at 0x7fc58cbe1760>
.venv/lib/python3.12/site-packages/flask/app.py:1511: in wsgi_app
    response = self.full_dispatch_request()
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        ctx        = <RequestContext 'http://localhost/login' [POST] of invenio>
        environ    = {'CONTENT_LENGTH': '42',
 'CONTENT_TYPE': 'application/x-www-form-urlencoded',
 'HTTP_HOST': 'localhost',
 'HTTP_USER_AGENT': 'Werkzeug/3.1.4',
 'PATH_INFO': '/login',
 'QUERY_STRING': '',
 'RAW_URI': '/login',
 'REMOTE_ADDR': '127.0.0.1',
 'REQUEST_METHOD': 'POST',
 'REQUEST_URI': '/login',
 'SCRIPT_NAME': '',
 'SERVER_NAME': 'localhost',
 'SERVER_PORT': '80',
 'SERVER_PROTOCOL': 'HTTP/1.1',
 'werkzeug.debug.preserve_context': <built-in method append of list object at 0x7fc587f6ca40>,
 'werkzeug.request': None,
 'wsgi.errors': <_io.TextIOWrapper name='<stderr>' mode='w' encoding='utf-8'>,
 'wsgi.input': <_io.BytesIO object at 0x7fc589180fe0>,
 'wsgi.multiprocess': False,
 'wsgi.multithread': False,
 'wsgi.run_once': False,
 'wsgi.url_scheme': 'http',
 'wsgi.version': (1, 0)}
        error      = PendingRollbackError("This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: UPDATE statement on table 'accounts_user' expected to update 1 row(s); 0 were matched.")
        self       = <Flask 'invenio'>
        start_response = <function run_wsgi_app.<locals>.start_response at 0x7fc58cbe1760>
.venv/lib/python3.12/site-packages/flask/app.py:919: in full_dispatch_request
    rv = self.handle_user_exception(e)
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        rv         = None
        self       = <Flask 'invenio'>
.venv/lib/python3.12/site-packages/flask/app.py:917: in full_dispatch_request
    rv = self.dispatch_request()
         ^^^^^^^^^^^^^^^^^^^^^^^
        rv         = None
        self       = <Flask 'invenio'>
.venv/lib/python3.12/site-packages/flask/app.py:902: in dispatch_request
    return self.ensure_sync(self.view_functions[rule.endpoint])(**view_args)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        req        = <Request 'http://localhost/login' [POST]>
        rule       = <Rule '/login' (POST, OPTIONS) -> invenio_accounts_rest_auth.login>
        self       = <Flask 'invenio'>
        view_args  = {}
.venv/lib/python3.12/site-packages/invenio_accounts/views/rest.py:61: in wrapper
    return f(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^
        args       = ()
        f          = <function View.as_view.<locals>.view at 0x7fc5892600e0>
        kwargs     = {}
.venv/lib/python3.12/site-packages/flask/views.py:110: in view
    return current_app.ensure_sync(self.dispatch_request)(**kwargs)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        class_args = ()
        class_kwargs = {}
        kwargs     = {}
        self       = <invenio_accounts.views.rest.LoginView object at 0x7fc589366810>
        view       = <function View.as_view.<locals>.view at 0x7fc589280a40>
.venv/lib/python3.12/site-packages/flask/views.py:191: in dispatch_request
    return current_app.ensure_sync(meth)(**kwargs)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        kwargs     = {}
        meth       = <bound method LoginView.post of <invenio_accounts.views.rest.LoginView object at 0x7fc589366810>>
        self       = <invenio_accounts.views.rest.LoginView object at 0x7fc589366810>
.venv/lib/python3.12/site-packages/webargs/core.py:445: in wrapper
    parsed_args = self.parse(
        argmap     = <GeneratedSchema(many=False)>
        args       = (<invenio_accounts.views.rest.LoginView object at 0x7fc589366810>,)
        as_kwargs  = True
        error_headers = None
        error_status_code = None
        func       = <function LoginView.post at 0x7fc58d494fe0>
        kwargs     = {}
        locations  = ('querystring', 'form', 'json')
        req_       = None
        req_obj    = None
        self       = <invenio_accounts.views.rest.FlaskParser object at 0x7fc58d659df0>
        validate   = None
.venv/lib/python3.12/site-packages/webargs/core.py:356: in parse
    result = schema.load(parsed)
             ^^^^^^^^^^^^^^^^^^^
        argmap     = <GeneratedSchema(many=False)>
        data       = None
        error_headers = None
        error_status_code = None
        locations  = ('querystring', 'form', 'json')
        parsed     = {'email': 'res@inveniosoftware.org', 'password': 'res'}
        parser     = <invenio_accounts.views.rest.FlaskParser object at 0x7fc5884fb9e0>
        req        = <Request 'http://localhost/' [GET]>
        schema     = <GeneratedSchema(many=False)>
        self       = <invenio_accounts.views.rest.FlaskParser object at 0x7fc58d659df0>
        validate   = None
        validators = []
.venv/lib/python3.12/site-packages/marshmallow/schema.py:792: in load
    return self._do_load(
        data       = {'email': 'res@inveniosoftware.org', 'password': 'res'}
        many       = None
        partial    = None
        self       = <GeneratedSchema(many=False)>
        unknown    = None
.venv/lib/python3.12/site-packages/marshmallow/schema.py:951: in _do_load
    result = self._deserialize(
        data       = {'email': 'res@inveniosoftware.org', 'password': 'res'}
        error_store = <marshmallow.error_store.ErrorStore object at 0x7fc58931bad0>
        errors     = {}
        many       = False
        partial    = None
        postprocess = True
        processed_data = {'email': 'res@inveniosoftware.org', 'password': 'res'}
        self       = <GeneratedSchema(many=False)>
        unknown    = 'raise'
.venv/lib/python3.12/site-packages/marshmallow/schema.py:734: in _deserialize
    value = self._call_and_store(
        attr_name  = 'email'
        d_kwargs   = {}
        data       = {'email': 'res@inveniosoftware.org', 'password': 'res'}
        error_store = <marshmallow.error_store.ErrorStore object at 0x7fc58931bad0>
        field_name = 'email'
        field_obj  = <fields.Email(dump_default=<marshmallow.missing>, attribute=None, validate=[<function user_exists at 0x7fc58d494400>], required=True, load_only=False, dump_only=False, load_default=<marshmallow.missing>, allow_none=False, error_messages={'required': 'Missing data for required field.', 'null': 'Field may not be null.', 'validator_failed': 'Invalid value.', 'invalid': 'Not a valid email address.', 'invalid_utf8': 'Not a valid utf-8 string.'})>
        getter     = <function Schema._deserialize.<locals>.getter at 0x7fc5891653a0>
        index      = None
        index_errors = True
        many       = False
        partial    = None
        partial_is_collection = False
        raw_value  = 'res@inveniosoftware.org'
        ret_d      = {}
        self       = <GeneratedSchema(many=False)>
        unknown    = 'raise'
.venv/lib/python3.12/site-packages/marshmallow/schema.py:570: in _call_and_store
    value = getter_func(data)
            ^^^^^^^^^^^^^^^^^
        data       = 'res@inveniosoftware.org'
        error_store = <marshmallow.error_store.ErrorStore object at 0x7fc58931bad0>
        field_name = 'email'
        getter_func = <function Schema._deserialize.<locals>.getter at 0x7fc5891653a0>
        index      = None
.venv/lib/python3.12/site-packages/marshmallow/schema.py:727: in getter
    return field_obj.deserialize(
        d_kwargs   = {}
        data       = {'email': 'res@inveniosoftware.org', 'password': 'res'}
        field_name = 'email'
        field_obj  = <fields.Email(dump_default=<marshmallow.missing>, attribute=None, validate=[<function user_exists at 0x7fc58d494400>], required=True, load_only=False, dump_only=False, load_default=<marshmallow.missing>, allow_none=False, error_messages={'required': 'Missing data for required field.', 'null': 'Field may not be null.', 'validator_failed': 'Invalid value.', 'invalid': 'Not a valid email address.', 'invalid_utf8': 'Not a valid utf-8 string.'})>
        val        = 'res@inveniosoftware.org'
.venv/lib/python3.12/site-packages/marshmallow/fields.py:375: in deserialize
    self._validate(output)
        attr       = 'email'
        data       = {'email': 'res@inveniosoftware.org', 'password': 'res'}
        kwargs     = {}
        output     = 'res@inveniosoftware.org'
        self       = <fields.Email(dump_default=<marshmallow.missing>, attribute=None, validate=[<function user_exists at 0x7fc58d494400>], required=True, load_only=False, dump_only=False, load_default=<marshmallow.missing>, allow_none=False, error_messages={'required': 'Missing data for required field.', 'null': 'Field may not be null.', 'validator_failed': 'Invalid value.', 'invalid': 'Not a valid email address.', 'invalid_utf8': 'Not a valid utf-8 string.'})>
        value      = 'res@inveniosoftware.org'
.venv/lib/python3.12/site-packages/marshmallow/fields.py:276: in _validate
    self._validate_all(value)
        self       = <fields.Email(dump_default=<marshmallow.missing>, attribute=None, validate=[<function user_exists at 0x7fc58d494400>], required=True, load_only=False, dump_only=False, load_default=<marshmallow.missing>, allow_none=False, error_messages={'required': 'Missing data for required field.', 'null': 'Field may not be null.', 'validator_failed': 'Invalid value.', 'invalid': 'Not a valid email address.', 'invalid_utf8': 'Not a valid utf-8 string.'})>
        value      = 'res@inveniosoftware.org'
.venv/lib/python3.12/site-packages/marshmallow/validate.py:82: in __call__
    r = validator(value)
        ^^^^^^^^^^^^^^^^
        errors     = []
        kwargs     = {}
        r          = 'res@inveniosoftware.org'
        self       = <And(validators=(<Email(error='Not a valid email address.')>, <function user_exists at 0x7fc58d494400>), error='Invalid value.')>
        validator  = <function user_exists at 0x7fc58d494400>
        value      = 'res@inveniosoftware.org'
.venv/lib/python3.12/site-packages/invenio_accounts/views/rest.py:187: in user_exists
    if not current_datastore.get_user(email):
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        email      = 'res@inveniosoftware.org'
.venv/lib/python3.12/site-packages/flask_security/datastore.py:219: in get_user
    rv = self.user_model.query.filter(query).first()
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        alchemyFn  = <sqlalchemy.sql.functions._FunctionGenerator object at 0x7fc5977df050>
        attr       = 'email'
        identifier = 'res@inveniosoftware.org'
        query      = <sqlalchemy.sql.elements.BinaryExpression object at 0x7fc5884f99d0>
        self       = <invenio_accounts.datastore.SessionAwareSQLAlchemyUserDatastore object at 0x7fc589304e00>
.venv/lib/python3.12/site-packages/sqlalchemy/orm/query.py:2759: in first
    return self.limit(1)._iter().first()  # type: ignore
           ^^^^^^^^^^^^^^^^^^^^^
        self       = <flask_sqlalchemy.query.Query object at 0x7fc5884fbd40>
.venv/lib/python3.12/site-packages/sqlalchemy/orm/query.py:2857: in _iter
    result: Union[ScalarResult[_T], Result[_T]] = self.session.execute(
        params     = immutabledict({})
        self       = <flask_sqlalchemy.query.Query object at 0x7fc5884f92b0>
        statement  = <sqlalchemy.sql.selectable.Select object at 0x7fc5884f9ee0>
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2351: in execute
    return self._execute_internal(
        _add_event = None
        _parent_execute_state = None
        bind_arguments = None
        execution_options = {'_sa_orm_load_options': default_load_options(_legacy_uniquing=True)}
        params     = immutabledict({})
        self       = <sqlalchemy.orm.session.Session object at 0x7fc5892ebef0>
        statement  = <sqlalchemy.sql.selectable.Select object at 0x7fc5884f9ee0>
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2239: in _execute_internal
    conn = self._connection_for_bind(bind)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        _add_event = None
        _parent_execute_state = None
        _scalar_result = False
        bind       = Engine(postgresql+psycopg2://invenio:***@localhost:5432/invenio)
        bind_arguments = {'clause': <sqlalchemy.sql.selectable.Select object at 0x7fc5884f9ee0>,
 'mapper': <Mapper at 0x7fc596363b30; User>}
        compile_state_cls = <class 'sqlalchemy.orm.context.ORMSelectCompileState'>
        events_todo = <sqlalchemy.event.attr._EmptyListener object at 0x7fc58e552b40>
        execution_options = immutabledict({'_sa_orm_load_options': default_load_options(_legacy_uniquing=True), '_result_disable_adapt_to_context': True})
        params     = immutabledict({})
        self       = <sqlalchemy.orm.session.Session object at 0x7fc5892ebef0>
        statement  = <sqlalchemy.sql.selectable.Select object at 0x7fc5884f9ee0>
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2108: in _connection_for_bind
    return trans._connection_for_bind(engine, execution_options)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        engine     = Engine(postgresql+psycopg2://invenio:***@localhost:5432/invenio)
        execution_options = None
        kw         = {}
        self       = <sqlalchemy.orm.session.Session object at 0x7fc5892ebef0>
        trans      = <sqlalchemy.orm.session.SessionTransaction object at 0x7fc5891b0490>
<string>:2: in _connection_for_bind
    ???
        bind       = Engine(postgresql+psycopg2://invenio:***@localhost:5432/invenio)
        execution_options = None
        self       = <sqlalchemy.orm.session.SessionTransaction object at 0x7fc5891b0490>
.venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:101: in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
        arg        = (Engine(postgresql+psycopg2://invenio:***@localhost:5432/invenio), None)
        current_state = <SessionTransactionState.DEACTIVE: 4>
        expect_state_change = False
        fn         = <function SessionTransaction._connection_for_bind at 0x7fc596668860>
        has_prerequisite_states = True
        kw         = {}
        moves_to   = <_StateChangeStates.NO_CHANGE: 2>
        prerequisite_state_collection = (<SessionTransactionState.ACTIVE: 1>,)
        self       = <sqlalchemy.orm.session.SessionTransaction object at 0x7fc5891b0490>
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <sqlalchemy.orm.session.SessionTransaction object at 0x7fc5891b0490>
operation_name = '_connection_for_bind'
state = <SessionTransactionState.DEACTIVE: 4>

    def _raise_for_prerequisite_state(
        self, operation_name: str, state: _StateChangeState
    ) -> NoReturn:
        if state is SessionTransactionState.DEACTIVE:
            if self._rollback_exception:
>               raise sa_exc.PendingRollbackError(
                    "This Session's transaction has been rolled back "
                    "due to a previous exception during flush."
                    " To begin a new transaction with this Session, "
                    "first issue Session.rollback()."
                    f" Original exception was: {self._rollback_exception}",
                    code="7s2a",
                )
E               sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: UPDATE statement on table 'accounts_user' expected to update 1 row(s); 0 were matched. (Background on this error at: https://sqlalche.me/e/20/7s2a)

operation_name = '_connection_for_bind'
self       = <sqlalchemy.orm.session.SessionTransaction object at 0x7fc5891b0490>
state      = <SessionTransactionState.DEACTIVE: 4>

.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:971: PendingRollbackError
=============================== warnings summary ===============================
.venv/lib/python3.12/site-packages/passlib/utils/__init__.py:854
    from crypt import crypt as _crypt

.venv/lib/python3.12/site-packages/jsonresolver/contrib/jsonschema.py:31
.venv/lib/python3.12/site-packages/jsonresolver/contrib/jsonschema.py:31
    from jsonschema import RefResolver as _RefResolver

.venv/lib/python3.12/site-packages/invenio_records/resolver.py:14
.venv/lib/python3.12/site-packages/invenio_records/resolver.py:14
    from jsonschema import RefResolutionError, RefResolver

.venv/lib/python3.12/site-packages/invenio_records/resolver.py:14
.venv/lib/python3.12/site-packages/invenio_records/resolver.py:14
    from jsonschema import RefResolutionError, RefResolver

.venv/lib/python3.12/site-packages/fs/__init__.py:4
    __import__("pkg_resources").declare_namespace(__name__)  # type: ignore

.venv/lib/python3.12/site-packages/pkg_resources/__init__.py:3146
  Implementing implicit namespace packages (as specified in PEP 420) is preferred to `pkg_resources.declare_namespace`. See https://setuptools.pypa.io/en/latest/references/keywords.html#keyword-namespace-packages
    declare_namespace(pkg)

.venv/lib/python3.12/site-packages/fs/__init__.py:4
  Implementing implicit namespace packages (as specified in PEP 420) is preferred to `pkg_resources.declare_namespace`. See https://setuptools.pypa.io/en/latest/references/keywords.html#keyword-namespace-packages
    __import__("pkg_resources").declare_namespace(__name__)  # type: ignore

.venv/lib/python3.12/site-packages/fs/opener/__init__.py:6
  Implementing implicit namespace packages (as specified in PEP 420) is preferred to `pkg_resources.declare_namespace`. See https://setuptools.pypa.io/en/latest/references/keywords.html#keyword-namespace-packages
    __import__("pkg_resources").declare_namespace(__name__)  # type: ignore

.venv/lib/python3.12/site-packages/pkg_resources/__init__.py:2558
  Implementing implicit namespace packages (as specified in PEP 420) is preferred to `pkg_resources.declare_namespace`. See https://setuptools.pypa.io/en/latest/references/keywords.html#keyword-namespace-packages
    declare_namespace(parent)

.venv/lib/python3.12/site-packages/marshmallow_utils/fields/generated.py:12
.venv/lib/python3.12/site-packages/marshmallow_utils/fields/generated.py:12
    from marshmallow import __version_info__ as marshmallow_version

.venv/lib/python3.12/site-packages/invenio_records_resources/services/files/schema.py:154
  /home/runner/work/invenio-testrig/invenio-testrig/package-repo/.venv/lib/python3.12/site-packages/invenio_records_resources/services/files/schema.py:154: RemovedInMarshmallow4Warning: The 'default' argument to fields is deprecated. Use 'dump_default' instead.
    storage_class = Str(default="L", dump_only=False)

    warnings.warn(

    warnings.warn(

    _security.datetime_factory(),

    target.updated = datetime.utcnow()

    created = datetime.utcnow()

    return util.wrap_callable(lambda ctx: fn(), fn)  # type: ignore

    return cls(int(id_s, 16), datetime.utcfromtimestamp(int(created_s, 16)))

    now = now or datetime.utcnow()

  /home/runner/work/invenio-testrig/invenio-testrig/package-repo/.venv/lib/python3.12/site-packages/invenio_records_resources/services/records/schema.py:105: RemovedInMarshmallow4Warning: The `context` parameter is deprecated and will be removed in marshmallow 4.0. Use `contextvars.ContextVar` to pass context instead.
    return self.schema(context=context, **schema_args).dump(data)

  /home/runner/work/invenio-testrig/invenio-testrig/package-repo/.venv/lib/python3.12/site-packages/marshmallow/fields.py:631: RemovedInMarshmallow4Warning: The `context` parameter is deprecated and will be removed in marshmallow 4.0. Use `contextvars.ContextVar` to pass context instead.
    self._schema = schema_class(

tests/resources/test_resources_domains.py::test_domains_read
    current_app.logger.warn(

  /home/runner/work/invenio-testrig/invenio-testrig/package-repo/.venv/lib/python3.12/site-packages/invenio_records_resources/services/records/schema.py:90: RemovedInMarshmallow4Warning: The `context` parameter is deprecated and will be removed in marshmallow 4.0. Use `contextvars.ContextVar` to pass context instead.
    valid_data = self.schema(context=context, **schema_args).load(data)

tests/resources/test_resources_groups.py::test_group_avatar
tests/resources/test_resources_users.py::test_read_self_serialization
tests/services/test_generators.py::test_group_not_managed_generator
tests/services/test_service_groups.py::test_groups_sort
tests/services/test_service_tasks_domains.py::test_import_domain_blocklist
tests/services/users/test_service_users.py::test_search_restricted
tests/services/users/test_user_moderation.py::test_moderation_callbacks_success
tests/test_notifications.py::test_user_recipient_generator
    self.init_app(app)

tests/resources/test_resources_groups.py::test_group_avatar
tests/resources/test_resources_users.py::test_read_self_serialization
tests/services/test_generators.py::test_group_not_managed_generator
tests/services/test_service_groups.py::test_groups_sort
tests/services/test_service_tasks_domains.py::test_import_domain_blocklist
tests/services/users/test_service_users.py::test_search_restricted
tests/services/users/test_user_moderation.py::test_moderation_callbacks_success
tests/test_notifications.py::test_user_recipient_generator
    self._set_cache(app, config)

    self._confirmed = datetime.utcnow() if confirmed else None

  /home/runner/work/invenio-testrig/invenio-testrig/package-repo/.venv/lib/python3.12/site-packages/flask_security/datastore.py:235: LegacyAPIWarning: The Query.get() method is considered legacy as of the 1.x series of SQLAlchemy and becomes a legacy construct in 2.0. The method is now available as Session.get() (deprecated since: 2.0) (Background on SQLAlchemy 2.0 at: https://sqlalche.me/e/b8d9)
    return self.user_model.query.get(identifier)

tests/resources/test_resources_groups.py::test_group_avatar
tests/resources/test_resources_users.py::test_user_avatar
tests/resources/test_resources_users.py::test_user_avatar_non_ascii
    max_age = datetime.utcnow() - timedelta(days=7)

tests/resources/test_resources_users.py::test_create_user
tests/services/users/test_service_users.py::test_create_user
tests/services/users/test_service_users.py::test_create_user_errors
    user.confirmed_at = datetime.utcnow()

tests/resources/test_resources_users.py::test_create_user
tests/resources/test_resources_users.py::test_approve_user
tests/services/users/test_service_users.py::test_create_user
tests/services/users/test_service_users.py::test_create_user_errors
tests/services/users/test_service_users.py::test_approve
    now = datetime.utcnow()

    self._created = datetime.utcnow()

tests/resources/test_resources_users.py::test_block_user
tests/services/users/test_service_users.py::test_block
tests/services/users/test_service_users.py::test_restore
tests/services/users/test_user_moderation.py::test_moderation_callbacks_success
tests/services/users/test_user_moderation.py::test_moderation_callbacks_failure
tests/services/users/test_user_moderation.py::test_moderation_callbacks_lock
tests/services/users/test_user_moderation.py::test_moderation_callbacks_lock_renewal[1-10-True]
tests/services/users/test_user_moderation.py::test_moderation_callbacks_lock_renewal[2-2-False]
    now = datetime.utcnow()

tests/services/users/test_user_moderation.py::test_moderation_callbacks_failure
tests/services/users/test_user_moderation.py::test_moderation_callbacks_lock_renewal[2-2-False]
    current_app.logger.warn(

- generated xml file: /home/runner/work/invenio-testrig/invenio-testrig/artifacts/test-report-patched.xml -
================================ tests coverage ================================
_______________ coverage: platform linux, python 3.12.12-final-0 _______________

Name                                                                      Stmts   Miss  Cover   Missing
invenio_users_resources/__init__.py                                           2      0   100%
invenio_users_resources/config.py                                            30      0   100%
invenio_users_resources/entity_resolvers.py                                  82     45    45%   36-43, 47-53, 57, 61-62, 66-90, 102-103, 107, 111, 115, 119, 128-136, 140-145, 149-150, 160, 173-174, 178, 182, 186, 190
invenio_users_resources/ext.py                                               64      5    92%   115-118, 126
invenio_users_resources/forms.py                                             14      5    64%   30-32, 38-39
invenio_users_resources/models.py                                            10      4    60%   21, 25, 29, 39
invenio_users_resources/notifications/__init__.py                             0      0   100%
invenio_users_resources/notifications/filters.py                             11      1    91%   23
invenio_users_resources/notifications/generators.py                          37     15    59%   25, 47, 51-53, 61-62, 67-68, 76-77, 80-85
invenio_users_resources/permissions.py                                        3      0   100%
invenio_users_resources/proxies.py                                           12      0   100%
invenio_users_resources/records/__init__.py                                   2      0   100%
invenio_users_resources/records/api.py                                      266     16    94%   89, 93, 102, 108, 228-232, 253-254, 263, 270, 277, 284, 296, 367
invenio_users_resources/records/dumpers/__init__.py                           2      0   100%
invenio_users_resources/records/dumpers/email.py                             15      0   100%
invenio_users_resources/records/hooks.py                                     45     16    64%   36-41, 44-49, 73, 78, 82, 88
invenio_users_resources/records/mappings/__init__.py                          0      0   100%
invenio_users_resources/records/mappings/os-v1/__init__.py                    0      0   100%
invenio_users_resources/records/mappings/os-v2/__init__.py                    0      0   100%
invenio_users_resources/records/mappings/v7/__init__.py                       0      0   100%
invenio_users_resources/records/models.py                                    98     11    89%   54, 85, 90, 152-154, 178-182
invenio_users_resources/records/systemfields/__init__.py                     72      0   100%
invenio_users_resources/resources/__init__.py                                 4      0   100%
invenio_users_resources/resources/domains/__init__.py                         3      0   100%
invenio_users_resources/resources/domains/config.py                          11      0   100%
invenio_users_resources/resources/domains/resource.py                         6      0   100%
invenio_users_resources/resources/groups/__init__.py                          3      0   100%
invenio_users_resources/resources/groups/config.py                           11      0   100%
invenio_users_resources/resources/groups/resource.py                         24      4    83%   44-49, 55-59
invenio_users_resources/resources/users/__init__.py                           3      0   100%
invenio_users_resources/resources/users/config.py                            19      0   100%
invenio_users_resources/resources/users/errors.py                             4      0   100%
invenio_users_resources/resources/users/resource.py                          74      8    89%   50, 79, 86-91, 149-153, 167-171
invenio_users_resources/services/__init__.py                                  4      0   100%
invenio_users_resources/services/common.py                                    5      0   100%
invenio_users_resources/services/domains/__init__.py                          3      0   100%
invenio_users_resources/services/domains/components.py                       27      6    78%   50-59
invenio_users_resources/services/domains/config.py                           29      0   100%
invenio_users_resources/services/domains/facets.py                            7      0   100%
invenio_users_resources/services/domains/service.py                           8      0   100%
invenio_users_resources/services/domains/tasks.py                            61     15    75%   25-30, 36-41, 71-73
invenio_users_resources/services/generators.py                               80      9    89%   37, 54-59, 86, 95, 161
invenio_users_resources/services/groups/__init__.py                           3      0   100%
invenio_users_resources/services/groups/config.py                            30      0   100%
invenio_users_resources/services/groups/results.py                           57      6    89%   39, 43, 59, 77, 83, 126
invenio_users_resources/services/groups/service.py                           26      7    73%   32, 38-39, 48, 54-58
invenio_users_resources/services/groups/tasks.py                             21      8    62%   27-28, 34-39
invenio_users_resources/services/params.py                                    9      0   100%
invenio_users_resources/services/permissions.py                              31      0   100%
invenio_users_resources/services/results.py                                  29      0   100%
invenio_users_resources/services/schemas.py                                 144     10    93%   199-202, 210, 213, 216, 259, 271, 281
invenio_users_resources/services/users/__init__.py                            3      0   100%
invenio_users_resources/services/users/config.py                             44      4    91%   54-57
invenio_users_resources/services/users/facets.py                              7      0   100%
invenio_users_resources/services/users/lock.py                               11      0   100%
invenio_users_resources/services/users/results.py                            57      4    93%   39, 43, 77, 83
invenio_users_resources/services/users/search_params.py                      23      8    65%   37-55
invenio_users_resources/services/users/service.py                           134     13    90%   142, 148-149, 158, 164-166, 184, 207, 231, 254, 266, 280
invenio_users_resources/services/users/tasks.py                              49      8    84%   56-57, 63-68
invenio_users_resources/templates/security/email/new_user_via_admin.txt       3      1    67%   3
invenio_users_resources/views.py                                             11      0   100%
TOTAL                                                                      1843    229    88%
=========================== short test summary info ============================
FAILED tests/resources/test_resources_users.py::test_admin_links[admin_records_html-/administration/records?q=parent.access.owned_by.user:{id}&f=allversions] - sqlalchemy.orm.exc.StaleDataError: UPDATE statement on table 'accounts_user' expected to update 1 row(s); 0 were matched.
FAILED tests/resources/test_resources_users.py::test_admin_links[admin_drafts_html-/administration/drafts?q=parent.access.owned_by.user:{id}&f=allversions] - sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: UPDATE statement on table 'accounts_user' expected to update 1 row(s); 0 were matched. (Background on this error at: https://sqlalche.me/e/20/7s2a)
FAILED tests/resources/test_resources_users.py::test_admin_links[admin_moderation_html-/administration/moderation?q=topic.user:{id}] - sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: UPDATE statement on table 'accounts_user' expected to update 1 row(s); 0 were matched. (Background on this error at: https://sqlalche.me/e/20/7s2a)
FAILED tests/resources/test_resources_users.py::test_admin_links_visibility[user_moderator-True] - sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: UPDATE statement on table 'accounts_user' expected to update 1 row(s); 0 were matched. (Background on this error at: https://sqlalche.me/e/20/7s2a)
FAILED tests/resources/test_resources_users.py::test_admin_links_visibility[pub-False] - sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: UPDATE statement on table 'accounts_user' expected to update 1 row(s); 0 were matched. (Background on this error at: https://sqlalche.me/e/20/7s2a)
FAILED tests/resources/test_resources_users.py::test_admin_links_visibility[res-False] - sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: UPDATE statement on table 'accounts_user' expected to update 1 row(s); 0 were matched. (Background on this error at: https://sqlalche.me/e/20/7s2a)
============ 6 failed, 296 passed, 840 warnings in 71.87s (0:01:11) ============
 Container docker_services_cli-opensearch-1  Stopping
 Container docker_services_cli-redis-1  Stopping
 Container docker_services_cli-postgresql-1  Stopping
 Container docker_services_cli-rabbitmq-1  Stopping
 Container docker_services_cli-postgresql-1  Stopped
 Container docker_services_cli-postgresql-1  Removing
 Container docker_services_cli-postgresql-1  Removed
 Container docker_services_cli-redis-1  Stopped
 Container docker_services_cli-redis-1  Removing
 Container docker_services_cli-redis-1  Removed
 Container docker_services_cli-opensearch-1  Stopped
 Container docker_services_cli-opensearch-1  Removing
 Container docker_services_cli-opensearch-1  Removed
 Container docker_services_cli-rabbitmq-1  Stopped
 Container docker_services_cli-rabbitmq-1  Removing
 Container docker_services_cli-rabbitmq-1  Removed
 Network docker_services_cli_default  Removing
 Network docker_services_cli_default  Removed
